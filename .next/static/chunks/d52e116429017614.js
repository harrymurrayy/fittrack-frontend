(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,92856,e=>{"use strict";var t=e.i(84190);let r="acquireTokenByRefreshToken",o="acquireTokenSilentAsync",i="acquireTokenRedirect",n="silentCacheClientAcquireToken",a="silentIframeClientAcquireToken",s="silentRefreshClientAcquireToken",c="standardInteractionClientGetDiscoveredAuthority",l="nativeInteractionClientAcquireToken",h="refreshTokenClientExecutePostToTokenEndpoint",d="authorizationCodeClientExecutePostToTokenEndpoint",u="refreshTokenClientExecuteTokenRequest",g="refreshTokenClientAcquireToken",p="refreshTokenClientAcquireTokenWithCachedRefreshToken",m="refreshTokenClientAcquireTokenByRefreshToken",f="refreshTokenClientCreateTokenRequestBody",y="acquireTokenFromCache",C="silentFlowClientAcquireCachedToken",T="silentFlowClientGenerateResultFromCacheRecord",A="acquireTokenBySilentIframe",I="initializeBaseRequest",w="initializeSilentRequest",v="silentIframeClientTokenHelper",E="silentHandlerInitiateAuthRequest",k="silentHandlerMonitorIframeForHash",S="silentHandlerLoadFrame",_="standardInteractionClientCreateAuthCodeClient",R="standardInteractionClientGetClientConfiguration",b="standardInteractionClientInitializeAuthorizationRequest",P="getAuthCodeUrl",O="handleCodeResponseFromServer",N="handleCodeResponse",M="handleResponseEar",q="handleResponsePlatformBroker",L="handleResponseCode",U="updateTokenEndpointAuthority",D="authClientAcquireToken",H="authClientExecuteTokenRequest",x="authClientCreateTokenRequestBody",F="popTokenGenerateCnf",B="handleServerTokenResponse",K="deserializeResponse",z="authorityFactoryCreateDiscoveredInstance",$="authorityResolveEndpointsAsync",Q="authorityGetCloudDiscoveryMetadataFromNetwork",G="authorityUpdateCloudDiscoveryMetadata",V="authorityGetEndpointMetadataFromNetwork",j="authorityUpdateEndpointMetadata",W="authorityUpdateMetadataWithRegionalInformation",J="regionDiscoveryDetectRegion",Y="regionDiscoveryGetRegionFromIMDS",X="regionDiscoveryGetCurrentVersion",Z="clearTokensAndKeysWithClaims",ee="generatePkceCodes",et="generateCodeChallengeFromVerifier",er="sha256Digest",eo="generateHKDF",ei="decrypt",en="generateEarKey";class ea{startMeasurement(){}endMeasurement(){}flushMeasurement(){return null}}class es{generateId(){return"callback-id"}startMeasurement(e,t){return{end:()=>null,discard:()=>{},add:()=>{},increment:()=>{},event:{eventId:this.generateId(),status:1,authority:"",libraryName:"",libraryVersion:"",clientId:"",name:e,startTimeMs:Date.now(),correlationId:t||""},measurement:new ea}}startPerformanceMeasurement(){return new ea}calculateQueuedTime(){return 0}addQueueMeasurement(){}setPreQueueTime(){}endMeasurement(){return null}discardMeasurements(){}removePerformanceCallback(){return!0}addPerformanceCallback(){return""}emitEvents(){}addFields(){}incrementFields(){}cacheEventByCorrelationId(){}}var ec=e.i(61732),el=e.i(22475);let eh="redirect_uri_empty",ed="claims_request_parsing_error",eu="authority_uri_insecure",eg="url_parse_error",ep="empty_url_error",em="empty_input_scopes_error",ef="invalid_claims",ey="token_request_empty",eC="logout_request_empty",eT="invalid_code_challenge_method",eA="pkce_params_missing",eI="invalid_cloud_discovery_metadata",ew="invalid_authority_metadata",ev="untrusted_authority",eE="missing_ssh_jwk",ek="missing_ssh_kid",eS="missing_nonce_authentication_header",e_="invalid_authentication_header",eR="cannot_set_OIDCOptions",eb="cannot_allow_platform_broker",eP="authority_mismatch",eO="invalid_request_method_for_EAR",eN="invalid_authorize_post_body_parameters",eM="invalid_platform_broker_configuration";e.s(["authorityMismatch",()=>eP,"authorityUriInsecure",()=>eu,"cannotAllowPlatformBroker",()=>eb,"cannotSetOIDCOptions",()=>eR,"claimsRequestParsingError",()=>ed,"emptyInputScopesError",()=>em,"invalidAuthenticationHeader",()=>e_,"invalidAuthorityMetadata",()=>ew,"invalidAuthorizePostBodyParameters",()=>eN,"invalidClaims",()=>ef,"invalidCloudDiscoveryMetadata",()=>eI,"invalidCodeChallengeMethod",()=>eT,"invalidPlatformBrokerConfiguration",()=>eM,"invalidRequestMethodForEAR",()=>eO,"logoutRequestEmpty",()=>eC,"missingNonceAuthenticationHeader",()=>eS,"missingSshJwk",()=>eE,"missingSshKid",()=>ek,"pkceParamsMissing",()=>eA,"redirectUriEmpty",()=>eh,"tokenRequestEmpty",()=>ey,"untrustedAuthority",()=>ev,"urlEmptyError",()=>ep,"urlParseError",()=>eg],95043);var eq=e.i(95043);let eL={[eh]:"A redirect URI is required for all calls, and none has been set.",[ed]:"Could not parse the given claims request object.",[eu]:"Authority URIs must use https.  Please see here for valid authority configuration options: https://docs.microsoft.com/en-us/azure/active-directory/develop/msal-js-initializing-client-applications#configuration-options",[eg]:"URL could not be parsed into appropriate segments.",[ep]:"URL was empty or null.",[em]:"Scopes cannot be passed as null, undefined or empty array because they are required to obtain an access token.",[ef]:"Given claims parameter must be a stringified JSON object.",[ey]:"Token request was empty and not found in cache.",[eC]:"The logout request was null or undefined.",[eT]:'code_challenge_method passed is invalid. Valid values are "plain" and "S256".',[eA]:"Both params: code_challenge and code_challenge_method are to be passed if to be sent in the request",[eI]:"Invalid cloudDiscoveryMetadata provided. Must be a stringified JSON object containing tenant_discovery_endpoint and metadata fields",[ew]:"Invalid authorityMetadata provided. Must by a stringified JSON object containing authorization_endpoint, token_endpoint, issuer fields.",[ev]:"The provided authority is not a trusted authority. Please include this authority in the knownAuthorities config parameter.",[eE]:"Missing sshJwk in SSH certificate request. A stringified JSON Web Key is required when using the SSH authentication scheme.",[ek]:"Missing sshKid in SSH certificate request. A string that uniquely identifies the public SSH key is required when using the SSH authentication scheme.",[eS]:"Unable to find an authentication header containing server nonce. Either the Authentication-Info or WWW-Authenticate headers must be present in order to obtain a server nonce.",[e_]:"Invalid authentication header provided",[eR]:"Cannot set OIDCOptions parameter. Please change the protocol mode to OIDC or use a non-Microsoft authority.",[eb]:"Cannot set allowPlatformBroker parameter to true when not in AAD protocol mode.",[eP]:"Authority mismatch error. Authority provided in login request or PublicClientApplication config does not match the environment of the provided account. Please use a matching account or make an interactive request to login to this authority.",[eN]:"Invalid authorize post body parameters provided. If you are using authorizePostBodyParameters, the request method must be POST. Please check the request method and parameters.",[eO]:"Invalid request method for EAR protocol mode. The request method cannot be GET when using EAR protocol mode. Please change the request method to POST.",[eM]:"Invalid platform broker configuration. `allowPlatformBrokerWithDOM` can only be enabled when `allowPlatformBroker` is enabled."};eL[eh],eL[ed],eL[eu],eL[eg],eL[ep],eL[em],eL[ef],eL[ey],eL[eC],eL[eT],eL[eA],eL[eI],eL[ew],eL[ev],eL[eE],eL[ek],eL[eS],eL[e_],eL[eR],eL[eb],eL[eP],eL[eN],eL[eO],eL[eM];class eU extends el.AuthError{constructor(e){super(e,eL[e]),this.name="ClientConfigurationError",Object.setPrototypeOf(this,eU.prototype)}}function eD(e){return new eU(e)}var eH=eq,ex=e.i(91493),eF=e.i(52375);let eB={sendGetRequestAsync:()=>Promise.reject((0,ex.createClientAuthError)(eF.methodNotImplemented)),sendPostRequestAsync:()=>Promise.reject((0,ex.createClientAuthError)(eF.methodNotImplemented))},eK={createNewGuid:()=>{throw(0,ex.createClientAuthError)(eF.methodNotImplemented)},base64Decode:()=>{throw(0,ex.createClientAuthError)(eF.methodNotImplemented)},base64Encode:()=>{throw(0,ex.createClientAuthError)(eF.methodNotImplemented)},base64UrlEncode:()=>{throw(0,ex.createClientAuthError)(eF.methodNotImplemented)},encodeKid:()=>{throw(0,ex.createClientAuthError)(eF.methodNotImplemented)},async getPublicKeyThumbprint(){throw(0,ex.createClientAuthError)(eF.methodNotImplemented)},async removeTokenBindingKey(){throw(0,ex.createClientAuthError)(eF.methodNotImplemented)},async clearKeystore(){throw(0,ex.createClientAuthError)(eF.methodNotImplemented)},async signJwt(){throw(0,ex.createClientAuthError)(eF.methodNotImplemented)},async hashString(){throw(0,ex.createClientAuthError)(eF.methodNotImplemented)}};var ez=e.i(88763);let e$="@azure/msal-common",eQ="15.13.3",eG="none";class eV{static isEmptyObj(e){if(e)try{let t=JSON.parse(e);return 0===Object.keys(t).length}catch(e){}return!0}static startsWith(e,t){return 0===e.indexOf(t)}static endsWith(e,t){return e.length>=t.length&&e.lastIndexOf(t)===e.length-t.length}static queryStringToObject(e){let t={},r=e.split("&"),o=e=>decodeURIComponent(e.replace(/\+/g," "));return r.forEach(e=>{if(e.trim()){let[r,i]=e.split(/=(.+)/g,2);r&&i&&(t[o(r)]=o(i))}}),t}static trimArrayEntries(e){return e.map(e=>e.trim())}static removeEmptyStringsFromArray(e){return e.filter(e=>!!e)}static jsonParseHelper(e){try{return JSON.parse(e)}catch(e){return null}}static matchPattern(e,t){return new RegExp(e.replace(/\\/g,"\\\\").replace(/\*/g,"[^ ]*").replace(/\?/g,"\\?")).test(t)}}class ej{constructor(e){const t=e?eV.trimArrayEntries([...e]):[],r=t?eV.removeEmptyStringsFromArray(t):[];if(!r||!r.length)throw eD(em);this.scopes=new Set,r.forEach(e=>this.scopes.add(e))}static fromString(e){return new ej((e||ez.Constants.EMPTY_STRING).split(" "))}static createSearchScopes(e){let t=new ej(e&&e.length>0?e:[...ez.OIDC_DEFAULT_SCOPES]);return t.containsOnlyOIDCScopes()?t.removeScope(ez.Constants.OFFLINE_ACCESS_SCOPE):t.removeOIDCScopes(),t}containsScope(e){let t=new ej(this.printScopesLowerCase().split(" "));return!!e&&t.scopes.has(e.toLowerCase())}containsScopeSet(e){return!!e&&!(e.scopes.size<=0)&&this.scopes.size>=e.scopes.size&&e.asArray().every(e=>this.containsScope(e))}containsOnlyOIDCScopes(){let e=0;return ez.OIDC_SCOPES.forEach(t=>{this.containsScope(t)&&(e+=1)}),this.scopes.size===e}appendScope(e){e&&this.scopes.add(e.trim())}appendScopes(e){try{e.forEach(e=>this.appendScope(e))}catch(e){throw(0,ex.createClientAuthError)(eF.cannotAppendScopeSet)}}removeScope(e){if(!e)throw(0,ex.createClientAuthError)(eF.cannotRemoveEmptyScope);this.scopes.delete(e.trim())}removeOIDCScopes(){ez.OIDC_SCOPES.forEach(e=>{this.scopes.delete(e)})}unionScopeSets(e){if(!e)throw(0,ex.createClientAuthError)(eF.emptyInputScopeSet);let t=new Set;return e.scopes.forEach(e=>t.add(e.toLowerCase())),this.scopes.forEach(e=>t.add(e.toLowerCase())),t}intersectingScopeSets(e){if(!e)throw(0,ex.createClientAuthError)(eF.emptyInputScopeSet);e.containsOnlyOIDCScopes()||e.removeOIDCScopes();let t=this.unionScopeSets(e),r=e.getScopeCount(),o=this.getScopeCount();return t.size<o+r}getScopeCount(){return this.scopes.size}asArray(){let e=[];return this.scopes.forEach(t=>e.push(t)),e}printScopes(){return this.scopes?this.asArray().join(" "):ez.Constants.EMPTY_STRING}printScopesLowerCase(){return this.printScopes().toLowerCase()}}var eW=e.i(28663),eJ=e.i(19335);function eY(e,t){let r=eZ(e);try{let e=t(r);return JSON.parse(e)}catch(e){throw(0,ex.createClientAuthError)(eF.tokenParsingError)}}function eX(e){if(!e.signin_state)return!1;let t=["kmsi","dvc_dmjd"];return e.signin_state.some(e=>t.includes(e.trim().toLowerCase()))}function eZ(e){if(!e)throw(0,ex.createClientAuthError)(eF.nullOrEmptyToken);let t=/^([^\.\s]*)\.([^\.\s]+)\.([^\.\s]*)$/.exec(e);if(!t||t.length<4)throw(0,ex.createClientAuthError)(eF.tokenParsingError);return t[2]}function e0(e,t){if(0===t||Date.now()-3e5>e+t)throw(0,ex.createClientAuthError)(eF.maxAgeTranspired)}function e1(e){if(!e)return e;let t=e.toLowerCase();return eV.endsWith(t,"?")?t=t.slice(0,-1):eV.endsWith(t,"?/")&&(t=t.slice(0,-2)),eV.endsWith(t,"/")||(t+="/"),t}function e2(e){return e.startsWith("#/")?e.substring(2):e.startsWith("#")||e.startsWith("?")?e.substring(1):e}function e6(e){if(!e||0>e.indexOf("="))return null;try{let t=e2(e),r=Object.fromEntries(new URLSearchParams(t));if(r.code||r.ear_jwe||r.error||r.error_description||r.state)return r}catch(e){throw(0,ex.createClientAuthError)(eF.hashNotDeserialized)}return null}function e4(e,t=!0,r){let o=[];return e.forEach((e,i)=>{!t&&r&&i in r?o.push(`${i}=${e}`):o.push(`${i}=${encodeURIComponent(e)}`)}),o.join("&")}function e3(e){if(!e)return e;let t=e.split("#")[0];try{let e=new URL(t),r=e.origin+e.pathname+e.search;return e1(r)}catch(e){return e1(t)}}e.s(["checkMaxAge",()=>e0,"extractTokenClaims",()=>eY,"getJWSPayload",()=>eZ,"isKmsi",()=>eX],84371),e.s(["getDeserializedResponse",()=>e6,"mapToQueryString",()=>e4,"normalizeUrlForComparison",()=>e3,"stripLeadingHashOrQuery",()=>e2],95369);class e5{get urlString(){return this._urlString}constructor(e){if(this._urlString=e,!this._urlString)throw eD(ep);e.includes("#")||(this._urlString=e5.canonicalizeUri(e))}static canonicalizeUri(e){if(e){let t=e.toLowerCase();return eV.endsWith(t,"?")?t=t.slice(0,-1):eV.endsWith(t,"?/")&&(t=t.slice(0,-2)),eV.endsWith(t,"/")||(t+="/"),t}return e}validateAsUri(){let e;try{e=this.getUrlComponents()}catch(e){throw eD(eg)}if(!e.HostNameAndPort||!e.PathSegments)throw eD(eg);if(!e.Protocol||"https:"!==e.Protocol.toLowerCase())throw eD(eu)}static appendQueryString(e,t){return t?0>e.indexOf("?")?`${e}?${t}`:`${e}&${t}`:e}static removeHashFromUrl(e){return e5.canonicalizeUri(e.split("#")[0])}replaceTenantPath(e){let t=this.getUrlComponents(),r=t.PathSegments;return e&&0!==r.length&&(r[0]===ez.AADAuthorityConstants.COMMON||r[0]===ez.AADAuthorityConstants.ORGANIZATIONS)&&(r[0]=e),e5.constructAuthorityUriFromObject(t)}getUrlComponents(){let e=RegExp("^(([^:/?#]+):)?(//([^/?#]*))?([^?#]*)(\\?([^#]*))?(#(.*))?"),t=this.urlString.match(e);if(!t)throw eD(eg);let r={Protocol:t[1],HostNameAndPort:t[4],AbsolutePath:t[5],QueryString:t[7]},o=r.AbsolutePath.split("/");return r.PathSegments=o=o.filter(e=>e&&e.length>0),r.QueryString&&r.QueryString.endsWith("/")&&(r.QueryString=r.QueryString.substring(0,r.QueryString.length-1)),r}static getDomainFromUrl(e){let t=RegExp("^([^:/?#]+://)?([^/?#]*)"),r=e.match(t);if(!r)throw eD(eg);return r[2]}static getAbsoluteUrl(e,t){if(e[0]===ez.Constants.FORWARD_SLASH){let r=new e5(t).getUrlComponents();return r.Protocol+"//"+r.HostNameAndPort+e}return e}static constructAuthorityUriFromObject(e){return new e5(e.Protocol+"//"+e.HostNameAndPort+"/"+e.PathSegments.join("/"))}static hashContainsKnownProperties(e){return!!e6(e)}}let e8={"login.microsoftonline.com":{token_endpoint:"https://login.microsoftonline.com/{tenantid}/oauth2/v2.0/token",jwks_uri:"https://login.microsoftonline.com/{tenantid}/discovery/v2.0/keys",issuer:"https://login.microsoftonline.com/{tenantid}/v2.0",authorization_endpoint:"https://login.microsoftonline.com/{tenantid}/oauth2/v2.0/authorize",end_session_endpoint:"https://login.microsoftonline.com/{tenantid}/oauth2/v2.0/logout"},"login.chinacloudapi.cn":{token_endpoint:"https://login.chinacloudapi.cn/{tenantid}/oauth2/v2.0/token",jwks_uri:"https://login.chinacloudapi.cn/{tenantid}/discovery/v2.0/keys",issuer:"https://login.partner.microsoftonline.cn/{tenantid}/v2.0",authorization_endpoint:"https://login.chinacloudapi.cn/{tenantid}/oauth2/v2.0/authorize",end_session_endpoint:"https://login.chinacloudapi.cn/{tenantid}/oauth2/v2.0/logout"},"login.microsoftonline.us":{token_endpoint:"https://login.microsoftonline.us/{tenantid}/oauth2/v2.0/token",jwks_uri:"https://login.microsoftonline.us/{tenantid}/discovery/v2.0/keys",issuer:"https://login.microsoftonline.us/{tenantid}/v2.0",authorization_endpoint:"https://login.microsoftonline.us/{tenantid}/oauth2/v2.0/authorize",end_session_endpoint:"https://login.microsoftonline.us/{tenantid}/oauth2/v2.0/logout"}},e9=[{preferred_network:"login.microsoftonline.com",preferred_cache:"login.windows.net",aliases:["login.microsoftonline.com","login.windows.net","login.microsoft.com","sts.windows.net"]},{preferred_network:"login.partner.microsoftonline.cn",preferred_cache:"login.partner.microsoftonline.cn",aliases:["login.partner.microsoftonline.cn","login.chinacloudapi.cn"]},{preferred_network:"login.microsoftonline.de",preferred_cache:"login.microsoftonline.de",aliases:["login.microsoftonline.de"]},{preferred_network:"login.microsoftonline.us",preferred_cache:"login.microsoftonline.us",aliases:["login.microsoftonline.us","login.usgovcloudapi.net"]},{preferred_network:"login-us.microsoftonline.com",preferred_cache:"login-us.microsoftonline.com",aliases:["login-us.microsoftonline.com"]}],e7=new Set;function te(e,t,r,o){if(o?.trace(`getAliasesFromMetadata called with source: ${r}`),e&&t){let i=tt(t,e);if(i)return o?.trace(`getAliasesFromMetadata: found cloud discovery metadata in ${r}, returning aliases`),i.aliases;o?.trace(`getAliasesFromMetadata: did not find cloud discovery metadata in ${r}`)}return null}function tt(e,t){for(let r=0;r<e.length;r++){let o=e[r];if(o.aliases.includes(t))return o}return null}e9.forEach(e=>{e.aliases.forEach(e=>{e7.add(e)})});var tr=el;let to="cache_quota_exceeded",ti="cache_error_unknown";e.s(["cacheErrorUnknown",()=>ti,"cacheQuotaExceeded",()=>to],52201);var tn=e.i(52201);let ta={[to]:"Exceeded cache storage capacity.",[ti]:"Unexpected error occurred when using cache storage."};class ts extends tr.AuthError{constructor(e,t){const r=t||(ta[e]?ta[e]:ta[ti]);super(`${e}: ${r}`),Object.setPrototypeOf(this,ts.prototype),this.name="CacheError",this.errorCode=e,this.errorMessage=r}}function tc(e){return e instanceof Error?"QuotaExceededError"===e.name||"NS_ERROR_DOM_QUOTA_REACHED"===e.name||e.message.includes("exceeded the quota")?new ts(to):new ts(e.name,e.message):new ts(ti)}class tl{constructor(e,t,r,o,i){this.clientId=e,this.cryptoImpl=t,this.commonLogger=r.clone(e$,eQ),this.staticAuthorityOptions=i,this.performanceClient=o}getAllAccounts(e,t){return this.buildTenantProfiles(this.getAccountsFilteredBy(e,t),t,e)}getAccountInfoFilteredBy(e,t){if(0===Object.keys(e).length||Object.values(e).every(e=>!e))return this.commonLogger.warning("getAccountInfoFilteredBy: Account filter is empty or invalid, returning null"),null;let r=this.getAllAccounts(e,t);return r.length>1?r.sort(e=>e.idTokenClaims?-1:1)[0]:1===r.length?r[0]:null}getBaseAccountInfo(e,t){let r=this.getAccountsFilteredBy(e,t);return r.length>0?eW.AccountEntity.getAccountInfo(r[0]):null}buildTenantProfiles(e,t,r){return e.flatMap(e=>this.getTenantProfilesFromAccountEntity(e,t,r?.tenantId,r))}getTenantedAccountInfoByFilter(e,t,r,o,i){let n;if(i&&!this.tenantProfileMatchesFilter(r,i))return null;let a=this.getIdToken(e,o,t,r.tenantId);return a&&(n=eY(a.secret,this.cryptoImpl.base64Decode),!this.idTokenClaimsMatchTenantProfileFilter(n,i))?null:(0,eJ.updateAccountTenantProfileData)(e,r,n,a?.secret)}getTenantProfilesFromAccountEntity(e,t,r,o){let i=eW.AccountEntity.getAccountInfo(e),n=i.tenantProfiles||new Map,a=this.getTokenKeys();if(r){let e=n.get(r);if(!e)return[];n=new Map([[r,e]])}let s=[];return n.forEach(e=>{let r=this.getTenantedAccountInfoByFilter(i,a,e,t,o);r&&s.push(r)}),s}tenantProfileMatchesFilter(e,t){return(!t.localAccountId||!!this.matchLocalAccountIdFromTenantProfile(e,t.localAccountId))&&(!t.name||e.name===t.name)&&(void 0===t.isHomeTenant||e.isHomeTenant===t.isHomeTenant)}idTokenClaimsMatchTenantProfileFilter(e,t){return(!t||(!t.localAccountId||!!this.matchLocalAccountIdFromTokenClaims(e,t.localAccountId))&&(!t.loginHint||!!this.matchLoginHintFromTokenClaims(e,t.loginHint))&&(!t.username||!!this.matchUsername(e.preferred_username,t.username))&&(!t.name||!!this.matchName(e,t.name))&&(!t.sid||!!this.matchSid(e,t.sid)))&&!0}async saveCacheRecord(e,t,r,o){if(!e)throw(0,ex.createClientAuthError)(eF.invalidCacheRecord);try{e.account&&await this.setAccount(e.account,t,r),e.idToken&&o?.idToken!==!1&&await this.setIdTokenCredential(e.idToken,t,r),e.accessToken&&o?.accessToken!==!1&&await this.saveAccessToken(e.accessToken,t,r),e.refreshToken&&o?.refreshToken!==!1&&await this.setRefreshTokenCredential(e.refreshToken,t,r),e.appMetadata&&this.setAppMetadata(e.appMetadata,t)}catch(e){if(this.commonLogger?.error("CacheManager.saveCacheRecord: failed"),e instanceof el.AuthError)throw e;throw tc(e)}}async saveAccessToken(e,t,r){let o={clientId:e.clientId,credentialType:e.credentialType,environment:e.environment,homeAccountId:e.homeAccountId,realm:e.realm,tokenType:e.tokenType,requestedClaimsHash:e.requestedClaimsHash},i=this.getTokenKeys(),n=ej.fromString(e.target);i.accessToken.forEach(e=>{if(!this.accessTokenKeyMatchesFilter(e,o,!1))return;let r=this.getAccessTokenCredential(e,t);r&&this.credentialMatchesFilter(r,o)&&ej.fromString(r.target).intersectingScopeSets(n)&&this.removeAccessToken(e,t)}),await this.setAccessTokenCredential(e,t,r)}getAccountsFilteredBy(e,t){let r=this.getAccountKeys(),o=[];return r.forEach(r=>{let i=this.getAccount(r,t);if(!i||e.homeAccountId&&!this.matchHomeAccountId(i,e.homeAccountId)||e.username&&!this.matchUsername(i.username,e.username)||e.environment&&!this.matchEnvironment(i,e.environment)||e.realm&&!this.matchRealm(i,e.realm)||e.nativeAccountId&&!this.matchNativeAccountId(i,e.nativeAccountId)||e.authorityType&&!this.matchAuthorityType(i,e.authorityType))return;let n={localAccountId:e?.localAccountId,name:e?.name},a=i.tenantProfiles?.filter(e=>this.tenantProfileMatchesFilter(e,n));a&&0===a.length||o.push(i)}),o}credentialMatchesFilter(e,t){return(!t.clientId||!!this.matchClientId(e,t.clientId))&&(!t.userAssertionHash||!!this.matchUserAssertionHash(e,t.userAssertionHash))&&("string"!=typeof t.homeAccountId||!!this.matchHomeAccountId(e,t.homeAccountId))&&(!t.environment||!!this.matchEnvironment(e,t.environment))&&(!t.realm||!!this.matchRealm(e,t.realm))&&(!t.credentialType||!!this.matchCredentialType(e,t.credentialType))&&(!t.familyId||!!this.matchFamilyId(e,t.familyId))&&(!t.target||!!this.matchTarget(e,t.target))&&(!t.requestedClaimsHash&&!e.requestedClaimsHash||e.requestedClaimsHash===t.requestedClaimsHash)&&(e.credentialType!==ez.CredentialType.ACCESS_TOKEN_WITH_AUTH_SCHEME||(!t.tokenType||!!this.matchTokenType(e,t.tokenType))&&(t.tokenType!==ez.AuthenticationScheme.SSH||!t.keyId||!!this.matchKeyId(e,t.keyId)))&&!0}getAppMetadataFilteredBy(e){let t=this.getKeys(),r={};return t.forEach(t=>{if(!this.isAppMetadata(t))return;let o=this.getAppMetadata(t);!o||e.environment&&!this.matchEnvironment(o,e.environment)||(!e.clientId||this.matchClientId(o,e.clientId))&&(r[t]=o)}),r}getAuthorityMetadataByAlias(e){let t=this.getAuthorityMetadataKeys(),r=null;return t.forEach(t=>{if(!this.isAuthorityMetadata(t)||-1===t.indexOf(this.clientId))return;let o=this.getAuthorityMetadata(t);o&&-1!==o.aliases.indexOf(e)&&(r=o)}),r}removeAllAccounts(e){this.getAllAccounts({},e).forEach(t=>{this.removeAccount(t,e)})}removeAccount(e,t){this.removeAccountContext(e,t),this.getAccountKeys().filter(t=>t.includes(e.homeAccountId)&&t.includes(e.environment)).forEach(e=>{this.removeItem(e,t),this.performanceClient.incrementFields({accountsRemoved:1},t)})}removeAccountContext(e,t){let r=this.getTokenKeys(),o=t=>t.includes(e.homeAccountId)&&t.includes(e.environment);r.idToken.filter(o).forEach(e=>{this.removeIdToken(e,t)}),r.accessToken.filter(o).forEach(e=>{this.removeAccessToken(e,t)}),r.refreshToken.filter(o).forEach(e=>{this.removeRefreshToken(e,t)})}removeAccessToken(e,t){let r=this.getAccessTokenCredential(e,t);if(this.removeItem(e,t),this.performanceClient.incrementFields({accessTokensRemoved:1},t),!r||r.credentialType.toLowerCase()!==ez.CredentialType.ACCESS_TOKEN_WITH_AUTH_SCHEME.toLowerCase()||r.tokenType!==ez.AuthenticationScheme.POP)return;let o=r.keyId;o&&this.cryptoImpl.removeTokenBindingKey(o).catch(()=>{this.commonLogger.error(`Failed to remove token binding key ${o}`,t),this.performanceClient?.incrementFields({removeTokenBindingKeyFailure:1},t)})}removeAppMetadata(e){return this.getKeys().forEach(t=>{this.isAppMetadata(t)&&this.removeItem(t,e)}),!0}getIdToken(e,t,r,o,i){this.commonLogger.trace("CacheManager - getIdToken called");let n={homeAccountId:e.homeAccountId,environment:e.environment,credentialType:ez.CredentialType.ID_TOKEN,clientId:this.clientId,realm:o},a=this.getIdTokensByFilter(n,t,r),s=a.size;if(s<1)return this.commonLogger.info("CacheManager:getIdToken - No token found"),null;if(s>1){let r=a;if(!o){let t=new Map;a.forEach((r,o)=>{r.realm===e.tenantId&&t.set(o,r)});let o=t.size;if(o<1)return this.commonLogger.info("CacheManager:getIdToken - Multiple ID tokens found for account but none match account entity tenant id, returning first result"),a.values().next().value;if(1===o)return this.commonLogger.info("CacheManager:getIdToken - Multiple ID tokens found for account, defaulting to home tenant profile"),t.values().next().value;r=t}return this.commonLogger.info("CacheManager:getIdToken - Multiple matching ID tokens found, clearing them"),r.forEach((e,r)=>{this.removeIdToken(r,t)}),i&&t&&i.addFields({multiMatchedID:a.size},t),null}return this.commonLogger.info("CacheManager:getIdToken - Returning ID token"),a.values().next().value}getIdTokensByFilter(e,t,r){let o=r&&r.idToken||this.getTokenKeys().idToken,i=new Map;return o.forEach(r=>{if(!this.idTokenKeyMatchesFilter(r,{clientId:this.clientId,...e}))return;let o=this.getIdTokenCredential(r,t);o&&this.credentialMatchesFilter(o,e)&&i.set(r,o)}),i}idTokenKeyMatchesFilter(e,t){let r=e.toLowerCase();return(!t.clientId||-1!==r.indexOf(t.clientId.toLowerCase()))&&(!t.homeAccountId||-1!==r.indexOf(t.homeAccountId.toLowerCase()))}removeIdToken(e,t){this.removeItem(e,t)}removeRefreshToken(e,t){this.removeItem(e,t)}getAccessToken(e,t,r,o){let i=t.correlationId;this.commonLogger.trace("CacheManager - getAccessToken called",i);let n=ej.createSearchScopes(t.scopes),a=t.authenticationScheme||ez.AuthenticationScheme.BEARER,s=a&&a.toLowerCase()!==ez.AuthenticationScheme.BEARER.toLowerCase()?ez.CredentialType.ACCESS_TOKEN_WITH_AUTH_SCHEME:ez.CredentialType.ACCESS_TOKEN,c={homeAccountId:e.homeAccountId,environment:e.environment,credentialType:s,clientId:this.clientId,realm:o||e.tenantId,target:n,tokenType:a,keyId:t.sshKid,requestedClaimsHash:t.requestedClaimsHash},l=r&&r.accessToken||this.getTokenKeys().accessToken,h=[];l.forEach(e=>{if(this.accessTokenKeyMatchesFilter(e,c,!0)){let t=this.getAccessTokenCredential(e,i);t&&this.credentialMatchesFilter(t,c)&&h.push(t)}});let d=h.length;return d<1?(this.commonLogger.info("CacheManager:getAccessToken - No token found",i),null):d>1?(this.commonLogger.info("CacheManager:getAccessToken - Multiple access tokens found, clearing them",i),h.forEach(e=>{this.removeAccessToken(this.generateCredentialKey(e),i)}),this.performanceClient.addFields({multiMatchedAT:h.length},i),null):(this.commonLogger.info("CacheManager:getAccessToken - Returning access token",i),h[0])}accessTokenKeyMatchesFilter(e,t,r){let o=e.toLowerCase();if(t.clientId&&-1===o.indexOf(t.clientId.toLowerCase())||t.homeAccountId&&-1===o.indexOf(t.homeAccountId.toLowerCase())||t.realm&&-1===o.indexOf(t.realm.toLowerCase())||t.requestedClaimsHash&&-1===o.indexOf(t.requestedClaimsHash.toLowerCase()))return!1;if(t.target){let e=t.target.asArray();for(let t=0;t<e.length;t++)if(r&&!o.includes(e[t].toLowerCase()))return!1;else if(!r&&o.includes(e[t].toLowerCase()))break}return!0}getAccessTokensByFilter(e,t){let r=this.getTokenKeys(),o=[];return r.accessToken.forEach(r=>{if(!this.accessTokenKeyMatchesFilter(r,e,!0))return;let i=this.getAccessTokenCredential(r,t);i&&this.credentialMatchesFilter(i,e)&&o.push(i)}),o}getRefreshToken(e,t,r,o,i){this.commonLogger.trace("CacheManager - getRefreshToken called");let n=t?ez.THE_FAMILY_ID:void 0,a={homeAccountId:e.homeAccountId,environment:e.environment,credentialType:ez.CredentialType.REFRESH_TOKEN,clientId:this.clientId,familyId:n},s=o&&o.refreshToken||this.getTokenKeys().refreshToken,c=[];s.forEach(e=>{if(this.refreshTokenKeyMatchesFilter(e,a)){let t=this.getRefreshTokenCredential(e,r);t&&this.credentialMatchesFilter(t,a)&&c.push(t)}});let l=c.length;return l<1?(this.commonLogger.info("CacheManager:getRefreshToken - No refresh token found."),null):(l>1&&i&&r&&i.addFields({multiMatchedRT:l},r),this.commonLogger.info("CacheManager:getRefreshToken - returning refresh token"),c[0])}refreshTokenKeyMatchesFilter(e,t){let r=e.toLowerCase();return(!t.familyId||-1!==r.indexOf(t.familyId.toLowerCase()))&&(!!t.familyId||!t.clientId||-1!==r.indexOf(t.clientId.toLowerCase()))&&(!t.homeAccountId||-1!==r.indexOf(t.homeAccountId.toLowerCase()))}readAppMetadataFromCache(e){let t={environment:e,clientId:this.clientId},r=this.getAppMetadataFilteredBy(t),o=Object.keys(r).map(e=>r[e]),i=o.length;if(i<1)return null;if(i>1)throw(0,ex.createClientAuthError)(eF.multipleMatchingAppMetadata);return o[0]}isAppMetadataFOCI(e){let t=this.readAppMetadataFromCache(e);return!!(t&&t.familyId===ez.THE_FAMILY_ID)}matchHomeAccountId(e,t){return"string"==typeof e.homeAccountId&&t===e.homeAccountId}matchLocalAccountIdFromTokenClaims(e,t){return t===(e.oid||e.sub)}matchLocalAccountIdFromTenantProfile(e,t){return e.localAccountId===t}matchName(e,t){return t.toLowerCase()===e.name?.toLowerCase()}matchUsername(e,t){return!!(e&&"string"==typeof e&&t?.toLowerCase()===e.toLowerCase())}matchUserAssertionHash(e,t){return!!(e.userAssertionHash&&t===e.userAssertionHash)}matchEnvironment(e,t){if(this.staticAuthorityOptions){let r=function(e,t){let r,o=e.canonicalAuthority;if(o){let i=new e5(o).getUrlComponents().HostNameAndPort;r=te(i,e.cloudDiscoveryMetadata?.metadata,ez.AuthorityMetadataSource.CONFIG,t)||te(i,e9,ez.AuthorityMetadataSource.HARDCODED_VALUES,t)||e.knownAuthorities}return r||[]}(this.staticAuthorityOptions,this.commonLogger);if(r.includes(t)&&r.includes(e.environment))return!0}let r=this.getAuthorityMetadataByAlias(t);return!!(r&&r.aliases.indexOf(e.environment)>-1)}matchCredentialType(e,t){return e.credentialType&&t.toLowerCase()===e.credentialType.toLowerCase()}matchClientId(e,t){return!!(e.clientId&&t===e.clientId)}matchFamilyId(e,t){return!!(e.familyId&&t===e.familyId)}matchRealm(e,t){return e.realm?.toLowerCase()===t.toLowerCase()}matchNativeAccountId(e,t){return!!(e.nativeAccountId&&t===e.nativeAccountId)}matchLoginHintFromTokenClaims(e,t){return e.login_hint===t||e.preferred_username===t||e.upn===t}matchSid(e,t){return e.sid===t}matchAuthorityType(e,t){return!!(e.authorityType&&t.toLowerCase()===e.authorityType.toLowerCase())}matchTarget(e,t){return(e.credentialType===ez.CredentialType.ACCESS_TOKEN||e.credentialType===ez.CredentialType.ACCESS_TOKEN_WITH_AUTH_SCHEME)&&!!e.target&&ej.fromString(e.target).containsScopeSet(t)}matchTokenType(e,t){return!!(e.tokenType&&e.tokenType===t)}matchKeyId(e,t){return!!(e.keyId&&e.keyId===t)}isAppMetadata(e){return -1!==e.indexOf(ez.APP_METADATA)}isAuthorityMetadata(e){return -1!==e.indexOf(ez.AUTHORITY_METADATA_CONSTANTS.CACHE_KEY)}generateAuthorityMetadataCacheKey(e){return`${ez.AUTHORITY_METADATA_CONSTANTS.CACHE_KEY}-${this.clientId}-${e}`}static toObject(e,t){for(let r in t)e[r]=t[r];return e}}class th extends tl{async setAccount(){throw(0,ex.createClientAuthError)(eF.methodNotImplemented)}getAccount(){throw(0,ex.createClientAuthError)(eF.methodNotImplemented)}async setIdTokenCredential(){throw(0,ex.createClientAuthError)(eF.methodNotImplemented)}getIdTokenCredential(){throw(0,ex.createClientAuthError)(eF.methodNotImplemented)}async setAccessTokenCredential(){throw(0,ex.createClientAuthError)(eF.methodNotImplemented)}getAccessTokenCredential(){throw(0,ex.createClientAuthError)(eF.methodNotImplemented)}async setRefreshTokenCredential(){throw(0,ex.createClientAuthError)(eF.methodNotImplemented)}getRefreshTokenCredential(){throw(0,ex.createClientAuthError)(eF.methodNotImplemented)}setAppMetadata(){throw(0,ex.createClientAuthError)(eF.methodNotImplemented)}getAppMetadata(){throw(0,ex.createClientAuthError)(eF.methodNotImplemented)}setServerTelemetry(){throw(0,ex.createClientAuthError)(eF.methodNotImplemented)}getServerTelemetry(){throw(0,ex.createClientAuthError)(eF.methodNotImplemented)}setAuthorityMetadata(){throw(0,ex.createClientAuthError)(eF.methodNotImplemented)}getAuthorityMetadata(){throw(0,ex.createClientAuthError)(eF.methodNotImplemented)}getAuthorityMetadataKeys(){throw(0,ex.createClientAuthError)(eF.methodNotImplemented)}setThrottlingCache(){throw(0,ex.createClientAuthError)(eF.methodNotImplemented)}getThrottlingCache(){throw(0,ex.createClientAuthError)(eF.methodNotImplemented)}removeItem(){throw(0,ex.createClientAuthError)(eF.methodNotImplemented)}getKeys(){throw(0,ex.createClientAuthError)(eF.methodNotImplemented)}getAccountKeys(){throw(0,ex.createClientAuthError)(eF.methodNotImplemented)}getTokenKeys(){throw(0,ex.createClientAuthError)(eF.methodNotImplemented)}generateCredentialKey(){throw(0,ex.createClientAuthError)(eF.methodNotImplemented)}generateAccountKey(){throw(0,ex.createClientAuthError)(eF.methodNotImplemented)}}let td={tokenRenewalOffsetSeconds:ez.DEFAULT_TOKEN_RENEWAL_OFFSET_SEC,preventCorsPreflight:!1},tu={loggerCallback:()=>{},piiLoggingEnabled:!1,logLevel:t.LogLevel.Info,correlationId:ez.Constants.EMPTY_STRING},tg={claimsBasedCachingEnabled:!1},tp={async sendGetRequestAsync(){throw(0,ex.createClientAuthError)(eF.methodNotImplemented)},async sendPostRequestAsync(){throw(0,ex.createClientAuthError)(eF.methodNotImplemented)}},tm={sku:ez.Constants.SKU,version:eQ,cpu:ez.Constants.EMPTY_STRING,os:ez.Constants.EMPTY_STRING},tf={clientSecret:ez.Constants.EMPTY_STRING,clientAssertion:void 0},ty={azureCloudInstance:eG,tenant:`${ez.Constants.DEFAULT_COMMON_TENANT}`},tC={application:{appName:"",appVersion:""}};function tT(e){return e.authOptions.authority.options.protocolMode===ec.ProtocolMode.OIDC}var tA=e.i(56518),tI=el;let tw="pkce_not_created",tv="ear_jwk_empty",tE="ear_jwe_empty",tk="crypto_nonexistent",tS="empty_navigate_uri",t_="hash_empty_error",tR="no_state_in_hash",tb="hash_does_not_contain_known_properties",tP="unable_to_parse_state",tO="state_interaction_type_mismatch",tN="interaction_in_progress",tM="popup_window_error",tq="empty_window_error",tL="user_cancelled",tU="monitor_popup_timeout",tD="monitor_window_timeout",tH="redirect_in_iframe",tx="block_iframe_reload",tF="block_nested_popups",tB="iframe_closed_prematurely",tK="silent_logout_unsupported",tz="no_account_error",t$="silent_prompt_value_error",tQ="no_token_request_cache_error",tG="unable_to_parse_token_request_cache_error",tV="auth_request_not_set_error",tj="invalid_cache_type",tW="non_browser_environment",tJ="database_not_open",tY="no_network_connectivity",tX="post_request_failed",tZ="get_request_failed",t0="failed_to_parse_response",t1="unable_to_load_token",t2="crypto_key_not_found",t6="auth_code_required",t4="auth_code_or_nativeAccountId_required",t3="spa_code_and_nativeAccountId_present",t5="database_unavailable",t8="unable_to_acquire_token_from_native_platform",t9="native_handshake_timeout",t7="native_extension_not_installed",re="native_connection_not_established",rt="uninitialized_public_client_application",rr="native_prompt_not_supported",ro="invalid_base64_string",ri="invalid_pop_token_request",rn="failed_to_build_headers",ra="failed_to_parse_headers",rs="failed_to_decrypt_ear_response",rc="timed_out";e.s(["authCodeOrNativeAccountIdRequired",()=>t4,"authCodeRequired",()=>t6,"authRequestNotSetError",()=>tV,"blockIframeReload",()=>tx,"blockNestedPopups",()=>tF,"cryptoKeyNotFound",()=>t2,"cryptoNonExistent",()=>tk,"databaseNotOpen",()=>tJ,"databaseUnavailable",()=>t5,"earJweEmpty",()=>tE,"earJwkEmpty",()=>tv,"emptyNavigateUri",()=>tS,"emptyWindowError",()=>tq,"failedToBuildHeaders",()=>rn,"failedToDecryptEarResponse",()=>rs,"failedToParseHeaders",()=>ra,"failedToParseResponse",()=>t0,"getRequestFailed",()=>tZ,"hashDoesNotContainKnownProperties",()=>tb,"hashEmptyError",()=>t_,"iframeClosedPrematurely",()=>tB,"interactionInProgress",()=>tN,"invalidBase64String",()=>ro,"invalidCacheType",()=>tj,"invalidPopTokenRequest",()=>ri,"monitorPopupTimeout",()=>tU,"monitorWindowTimeout",()=>tD,"nativeConnectionNotEstablished",()=>re,"nativeExtensionNotInstalled",()=>t7,"nativeHandshakeTimeout",()=>t9,"nativePromptNotSupported",()=>rr,"noAccountError",()=>tz,"noNetworkConnectivity",()=>tY,"noStateInHash",()=>tR,"noTokenRequestCacheError",()=>tQ,"nonBrowserEnvironment",()=>tW,"pkceNotCreated",()=>tw,"popupWindowError",()=>tM,"postRequestFailed",()=>tX,"redirectInIframe",()=>tH,"silentLogoutUnsupported",()=>tK,"silentPromptValueError",()=>t$,"spaCodeAndNativeAccountIdPresent",()=>t3,"stateInteractionTypeMismatch",()=>tO,"timedOut",()=>rc,"unableToAcquireTokenFromNativePlatform",()=>t8,"unableToLoadToken",()=>t1,"unableToParseState",()=>tP,"unableToParseTokenRequestCacheError",()=>tG,"uninitializedPublicClientApplication",()=>rt,"userCancelled",()=>tL],15756),e.i(15756);let rl="For more visit: aka.ms/msaljs/browser-errors",rh={[tw]:"The PKCE code challenge and verifier could not be generated.",[tv]:"No EAR encryption key provided. This is unexpected.",[tE]:"Server response does not contain ear_jwe property. This is unexpected.",[tk]:"The crypto object or function is not available.",[tS]:"Navigation URI is empty. Please check stack trace for more info.",[t_]:`Hash value cannot be processed because it is empty. Please verify that your redirectUri is not clearing the hash. ${rl}`,[tR]:"Hash does not contain state. Please verify that the request originated from msal.",[tb]:`Hash does not contain known properites. Please verify that your redirectUri is not changing the hash.  ${rl}`,[tP]:"Unable to parse state. Please verify that the request originated from msal.",[tO]:"Hash contains state but the interaction type does not match the caller.",[tN]:`Interaction is currently in progress. Please ensure that this interaction has been completed before calling an interactive API.   ${rl}`,[tM]:"Error opening popup window. This can happen if you are using IE or if popups are blocked in the browser.",[tq]:"window.open returned null or undefined window object.",[tL]:"User cancelled the flow.",[tU]:`Token acquisition in popup failed due to timeout.  ${rl}`,[tD]:`Token acquisition in iframe failed due to timeout.  ${rl}`,[tH]:"Redirects are not supported for iframed or brokered applications. Please ensure you are using MSAL.js in a top frame of the window if using the redirect APIs, or use the popup APIs.",[tx]:`Request was blocked inside an iframe because MSAL detected an authentication response.  ${rl}`,[tF]:"Request was blocked inside a popup because MSAL detected it was running in a popup.",[tB]:"The iframe being monitored was closed prematurely.",[tK]:"Silent logout not supported. Please call logoutRedirect or logoutPopup instead.",[tz]:"No account object provided to acquireTokenSilent and no active account has been set. Please call setActiveAccount or provide an account on the request.",[t$]:"The value given for the prompt value is not valid for silent requests - must be set to 'none' or 'no_session'.",[tQ]:"No token request found in cache.",[tG]:"The cached token request could not be parsed.",[tV]:"Auth Request not set. Please ensure initiateAuthRequest was called from the InteractionHandler",[tj]:"Invalid cache type",[tW]:"Login and token requests are not supported in non-browser environments.",[tJ]:"Database is not open!",[tY]:"No network connectivity. Check your internet connection.",[tX]:"Network request failed: If the browser threw a CORS error, check that the redirectUri is registered in the Azure App Portal as type 'SPA'",[tZ]:"Network request failed. Please check the network trace to determine root cause.",[t0]:"Failed to parse network response. Check network trace.",[t1]:"Error loading token to cache.",[t2]:"Cryptographic Key or Keypair not found in browser storage.",[t6]:"An authorization code must be provided (as the `code` property on the request) to this flow.",[t4]:"An authorization code or nativeAccountId must be provided to this flow.",[t3]:"Request cannot contain both spa code and native account id.",[t5]:"IndexedDB, which is required for persistent cryptographic key storage, is unavailable. This may be caused by browser privacy features which block persistent storage in third-party contexts.",[t8]:`Unable to acquire token from native platform.  ${rl}`,[t9]:"Timed out while attempting to establish connection to browser extension",[t7]:"Native extension is not installed. If you think this is a mistake call the initialize function.",[re]:`Connection to native platform has not been established. Please install a compatible browser extension and run initialize().  ${rl}`,[rt]:`You must call and await the initialize function before attempting to call any other MSAL API.  ${rl}`,[rr]:"The provided prompt is not supported by the native platform. This request should be routed to the web based flow.",[ro]:"Invalid base64 encoded string.",[ri]:"Invalid PoP token request. The request should not have both a popKid value and signPopToken set to true.",[rn]:"Failed to build request headers object.",[ra]:"Failed to parse response headers",[rs]:"Failed to decrypt ear response",[rc]:"The request timed out."};rh[tw],rh[tk],rh[tS],rh[t_],rh[tR],rh[tb],rh[tP],rh[tO],rh[tN],rh[tM],rh[tq],rh[tL],rh[tU],rh[tD],rh[tH],rh[tx],rh[tF],rh[tB],rh[tK],rh[tz],rh[t$],rh[tQ],rh[tG],rh[tV],rh[tj],rh[tW],rh[tJ],rh[tY],rh[tX],rh[tZ],rh[t0],rh[t1],rh[t2],rh[t6],rh[t4],rh[t3],rh[t5],rh[t8],rh[t9],rh[t7],rh[re],rh[rt],rh[rr],rh[ro],rh[ri];class rd extends tI.AuthError{constructor(e,t){super(e,rh[e],t),Object.setPrototypeOf(this,rd.prototype),this.name="BrowserAuthError"}}function ru(e,t){return new rd(e,t)}class rg{navigateInternal(e,t){return rg.defaultNavigateWindow(e,t)}navigateExternal(e,t){return rg.defaultNavigateWindow(e,t)}static defaultNavigateWindow(e,t){return t.noHistory?window.location.replace(e):window.location.assign(e),new Promise((e,r)=>{setTimeout(()=>{r(ru(rc,"failed_to_redirect"))},t.timeout)})}}var rp=el;class rm extends rp.AuthError{constructor(e,t,r){super(e.errorCode,e.errorMessage,e.subError),Object.setPrototypeOf(this,rm.prototype),this.name="NetworkError",this.error=e,this.httpStatus=t,this.responseHeaders=r}}function rf(e,t,r,o){return e.errorMessage=`${e.errorMessage}, additionalErrorInfo: error.name:${o?.name}, error.message:${o?.message}`,new rm(e,t,r)}class ry{async sendGetRequestAsync(e,t){let r,o={},i=0,n=rC(t);try{r=await fetch(e,{method:tA.HTTP_REQUEST_TYPE.GET,headers:n})}catch(e){throw rf(ru(window.navigator.onLine?tZ:tY),void 0,void 0,e)}o=rT(r.headers);try{return i=r.status,{headers:o,body:await r.json(),status:i}}catch(e){throw rf(ru(t0),i,o,e)}}async sendPostRequestAsync(e,t){let r,o=t&&t.body||"",i=rC(t),n=0,a={};try{r=await fetch(e,{method:tA.HTTP_REQUEST_TYPE.POST,headers:i,body:o})}catch(e){throw rf(ru(window.navigator.onLine?tX:tY),void 0,void 0,e)}a=rT(r.headers);try{return n=r.status,{headers:a,body:await r.json(),status:n}}catch(e){throw rf(ru(t0),n,a,e)}}}function rC(e){try{let t=new Headers;if(!(e&&e.headers))return t;let r=e.headers;return Object.entries(r).forEach(([e,r])=>{t.append(e,r)}),t}catch(e){throw rf(ru(rn),void 0,void 0,e)}}function rT(e){try{let t={};return e.forEach((e,r)=>{t[r]=e}),t}catch(e){throw ru(ra)}}let rA="client_id",rI="redirect_uri",rw="response_type",rv="response_mode",rE="grant_type",rk="claims",rS="scope",r_="refresh_token",rR="state",rb="nonce",rP="prompt",rO="code",rN="code_challenge",rM="code_challenge_method",rq="code_verifier",rL="client-request-id",rU="x-client-SKU",rD="x-client-VER",rH="x-client-OS",rx="x-client-CPU",rF="x-client-current-telemetry",rB="x-client-last-telemetry",rK="x-ms-lib-capability",rz="x-app-name",r$="x-app-ver",rQ="post_logout_redirect_uri",rG="id_token_hint",rV="device_code",rj="client_secret",rW="client_assertion",rJ="client_assertion_type",rY="token_type",rX="req_cnf",rZ="assertion",r0="requested_token_use",r1="return_spa_code",r2="nativebroker",r6="logout_hint",r4="login_hint",r3="domain_hint",r5="brk_client_id",r8="brk_redirect_uri",r9="instance_aware",r7="ear_jwk",oe="ear_jwe_crypto";function ot(e,t,r){if(!t)return;let o=e.get(rA);o&&e.has(r5)&&r?.addFields({embeddedClientId:o,embeddedRedirectUri:e.get(rI)},t)}function or(e,t){e.set(rw,t)}function oo(e,t){e.set(rv,t||ez.ResponseMode.QUERY)}function oi(e){e.set(r2,"1")}function on(e,t,r=!0,o=ez.OIDC_DEFAULT_SCOPES){!r||o.includes("openid")||t.includes("openid")||o.push("openid");let i=new ej(r?[...t||[],...o]:t||[]);e.set(rS,i.printScopes())}function oa(e,t){e.set(rA,t)}function os(e,t){e.set(rI,t)}function oc(e,t){e.set(rQ,t)}function ol(e,t){e.set(rG,t)}function oh(e,t){e.set(r3,t)}function od(e,t){e.set(r4,t)}function ou(e,t){e.set(ez.HeaderNames.CCS_HEADER,`UPN:${t}`)}function og(e,t){e.set(ez.HeaderNames.CCS_HEADER,`Oid:${t.uid}@${t.utid}`)}function op(e,t){e.set("sid",t)}function om(e,t,r){let o=oU(t,r);try{JSON.parse(o)}catch(e){throw eD(ef)}e.set(rk,o)}function of(e,t){e.set(rL,t)}function oy(e,t){e.set(rU,t.sku),e.set(rD,t.version),t.os&&e.set(rH,t.os),t.cpu&&e.set(rx,t.cpu)}function oC(e,t){t?.appName&&e.set(rz,t.appName),t?.appVersion&&e.set(r$,t.appVersion)}function oT(e,t){e.set(rP,t)}function oA(e,t){t&&e.set(rR,t)}function oI(e,t){e.set(rb,t)}function ow(e,t,r){if(t&&r)e.set(rN,t),e.set(rM,r);else throw eD(eA)}function ov(e,t){e.set(rO,t)}function oE(e,t){e.set(rV,t)}function ok(e,t){e.set(r_,t)}function oS(e,t){e.set(rq,t)}function o_(e,t){e.set(rj,t)}function oR(e,t){t&&e.set(rW,t)}function ob(e,t){t&&e.set(rJ,t)}function oP(e,t){e.set(rZ,t)}function oO(e,t){e.set(r0,t)}function oN(e,t){e.set(rE,t)}function oM(e){e.set(ez.CLIENT_INFO,"1")}function oq(e){e.has(r9)||e.set(r9,"true")}function oL(e,t){Object.entries(t).forEach(([t,r])=>{!e.has(t)&&r&&e.set(t,r)})}function oU(e,t){let r;if(e)try{r=JSON.parse(e)}catch(e){throw eD(ef)}else r={};return t&&t.length>0&&(r.hasOwnProperty(ez.ClaimsRequestKeys.ACCESS_TOKEN)||(r[ez.ClaimsRequestKeys.ACCESS_TOKEN]={}),r[ez.ClaimsRequestKeys.ACCESS_TOKEN][ez.ClaimsRequestKeys.XMS_CC]={values:t}),JSON.stringify(r)}function oD(e,t){e.set(ez.PasswordGrantConstants.username,t)}function oH(e,t){e.set(ez.PasswordGrantConstants.password,t)}function ox(e,t){t&&(e.set(rY,ez.AuthenticationScheme.POP),e.set(rX,t))}function oF(e,t){t&&(e.set(rY,ez.AuthenticationScheme.SSH),e.set(rX,t))}function oB(e,t){e.set(rF,t.generateCurrentRequestHeaderValue()),e.set(rB,t.generateLastRequestHeaderValue())}function oK(e){e.set(rK,ez.ThrottlingConstants.X_MS_LIB_CAPABILITY_VALUE)}function oz(e,t){e.set(r6,t)}function o$(e,t,r){e.has(r5)||e.set(r5,t),e.has(r8)||e.set(r8,r)}function oQ(e,t){e.set(r7,encodeURIComponent(t)),e.set(oe,"eyJhbGciOiJkaXIiLCJlbmMiOiJBMjU2R0NNIn0")}function oG(e,t){Object.entries(t).forEach(([t,r])=>{r&&e.set(t,r)})}e.s(["ACCESS_TOKEN",()=>"access_token","BROKER_CLIENT_ID",()=>r5,"BROKER_REDIRECT_URI",()=>r8,"CCS_HEADER",()=>"X-AnchorMailbox","CLAIMS",()=>rk,"CLIENT_ASSERTION",()=>rW,"CLIENT_ASSERTION_TYPE",()=>rJ,"CLIENT_ID",()=>rA,"CLIENT_INFO",()=>"client_info","CLIENT_REQUEST_ID",()=>rL,"CLIENT_SECRET",()=>rj,"CODE",()=>rO,"CODE_CHALLENGE",()=>rN,"CODE_CHALLENGE_METHOD",()=>rM,"CODE_VERIFIER",()=>rq,"DEVICE_CODE",()=>rV,"DOMAIN_HINT",()=>r3,"EAR_JWE_CRYPTO",()=>oe,"EAR_JWK",()=>r7,"ERROR",()=>"error","ERROR_DESCRIPTION",()=>"error_description","EXPIRES_IN",()=>"expires_in","FOCI",()=>"foci","GRANT_TYPE",()=>rE,"ID_TOKEN",()=>"id_token","ID_TOKEN_HINT",()=>rG,"INSTANCE_AWARE",()=>r9,"LOGIN_HINT",()=>r4,"LOGOUT_HINT",()=>r6,"NATIVE_BROKER",()=>r2,"NONCE",()=>rb,"OBO_ASSERTION",()=>rZ,"ON_BEHALF_OF",()=>"on_behalf_of","POST_LOGOUT_URI",()=>rQ,"PROMPT",()=>rP,"REDIRECT_URI",()=>rI,"REFRESH_TOKEN",()=>r_,"REFRESH_TOKEN_EXPIRES_IN",()=>"refresh_token_expires_in","REQUESTED_TOKEN_USE",()=>r0,"REQ_CNF",()=>rX,"RESPONSE_MODE",()=>rv,"RESPONSE_TYPE",()=>rw,"RETURN_SPA_CODE",()=>r1,"SCOPE",()=>rS,"SESSION_STATE",()=>"session_state","SID",()=>"sid","STATE",()=>rR,"TOKEN_TYPE",()=>rY,"X_APP_NAME",()=>rz,"X_APP_VER",()=>r$,"X_CLIENT_CPU",()=>rx,"X_CLIENT_CURR_TELEM",()=>rF,"X_CLIENT_EXTRA_SKU",()=>"x-client-xtra-sku","X_CLIENT_LAST_TELEM",()=>rB,"X_CLIENT_OS",()=>rH,"X_CLIENT_SKU",()=>rU,"X_CLIENT_VER",()=>rD,"X_MS_LIB_CAPABILITY",()=>rK],14811),e.s(["addApplicationTelemetry",()=>oC,"addAuthorizationCode",()=>ov,"addBrokerParameters",()=>o$,"addCcsOid",()=>og,"addCcsUpn",()=>ou,"addClaims",()=>om,"addClientAssertion",()=>oR,"addClientAssertionType",()=>ob,"addClientCapabilitiesToClaims",()=>oU,"addClientId",()=>oa,"addClientInfo",()=>oM,"addClientSecret",()=>o_,"addCodeChallengeParams",()=>ow,"addCodeVerifier",()=>oS,"addCorrelationId",()=>of,"addDeviceCode",()=>oE,"addDomainHint",()=>oh,"addEARParameters",()=>oQ,"addExtraQueryParameters",()=>oL,"addGrantType",()=>oN,"addIdTokenHint",()=>ol,"addInstanceAware",()=>oq,"addLibraryInfo",()=>oy,"addLoginHint",()=>od,"addLogoutHint",()=>oz,"addNativeBroker",()=>oi,"addNonce",()=>oI,"addOboAssertion",()=>oP,"addPassword",()=>oH,"addPopToken",()=>ox,"addPostBodyParameters",()=>oG,"addPostLogoutRedirectUri",()=>oc,"addPrompt",()=>oT,"addRedirectUri",()=>os,"addRefreshToken",()=>ok,"addRequestTokenUse",()=>oO,"addResponseMode",()=>oo,"addResponseType",()=>or,"addScopes",()=>on,"addServerTelemetry",()=>oB,"addSid",()=>op,"addSshJwk",()=>oF,"addState",()=>oA,"addThrottling",()=>oK,"addUsername",()=>oD,"instrumentBrokerParams",()=>ot],63235);var oV=e.i(63235),oV=oV;function oj(e){return encodeURIComponent(oJ(e).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_"))}function oW(e){return oY(e).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}function oJ(e){return oY(new TextEncoder().encode(e))}function oY(e){return btoa(Array.from(e,e=>String.fromCodePoint(e)).join(""))}function oX(e){return new TextDecoder().decode(oZ(e))}function oZ(e){let t=e.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw ru(ro)}let r=atob(t);return Uint8Array.from(r,e=>e.codePointAt(0)||0)}let o0="AES-GCM",o1="HKDF",o2="SHA-256",o6=new Uint8Array([1,0,1]),o4="0123456789abcdef",o3=new Uint32Array(1),o5="encrypt",o8="decrypt",o9={name:"RSASSA-PKCS1-v1_5",hash:o2,modulusLength:2048,publicExponent:o6};async function o7(e,t,r){t?.addQueueMeasurement(er,r);let o=new TextEncoder().encode(e);return window.crypto.subtle.digest(o2,o)}function ie(e){return window.crypto.getRandomValues(e)}function it(){return window.crypto.getRandomValues(o3),o3[0]}function ir(){let e=Date.now(),t=1024*it()+(1023&it()),r=new Uint8Array(16),o=Math.trunc(t/0x40000000),i=t&0x40000000-1,n=it();r[0]=e/0x10000000000,r[1]=e/0x100000000,r[2]=e/0x1000000,r[3]=e/65536,r[4]=e/256,r[5]=e,r[6]=112|o>>>8,r[7]=o,r[8]=128|i>>>24,r[9]=i>>>16,r[10]=i>>>8,r[11]=i,r[12]=n>>>24,r[13]=n>>>16,r[14]=n>>>8,r[15]=n;let a="";for(let e=0;e<r.length;e++)a+=o4.charAt(r[e]>>>4),a+=o4.charAt(15&r[e]),(3===e||5===e||7===e||9===e)&&(a+="-");return a}async function io(e,t){return window.crypto.subtle.generateKey(o9,e,t)}async function ii(e){return window.crypto.subtle.exportKey(tA.KEY_FORMAT_JWK,e)}async function ia(e,t,r){return window.crypto.subtle.importKey(tA.KEY_FORMAT_JWK,e,o9,t,r)}async function is(e,t){return window.crypto.subtle.sign(o9,e,t)}async function ic(){return oJ(JSON.stringify({alg:"dir",kty:"oct",k:oW(new Uint8Array(await id()))}))}async function il(e){let t=oZ(JSON.parse(oX(e)).k);return window.crypto.subtle.importKey("raw",t,o0,!1,[o8])}async function ih(e,t){let r=t.split(".");if(5!==r.length)throw ru(rs,"jwe_length");let o=await il(e).catch(()=>{throw ru(rs,"import_key")});try{let e=new TextEncoder().encode(r[0]),t=oZ(r[2]),i=oZ(r[3]),n=oZ(r[4]),a=8*n.byteLength,s=new Uint8Array(i.length+n.length);s.set(i),s.set(n,i.length);let c=await window.crypto.subtle.decrypt({name:o0,iv:t,tagLength:a,additionalData:e},o,s);return new TextDecoder().decode(c)}catch(e){throw ru(rs,"decrypt")}}async function id(){let e=await window.crypto.subtle.generateKey({name:o0,length:256},!0,[o5,o8]);return window.crypto.subtle.exportKey("raw",e)}async function iu(e){return window.crypto.subtle.importKey("raw",e,o1,!1,["deriveKey"])}async function ig(e,t,r){return window.crypto.subtle.deriveKey({name:o1,salt:t,hash:o2,info:new TextEncoder().encode(r)},e,{name:o0,length:256},!1,[o5,o8])}async function ip(e,t,r){let o=new TextEncoder().encode(t),i=window.crypto.getRandomValues(new Uint8Array(16)),n=await ig(e,i,r),a=await window.crypto.subtle.encrypt({name:o0,iv:new Uint8Array(12)},n,o);return{data:oW(new Uint8Array(a)),nonce:oW(i)}}async function im(e,t,r,o){let i=oZ(o),n=await ig(e,oZ(t),r),a=await window.crypto.subtle.decrypt({name:o0,iv:new Uint8Array(12)},n,i);return new TextDecoder().decode(a)}async function iy(e){return oW(new Uint8Array(await o7(e)))}var iC=e.i(1207),iT=e.i(40956);function iA(e){e.location.hash="","function"==typeof e.history.replaceState&&e.history.replaceState(null,"",`${e.location.origin}${e.location.pathname}${e.location.search}`)}function iI(){return window.parent!==window}function iw(){return"undefined"!=typeof window&&window.location?window.location.href.split("?")[0].split("#")[0]:""}function iv(){if("undefined"==typeof window)throw ru(tW)}function iE(e){if(!e)throw ru(rt)}function ik(e){if(iv(),e5.hashContainsKnownProperties(window.location.hash)&&iI())throw ru(tx);if("undefined"!=typeof window&&window.opener&&window.opener!==window&&"string"==typeof window.name&&0===window.name.indexOf(`${tA.BrowserConstants.POPUP_NAME_PREFIX}.`))throw ru(tF);iE(e)}function iS(e,t){ik(e);var r=t.system.allowRedirectInIframe;if(iI()&&!r)throw ru(tH);if(t.cache.cacheLocation===tA.BrowserCacheLocation.MemoryStorage&&!t.cache.storeAuthStateInCookie)throw(0,iC.createBrowserConfigurationAuthError)(iT.inMemRedirectUnavailable)}function i_(e){let t=document.createElement("link");t.rel="preconnect",t.href=new URL(e).origin,t.crossOrigin="anonymous",document.head.appendChild(t),window.setTimeout(()=>{try{document.head.removeChild(t)}catch{}},1e4)}oV.addClientCapabilitiesToClaims;let iR="4.27.0",ib="msal",iP="browser",iO=`${ib}.${iP}.log.level`,iN=`${ib}.${iP}.log.pii`,iM=`${ib}.version`,iq="account.keys",iL="token.keys";function iU(e=2){return e<1?`${ib}.${iq}`:`${ib}.${e}.${iq}`}function iD(e,t=2){return t<1?`${ib}.${iL}.${e}`:`${ib}.${t}.${iL}.${e}`}class iH{static loggerCallback(e,r){switch(e){case t.LogLevel.Error:console.error(r);return;case t.LogLevel.Info:console.info(r);return;case t.LogLevel.Verbose:console.debug(r);return;case t.LogLevel.Warning:console.warn(r);return;default:console.log(r);return}}constructor(e){let r;this.browserEnvironment="undefined"!=typeof window,this.config=function({auth:e,cache:r,system:o,telemetry:i},n){let a={clientId:ez.Constants.EMPTY_STRING,authority:`${ez.Constants.DEFAULT_AUTHORITY}`,knownAuthorities:[],cloudDiscoveryMetadata:ez.Constants.EMPTY_STRING,authorityMetadata:ez.Constants.EMPTY_STRING,redirectUri:"undefined"!=typeof window?iw():"",postLogoutRedirectUri:ez.Constants.EMPTY_STRING,navigateToLoginRequestUrl:!0,clientCapabilities:[],protocolMode:ec.ProtocolMode.AAD,OIDCOptions:{serverResponseType:ez.ServerResponseType.FRAGMENT,defaultScopes:[ez.Constants.OPENID_SCOPE,ez.Constants.PROFILE_SCOPE,ez.Constants.OFFLINE_ACCESS_SCOPE]},azureCloudOptions:{azureCloudInstance:eG,tenant:ez.Constants.EMPTY_STRING},skipAuthorityMetadataCache:!1,supportsNestedAppAuth:!1,instanceAware:!1,encodeExtraQueryParams:!1},s={cacheLocation:tA.BrowserCacheLocation.SessionStorage,cacheRetentionDays:5,temporaryCacheLocation:tA.BrowserCacheLocation.SessionStorage,storeAuthStateInCookie:!1,secureCookies:!1,cacheMigrationEnabled:!!r&&r.cacheLocation===tA.BrowserCacheLocation.LocalStorage,claimsBasedCachingEnabled:!1},c={loggerCallback:()=>{},logLevel:t.LogLevel.Info,piiLoggingEnabled:!1},l={...{...td,loggerOptions:c,networkClient:n?new ry:eB,navigationClient:new rg,loadFrameTimeout:0,windowHashTimeout:o?.loadFrameTimeout||6e4,iframeHashTimeout:o?.loadFrameTimeout||1e4,navigateFrameWait:0,redirectNavigationTimeout:3e4,asyncPopups:!1,allowRedirectInIframe:!1,allowPlatformBroker:!1,allowPlatformBrokerWithDOM:!1,nativeBrokerHandshakeTimeout:o?.nativeBrokerHandshakeTimeout||2e3,pollIntervalMilliseconds:tA.BrowserConstants.DEFAULT_POLL_INTERVAL_MS},...o,loggerOptions:o?.loggerOptions||c},h={application:{appName:ez.Constants.EMPTY_STRING,appVersion:ez.Constants.EMPTY_STRING},client:new es};if(e?.protocolMode!==ec.ProtocolMode.OIDC&&e?.OIDCOptions&&new t.Logger(l.loggerOptions).warning(JSON.stringify(eD(eH.cannotSetOIDCOptions))),e?.protocolMode&&e.protocolMode===ec.ProtocolMode.OIDC&&l?.allowPlatformBroker)throw eD(eH.cannotAllowPlatformBroker);return{auth:{...a,...e,OIDCOptions:{...a.OIDCOptions,...e?.OIDCOptions}},cache:{...s,...r},system:l,telemetry:{...h,...i}}}(e,this.browserEnvironment);try{r=window[tA.BrowserCacheLocation.SessionStorage]}catch(e){}const o=r?.getItem(iO),i=r?.getItem(iN)?.toLowerCase(),n="true"===i||"false"!==i&&void 0,a={...this.config.system.loggerOptions},s=o&&Object.keys(t.LogLevel).includes(o)?t.LogLevel[o]:void 0;s&&(a.loggerCallback=iH.loggerCallback,a.logLevel=s),void 0!==n&&(a.piiLoggingEnabled=n),this.logger=new t.Logger(a,"@azure/msal-browser",iR),this.available=!1}getConfig(){return this.config}getLogger(){return this.logger}isAvailable(){return this.available}isBrowserEnvironment(){return this.browserEnvironment}}class ix{static async initializeNestedAppAuthBridge(){if(void 0===window)throw Error("window is undefined");if(void 0===window.nestedAppAuthBridge)throw Error("window.nestedAppAuthBridge is undefined");try{window.nestedAppAuthBridge.addEventListener("message",e=>{let t="string"==typeof e?e:e.data,r=JSON.parse(t),o=ix.bridgeRequests.find(e=>e.requestId===r.requestId);void 0!==o&&(ix.bridgeRequests.splice(ix.bridgeRequests.indexOf(o),1),r.success?o.resolve(r):o.reject(r.error))});let e=await new Promise((e,t)=>{let r=ix.buildRequest("GetInitContext"),o={requestId:r.requestId,method:r.method,resolve:e,reject:t};ix.bridgeRequests.push(o),window.nestedAppAuthBridge.postMessage(JSON.stringify(r))});return ix.validateBridgeResultOrThrow(e.initContext)}catch(e){throw window.console.log(e),e}}getTokenInteractive(e){return this.getToken("GetTokenPopup",e)}getTokenSilent(e){return this.getToken("GetToken",e)}async getToken(e,t){let r=await this.sendRequest(e,{tokenParams:t});return{token:ix.validateBridgeResultOrThrow(r.token),account:ix.validateBridgeResultOrThrow(r.account)}}getHostCapabilities(){return this.capabilities??null}getAccountContext(){return this.accountContext?this.accountContext:null}static buildRequest(e,t){return{messageType:"NestedAppAuthRequest",method:e,requestId:ir(),sendTime:Date.now(),clientLibrary:tA.BrowserConstants.MSAL_SKU,clientLibraryVersion:iR,...t}}sendRequest(e,t){let r=ix.buildRequest(e,t);return new Promise((e,t)=>{let o={requestId:r.requestId,method:r.method,resolve:e,reject:t};ix.bridgeRequests.push(o),window.nestedAppAuthBridge.postMessage(JSON.stringify(r))})}static validateBridgeResultOrThrow(e){if(void 0===e)throw{status:"NESTED_APP_AUTH_UNAVAILABLE"};return e}constructor(e,t,r,o){this.sdkName=e,this.sdkVersion=t,this.accountContext=r,this.capabilities=o}static async create(){let e=await ix.initializeNestedAppAuthBridge();return new ix(e.sdkName,e.sdkVersion,e.accountContext,e.capabilities)}}ix.bridgeRequests=[];class iF extends iH{constructor(){super(...arguments),this.bridgeProxy=void 0,this.accountContext=null}getModuleName(){return iF.MODULE_NAME}getId(){return iF.ID}getBridgeProxy(){return this.bridgeProxy}async initialize(){try{if("undefined"!=typeof window){"function"==typeof window.__initializeNestedAppAuth&&await window.__initializeNestedAppAuth();let e=await ix.create();this.accountContext=e.getAccountContext(),this.bridgeProxy=e,this.available=void 0!==e}}catch(e){this.logger.infoPii(`Could not initialize Nested App Auth bridge (${e})`)}return this.logger.info(`Nested App Auth Bridge available: ${this.available}`),this.available}}iF.MODULE_NAME="",iF.ID="NestedAppOperatingContext";class iB extends iH{getModuleName(){return iB.MODULE_NAME}getId(){return iB.ID}async initialize(){return this.available="undefined"!=typeof window,this.available}}iB.MODULE_NAME="",iB.ID="StandardOperatingContext";var iK=eF,iz=el;let i$="missing_kid_error",iQ="missing_alg_error",iG={[i$]:"The JOSE Header for the requested JWT, JWS or JWK object requires a keyId to be configured as the 'kid' header claim. No 'kid' value was provided.",[iQ]:"The JOSE Header for the requested JWT, JWS or JWK object requires an algorithm to be specified as the 'alg' header claim. No 'alg' value was provided."};class iV extends iz.AuthError{constructor(e,t){super(e,t),this.name="JoseHeaderError",Object.setPrototypeOf(this,iV.prototype)}}function ij(e){return new iV(e,iG[e])}class iW{constructor(e){this.typ=e.typ,this.alg=e.alg,this.kid=e.kid}static getShrHeaderString(e){if(!e.kid)throw ij(i$);if(!e.alg)throw ij(iQ);return JSON.stringify(new iW({typ:e.typ||ez.JsonWebTokenTypes.Pop,kid:e.kid,alg:e.alg}))}}class iJ{constructor(){this.dbName=tA.DB_NAME,this.version=tA.DB_VERSION,this.tableName=tA.DB_TABLE_NAME,this.dbOpen=!1}async open(){return new Promise((e,t)=>{let r=window.indexedDB.open(this.dbName,this.version);r.addEventListener("upgradeneeded",e=>{e.target.result.createObjectStore(this.tableName)}),r.addEventListener("success",t=>{this.db=t.target.result,this.dbOpen=!0,e()}),r.addEventListener("error",()=>t(ru(t5)))})}closeConnection(){let e=this.db;e&&this.dbOpen&&(e.close(),this.dbOpen=!1)}async validateDbIsOpen(){if(!this.dbOpen)return this.open()}async getItem(e){return await this.validateDbIsOpen(),new Promise((t,r)=>{if(!this.db)return r(ru(tJ));let o=this.db.transaction([this.tableName],"readonly").objectStore(this.tableName).get(e);o.addEventListener("success",e=>{this.closeConnection(),t(e.target.result)}),o.addEventListener("error",e=>{this.closeConnection(),r(e)})})}async setItem(e,t){return await this.validateDbIsOpen(),new Promise((r,o)=>{if(!this.db)return o(ru(tJ));let i=this.db.transaction([this.tableName],"readwrite").objectStore(this.tableName).put(t,e);i.addEventListener("success",()=>{this.closeConnection(),r()}),i.addEventListener("error",e=>{this.closeConnection(),o(e)})})}async removeItem(e){return await this.validateDbIsOpen(),new Promise((t,r)=>{if(!this.db)return r(ru(tJ));let o=this.db.transaction([this.tableName],"readwrite").objectStore(this.tableName).delete(e);o.addEventListener("success",()=>{this.closeConnection(),t()}),o.addEventListener("error",e=>{this.closeConnection(),r(e)})})}async getKeys(){return await this.validateDbIsOpen(),new Promise((e,t)=>{if(!this.db)return t(ru(tJ));let r=this.db.transaction([this.tableName],"readonly").objectStore(this.tableName).getAllKeys();r.addEventListener("success",t=>{this.closeConnection(),e(t.target.result)}),r.addEventListener("error",e=>{this.closeConnection(),t(e)})})}async containsKey(e){return await this.validateDbIsOpen(),new Promise((t,r)=>{if(!this.db)return r(ru(tJ));let o=this.db.transaction([this.tableName],"readonly").objectStore(this.tableName).count(e);o.addEventListener("success",e=>{this.closeConnection(),t(1===e.target.result)}),o.addEventListener("error",e=>{this.closeConnection(),r(e)})})}async deleteDatabase(){return this.db&&this.dbOpen&&this.closeConnection(),new Promise((e,t)=>{let r=window.indexedDB.deleteDatabase(tA.DB_NAME),o=setTimeout(()=>t(!1),200);r.addEventListener("success",()=>(clearTimeout(o),e(!0))),r.addEventListener("blocked",()=>(clearTimeout(o),e(!0))),r.addEventListener("error",()=>(clearTimeout(o),t(!1)))})}}class iY{constructor(){this.cache=new Map}async initialize(){}getItem(e){return this.cache.get(e)||null}getUserData(e){return this.getItem(e)}setItem(e,t){this.cache.set(e,t)}async setUserData(e,t){this.setItem(e,t)}removeItem(e){this.cache.delete(e)}getKeys(){let e=[];return this.cache.forEach((t,r)=>{e.push(r)}),e}containsKey(e){return this.cache.has(e)}clear(){this.cache.clear()}decryptData(){return Promise.resolve(null)}}class iX{constructor(e){this.inMemoryCache=new iY,this.indexedDBCache=new iJ,this.logger=e}handleDatabaseAccessError(e){if(e instanceof rd&&e.errorCode===t5)this.logger.error("Could not access persistent storage. This may be caused by browser privacy features which block persistent storage in third-party contexts.");else throw e}async getItem(e){let t=this.inMemoryCache.getItem(e);if(!t)try{return this.logger.verbose("Queried item not found in in-memory cache, now querying persistent storage."),await this.indexedDBCache.getItem(e)}catch(e){this.handleDatabaseAccessError(e)}return t}async setItem(e,t){this.inMemoryCache.setItem(e,t);try{await this.indexedDBCache.setItem(e,t)}catch(e){this.handleDatabaseAccessError(e)}}async removeItem(e){this.inMemoryCache.removeItem(e);try{await this.indexedDBCache.removeItem(e)}catch(e){this.handleDatabaseAccessError(e)}}async getKeys(){let e=this.inMemoryCache.getKeys();if(0===e.length)try{return this.logger.verbose("In-memory cache is empty, now querying persistent storage."),await this.indexedDBCache.getKeys()}catch(e){this.handleDatabaseAccessError(e)}return e}async containsKey(e){let t=this.inMemoryCache.containsKey(e);if(!t)try{return this.logger.verbose("Key not found in in-memory cache, now querying persistent storage."),await this.indexedDBCache.containsKey(e)}catch(e){this.handleDatabaseAccessError(e)}return t}clearInMemory(){this.logger.verbose("Deleting in-memory keystore"),this.inMemoryCache.clear(),this.logger.verbose("In-memory keystore deleted")}async clearPersistent(){try{this.logger.verbose("Deleting persistent keystore");let e=await this.indexedDBCache.deleteDatabase();return e&&this.logger.verbose("Persistent keystore deleted"),e}catch(e){return this.handleDatabaseAccessError(e),!1}}}class iZ{constructor(e,t,r){this.logger=e;if(!window)throw ru(tW);if(!window.crypto)throw ru(tk);if(!r&&!window.crypto.subtle)throw ru(tk,"crypto_subtle_undefined");this.cache=new iX(this.logger),this.performanceClient=t}createNewGuid(){return ir()}base64Encode(e){return oJ(e)}base64Decode(e){return oX(e)}base64UrlEncode(e){return oj(e)}encodeKid(e){return this.base64UrlEncode(JSON.stringify({kid:e}))}async getPublicKeyThumbprint(e){let t=this.performanceClient?.startMeasurement("cryptoOptsGetPublicKeyThumbprint",e.correlationId),r=await io(iZ.EXTRACTABLE,iZ.POP_KEY_USAGES),o=await ii(r.publicKey),i=i0({e:o.e,kty:o.kty,n:o.n}),n=await this.hashString(i),a=await ii(r.privateKey),s=await ia(a,!1,["sign"]);return await this.cache.setItem(n,{privateKey:s,publicKey:r.publicKey,requestMethod:e.resourceRequestMethod,requestUri:e.resourceRequestUri}),t&&t.end({success:!0}),n}async removeTokenBindingKey(e){if(await this.cache.removeItem(e),await this.cache.containsKey(e))throw(0,ex.createClientAuthError)(iK.bindingKeyNotRemoved)}async clearKeystore(){this.cache.clearInMemory();try{return await this.cache.clearPersistent(),!0}catch(e){return e instanceof Error?this.logger.error(`Clearing keystore failed with error: ${e.message}`):this.logger.error("Clearing keystore failed with unknown error"),!1}}async signJwt(e,t,r,o){let i=this.performanceClient?.startMeasurement("cryptoOptsSignJwt",o),n=await this.cache.getItem(t);if(!n)throw ru(t2);let a=await ii(n.publicKey),s=i0(a),c=oj(JSON.stringify({kid:t})),l=oj(iW.getShrHeaderString({...r?.header,alg:a.alg,kid:c}));e.cnf={jwk:JSON.parse(s)};let h=oj(JSON.stringify(e)),d=`${l}.${h}`,u=new TextEncoder().encode(d),g=oW(new Uint8Array(await is(n.privateKey,u))),p=`${d}.${g}`;return i&&i.end({success:!0}),p}async hashString(e){return iy(e)}}function i0(e){return JSON.stringify(e,Object.keys(e).sort())}iZ.POP_KEY_USAGES=["sign","verify"],iZ.EXTRACTABLE=!0;var i1=e.i(2755);let i2=(e,t,r,o,i)=>(...n)=>{r.trace(`Executing function ${t}`);let a=o?.startMeasurement(t,i);i&&o?.incrementFields({[t+"CallCount"]:1},i);try{let o=e(...n);return a?.end({success:!0}),r.trace(`Returning result from ${t}`),o}catch(e){r.trace(`Error occurred in ${t}`);try{r.trace(JSON.stringify(e))}catch(e){r.trace("Unable to print error message.")}throw a?.end({success:!1},e),e}},i6=(e,t,r,o,i)=>(...n)=>{r.trace(`Executing function ${t}`);let a=o?.startMeasurement(t,i);return i&&o?.incrementFields({[t+"CallCount"]:1},i),o?.setPreQueueTime(t,i),e(...n).then(e=>(r.trace(`Returning result from ${t}`),a?.end({success:!0}),e)).catch(e=>{r.trace(`Error occurred in ${t}`);try{r.trace(JSON.stringify(e))}catch(e){r.trace("Unable to print error message.")}throw a?.end({success:!1},e),e})};class i4{constructor(e,t,r,o){this.networkInterface=e,this.logger=t,this.performanceClient=r,this.correlationId=o}async detectRegion(e,t){this.performanceClient?.addQueueMeasurement(J,this.correlationId);let r=e;if(r)t.region_source=ez.RegionDiscoverySources.ENVIRONMENT_VARIABLE;else{let e=i4.IMDS_OPTIONS;try{let o=await i6(this.getRegionFromIMDS.bind(this),Y,this.logger,this.performanceClient,this.correlationId)(ez.Constants.IMDS_VERSION,e);if(o.status===ez.HttpStatus.SUCCESS&&(r=o.body,t.region_source=ez.RegionDiscoverySources.IMDS),o.status===ez.HttpStatus.BAD_REQUEST){let o=await i6(this.getCurrentVersion.bind(this),X,this.logger,this.performanceClient,this.correlationId)(e);if(!o)return t.region_source=ez.RegionDiscoverySources.FAILED_AUTO_DETECTION,null;let i=await i6(this.getRegionFromIMDS.bind(this),Y,this.logger,this.performanceClient,this.correlationId)(o,e);i.status===ez.HttpStatus.SUCCESS&&(r=i.body,t.region_source=ez.RegionDiscoverySources.IMDS)}}catch(e){return t.region_source=ez.RegionDiscoverySources.FAILED_AUTO_DETECTION,null}}return r||(t.region_source=ez.RegionDiscoverySources.FAILED_AUTO_DETECTION),r||null}async getRegionFromIMDS(e,t){return this.performanceClient?.addQueueMeasurement(Y,this.correlationId),this.networkInterface.sendGetRequestAsync(`${ez.Constants.IMDS_ENDPOINT}?api-version=${e}&format=text`,t,ez.Constants.IMDS_TIMEOUT)}async getCurrentVersion(e){this.performanceClient?.addQueueMeasurement(X,this.correlationId);try{let t=await this.networkInterface.sendGetRequestAsync(`${ez.Constants.IMDS_ENDPOINT}?format=json`,e);if(t.status===ez.HttpStatus.BAD_REQUEST&&t.body&&t.body["newest-versions"]&&t.body["newest-versions"].length>0)return t.body["newest-versions"][0];return null}catch(e){return null}}}function i3(){return Math.round(new Date().getTime()/1e3)}function i5(e){return e.getTime()/1e3}function i8(e){return e?new Date(1e3*Number(e)):new Date}function i9(e,t){let r=Number(e)||0;return i3()+t>r}function i7(e,t){let r=Number(e)+24*t*36e5;return Date.now()>r}function ne(e){return Number(e)>i3()}function nt(e,t){return new Promise(r=>setTimeout(()=>r(t),e))}function nr(e,t,r,o,i){return{credentialType:ez.CredentialType.ID_TOKEN,homeAccountId:e,environment:t,clientId:o,secret:r,realm:i,lastUpdatedAt:Date.now().toString()}}function no(e,t,r,o,i,n,a,s,c,l,h,d,u,g,p){let m={homeAccountId:e,credentialType:ez.CredentialType.ACCESS_TOKEN,secret:r,cachedAt:i3().toString(),expiresOn:a.toString(),extendedExpiresOn:s.toString(),environment:t,clientId:o,realm:i,target:n,tokenType:h||ez.AuthenticationScheme.BEARER,lastUpdatedAt:Date.now().toString()};if(d&&(m.userAssertionHash=d),l&&(m.refreshOn=l.toString()),g&&(m.requestedClaims=g,m.requestedClaimsHash=p),m.tokenType?.toLowerCase()!==ez.AuthenticationScheme.BEARER.toLowerCase())switch(m.credentialType=ez.CredentialType.ACCESS_TOKEN_WITH_AUTH_SCHEME,m.tokenType){case ez.AuthenticationScheme.POP:let f=eY(r,c);if(!f?.cnf?.kid)throw(0,ex.createClientAuthError)(eF.tokenClaimsCnfRequiredForSignedJwt);m.keyId=f.cnf.kid;break;case ez.AuthenticationScheme.SSH:m.keyId=u}return m}function ni(e,t,r,o,i,n,a){let s={credentialType:ez.CredentialType.REFRESH_TOKEN,homeAccountId:e,environment:t,clientId:o,secret:r,lastUpdatedAt:Date.now().toString()};return n&&(s.userAssertionHash=n),i&&(s.familyId=i),a&&(s.expiresOn=a.toString()),s}function nn(e){return e.hasOwnProperty("homeAccountId")&&e.hasOwnProperty("environment")&&e.hasOwnProperty("credentialType")&&e.hasOwnProperty("clientId")&&e.hasOwnProperty("secret")}function na(e){return!!e&&nn(e)&&e.hasOwnProperty("realm")&&e.hasOwnProperty("target")&&(e.credentialType===ez.CredentialType.ACCESS_TOKEN||e.credentialType===ez.CredentialType.ACCESS_TOKEN_WITH_AUTH_SCHEME)}function ns(e){return!!e&&nn(e)&&e.hasOwnProperty("realm")&&e.credentialType===ez.CredentialType.ID_TOKEN}function nc(e){return!!e&&nn(e)&&e.credentialType===ez.CredentialType.REFRESH_TOKEN}function nl(e,t){let r=0===e.indexOf(ez.SERVER_TELEM_CONSTANTS.CACHE_KEY),o=!0;return t&&(o=t.hasOwnProperty("failedRequests")&&t.hasOwnProperty("errors")&&t.hasOwnProperty("cacheHits")),r&&o}function nh(e,t){let r=!1;e&&(r=0===e.indexOf(ez.ThrottlingConstants.THROTTLING_PREFIX));let o=!0;return t&&(o=t.hasOwnProperty("throttleTime")),r&&o}function nd({environment:e,clientId:t}){return[ez.APP_METADATA,e,t].join(ez.Separators.CACHE_KEY_SEPARATOR).toLowerCase()}function nu(e,t){return!!t&&0===e.indexOf(ez.APP_METADATA)&&t.hasOwnProperty("clientId")&&t.hasOwnProperty("environment")}function ng(e,t){return!!t&&0===e.indexOf(ez.AUTHORITY_METADATA_CONSTANTS.CACHE_KEY)&&t.hasOwnProperty("aliases")&&t.hasOwnProperty("preferred_cache")&&t.hasOwnProperty("preferred_network")&&t.hasOwnProperty("canonical_authority")&&t.hasOwnProperty("authorization_endpoint")&&t.hasOwnProperty("token_endpoint")&&t.hasOwnProperty("issuer")&&t.hasOwnProperty("aliasesFromNetwork")&&t.hasOwnProperty("endpointsFromNetwork")&&t.hasOwnProperty("expiresAt")&&t.hasOwnProperty("jwks_uri")}function np(){return i3()+ez.AUTHORITY_METADATA_CONSTANTS.REFRESH_TIME_SECONDS}function nm(e,t,r){e.authorization_endpoint=t.authorization_endpoint,e.token_endpoint=t.token_endpoint,e.end_session_endpoint=t.end_session_endpoint,e.issuer=t.issuer,e.endpointsFromNetwork=r,e.jwks_uri=t.jwks_uri}function nf(e,t,r){e.aliases=t.aliases,e.preferred_cache=t.preferred_cache,e.preferred_network=t.preferred_network,e.aliasesFromNetwork=r}function ny(e){return e.expiresAt<=i3()}i4.IMDS_OPTIONS={headers:{Metadata:"true"}},e.s(["delay",()=>nt,"isCacheExpired",()=>i7,"isTokenExpired",()=>i9,"nowSeconds",()=>i3,"toDateFromSeconds",()=>i8,"toSecondsFromDate",()=>i5,"wasClockTurnedBack",()=>ne],72036),e.s(["createAccessTokenEntity",()=>no,"createIdTokenEntity",()=>nr,"createRefreshTokenEntity",()=>ni,"generateAppMetadataKey",()=>nd,"generateAuthorityMetadataExpiresAt",()=>np,"isAccessTokenEntity",()=>na,"isAppMetadataEntity",()=>nu,"isAuthorityMetadataEntity",()=>ng,"isAuthorityMetadataExpired",()=>ny,"isCredentialEntity",()=>nn,"isIdTokenEntity",()=>ns,"isRefreshTokenEntity",()=>nc,"isServerTelemetryEntity",()=>nl,"isThrottlingEntity",()=>nh,"updateAuthorityEndpointMetadata",()=>nm,"updateCloudDiscoveryMetadata",()=>nf],18213);class nC{constructor(e,t,r,o,i,n,a,s){this.canonicalAuthority=e,this._canonicalAuthority.validateAsUri(),this.networkInterface=t,this.cacheManager=r,this.authorityOptions=o,this.regionDiscoveryMetadata={region_used:void 0,region_source:void 0,region_outcome:void 0},this.logger=i,this.performanceClient=a,this.correlationId=n,this.managedIdentity=s||!1,this.regionDiscovery=new i4(t,this.logger,this.performanceClient,this.correlationId)}getAuthorityType(e){if(e.HostNameAndPort.endsWith(ez.Constants.CIAM_AUTH_URL))return i1.AuthorityType.Ciam;let t=e.PathSegments;if(t.length)switch(t[0].toLowerCase()){case ez.Constants.ADFS:return i1.AuthorityType.Adfs;case ez.Constants.DSTS:return i1.AuthorityType.Dsts}return i1.AuthorityType.Default}get authorityType(){return this.getAuthorityType(this.canonicalAuthorityUrlComponents)}get protocolMode(){return this.authorityOptions.protocolMode}get options(){return this.authorityOptions}get canonicalAuthority(){return this._canonicalAuthority.urlString}set canonicalAuthority(e){this._canonicalAuthority=new e5(e),this._canonicalAuthority.validateAsUri(),this._canonicalAuthorityUrlComponents=null}get canonicalAuthorityUrlComponents(){return this._canonicalAuthorityUrlComponents||(this._canonicalAuthorityUrlComponents=this._canonicalAuthority.getUrlComponents()),this._canonicalAuthorityUrlComponents}get hostnameAndPort(){return this.canonicalAuthorityUrlComponents.HostNameAndPort.toLowerCase()}get tenant(){return this.canonicalAuthorityUrlComponents.PathSegments[0]}get authorizationEndpoint(){if(this.discoveryComplete())return this.replacePath(this.metadata.authorization_endpoint);throw(0,ex.createClientAuthError)(eF.endpointResolutionError)}get tokenEndpoint(){if(this.discoveryComplete())return this.replacePath(this.metadata.token_endpoint);throw(0,ex.createClientAuthError)(eF.endpointResolutionError)}get deviceCodeEndpoint(){if(this.discoveryComplete())return this.replacePath(this.metadata.token_endpoint.replace("/token","/devicecode"));throw(0,ex.createClientAuthError)(eF.endpointResolutionError)}get endSessionEndpoint(){if(this.discoveryComplete()){if(!this.metadata.end_session_endpoint)throw(0,ex.createClientAuthError)(eF.endSessionEndpointNotSupported);return this.replacePath(this.metadata.end_session_endpoint)}throw(0,ex.createClientAuthError)(eF.endpointResolutionError)}get selfSignedJwtAudience(){if(this.discoveryComplete())return this.replacePath(this.metadata.issuer);throw(0,ex.createClientAuthError)(eF.endpointResolutionError)}get jwksUri(){if(this.discoveryComplete())return this.replacePath(this.metadata.jwks_uri);throw(0,ex.createClientAuthError)(eF.endpointResolutionError)}canReplaceTenant(e){return 1===e.PathSegments.length&&!nC.reservedTenantDomains.has(e.PathSegments[0])&&this.getAuthorityType(e)===i1.AuthorityType.Default&&this.protocolMode!==ec.ProtocolMode.OIDC}replaceTenant(e){return e.replace(/{tenant}|{tenantid}/g,this.tenant)}replacePath(e){let t=e,r=new e5(this.metadata.canonical_authority).getUrlComponents(),o=r.PathSegments;return this.canonicalAuthorityUrlComponents.PathSegments.forEach((e,i)=>{let n=o[i];if(0===i&&this.canReplaceTenant(r)){let e=new e5(this.metadata.authorization_endpoint).getUrlComponents().PathSegments[0];n!==e&&(this.logger.verbose(`Replacing tenant domain name ${n} with id ${e}`),n=e)}e!==n&&(t=t.replace(`/${n}/`,`/${e}/`))}),this.replaceTenant(t)}get defaultOpenIdConfigurationEndpoint(){let e=this.hostnameAndPort;return this.canonicalAuthority.endsWith("v2.0/")||this.authorityType===i1.AuthorityType.Adfs||this.protocolMode===ec.ProtocolMode.OIDC&&!this.isAliasOfKnownMicrosoftAuthority(e)?`${this.canonicalAuthority}.well-known/openid-configuration`:`${this.canonicalAuthority}v2.0/.well-known/openid-configuration`}discoveryComplete(){return!!this.metadata}async resolveEndpointsAsync(){this.performanceClient?.addQueueMeasurement($,this.correlationId);let e=this.getCurrentMetadataEntity(),t=await i6(this.updateCloudDiscoveryMetadata.bind(this),G,this.logger,this.performanceClient,this.correlationId)(e);this.canonicalAuthority=this.canonicalAuthority.replace(this.hostnameAndPort,e.preferred_network);let r=await i6(this.updateEndpointMetadata.bind(this),j,this.logger,this.performanceClient,this.correlationId)(e);this.updateCachedMetadata(e,t,{source:r}),this.performanceClient?.addFields({cloudDiscoverySource:t,authorityEndpointSource:r},this.correlationId)}getCurrentMetadataEntity(){let e=this.cacheManager.getAuthorityMetadataByAlias(this.hostnameAndPort);return e||(e={aliases:[],preferred_cache:this.hostnameAndPort,preferred_network:this.hostnameAndPort,canonical_authority:this.canonicalAuthority,authorization_endpoint:"",token_endpoint:"",end_session_endpoint:"",issuer:"",aliasesFromNetwork:!1,endpointsFromNetwork:!1,expiresAt:np(),jwks_uri:""}),e}updateCachedMetadata(e,t,r){t!==ez.AuthorityMetadataSource.CACHE&&r?.source!==ez.AuthorityMetadataSource.CACHE&&(e.expiresAt=np(),e.canonical_authority=this.canonicalAuthority);let o=this.cacheManager.generateAuthorityMetadataCacheKey(e.preferred_cache);this.cacheManager.setAuthorityMetadata(o,e),this.metadata=e}async updateEndpointMetadata(e){this.performanceClient?.addQueueMeasurement(j,this.correlationId);let t=this.updateEndpointMetadataFromLocalSources(e);if(t)return t.source===ez.AuthorityMetadataSource.HARDCODED_VALUES&&this.authorityOptions.azureRegionConfiguration?.azureRegion&&t.metadata&&(nm(e,await i6(this.updateMetadataWithRegionalInformation.bind(this),W,this.logger,this.performanceClient,this.correlationId)(t.metadata),!1),e.canonical_authority=this.canonicalAuthority),t.source;let r=await i6(this.getEndpointMetadataFromNetwork.bind(this),V,this.logger,this.performanceClient,this.correlationId)();if(r)return this.authorityOptions.azureRegionConfiguration?.azureRegion&&(r=await i6(this.updateMetadataWithRegionalInformation.bind(this),W,this.logger,this.performanceClient,this.correlationId)(r)),nm(e,r,!0),ez.AuthorityMetadataSource.NETWORK;throw(0,ex.createClientAuthError)(eF.openIdConfigError,this.defaultOpenIdConfigurationEndpoint)}updateEndpointMetadataFromLocalSources(e){this.logger.verbose("Attempting to get endpoint metadata from authority configuration");let t=this.getEndpointMetadataFromConfig();if(t)return this.logger.verbose("Found endpoint metadata in authority configuration"),nm(e,t,!1),{source:ez.AuthorityMetadataSource.CONFIG};if(this.logger.verbose("Did not find endpoint metadata in the config... Attempting to get endpoint metadata from the hardcoded values."),this.authorityOptions.skipAuthorityMetadataCache)this.logger.verbose("Skipping hardcoded metadata cache since skipAuthorityMetadataCache is set to true. Attempting to get endpoint metadata from the network metadata cache.");else{let t=this.getEndpointMetadataFromHardcodedValues();if(t)return nm(e,t,!1),{source:ez.AuthorityMetadataSource.HARDCODED_VALUES,metadata:t};this.logger.verbose("Did not find endpoint metadata in hardcoded values... Attempting to get endpoint metadata from the network metadata cache.")}let r=ny(e);return this.isAuthoritySameType(e)&&e.endpointsFromNetwork&&!r?(this.logger.verbose("Found endpoint metadata in the cache."),{source:ez.AuthorityMetadataSource.CACHE}):(r&&this.logger.verbose("The metadata entity is expired."),null)}isAuthoritySameType(e){return new e5(e.canonical_authority).getUrlComponents().PathSegments.length===this.canonicalAuthorityUrlComponents.PathSegments.length}getEndpointMetadataFromConfig(){if(this.authorityOptions.authorityMetadata)try{return JSON.parse(this.authorityOptions.authorityMetadata)}catch(e){throw eD(ew)}return null}async getEndpointMetadataFromNetwork(){this.performanceClient?.addQueueMeasurement(V,this.correlationId);let e=this.defaultOpenIdConfigurationEndpoint;this.logger.verbose(`Authority.getEndpointMetadataFromNetwork: attempting to retrieve OAuth endpoints from ${e}`);try{var t;let r=await this.networkInterface.sendGetRequestAsync(e,{});if((t=r.body).hasOwnProperty("authorization_endpoint")&&t.hasOwnProperty("token_endpoint")&&t.hasOwnProperty("issuer")&&t.hasOwnProperty("jwks_uri"))return r.body;return this.logger.verbose("Authority.getEndpointMetadataFromNetwork: could not parse response as OpenID configuration"),null}catch(e){return this.logger.verbose(`Authority.getEndpointMetadataFromNetwork: ${e}`),null}}getEndpointMetadataFromHardcodedValues(){return this.hostnameAndPort in e8?e8[this.hostnameAndPort]:null}async updateMetadataWithRegionalInformation(e){this.performanceClient?.addQueueMeasurement(W,this.correlationId);let t=this.authorityOptions.azureRegionConfiguration?.azureRegion;if(t){if(t!==ez.Constants.AZURE_REGION_AUTO_DISCOVER_FLAG)return this.regionDiscoveryMetadata.region_outcome=ez.RegionDiscoveryOutcomes.CONFIGURED_NO_AUTO_DETECTION,this.regionDiscoveryMetadata.region_used=t,nC.replaceWithRegionalInformation(e,t);let r=await i6(this.regionDiscovery.detectRegion.bind(this.regionDiscovery),J,this.logger,this.performanceClient,this.correlationId)(this.authorityOptions.azureRegionConfiguration?.environmentRegion,this.regionDiscoveryMetadata);if(r)return this.regionDiscoveryMetadata.region_outcome=ez.RegionDiscoveryOutcomes.AUTO_DETECTION_REQUESTED_SUCCESSFUL,this.regionDiscoveryMetadata.region_used=r,nC.replaceWithRegionalInformation(e,r);this.regionDiscoveryMetadata.region_outcome=ez.RegionDiscoveryOutcomes.AUTO_DETECTION_REQUESTED_FAILED}return e}async updateCloudDiscoveryMetadata(e){this.performanceClient?.addQueueMeasurement(G,this.correlationId);let t=this.updateCloudDiscoveryMetadataFromLocalSources(e);if(t)return t;let r=await i6(this.getCloudDiscoveryMetadataFromNetwork.bind(this),Q,this.logger,this.performanceClient,this.correlationId)();if(r)return nf(e,r,!0),ez.AuthorityMetadataSource.NETWORK;throw eD(ev)}updateCloudDiscoveryMetadataFromLocalSources(e){this.logger.verbose("Attempting to get cloud discovery metadata  from authority configuration"),this.logger.verbosePii(`Known Authorities: ${this.authorityOptions.knownAuthorities||ez.Constants.NOT_APPLICABLE}`),this.logger.verbosePii(`Authority Metadata: ${this.authorityOptions.authorityMetadata||ez.Constants.NOT_APPLICABLE}`),this.logger.verbosePii(`Canonical Authority: ${e.canonical_authority||ez.Constants.NOT_APPLICABLE}`);let t=this.getCloudDiscoveryMetadataFromConfig();if(t)return this.logger.verbose("Found cloud discovery metadata in authority configuration"),nf(e,t,!1),ez.AuthorityMetadataSource.CONFIG;if(this.logger.verbose("Did not find cloud discovery metadata in the config... Attempting to get cloud discovery metadata from the hardcoded values."),this.options.skipAuthorityMetadataCache)this.logger.verbose("Skipping hardcoded cloud discovery metadata cache since skipAuthorityMetadataCache is set to true. Attempting to get cloud discovery metadata from the network metadata cache.");else{var r;let t=(r=this.hostnameAndPort,tt(e9,r));if(t)return this.logger.verbose("Found cloud discovery metadata from hardcoded values."),nf(e,t,!1),ez.AuthorityMetadataSource.HARDCODED_VALUES;this.logger.verbose("Did not find cloud discovery metadata in hardcoded values... Attempting to get cloud discovery metadata from the network metadata cache.")}let o=ny(e);return this.isAuthoritySameType(e)&&e.aliasesFromNetwork&&!o?(this.logger.verbose("Found cloud discovery metadata in the cache."),ez.AuthorityMetadataSource.CACHE):(o&&this.logger.verbose("The metadata entity is expired."),null)}getCloudDiscoveryMetadataFromConfig(){if(this.authorityType===i1.AuthorityType.Ciam)return this.logger.verbose("CIAM authorities do not support cloud discovery metadata, generate the aliases from authority host."),nC.createCloudDiscoveryMetadataFromHost(this.hostnameAndPort);if(this.authorityOptions.cloudDiscoveryMetadata){this.logger.verbose("The cloud discovery metadata has been provided as a network response, in the config.");try{this.logger.verbose("Attempting to parse the cloud discovery metadata.");let e=JSON.parse(this.authorityOptions.cloudDiscoveryMetadata),t=tt(e.metadata,this.hostnameAndPort);if(this.logger.verbose("Parsed the cloud discovery metadata."),t)return this.logger.verbose("There is returnable metadata attached to the parsed cloud discovery metadata."),t;this.logger.verbose("There is no metadata attached to the parsed cloud discovery metadata.")}catch(e){throw this.logger.verbose("Unable to parse the cloud discovery metadata. Throwing Invalid Cloud Discovery Metadata Error."),eD(eI)}}return this.isInKnownAuthorities()?(this.logger.verbose("The host is included in knownAuthorities. Creating new cloud discovery metadata from the host."),nC.createCloudDiscoveryMetadataFromHost(this.hostnameAndPort)):null}async getCloudDiscoveryMetadataFromNetwork(){this.performanceClient?.addQueueMeasurement(Q,this.correlationId);let e=`${ez.Constants.AAD_INSTANCE_DISCOVERY_ENDPT}${this.canonicalAuthority}oauth2/v2.0/authorize`,t=null;try{var r,o;let i,n,a=await this.networkInterface.sendGetRequestAsync(e,{});if((r=a.body).hasOwnProperty("tenant_discovery_endpoint")&&r.hasOwnProperty("metadata"))n=(i=a.body).metadata,this.logger.verbosePii(`tenant_discovery_endpoint is: ${i.tenant_discovery_endpoint}`);else{if(!((o=a.body).hasOwnProperty("error")&&o.hasOwnProperty("error_description")))return this.logger.error("AAD did not return a CloudInstanceDiscoveryResponse or CloudInstanceDiscoveryErrorResponse"),null;if(this.logger.warning(`A CloudInstanceDiscoveryErrorResponse was returned. The cloud instance discovery network request's status code is: ${a.status}`),(i=a.body).error===ez.Constants.INVALID_INSTANCE)return this.logger.error("The CloudInstanceDiscoveryErrorResponse error is invalid_instance."),null;this.logger.warning(`The CloudInstanceDiscoveryErrorResponse error is ${i.error}`),this.logger.warning(`The CloudInstanceDiscoveryErrorResponse error description is ${i.error_description}`),this.logger.warning("Setting the value of the CloudInstanceDiscoveryMetadata (returned from the network) to []"),n=[]}this.logger.verbose("Attempting to find a match between the developer's authority and the CloudInstanceDiscoveryMetadata returned from the network request."),t=tt(n,this.hostnameAndPort)}catch(e){return e instanceof el.AuthError?this.logger.error(`There was a network error while attempting to get the cloud discovery instance metadata.
Error: ${e.errorCode}
Error Description: ${e.errorMessage}`):this.logger.error(`A non-MSALJS error was thrown while attempting to get the cloud instance discovery metadata.
Error: ${e.name}
Error Description: ${e.message}`),null}return t||(this.logger.warning("The developer's authority was not found within the CloudInstanceDiscoveryMetadata returned from the network request."),this.logger.verbose("Creating custom Authority for custom domain scenario."),t=nC.createCloudDiscoveryMetadataFromHost(this.hostnameAndPort)),t}isInKnownAuthorities(){return this.authorityOptions.knownAuthorities.filter(e=>e&&e5.getDomainFromUrl(e).toLowerCase()===this.hostnameAndPort).length>0}static generateAuthority(e,t){let r;if(t&&t.azureCloudInstance!==eG){let e=t.tenant?t.tenant:ez.Constants.DEFAULT_COMMON_TENANT;r=`${t.azureCloudInstance}/${e}/`}return r||e}static createCloudDiscoveryMetadataFromHost(e){return{preferred_network:e,preferred_cache:e,aliases:[e]}}getPreferredCache(){if(this.managedIdentity)return ez.Constants.DEFAULT_AUTHORITY_HOST;if(this.discoveryComplete())return this.metadata.preferred_cache;throw(0,ex.createClientAuthError)(eF.endpointResolutionError)}isAlias(e){return this.metadata.aliases.indexOf(e)>-1}isAliasOfKnownMicrosoftAuthority(e){return e7.has(e)}static isPublicCloudAuthority(e){return ez.Constants.KNOWN_PUBLIC_CLOUDS.indexOf(e)>=0}static buildRegionalAuthorityString(e,t,r){let o=new e5(e);o.validateAsUri();let i=o.getUrlComponents(),n=`${t}.${i.HostNameAndPort}`;this.isPublicCloudAuthority(i.HostNameAndPort)&&(n=`${t}.${ez.Constants.REGIONAL_AUTH_PUBLIC_CLOUD_SUFFIX}`);let a=e5.constructAuthorityUriFromObject({...o.getUrlComponents(),HostNameAndPort:n}).urlString;return r?`${a}?${r}`:a}static replaceWithRegionalInformation(e,t){let r={...e};return r.authorization_endpoint=nC.buildRegionalAuthorityString(r.authorization_endpoint,t),r.token_endpoint=nC.buildRegionalAuthorityString(r.token_endpoint,t),r.end_session_endpoint&&(r.end_session_endpoint=nC.buildRegionalAuthorityString(r.end_session_endpoint,t)),r}static transformCIAMAuthority(e){let t=e,r=new e5(e).getUrlComponents();if(0===r.PathSegments.length&&r.HostNameAndPort.endsWith(ez.Constants.CIAM_AUTH_URL)){let e=r.HostNameAndPort.split(".")[0];t=`${t}${e}${ez.Constants.AAD_TENANT_DOMAIN_SUFFIX}`}return t}}function nT(e){return e.endsWith(ez.Constants.FORWARD_SLASH)?e:`${e}${ez.Constants.FORWARD_SLASH}`}nC.reservedTenantDomains=new Set(["{tenant}","{tenantid}",ez.AADAuthorityConstants.COMMON,ez.AADAuthorityConstants.CONSUMERS,ez.AADAuthorityConstants.ORGANIZATIONS]);var nA=e.i(27297),iK=eF,nI=e.i(84371),nI=nI;function nw(e,t,r){return{clientId:e,authority:t.authority,scopes:t.scopes,homeAccountIdentifier:r,claims:t.claims,authenticationScheme:t.authenticationScheme,resourceRequestMethod:t.resourceRequestMethod,resourceRequestUri:t.resourceRequestUri,shrClaims:t.shrClaims,sshKid:t.sshKid,embeddedClientId:t.embeddedClientId||t.tokenBodyParameters?.clientId}}var nv=e.i(82338),nv=nv,nE=e.i(72036),nE=nE,nk=e.i(18213),nk=nk,nI=nI,nS=e.i(97364),iK=eF;let n_="None";class nR{initialize(){return Promise.resolve()}getItem(e){let t=`${encodeURIComponent(e)}`,r=document.cookie.split(";");for(let e=0;e<r.length;e++){let[o,...i]=decodeURIComponent(r[e]).trim().split("="),n=i.join("=");if(o===t)return n}return""}getUserData(){throw(0,ex.createClientAuthError)(iK.methodNotImplemented)}setItem(e,t,r,o=!0,i="Lax"){let n=`${encodeURIComponent(e)}=${encodeURIComponent(t)};path=/;SameSite=${i};`;if(r){var a;let e=(a=r,new Date(new Date().getTime()+864e5*a).toUTCString());n+=`expires=${e};`}(o||i===n_)&&(n+="Secure;"),document.cookie=n}async setUserData(){return Promise.reject((0,ex.createClientAuthError)(iK.methodNotImplemented))}removeItem(e){this.setItem(e,"",-1)}getKeys(){let e=document.cookie.split(";"),t=[];return e.forEach(e=>{let r=decodeURIComponent(e).trim().split("=");t.push(r[0])}),t}containsKey(e){return this.getKeys().includes(e)}decryptData(){return Promise.resolve(null)}}function nb(e,t){let r=e.getItem(iU(t));return r?JSON.parse(r):[]}function nP(e,t,r){let o=t.getItem(iD(e,r));if(o){let e=JSON.parse(o);if(e&&e.hasOwnProperty("idToken")&&e.hasOwnProperty("accessToken")&&e.hasOwnProperty("refreshToken"))return e}return{idToken:[],accessToken:[],refreshToken:[]}}function nO(e){return e.hasOwnProperty("id")&&e.hasOwnProperty("nonce")&&e.hasOwnProperty("data")}let nN="msal.cache.encryption";class nM{constructor(e,t,r){if(!window.localStorage)throw(0,iC.createBrowserConfigurationAuthError)(iT.storageNotSupported);this.memoryStorage=new iY,this.initialized=!1,this.clientId=e,this.logger=t,this.performanceClient=r,this.broadcast=new BroadcastChannel("msal.broadcast.cache")}async initialize(e){let t=new nR,r=t.getItem(nN),o={key:"",id:""};if(r)try{o=JSON.parse(r)}catch(e){}if(o.key&&o.id){let t=i2(oZ,"base64Decode",this.logger,this.performanceClient,e)(o.key);this.encryptionCookie={id:o.id,key:await i6(iu,eo,this.logger,this.performanceClient,e)(t)}}else{let r=ir(),o=await i6(id,"generateBaseKey",this.logger,this.performanceClient,e)(),i=i2(oW,"urlEncodeArr",this.logger,this.performanceClient,e)(new Uint8Array(o));this.encryptionCookie={id:r,key:await i6(iu,eo,this.logger,this.performanceClient,e)(o)},t.setItem(nN,JSON.stringify({id:r,key:i}),0,!0,n_)}await i6(this.importExistingCache.bind(this),"importExistingCache",this.logger,this.performanceClient,e)(e),this.broadcast.addEventListener("message",this.updateCache.bind(this)),this.initialized=!0}getItem(e){return window.localStorage.getItem(e)}getUserData(e){if(!this.initialized)throw ru(rt);return this.memoryStorage.getItem(e)}async decryptData(e,t,r){if(!this.initialized||!this.encryptionCookie)throw ru(rt);if(t.id!==this.encryptionCookie.id)return this.performanceClient.incrementFields({encryptedCacheExpiredCount:1},r),null;let o=await i6(im,ei,this.logger,this.performanceClient,r)(this.encryptionCookie.key,t.nonce,this.getContext(e),t.data);if(!o)return null;try{return{...JSON.parse(o),lastUpdatedAt:t.lastUpdatedAt}}catch(e){return this.performanceClient.incrementFields({encryptedCacheCorruptionCount:1},r),null}}setItem(e,t){window.localStorage.setItem(e,t)}async setUserData(e,t,r,o,i){if(!this.initialized||!this.encryptionCookie)throw ru(rt);if(i)this.setItem(e,t);else{let{data:i,nonce:n}=await i6(ip,"encrypt",this.logger,this.performanceClient,r)(this.encryptionCookie.key,t,this.getContext(e)),a={id:this.encryptionCookie.id,nonce:n,data:i,lastUpdatedAt:o};this.setItem(e,JSON.stringify(a))}this.memoryStorage.setItem(e,t),this.broadcast.postMessage({key:e,value:t,context:this.getContext(e)})}removeItem(e){this.memoryStorage.containsKey(e)&&(this.memoryStorage.removeItem(e),this.broadcast.postMessage({key:e,value:null,context:this.getContext(e)})),window.localStorage.removeItem(e)}getKeys(){return Object.keys(window.localStorage)}containsKey(e){return window.localStorage.hasOwnProperty(e)}clear(){this.memoryStorage.clear(),nb(this).forEach(e=>this.removeItem(e));let e=nP(this.clientId,this);e.idToken.forEach(e=>this.removeItem(e)),e.accessToken.forEach(e=>this.removeItem(e)),e.refreshToken.forEach(e=>this.removeItem(e)),this.getKeys().forEach(e=>{(e.startsWith(ib)||-1!==e.indexOf(this.clientId))&&this.removeItem(e)})}async importExistingCache(e){if(!this.encryptionCookie)return;let t=nb(this);(t=await this.importArray(t,e)).length?this.setItem(iU(),JSON.stringify(t)):this.removeItem(iU());let r=nP(this.clientId,this);r.idToken=await this.importArray(r.idToken,e),r.accessToken=await this.importArray(r.accessToken,e),r.refreshToken=await this.importArray(r.refreshToken,e),r.idToken.length||r.accessToken.length||r.refreshToken.length?this.setItem(iD(this.clientId),JSON.stringify(r)):this.removeItem(iD(this.clientId))}async getItemFromEncryptedCache(e,t){let r;if(!this.encryptionCookie)return null;let o=this.getItem(e);if(!o)return null;try{r=JSON.parse(o)}catch(e){return null}return nO(r)?r.id!==this.encryptionCookie.id?(this.performanceClient.incrementFields({encryptedCacheExpiredCount:1},t),null):(this.performanceClient.incrementFields({encryptedCacheCount:1},t),i6(im,ei,this.logger,this.performanceClient,t)(this.encryptionCookie.key,r.nonce,this.getContext(e),r.data)):(this.performanceClient.incrementFields({unencryptedCacheCount:1},t),o)}async importArray(e,t){let r=[],o=[];return e.forEach(e=>{let i=this.getItemFromEncryptedCache(e,t).then(t=>{t?(this.memoryStorage.setItem(e,t),r.push(e)):this.removeItem(e)});o.push(i)}),await Promise.all(o),r}getContext(e){let t="";return e.includes(this.clientId)&&(t=this.clientId),t}updateCache(e){this.logger.trace("Updating internal cache from broadcast event");let t=this.performanceClient.startMeasurement("localStorageUpdated");t.add({isBackground:!0});let{key:r,value:o,context:i}=e.data;if(!r){this.logger.error("Broadcast event missing key"),t.end({success:!1,errorCode:"noKey"});return}if(i&&i!==this.clientId){this.logger.trace(`Ignoring broadcast event from clientId: ${i}`),t.end({success:!1,errorCode:"contextMismatch"});return}o?(this.memoryStorage.setItem(r,o),this.logger.verbose("Updated item in internal cache")):(this.memoryStorage.removeItem(r),this.logger.verbose("Removed item from internal cache")),t.end({success:!0})}}class nq{constructor(){if(!window.sessionStorage)throw(0,iC.createBrowserConfigurationAuthError)(iT.storageNotSupported)}async initialize(){}getItem(e){return window.sessionStorage.getItem(e)}getUserData(e){return this.getItem(e)}setItem(e,t){window.sessionStorage.setItem(e,t)}async setUserData(e,t){this.setItem(e,t)}removeItem(e){window.sessionStorage.removeItem(e)}getKeys(){return Object.keys(window.sessionStorage)}containsKey(e){return window.sessionStorage.hasOwnProperty(e)}decryptData(){return Promise.resolve(null)}}var nL=e.i(46893);function nU(e,t){let r=e.indexOf(t);r>-1&&e.splice(r,1)}class nD extends tl{constructor(e,t,r,o,i,n,a){super(e,r,o,i,a),this.cacheConfig=t,this.logger=o,this.internalStorage=new iY,this.browserStorage=nH(e,t.cacheLocation,o,i),this.temporaryCacheStorage=nH(e,t.temporaryCacheLocation,o,i),this.cookieStorage=new nR,this.eventHandler=n}async initialize(e){this.performanceClient.addFields({cacheLocation:this.cacheConfig.cacheLocation,cacheRetentionDays:this.cacheConfig.cacheRetentionDays},e),await this.browserStorage.initialize(e),await this.migrateExistingCache(e),this.trackVersionChanges(e)}async migrateExistingCache(e){let t=nb(this.browserStorage),r=nP(this.clientId,this.browserStorage);this.performanceClient.addFields({preMigrateAcntCount:t.length,preMigrateATCount:r.accessToken.length,preMigrateITCount:r.idToken.length,preMigrateRTCount:r.refreshToken.length},e);for(let t=0;t<2;t++){let r=t;await this.removeStaleAccounts(t,r,e)}for(let t=0;t<2;t++){let r=t;await this.migrateIdTokens(t,r,e)}let o=this.getKMSIValues();for(let t=0;t<2;t++)await this.migrateAccessTokens(t,o,e),await this.migrateRefreshTokens(t,o,e);t=nb(this.browserStorage),r=nP(this.clientId,this.browserStorage),this.performanceClient.addFields({postMigrateAcntCount:t.length,postMigrateATCount:r.accessToken.length,postMigrateITCount:r.idToken.length,postMigrateRTCount:r.refreshToken.length},e)}async updateOldEntry(e,t){let r=this.browserStorage.getItem(e),o=this.validateAndParseJson(r||"");if(!o)return this.browserStorage.removeItem(e),null;if(o.lastUpdatedAt){if(nE.isCacheExpired(o.lastUpdatedAt,this.cacheConfig.cacheRetentionDays))return this.browserStorage.removeItem(e),this.performanceClient.incrementFields({expiredCacheRemovedCount:1},t),null}else o.lastUpdatedAt=Date.now().toString(),this.setItem(e,JSON.stringify(o),t);let i=nO(o)?await this.browserStorage.decryptData(e,o,t):o;return i&&nk.isCredentialEntity(i)?(nk.isAccessTokenEntity(i)||nk.isRefreshTokenEntity(i))&&i.expiresOn&&nE.isTokenExpired(i.expiresOn,ez.DEFAULT_TOKEN_RENEWAL_OFFSET_SEC)?(this.browserStorage.removeItem(e),this.performanceClient.incrementFields({expiredCacheRemovedCount:1},t),null):i:(this.performanceClient.incrementFields({invalidCacheCount:1},t),null)}async removeStaleAccounts(e,t,r){let o=nb(this.browserStorage,e);if(0!==o.length){for(let e of[...o]){this.performanceClient.incrementFields({oldAcntCount:1},r);let i=this.browserStorage.getItem(e),n=this.validateAndParseJson(i||"");if(!n){nU(o,e);continue}if(n.lastUpdatedAt)nE.isCacheExpired(n.lastUpdatedAt,this.cacheConfig.cacheRetentionDays)&&(await this.removeAccountOldSchema(e,n,t,r),nU(o,e));else{n.lastUpdatedAt=Date.now().toString(),this.setItem(e,JSON.stringify(n),r);continue}}this.setAccountKeys(o,r,e)}}async removeAccountOldSchema(e,t,r,o){let i=nO(t)?await this.browserStorage.decryptData(e,t,o):t,n=i?.homeAccountId;if(n){let e=this.getTokenKeys(r);[...e.idToken].filter(e=>e.includes(n)).forEach(t=>{this.browserStorage.removeItem(t),nU(e.idToken,t)}),[...e.accessToken].filter(e=>e.includes(n)).forEach(t=>{this.browserStorage.removeItem(t),nU(e.accessToken,t)}),[...e.refreshToken].filter(e=>e.includes(n)).forEach(t=>{this.browserStorage.removeItem(t),nU(e.refreshToken,t)}),this.setTokenKeys(e,o,r)}this.performanceClient.incrementFields({expiredAcntRemovedCount:1},o),this.browserStorage.removeItem(e)}getKMSIValues(){let e={};for(let t of this.getTokenKeys().idToken){let r=this.browserStorage.getUserData(t);if(r){let t=JSON.parse(r),o=nI.extractTokenClaims(t.secret,oX);o&&(e[t.homeAccountId]=nI.isKmsi(o))}}return e}async migrateIdTokens(e,t,r){let o=nP(this.clientId,this.browserStorage,e);if(0===o.idToken.length)return;let i=nP(this.clientId,this.browserStorage,2),n=nb(this.browserStorage),a=nb(this.browserStorage,t);for(let e of[...o.idToken]){this.performanceClient.incrementFields({oldITCount:1},r);let t=await this.updateOldEntry(e,r);if(!t){nU(o.idToken,e);continue}let s=n.find(e=>e.includes(t.homeAccountId)),c=a.find(e=>e.includes(t.homeAccountId)),l=null;if(s)l=this.getAccount(s,r);else if(c){let e=this.browserStorage.getItem(c),t=this.validateAndParseJson(e||"");l=t&&nO(t)?await this.browserStorage.decryptData(c,t,r):t}if(!l){this.performanceClient.incrementFields({skipITMigrateCount:1},r);continue}let h=nI.extractTokenClaims(t.secret,oX),d=this.generateCredentialKey(t),u=this.getIdTokenCredential(d,r),g=Object.keys(h).includes("signin_state"),p=u&&Object.keys(nI.extractTokenClaims(u.secret,oX)||{}).includes("signin_state");if(!u||t.lastUpdatedAt>u.lastUpdatedAt&&(g||!p)){let e=l.tenantProfiles||[],o=(0,nS.getTenantIdFromIdTokenClaims)(h)||l.realm;if(o&&!e.find(e=>e.tenantId===o)){let t=(0,eJ.buildTenantProfile)(l.homeAccountId,l.localAccountId,o,h);e.push(t)}l.tenantProfiles=e;let a=this.generateAccountKey(eW.AccountEntity.getAccountInfo(l)),s=nI.isKmsi(h);await this.setUserData(a,JSON.stringify(l),r,l.lastUpdatedAt,s),n.includes(a)||n.push(a),await this.setUserData(d,JSON.stringify(t),r,t.lastUpdatedAt,s),this.performanceClient.incrementFields({migratedITCount:1},r),i.idToken.push(d)}}this.setTokenKeys(o,r,e),this.setTokenKeys(i,r),this.setAccountKeys(n,r)}async migrateAccessTokens(e,t,r){let o=nP(this.clientId,this.browserStorage,e);if(0===o.accessToken.length)return;let i=nP(this.clientId,this.browserStorage,2);for(let e of[...o.accessToken]){this.performanceClient.incrementFields({oldATCount:1},r);let n=await this.updateOldEntry(e,r);if(!n){nU(o.accessToken,e);continue}if(!Object.keys(t).includes(n.homeAccountId)){this.performanceClient.incrementFields({skipATMigrateCount:1},r);continue}let a=this.generateCredentialKey(n),s=t[n.homeAccountId];if(i.accessToken.includes(a)){let e=this.getAccessTokenCredential(a,r);(!e||n.lastUpdatedAt>e.lastUpdatedAt)&&(await this.setUserData(a,JSON.stringify(n),r,n.lastUpdatedAt,s),this.performanceClient.incrementFields({migratedATCount:1},r))}else await this.setUserData(a,JSON.stringify(n),r,n.lastUpdatedAt,s),this.performanceClient.incrementFields({migratedATCount:1},r),i.accessToken.push(a)}this.setTokenKeys(o,r,e),this.setTokenKeys(i,r)}async migrateRefreshTokens(e,t,r){let o=nP(this.clientId,this.browserStorage,e);if(0===o.refreshToken.length)return;let i=nP(this.clientId,this.browserStorage,2);for(let e of[...o.refreshToken]){this.performanceClient.incrementFields({oldRTCount:1},r);let n=await this.updateOldEntry(e,r);if(!n){nU(o.refreshToken,e);continue}if(!Object.keys(t).includes(n.homeAccountId)){this.performanceClient.incrementFields({skipRTMigrateCount:1},r);continue}let a=this.generateCredentialKey(n),s=t[n.homeAccountId];if(i.refreshToken.includes(a)){let e=this.getRefreshTokenCredential(a,r);(!e||n.lastUpdatedAt>e.lastUpdatedAt)&&(await this.setUserData(a,JSON.stringify(n),r,n.lastUpdatedAt,s),this.performanceClient.incrementFields({migratedRTCount:1},r))}else await this.setUserData(a,JSON.stringify(n),r,n.lastUpdatedAt,s),this.performanceClient.incrementFields({migratedRTCount:1},r),i.refreshToken.push(a)}this.setTokenKeys(o,r,e),this.setTokenKeys(i,r)}trackVersionChanges(e){let t=this.browserStorage.getItem(iM);t&&(this.logger.info(`MSAL.js was last initialized by version: ${t}`),this.performanceClient.addFields({previousLibraryVersion:t},e)),t!==iR&&this.setItem(iM,iR,e)}validateAndParseJson(e){if(!e)return null;try{let t=JSON.parse(e);return t&&"object"==typeof t?t:null}catch(e){return null}}setItem(e,t,r){let o=[,,,].fill(0),i=[];for(let n=0;n<=20;n++)try{if(this.browserStorage.setItem(e,t),n>0)for(let e=0;e<=2;e++){let t=o.slice(0,e).reduce((e,t)=>e+t,0);if(t>=n)break;let a=n>t+o[e]?t+o[e]:n;n>t&&o[e]>0&&this.removeAccessTokenKeys(i.slice(t,a),r,e)}break}catch(s){let a=tc(s);if(a.errorCode===tn.cacheQuotaExceeded&&n<20){if(!i.length)for(let r=0;r<=2;r++)if(e===iD(this.clientId,r)){let e=JSON.parse(t).accessToken;i.push(...e),o[r]=e.length}else{let e=this.getTokenKeys(r).accessToken;i.push(...e),o[r]=e.length}if(i.length<=n)throw a;this.removeAccessToken(i[n],r,!1)}else throw a}}async setUserData(e,t,r,o,i){let n=[,,,].fill(0),a=[];for(let s=0;s<=20;s++)try{if(await i6(this.browserStorage.setUserData.bind(this.browserStorage),"setUserData",this.logger,this.performanceClient)(e,t,r,o,i),s>0)for(let e=0;e<=2;e++){let t=n.slice(0,e).reduce((e,t)=>e+t,0);if(t>=s)break;let o=s>t+n[e]?t+n[e]:s;s>t&&n[e]>0&&this.removeAccessTokenKeys(a.slice(t,o),r,e)}break}catch(t){let e=tc(t);if(e.errorCode===tn.cacheQuotaExceeded&&s<20){if(!a.length)for(let e=0;e<=2;e++){let t=this.getTokenKeys(e).accessToken;a.push(...t),n[e]=t.length}if(a.length<=s)throw e;this.removeAccessToken(a[s],r,!1)}else throw e}}getAccount(e,t){this.logger.trace("BrowserCacheManager.getAccount called");let r=this.browserStorage.getUserData(e);if(!r)return this.removeAccountKeyFromMap(e,t),null;let o=this.validateAndParseJson(r);return o&&eW.AccountEntity.isAccountEntity(o)?tl.toObject(new eW.AccountEntity,o):null}async setAccount(e,t,r){this.logger.trace("BrowserCacheManager.setAccount called");let o=this.generateAccountKey(eW.AccountEntity.getAccountInfo(e)),i=Date.now().toString();e.lastUpdatedAt=i,await this.setUserData(o,JSON.stringify(e),t,i,r);let n=this.addAccountKeyToMap(o,t);this.performanceClient.addFields({kmsi:r},t),this.cacheConfig.cacheLocation===tA.BrowserCacheLocation.LocalStorage&&n&&this.eventHandler.emitEvent(nL.EventType.ACCOUNT_ADDED,void 0,eW.AccountEntity.getAccountInfo(e))}getAccountKeys(){return nb(this.browserStorage)}setAccountKeys(e,t,r=2){0===e.length?this.removeItem(iU(r)):this.setItem(iU(r),JSON.stringify(e),t)}addAccountKeyToMap(e,t){this.logger.trace("BrowserCacheManager.addAccountKeyToMap called"),this.logger.tracePii(`BrowserCacheManager.addAccountKeyToMap called with key: ${e}`);let r=this.getAccountKeys();return -1===r.indexOf(e)?(r.push(e),this.setItem(iU(),JSON.stringify(r),t),this.logger.verbose("BrowserCacheManager.addAccountKeyToMap account key added"),!0):(this.logger.verbose("BrowserCacheManager.addAccountKeyToMap account key already exists in map"),!1)}removeAccountKeyFromMap(e,t){this.logger.trace("BrowserCacheManager.removeAccountKeyFromMap called"),this.logger.tracePii(`BrowserCacheManager.removeAccountKeyFromMap called with key: ${e}`);let r=this.getAccountKeys(),o=r.indexOf(e);o>-1?(r.splice(o,1),this.setAccountKeys(r,t),this.logger.trace("BrowserCacheManager.removeAccountKeyFromMap account key removed")):this.logger.trace("BrowserCacheManager.removeAccountKeyFromMap key not found in existing map")}removeAccount(e,t){let r=this.getActiveAccount(t);r?.homeAccountId===e.homeAccountId&&r?.environment===e.environment&&this.setActiveAccount(null,t),super.removeAccount(e,t),this.removeAccountKeyFromMap(this.generateAccountKey(e),t),this.browserStorage.getKeys().forEach(t=>{t.includes(e.homeAccountId)&&t.includes(e.environment)&&this.browserStorage.removeItem(t)}),this.cacheConfig.cacheLocation===tA.BrowserCacheLocation.LocalStorage&&this.eventHandler.emitEvent(nL.EventType.ACCOUNT_REMOVED,void 0,e)}removeIdToken(e,t){super.removeIdToken(e,t);let r=this.getTokenKeys(),o=r.idToken.indexOf(e);o>-1&&(this.logger.info("idToken removed from tokenKeys map"),r.idToken.splice(o,1),this.setTokenKeys(r,t))}removeAccessToken(e,t,r=!0){super.removeAccessToken(e,t),r&&this.removeAccessTokenKeys([e],t)}removeAccessTokenKeys(e,t,r=2){this.logger.trace("removeAccessTokenKey called");let o=this.getTokenKeys(r),i=0;if(e.forEach(e=>{let t=o.accessToken.indexOf(e);t>-1&&(o.accessToken.splice(t,1),i++)}),i>0){this.logger.info(`removed ${i} accessToken keys from tokenKeys map`),this.setTokenKeys(o,t,r);return}}removeRefreshToken(e,t){super.removeRefreshToken(e,t);let r=this.getTokenKeys(),o=r.refreshToken.indexOf(e);o>-1&&(this.logger.info("refreshToken removed from tokenKeys map"),r.refreshToken.splice(o,1),this.setTokenKeys(r,t))}getTokenKeys(e=2){return nP(this.clientId,this.browserStorage,e)}setTokenKeys(e,t,r=2){0===e.idToken.length&&0===e.accessToken.length&&0===e.refreshToken.length?this.removeItem(iD(this.clientId,r)):this.setItem(iD(this.clientId,r),JSON.stringify(e),t)}getIdTokenCredential(e,t){let r=this.browserStorage.getUserData(e);if(!r)return this.logger.trace("BrowserCacheManager.getIdTokenCredential: called, no cache hit"),this.removeIdToken(e,t),null;let o=this.validateAndParseJson(r);return o&&nk.isIdTokenEntity(o)?(this.logger.trace("BrowserCacheManager.getIdTokenCredential: cache hit"),o):(this.logger.trace("BrowserCacheManager.getIdTokenCredential: called, no cache hit"),null)}async setIdTokenCredential(e,t,r){this.logger.trace("BrowserCacheManager.setIdTokenCredential called");let o=this.generateCredentialKey(e),i=Date.now().toString();e.lastUpdatedAt=i,await this.setUserData(o,JSON.stringify(e),t,i,r);let n=this.getTokenKeys();-1===n.idToken.indexOf(o)&&(this.logger.info("BrowserCacheManager: addTokenKey - idToken added to map"),n.idToken.push(o),this.setTokenKeys(n,t))}getAccessTokenCredential(e,t){let r=this.browserStorage.getUserData(e);if(!r)return this.logger.trace("BrowserCacheManager.getAccessTokenCredential: called, no cache hit"),this.removeAccessTokenKeys([e],t),null;let o=this.validateAndParseJson(r);return o&&nk.isAccessTokenEntity(o)?(this.logger.trace("BrowserCacheManager.getAccessTokenCredential: cache hit"),o):(this.logger.trace("BrowserCacheManager.getAccessTokenCredential: called, no cache hit"),null)}async setAccessTokenCredential(e,t,r){this.logger.trace("BrowserCacheManager.setAccessTokenCredential called");let o=this.generateCredentialKey(e),i=Date.now().toString();e.lastUpdatedAt=i,await this.setUserData(o,JSON.stringify(e),t,i,r);let n=this.getTokenKeys(),a=n.accessToken.indexOf(o);-1!==a&&n.accessToken.splice(a,1),this.logger.trace(`access token ${-1===a?"added to":"updated in"} map`),n.accessToken.push(o),this.setTokenKeys(n,t)}getRefreshTokenCredential(e,t){let r=this.browserStorage.getUserData(e);if(!r)return this.logger.trace("BrowserCacheManager.getRefreshTokenCredential: called, no cache hit"),this.removeRefreshToken(e,t),null;let o=this.validateAndParseJson(r);return o&&nk.isRefreshTokenEntity(o)?(this.logger.trace("BrowserCacheManager.getRefreshTokenCredential: cache hit"),o):(this.logger.trace("BrowserCacheManager.getRefreshTokenCredential: called, no cache hit"),null)}async setRefreshTokenCredential(e,t,r){this.logger.trace("BrowserCacheManager.setRefreshTokenCredential called");let o=this.generateCredentialKey(e),i=Date.now().toString();e.lastUpdatedAt=i,await this.setUserData(o,JSON.stringify(e),t,i,r);let n=this.getTokenKeys();-1===n.refreshToken.indexOf(o)&&(this.logger.info("BrowserCacheManager: addTokenKey - refreshToken added to map"),n.refreshToken.push(o),this.setTokenKeys(n,t))}getAppMetadata(e){let t=this.browserStorage.getItem(e);if(!t)return this.logger.trace("BrowserCacheManager.getAppMetadata: called, no cache hit"),null;let r=this.validateAndParseJson(t);return r&&nk.isAppMetadataEntity(e,r)?(this.logger.trace("BrowserCacheManager.getAppMetadata: cache hit"),r):(this.logger.trace("BrowserCacheManager.getAppMetadata: called, no cache hit"),null)}setAppMetadata(e,t){this.logger.trace("BrowserCacheManager.setAppMetadata called");let r=nk.generateAppMetadataKey(e);this.setItem(r,JSON.stringify(e),t)}getServerTelemetry(e){let t=this.browserStorage.getItem(e);if(!t)return this.logger.trace("BrowserCacheManager.getServerTelemetry: called, no cache hit"),null;let r=this.validateAndParseJson(t);return r&&nk.isServerTelemetryEntity(e,r)?(this.logger.trace("BrowserCacheManager.getServerTelemetry: cache hit"),r):(this.logger.trace("BrowserCacheManager.getServerTelemetry: called, no cache hit"),null)}setServerTelemetry(e,t,r){this.logger.trace("BrowserCacheManager.setServerTelemetry called"),this.setItem(e,JSON.stringify(t),r)}getAuthorityMetadata(e){let t=this.internalStorage.getItem(e);if(!t)return this.logger.trace("BrowserCacheManager.getAuthorityMetadata: called, no cache hit"),null;let r=this.validateAndParseJson(t);return r&&nk.isAuthorityMetadataEntity(e,r)?(this.logger.trace("BrowserCacheManager.getAuthorityMetadata: cache hit"),r):null}getAuthorityMetadataKeys(){return this.internalStorage.getKeys().filter(e=>this.isAuthorityMetadata(e))}setWrapperMetadata(e,t){this.internalStorage.setItem(tA.InMemoryCacheKeys.WRAPPER_SKU,e),this.internalStorage.setItem(tA.InMemoryCacheKeys.WRAPPER_VER,t)}getWrapperMetadata(){return[this.internalStorage.getItem(tA.InMemoryCacheKeys.WRAPPER_SKU)||ez.Constants.EMPTY_STRING,this.internalStorage.getItem(tA.InMemoryCacheKeys.WRAPPER_VER)||ez.Constants.EMPTY_STRING]}setAuthorityMetadata(e,t){this.logger.trace("BrowserCacheManager.setAuthorityMetadata called"),this.internalStorage.setItem(e,JSON.stringify(t))}getActiveAccount(e){let t=this.generateCacheKey(ez.PersistentCacheKeys.ACTIVE_ACCOUNT_FILTERS),r=this.browserStorage.getItem(t);if(!r)return this.logger.trace("BrowserCacheManager.getActiveAccount: No active account filters found"),null;let o=this.validateAndParseJson(r);return o?(this.logger.trace("BrowserCacheManager.getActiveAccount: Active account filters schema found"),this.getAccountInfoFilteredBy({homeAccountId:o.homeAccountId,localAccountId:o.localAccountId,tenantId:o.tenantId},e)):(this.logger.trace("BrowserCacheManager.getActiveAccount: No active account found"),null)}setActiveAccount(e,t){let r=this.generateCacheKey(ez.PersistentCacheKeys.ACTIVE_ACCOUNT_FILTERS);if(e){this.logger.verbose("setActiveAccount: Active account set");let o={homeAccountId:e.homeAccountId,localAccountId:e.localAccountId,tenantId:e.tenantId,lastUpdatedAt:nE.nowSeconds().toString()};this.setItem(r,JSON.stringify(o),t)}else this.logger.verbose("setActiveAccount: No account passed, active account not set"),this.browserStorage.removeItem(r);this.eventHandler.emitEvent(nL.EventType.ACTIVE_ACCOUNT_CHANGED)}getThrottlingCache(e){let t=this.browserStorage.getItem(e);if(!t)return this.logger.trace("BrowserCacheManager.getThrottlingCache: called, no cache hit"),null;let r=this.validateAndParseJson(t);return r&&nk.isThrottlingEntity(e,r)?(this.logger.trace("BrowserCacheManager.getThrottlingCache: cache hit"),r):(this.logger.trace("BrowserCacheManager.getThrottlingCache: called, no cache hit"),null)}setThrottlingCache(e,t,r){this.logger.trace("BrowserCacheManager.setThrottlingCache called"),this.setItem(e,JSON.stringify(t),r)}getTemporaryCache(e,t){let r=t?this.generateCacheKey(e):e;if(this.cacheConfig.storeAuthStateInCookie){let e=this.cookieStorage.getItem(r);if(e)return this.logger.trace("BrowserCacheManager.getTemporaryCache: storeAuthStateInCookies set to true, retrieving from cookies"),e}let o=this.temporaryCacheStorage.getItem(r);if(!o){if(this.cacheConfig.cacheLocation===tA.BrowserCacheLocation.LocalStorage){let e=this.browserStorage.getItem(r);if(e)return this.logger.trace("BrowserCacheManager.getTemporaryCache: Temporary cache item found in local storage"),e}return this.logger.trace("BrowserCacheManager.getTemporaryCache: No cache item found in local storage"),null}return this.logger.trace("BrowserCacheManager.getTemporaryCache: Temporary cache item returned"),o}setTemporaryCache(e,t,r){let o=r?this.generateCacheKey(e):e;this.temporaryCacheStorage.setItem(o,t),this.cacheConfig.storeAuthStateInCookie&&(this.logger.trace("BrowserCacheManager.setTemporaryCache: storeAuthStateInCookie set to true, setting item cookie"),this.cookieStorage.setItem(o,t,void 0,this.cacheConfig.secureCookies))}removeItem(e){this.browserStorage.removeItem(e)}removeTemporaryItem(e){this.temporaryCacheStorage.removeItem(e),this.cacheConfig.storeAuthStateInCookie&&(this.logger.trace("BrowserCacheManager.removeItem: storeAuthStateInCookie is true, clearing item cookie"),this.cookieStorage.removeItem(e))}getKeys(){return this.browserStorage.getKeys()}clear(e){this.removeAllAccounts(e),this.removeAppMetadata(e),this.temporaryCacheStorage.getKeys().forEach(e=>{(-1!==e.indexOf(ib)||-1!==e.indexOf(this.clientId))&&this.removeTemporaryItem(e)}),this.browserStorage.getKeys().forEach(e=>{(-1!==e.indexOf(ib)||-1!==e.indexOf(this.clientId))&&this.browserStorage.removeItem(e)}),this.internalStorage.clear()}clearTokensAndKeysWithClaims(e){this.performanceClient.addQueueMeasurement(Z,e);let t=this.getTokenKeys(),r=0;t.accessToken.forEach(t=>{let o=this.getAccessTokenCredential(t,e);o?.requestedClaimsHash&&t.includes(o.requestedClaimsHash.toLowerCase())&&(this.removeAccessToken(t,e),r++)}),r>0&&this.logger.warning(`${r} access tokens with claims in the cache keys have been removed from the cache.`)}generateCacheKey(e){return eV.startsWith(e,ib)?e:`${ib}.${this.clientId}.${e}`}generateCredentialKey(e){let t=e.credentialType===ez.CredentialType.REFRESH_TOKEN&&e.familyId||e.clientId,r=e.tokenType&&e.tokenType.toLowerCase()!==ez.AuthenticationScheme.BEARER.toLowerCase()?e.tokenType.toLowerCase():"";return[`${ib}.2`,e.homeAccountId,e.environment,e.credentialType,t,e.realm||"",e.target||"",e.requestedClaimsHash||"",r].join("|").toLowerCase()}generateAccountKey(e){let t=e.homeAccountId.split(".")[1];return[`${ib}.2`,e.homeAccountId,e.environment,t||e.tenantId||""].join("|").toLowerCase()}resetRequestCache(){this.logger.trace("BrowserCacheManager.resetRequestCache called"),this.removeTemporaryItem(this.generateCacheKey(tA.TemporaryCacheKeys.REQUEST_PARAMS)),this.removeTemporaryItem(this.generateCacheKey(tA.TemporaryCacheKeys.VERIFIER)),this.removeTemporaryItem(this.generateCacheKey(tA.TemporaryCacheKeys.ORIGIN_URI)),this.removeTemporaryItem(this.generateCacheKey(tA.TemporaryCacheKeys.URL_HASH)),this.removeTemporaryItem(this.generateCacheKey(tA.TemporaryCacheKeys.NATIVE_REQUEST)),this.setInteractionInProgress(!1)}cacheAuthorizeRequest(e,t){this.logger.trace("BrowserCacheManager.cacheAuthorizeRequest called");let r=oJ(JSON.stringify(e));if(this.setTemporaryCache(tA.TemporaryCacheKeys.REQUEST_PARAMS,r,!0),t){let e=oJ(t);this.setTemporaryCache(tA.TemporaryCacheKeys.VERIFIER,e,!0)}}getCachedRequest(){let e;this.logger.trace("BrowserCacheManager.getCachedRequest called");let t=this.getTemporaryCache(tA.TemporaryCacheKeys.REQUEST_PARAMS,!0);if(!t)throw ru(tQ);let r=this.getTemporaryCache(tA.TemporaryCacheKeys.VERIFIER,!0),o="";try{e=JSON.parse(oX(t)),r&&(o=oX(r))}catch(e){throw this.logger.errorPii(`Attempted to parse: ${t}`),this.logger.error(`Parsing cached token request threw with error: ${e}`),ru(tG)}return[e,o]}getCachedNativeRequest(){this.logger.trace("BrowserCacheManager.getCachedNativeRequest called");let e=this.getTemporaryCache(tA.TemporaryCacheKeys.NATIVE_REQUEST,!0);if(!e)return this.logger.trace("BrowserCacheManager.getCachedNativeRequest: No cached native request found"),null;let t=this.validateAndParseJson(e);return t||(this.logger.error("BrowserCacheManager.getCachedNativeRequest: Unable to parse native request"),null)}isInteractionInProgress(e){let t=this.getInteractionInProgress()?.clientId;return e?t===this.clientId:!!t}getInteractionInProgress(){let e=`${ib}.${tA.TemporaryCacheKeys.INTERACTION_STATUS_KEY}`,t=this.getTemporaryCache(e,!1);try{return t?JSON.parse(t):null}catch(t){return this.logger.error("Cannot parse interaction status. Removing temporary cache items and clearing url hash. Retrying interaction should fix the error"),this.removeTemporaryItem(e),this.resetRequestCache(),iA(window),null}}setInteractionInProgress(e,t=tA.INTERACTION_TYPE.SIGNIN){let r=`${ib}.${tA.TemporaryCacheKeys.INTERACTION_STATUS_KEY}`;if(e)if(this.getInteractionInProgress())throw ru(tN);else this.setTemporaryCache(r,JSON.stringify({clientId:this.clientId,type:t}),!1);else e||this.getInteractionInProgress()?.clientId!==this.clientId||this.removeTemporaryItem(r)}async hydrateCache(e,t){let r,o=nk.createIdTokenEntity(e.account?.homeAccountId,e.account?.environment,e.idToken,this.clientId,e.tenantId);t.claims&&(r=await this.cryptoImpl.hashString(t.claims));let i=nk.createAccessTokenEntity(e.account?.homeAccountId,e.account.environment,e.accessToken,this.clientId,e.tenantId,e.scopes.join(" "),e.expiresOn?nE.toSecondsFromDate(e.expiresOn):0,e.extExpiresOn?nE.toSecondsFromDate(e.extExpiresOn):0,oX,void 0,e.tokenType,void 0,t.sshKid,t.claims,r);return this.saveCacheRecord({idToken:o,accessToken:i},e.correlationId,nI.isKmsi(nI.extractTokenClaims(e.idToken,oX)))}async saveCacheRecord(e,t,r,o){try{await super.saveCacheRecord(e,t,r,o)}catch(e){if(e instanceof ts&&this.performanceClient&&t)try{let e=this.getTokenKeys();this.performanceClient.addFields({cacheRtCount:e.refreshToken.length,cacheIdCount:e.idToken.length,cacheAtCount:e.accessToken.length},t)}catch(e){}throw e}}}function nH(e,t,r,o){try{switch(t){case tA.BrowserCacheLocation.LocalStorage:return new nM(e,r,o);case tA.BrowserCacheLocation.SessionStorage:return new nq;case tA.BrowserCacheLocation.MemoryStorage:}}catch(e){r.error(e)}return new iY}class nx{constructor(e){this.eventCallbacks=new Map,this.logger=e||new t.Logger({}),"undefined"!=typeof BroadcastChannel&&(this.broadcastChannel=new BroadcastChannel("msal.broadcast.event")),this.invokeCrossTabCallbacks=this.invokeCrossTabCallbacks.bind(this)}addEventCallback(e,t,r){if("undefined"!=typeof window){let o=r||ir();return this.eventCallbacks.has(o)?(this.logger.error(`Event callback with id: ${o} is already registered. Please provide a unique id or remove the existing callback and try again.`),null):(this.eventCallbacks.set(o,[e,t||[]]),this.logger.verbose(`Event callback registered with id: ${o}`),o)}return null}removeEventCallback(e){this.eventCallbacks.delete(e),this.logger.verbose(`Event callback ${e} removed.`)}emitEvent(e,t,r,o){let i={eventType:e,interactionType:t||null,payload:r||null,error:o||null,timestamp:Date.now()};switch(e){case nL.EventType.ACCOUNT_ADDED:case nL.EventType.ACCOUNT_REMOVED:case nL.EventType.ACTIVE_ACCOUNT_CHANGED:this.broadcastChannel?.postMessage(i);break;default:this.invokeCallbacks(i)}}invokeCallbacks(e){this.eventCallbacks.forEach(([t,r],o)=>{(0===r.length||r.includes(e.eventType))&&(this.logger.verbose(`Emitting event to callback ${o}: ${e.eventType}`),t.apply(null,[e]))})}invokeCrossTabCallbacks(e){let t=e.data;this.invokeCallbacks(t)}subscribeCrossTab(){this.broadcastChannel?.addEventListener("message",this.invokeCrossTabCallbacks)}unsubscribeCrossTab(){this.broadcastChannel?.removeEventListener("message",this.invokeCrossTabCallbacks)}}let nF="home_account_id";var nB=e.i(60039);async function nK(e,t,r,o,i,n,a){a?.addQueueMeasurement(z,n);let s=nC.transformCIAMAuthority(nT(e)),c=new nC(s,t,r,o,i,n,a);try{return await i6(c.resolveEndpointsAsync.bind(c),$,i,a,n)(),c}catch(e){throw(0,ex.createClientAuthError)(eF.endpointResolutionError)}}e.s(["createDiscoveredInstance",()=>nK],20891);var nz=el;class n$ extends nz.AuthError{constructor(e,t,r,o,i){super(e,t,r),this.name="ServerError",this.errorNo=o,this.status=i,Object.setPrototypeOf(this,n$.prototype)}}class nQ{static generateThrottlingStorageKey(e){return`${ez.ThrottlingConstants.THROTTLING_PREFIX}.${JSON.stringify(e)}`}static preProcess(e,t,r){let o=nQ.generateThrottlingStorageKey(t),i=e.getThrottlingCache(o);if(i){if(i.throttleTime<Date.now())return void e.removeItem(o,r);throw new n$(i.errorCodes?.join(" ")||ez.Constants.EMPTY_STRING,i.errorMessage,i.subError)}}static postProcess(e,t,r,o){if(nQ.checkResponseStatus(r)||nQ.checkResponseForRetryAfter(r)){let i={throttleTime:nQ.calculateThrottleTime(parseInt(r.headers[ez.HeaderNames.RETRY_AFTER])),error:r.body.error,errorCodes:r.body.error_codes,errorMessage:r.body.error_description,subError:r.body.suberror};e.setThrottlingCache(nQ.generateThrottlingStorageKey(t),i,o)}}static checkResponseStatus(e){return 429===e.status||e.status>=500&&e.status<600}static checkResponseForRetryAfter(e){return!!e.headers&&e.headers.hasOwnProperty(ez.HeaderNames.RETRY_AFTER)&&(e.status<200||e.status>=300)}static calculateThrottleTime(e){let t=Date.now()/1e3;return Math.floor(1e3*Math.min(t+((e<=0?0:e)||ez.ThrottlingConstants.DEFAULT_THROTTLE_TIME_SECONDS),t+ez.ThrottlingConstants.DEFAULT_MAX_THROTTLE_TIME_SECONDS))}static removeThrottle(e,t,r,o){let i=nw(t,r,o),n=this.generateThrottlingStorageKey(i);e.removeItem(n,r.correlationId)}}class nG{constructor(e,r){this.config=function({authOptions:e,systemOptions:r,loggerOptions:o,cacheOptions:i,storageInterface:n,networkInterface:a,cryptoInterface:s,clientCredentials:c,libraryInfo:l,telemetry:h,serverTelemetryManager:d,persistencePlugin:u,serializableCache:g}){let p={...tu,...o};return{authOptions:{clientCapabilities:[],azureCloudOptions:ty,skipAuthorityMetadataCache:!1,instanceAware:!1,encodeExtraQueryParams:!1,...e},systemOptions:{...td,...r},loggerOptions:p,cacheOptions:{...tg,...i},storageInterface:n||new th(e.clientId,eK,new t.Logger(p),new es),networkInterface:a||tp,cryptoInterface:s||eK,clientCredentials:c||tf,libraryInfo:{...tm,...l},telemetry:{...tC,...h},serverTelemetryManager:d||null,persistencePlugin:u||null,serializableCache:g||null}}(e),this.logger=new t.Logger(this.config.loggerOptions,e$,eQ),this.cryptoUtils=this.config.cryptoInterface,this.cacheManager=this.config.storageInterface,this.networkClient=this.config.networkInterface,this.serverTelemetryManager=this.config.serverTelemetryManager,this.authority=this.config.authOptions.authority,this.performanceClient=r}createTokenRequestHeaders(e){let t={};if(t[ez.HeaderNames.CONTENT_TYPE]=ez.Constants.URL_FORM_CONTENT_TYPE,!this.config.systemOptions.preventCorsPreflight&&e)switch(e.type){case nF:try{let r=(0,nB.buildClientInfoFromHomeAccountId)(e.credential);t[ez.HeaderNames.CCS_HEADER]=`Oid:${r.uid}@${r.utid}`}catch(e){this.logger.verbose("Could not parse home account ID for CCS Header: "+e)}break;case"UPN":t[ez.HeaderNames.CCS_HEADER]=`UPN: ${e.credential}`}return t}async executePostToTokenEndpoint(e,t,r,o,i,n){n&&this.performanceClient?.addQueueMeasurement(n,i);let a=await this.sendPostRequest(o,e,{body:t,headers:r},i);return this.config.serverTelemetryManager&&a.status<500&&429!==a.status&&this.config.serverTelemetryManager.clearTelemetryCache(),a}async sendPostRequest(e,t,r,o){let i;nQ.preProcess(this.cacheManager,e,o);try{let e=(i=await i6(this.networkClient.sendPostRequestAsync.bind(this.networkClient),"networkClientSendPostRequestAsync",this.logger,this.performanceClient,o)(t,r)).headers||{};this.performanceClient?.addFields({refreshTokenSize:i.body.refresh_token?.length||0,httpVerToken:e[ez.HeaderNames.X_MS_HTTP_VERSION]||"",requestId:e[ez.HeaderNames.X_MS_REQUEST_ID]||""},o)}catch(e){if(e instanceof rm){let t=e.responseHeaders;throw t&&this.performanceClient?.addFields({httpVerToken:t[ez.HeaderNames.X_MS_HTTP_VERSION]||"",requestId:t[ez.HeaderNames.X_MS_REQUEST_ID]||"",contentTypeHeader:t[ez.HeaderNames.CONTENT_TYPE]||void 0,contentLengthHeader:t[ez.HeaderNames.CONTENT_LENGTH]||void 0,httpStatus:e.httpStatus},o),e.error}if(e instanceof el.AuthError)throw e;throw(0,ex.createClientAuthError)(eF.networkError)}return nQ.postProcess(this.cacheManager,e,i,o),i}async updateAuthority(e,t){this.performanceClient?.addQueueMeasurement(U,t);let r=`https://${e}/${this.authority.tenant}/`,o=await nK(r,this.networkClient,this.cacheManager,this.authority.options,this.logger,t,this.performanceClient);this.authority=o}createTokenQueryParameters(e){let t=new Map;return e.embeddedClientId&&o$(t,this.config.authOptions.clientId,this.config.authOptions.redirectUri),e.tokenQueryParameters&&oL(t,e.tokenQueryParameters),of(t,e.correlationId),ot(t,e.correlationId,this.performanceClient),e4(t)}}class nV{static setRequestState(e,t,r){let o=nV.generateLibraryState(e,r);return t?`${o}${ez.Constants.RESOURCE_DELIM}${t}`:o}static generateLibraryState(e,t){if(!e)throw(0,ex.createClientAuthError)(eF.noCryptoObject);let r={id:e.createNewGuid()};t&&(r.meta=t);let o=JSON.stringify(r);return e.base64Encode(o)}static parseRequestState(e,t){if(!e)throw(0,ex.createClientAuthError)(eF.noCryptoObject);if(!t)throw(0,ex.createClientAuthError)(eF.invalidState);try{let r=t.split(ez.Constants.RESOURCE_DELIM),o=r[0],i=r.length>1?r.slice(1).join(ez.Constants.RESOURCE_DELIM):ez.Constants.EMPTY_STRING,n=e.base64Decode(o),a=JSON.parse(n);return{userRequestState:i||ez.Constants.EMPTY_STRING,libraryState:a}}catch(e){throw(0,ex.createClientAuthError)(eF.invalidState)}}}class nj{constructor(e,t){this.cryptoUtils=e,this.performanceClient=t}async generateCnf(e,t){this.performanceClient?.addQueueMeasurement(F,e.correlationId);let r=await i6(this.generateKid.bind(this),F,t,this.performanceClient,e.correlationId)(e),o=this.cryptoUtils.base64UrlEncode(JSON.stringify(r));return{kid:r.kid,reqCnfString:o}}async generateKid(e){return this.performanceClient?.addQueueMeasurement("popTokenGenerateKid",e.correlationId),{kid:await this.cryptoUtils.getPublicKeyThumbprint(e),xms_ksl:"sw"}}async signPopToken(e,t,r){return this.signPayload(e,t,r)}async signPayload(e,t,r,o){let{resourceRequestMethod:i,resourceRequestUri:n,shrClaims:a,shrNonce:s,shrOptions:c}=r,l=n?new e5(n):void 0,h=l?.getUrlComponents();return this.cryptoUtils.signJwt({at:e,ts:i3(),m:i?.toUpperCase(),u:h?.HostNameAndPort,nonce:s||this.cryptoUtils.createNewGuid(),p:h?.AbsolutePath,q:h?.QueryString?[[],h.QueryString]:void 0,client_claims:a||void 0,...o},t,c,r.correlationId)}}class nW{constructor(e,t){this.cache=e,this.hasChanged=t}get cacheHasChanged(){return this.hasChanged}get tokenCache(){return this.cache}}class nJ{constructor(e,t,r,o,i,n,a){this.clientId=e,this.cacheStorage=t,this.cryptoObj=r,this.logger=o,this.serializableCache=i,this.persistencePlugin=n,this.performanceClient=a}validateTokenResponse(e,t){if(e.error||e.error_description||e.suberror){let r=`Error(s): ${e.error_codes||ez.Constants.NOT_AVAILABLE} - Timestamp: ${e.timestamp||ez.Constants.NOT_AVAILABLE} - Description: ${e.error_description||ez.Constants.NOT_AVAILABLE} - Correlation ID: ${e.correlation_id||ez.Constants.NOT_AVAILABLE} - Trace ID: ${e.trace_id||ez.Constants.NOT_AVAILABLE}`,o=e.error_codes?.length?e.error_codes[0]:void 0,i=new n$(e.error,r,e.suberror,o,e.status);if(t&&e.status&&e.status>=ez.HttpStatus.SERVER_ERROR_RANGE_START&&e.status<=ez.HttpStatus.SERVER_ERROR_RANGE_END)return void this.logger.warning(`executeTokenRequest:validateTokenResponse - AAD is currently unavailable and the access token is unable to be refreshed.
${i}`);if(t&&e.status&&e.status>=ez.HttpStatus.CLIENT_ERROR_RANGE_START&&e.status<=ez.HttpStatus.CLIENT_ERROR_RANGE_END)return void this.logger.warning(`executeTokenRequest:validateTokenResponse - AAD is currently available but is unable to refresh the access token.
${i}`);if((0,nA.isInteractionRequiredError)(e.error,e.error_description,e.suberror))throw new nA.InteractionRequiredAuthError(e.error,e.error_description,e.suberror,e.timestamp||ez.Constants.EMPTY_STRING,e.trace_id||ez.Constants.EMPTY_STRING,e.correlation_id||ez.Constants.EMPTY_STRING,e.claims||ez.Constants.EMPTY_STRING,o);throw i}}async handleServerTokenResponse(e,t,r,o,i,n,a,s,c){let l,h,d;if(this.performanceClient?.addQueueMeasurement(B,e.correlation_id),e.id_token){if(l=eY(e.id_token||ez.Constants.EMPTY_STRING,this.cryptoObj.base64Decode),i&&i.nonce&&l.nonce!==i.nonce)throw(0,ex.createClientAuthError)(eF.nonceMismatch);if(o.maxAge||0===o.maxAge){let e=l.auth_time;if(!e)throw(0,ex.createClientAuthError)(eF.authTimeNotFound);e0(e,o.maxAge)}}this.homeAccountIdentifier=eW.AccountEntity.generateHomeAccountId(e.client_info||ez.Constants.EMPTY_STRING,t.authorityType,this.logger,this.cryptoObj,l),i&&i.state&&(h=nV.parseRequestState(this.cryptoObj,i.state)),e.key_id=e.key_id||o.sshKid||void 0;let u=this.generateCacheRecord(e,t,r,o,l,n,i);try{if(this.persistencePlugin&&this.serializableCache&&(this.logger.verbose("Persistence enabled, calling beforeCacheAccess"),d=new nW(this.serializableCache,!0),await this.persistencePlugin.beforeCacheAccess(d)),a&&!s&&u.account){let e=this.cacheStorage.generateAccountKey(eW.AccountEntity.getAccountInfo(u.account));if(!this.cacheStorage.getAccount(e,o.correlationId))return this.logger.warning("Account used to refresh tokens not in persistence, refreshed tokens will not be stored in the cache"),await nJ.generateAuthenticationResult(this.cryptoObj,t,u,!1,o,l,h,void 0,c)}await this.cacheStorage.saveCacheRecord(u,o.correlationId,eX(l||{}),o.storeInCache)}finally{this.persistencePlugin&&this.serializableCache&&d&&(this.logger.verbose("Persistence enabled, calling afterCacheAccess"),await this.persistencePlugin.afterCacheAccess(d))}return nJ.generateAuthenticationResult(this.cryptoObj,t,u,!1,o,l,h,e,c)}generateCacheRecord(e,t,r,o,i,n,a){let s,c,l=t.getPreferredCache();if(!l)throw(0,ex.createClientAuthError)(eF.invalidCacheEnvironment);let h=(0,nS.getTenantIdFromIdTokenClaims)(i);e.id_token&&i&&(s=nr(this.homeAccountIdentifier,l,e.id_token,this.clientId,h||""),c=nY(this.cacheStorage,t,this.homeAccountIdentifier,this.cryptoObj.base64Decode,o.correlationId,i,e.client_info,l,h,a,void 0,this.logger));let d=null;if(e.access_token){let i=e.scope?ej.fromString(e.scope):new ej(o.scopes||[]),a=("string"==typeof e.expires_in?parseInt(e.expires_in,10):e.expires_in)||0,s=("string"==typeof e.ext_expires_in?parseInt(e.ext_expires_in,10):e.ext_expires_in)||0,c=("string"==typeof e.refresh_in?parseInt(e.refresh_in,10):e.refresh_in)||void 0,u=r+a;d=no(this.homeAccountIdentifier,l,e.access_token,this.clientId,h||t.tenant||"",i.printScopes(),u,u+s,this.cryptoObj.base64Decode,c&&c>0?r+c:void 0,e.token_type,n,e.key_id,o.claims,o.requestedClaimsHash)}let u=null;if(e.refresh_token){let t;e.refresh_token_expires_in&&(t=r+("string"==typeof e.refresh_token_expires_in?parseInt(e.refresh_token_expires_in,10):e.refresh_token_expires_in)),u=ni(this.homeAccountIdentifier,l,e.refresh_token,this.clientId,e.foci,n,t)}let g=null;return e.foci&&(g={clientId:this.clientId,environment:l,familyId:e.foci}),{account:c,idToken:s,accessToken:d,refreshToken:u,appMetadata:g}}static async generateAuthenticationResult(e,t,r,o,i,n,a,s,c){let l,h,d=ez.Constants.EMPTY_STRING,u=[],g=null,p=ez.Constants.EMPTY_STRING;if(r.accessToken){if(r.accessToken.tokenType!==ez.AuthenticationScheme.POP||i.popKid)d=r.accessToken.secret;else{let t=new nj(e),{secret:o,keyId:n}=r.accessToken;if(!n)throw(0,ex.createClientAuthError)(eF.keyIdMissing);d=await t.signPopToken(o,n,i)}u=ej.fromString(r.accessToken.target).asArray(),g=i8(r.accessToken.expiresOn),l=i8(r.accessToken.extendedExpiresOn),r.accessToken.refreshOn&&(h=i8(r.accessToken.refreshOn))}r.appMetadata&&(p=r.appMetadata.familyId===ez.THE_FAMILY_ID?ez.THE_FAMILY_ID:"");let m=n?.oid||n?.sub||"",f=n?.tid||"";s?.spa_accountid&&r.account&&(r.account.nativeAccountId=s?.spa_accountid);let y=r.account?(0,eJ.updateAccountTenantProfileData)(eW.AccountEntity.getAccountInfo(r.account),void 0,n,r.idToken?.secret):null;return{authority:t.canonicalAuthority,uniqueId:m,tenantId:f,scopes:u,account:y,idToken:r?.idToken?.secret||"",idTokenClaims:n||{},accessToken:d,fromCache:o,expiresOn:g,extExpiresOn:l,refreshOn:h,correlationId:i.correlationId,requestId:c||ez.Constants.EMPTY_STRING,familyId:p,tokenType:r.accessToken?.tokenType||ez.Constants.EMPTY_STRING,state:a?a.userRequestState:ez.Constants.EMPTY_STRING,cloudGraphHostName:r.account?.cloudGraphHostName||ez.Constants.EMPTY_STRING,msGraphHost:r.account?.msGraphHost||ez.Constants.EMPTY_STRING,code:s?.spa_code,fromNativeBroker:!1}}}function nY(e,t,r,o,i,n,a,s,c,l,h,d){d?.verbose("setCachedAccount called");let u=e.getAccountKeys().find(e=>e.startsWith(r)),g=null;u&&(g=e.getAccount(u,i));let p=g||eW.AccountEntity.createAccount({homeAccountId:r,idTokenClaims:n,clientInfo:a,environment:s,cloudGraphHostName:l?.cloud_graph_host_name,msGraphHost:l?.msgraph_host,nativeAccountId:h},t,o),m=p.tenantProfiles||[],f=c||p.realm;if(f&&!m.find(e=>e.tenantId===f)){let e=(0,eJ.buildTenantProfile)(r,p.localAccountId,f,n);m.push(e)}return p.tenantProfiles=m,p}async function nX(e,t,r){return"string"==typeof e?e:e({clientId:t,tokenEndpoint:r})}class nZ extends nG{constructor(e,t){super(e,t),this.includeRedirectUri=!0,this.oidcDefaultScopes=this.config.authOptions.authority.options.OIDCOptions?.defaultScopes}async acquireToken(e,t){if(this.performanceClient?.addQueueMeasurement(D,e.correlationId),!e.code)throw(0,ex.createClientAuthError)(eF.requestCannotBeMade);let r=i3(),o=await i6(this.executeTokenRequest.bind(this),H,this.logger,this.performanceClient,e.correlationId)(this.authority,e),i=o.headers?.[ez.HeaderNames.X_MS_REQUEST_ID],n=new nJ(this.config.authOptions.clientId,this.cacheManager,this.cryptoUtils,this.logger,this.config.serializableCache,this.config.persistencePlugin,this.performanceClient);return n.validateTokenResponse(o.body),i6(n.handleServerTokenResponse.bind(n),B,this.logger,this.performanceClient,e.correlationId)(o.body,this.authority,r,e,t,void 0,void 0,void 0,i)}getLogoutUri(e){if(!e)throw eD(eC);let t=this.createLogoutUrlQueryString(e);return e5.appendQueryString(this.authority.endSessionEndpoint,t)}async executeTokenRequest(e,t){let r;this.performanceClient?.addQueueMeasurement(H,t.correlationId);let o=this.createTokenQueryParameters(t),i=e5.appendQueryString(e.tokenEndpoint,o),n=await i6(this.createTokenRequestBody.bind(this),x,this.logger,this.performanceClient,t.correlationId)(t);if(t.clientInfo)try{let e=(0,nB.buildClientInfo)(t.clientInfo,this.cryptoUtils.base64Decode);r={credential:`${e.uid}${ez.Separators.CLIENT_INFO_SEPARATOR}${e.utid}`,type:nF}}catch(e){this.logger.verbose("Could not parse client info for CCS Header: "+e)}let a=this.createTokenRequestHeaders(r||t.ccsCredential),s=nw(this.config.authOptions.clientId,t);return i6(this.executePostToTokenEndpoint.bind(this),d,this.logger,this.performanceClient,t.correlationId)(i,n,a,s,t.correlationId,d)}async createTokenRequestBody(e){let t;this.performanceClient?.addQueueMeasurement(x,e.correlationId);let r=new Map;if(oa(r,e.embeddedClientId||e.tokenBodyParameters?.[rA]||this.config.authOptions.clientId),this.includeRedirectUri)os(r,e.redirectUri);else if(!e.redirectUri)throw eD(eh);if(on(r,e.scopes,!0,this.oidcDefaultScopes),ov(r,e.code),oy(r,this.config.libraryInfo),oC(r,this.config.telemetry.application),oK(r),this.serverTelemetryManager&&!tT(this.config)&&oB(r,this.serverTelemetryManager),e.codeVerifier&&oS(r,e.codeVerifier),this.config.clientCredentials.clientSecret&&o_(r,this.config.clientCredentials.clientSecret),this.config.clientCredentials.clientAssertion){let t=this.config.clientCredentials.clientAssertion;oR(r,await nX(t.assertion,this.config.authOptions.clientId,e.resourceRequestUri)),ob(r,t.assertionType)}if(oN(r,ez.GrantType.AUTHORIZATION_CODE_GRANT),oM(r),e.authenticationScheme===ez.AuthenticationScheme.POP){let t=new nj(this.cryptoUtils,this.performanceClient);ox(r,e.popKid?this.cryptoUtils.encodeKid(e.popKid):(await i6(t.generateCnf.bind(t),F,this.logger,this.performanceClient,e.correlationId)(e,this.logger)).reqCnfString)}else if(e.authenticationScheme===ez.AuthenticationScheme.SSH)if(e.sshJwk)oF(r,e.sshJwk);else throw eD(eE);if((!eV.isEmptyObj(e.claims)||this.config.authOptions.clientCapabilities&&this.config.authOptions.clientCapabilities.length>0)&&om(r,e.claims,this.config.authOptions.clientCapabilities),e.clientInfo)try{let r=(0,nB.buildClientInfo)(e.clientInfo,this.cryptoUtils.base64Decode);t={credential:`${r.uid}${ez.Separators.CLIENT_INFO_SEPARATOR}${r.utid}`,type:nF}}catch(e){this.logger.verbose("Could not parse client info for CCS Header: "+e)}else t=e.ccsCredential;if(this.config.systemOptions.preventCorsPreflight&&t)switch(t.type){case nF:try{let e=(0,nB.buildClientInfoFromHomeAccountId)(t.credential);og(r,e)}catch(e){this.logger.verbose("Could not parse home account ID for CCS Header: "+e)}break;case"UPN":ou(r,t.credential)}return e.embeddedClientId&&o$(r,this.config.authOptions.clientId,this.config.authOptions.redirectUri),e.tokenBodyParameters&&oL(r,e.tokenBodyParameters),!e.enableSpaAuthorizationCode||e.tokenBodyParameters&&e.tokenBodyParameters[r1]||oL(r,{[r1]:"1"}),ot(r,e.correlationId,this.performanceClient),e4(r)}createLogoutUrlQueryString(e){let t=new Map;return e.postLogoutRedirectUri&&oc(t,e.postLogoutRedirectUri),e.correlationId&&of(t,e.correlationId),e.idTokenHint&&ol(t,e.idTokenHint),e.state&&oA(t,e.state),e.logoutHint&&oz(t,e.logoutHint),e.extraQueryParameters&&oL(t,e.extraQueryParameters),this.config.authOptions.instanceAware&&oq(t),e4(t,this.config.authOptions.encodeExtraQueryParams,e.extraQueryParameters)}}class n0{constructor(e,t){this.cacheOutcome=ez.CacheOutcome.NOT_APPLICABLE,this.cacheManager=t,this.apiId=e.apiId,this.correlationId=e.correlationId,this.wrapperSKU=e.wrapperSKU||ez.Constants.EMPTY_STRING,this.wrapperVer=e.wrapperVer||ez.Constants.EMPTY_STRING,this.telemetryCacheKey=ez.SERVER_TELEM_CONSTANTS.CACHE_KEY+ez.Separators.CACHE_KEY_SEPARATOR+e.clientId}generateCurrentRequestHeaderValue(){let e=`${this.apiId}${ez.SERVER_TELEM_CONSTANTS.VALUE_SEPARATOR}${this.cacheOutcome}`,t=[this.wrapperSKU,this.wrapperVer],r=this.getNativeBrokerErrorCode();r?.length&&t.push(`broker_error=${r}`);let o=t.join(ez.SERVER_TELEM_CONSTANTS.VALUE_SEPARATOR),i=[e,this.getRegionDiscoveryFields()].join(ez.SERVER_TELEM_CONSTANTS.VALUE_SEPARATOR);return[ez.SERVER_TELEM_CONSTANTS.SCHEMA_VERSION,i,o].join(ez.SERVER_TELEM_CONSTANTS.CATEGORY_SEPARATOR)}generateLastRequestHeaderValue(){let e=this.getLastRequests(),t=n0.maxErrorsToSend(e),r=e.failedRequests.slice(0,2*t).join(ez.SERVER_TELEM_CONSTANTS.VALUE_SEPARATOR),o=e.errors.slice(0,t).join(ez.SERVER_TELEM_CONSTANTS.VALUE_SEPARATOR),i=e.errors.length,n=t<i?ez.SERVER_TELEM_CONSTANTS.OVERFLOW_TRUE:ez.SERVER_TELEM_CONSTANTS.OVERFLOW_FALSE,a=[i,n].join(ez.SERVER_TELEM_CONSTANTS.VALUE_SEPARATOR);return[ez.SERVER_TELEM_CONSTANTS.SCHEMA_VERSION,e.cacheHits,r,o,a].join(ez.SERVER_TELEM_CONSTANTS.CATEGORY_SEPARATOR)}cacheFailedRequest(e){let t=this.getLastRequests();t.errors.length>=ez.SERVER_TELEM_CONSTANTS.MAX_CACHED_ERRORS&&(t.failedRequests.shift(),t.failedRequests.shift(),t.errors.shift()),t.failedRequests.push(this.apiId,this.correlationId),e instanceof Error&&e&&e.toString()?e instanceof el.AuthError?e.subError?t.errors.push(e.subError):e.errorCode?t.errors.push(e.errorCode):t.errors.push(e.toString()):t.errors.push(e.toString()):t.errors.push(ez.SERVER_TELEM_CONSTANTS.UNKNOWN_ERROR),this.cacheManager.setServerTelemetry(this.telemetryCacheKey,t,this.correlationId)}incrementCacheHits(){let e=this.getLastRequests();return e.cacheHits+=1,this.cacheManager.setServerTelemetry(this.telemetryCacheKey,e,this.correlationId),e.cacheHits}getLastRequests(){return this.cacheManager.getServerTelemetry(this.telemetryCacheKey)||{failedRequests:[],errors:[],cacheHits:0}}clearTelemetryCache(){let e=this.getLastRequests(),t=n0.maxErrorsToSend(e);if(t===e.errors.length)this.cacheManager.removeItem(this.telemetryCacheKey,this.correlationId);else{let r={failedRequests:e.failedRequests.slice(2*t),errors:e.errors.slice(t),cacheHits:0};this.cacheManager.setServerTelemetry(this.telemetryCacheKey,r,this.correlationId)}}static maxErrorsToSend(e){let t,r=0,o=0,i=e.errors.length;for(t=0;t<i;t++){let i=e.failedRequests[2*t]||ez.Constants.EMPTY_STRING,n=e.failedRequests[2*t+1]||ez.Constants.EMPTY_STRING,a=e.errors[t]||ez.Constants.EMPTY_STRING;if((o+=i.toString().length+n.toString().length+a.length+3)<ez.SERVER_TELEM_CONSTANTS.MAX_LAST_HEADER_BYTES)r+=1;else break}return r}getRegionDiscoveryFields(){let e=[];return e.push(this.regionUsed||ez.Constants.EMPTY_STRING),e.push(this.regionSource||ez.Constants.EMPTY_STRING),e.push(this.regionOutcome||ez.Constants.EMPTY_STRING),e.join(",")}updateRegionDiscoveryMetadata(e){this.regionUsed=e.region_used,this.regionSource=e.region_source,this.regionOutcome=e.region_outcome}setCacheOutcome(e){this.cacheOutcome=e}setNativeBrokerErrorCode(e){let t=this.getLastRequests();t.nativeBrokerErrorCode=e,this.cacheManager.setServerTelemetry(this.telemetryCacheKey,t,this.correlationId)}getNativeBrokerErrorCode(){return this.getLastRequests().nativeBrokerErrorCode}clearNativeBrokerErrorCode(){let e=this.getLastRequests();delete e.nativeBrokerErrorCode,this.cacheManager.setServerTelemetry(this.telemetryCacheKey,e,this.correlationId)}static makeExtraSkuString(e){return function(e){let{skus:t,libraryName:r,libraryVersion:o,extensionName:i,extensionVersion:n}=e,a=new Map([[0,[r,o]],[2,[i,n]]]),s=[];if(t?.length){if((s=t.split(",")).length<4)return t}else s=Array.from({length:4},()=>"|");return a.forEach((e,t)=>{2===e.length&&e[0]?.length&&e[1]?.length&&function(e){let{skuArr:t,index:r,skuName:o,skuVersion:i}=e;r>=t.length||(t[r]=[o,i].join("|"))}({skuArr:s,index:t,skuName:e[0],skuVersion:e[1]})}),s.join(",")}(e)}}var n1=e.i(20891),n1=n1,eH=eq;class n2{constructor(e,t,r,o,i,n,a,s,c){this.config=e,this.browserStorage=t,this.browserCrypto=r,this.networkClient=this.config.system.networkClient,this.eventHandler=i,this.navigationClient=n,this.platformAuthProvider=s,this.correlationId=c||ir(),this.logger=o.clone(tA.BrowserConstants.MSAL_SKU,iR,this.correlationId),this.performanceClient=a}async clearCacheOnLogout(e,t){if(t)try{this.browserStorage.removeAccount(t,e),this.logger.verbose("Cleared cache items belonging to the account provided in the logout request.")}catch(e){this.logger.error("Account provided in logout request was not found. Local cache unchanged.")}else try{this.logger.verbose("No account provided in logout request, clearing all cache items.",this.correlationId),this.browserStorage.clear(e),await this.browserCrypto.clearKeystore()}catch(e){this.logger.error("Attempted to clear all MSAL cache items and failed. Local cache unchanged.")}}getRedirectUri(e){this.logger.verbose("getRedirectUri called");let t=e||this.config.auth.redirectUri;return e5.getAbsoluteUrl(t,iw())}initializeServerTelemetryManager(e,t){return this.logger.verbose("initializeServerTelemetryManager called"),new n0({clientId:this.config.auth.clientId,correlationId:this.correlationId,apiId:e,forceRefresh:t||!1,wrapperSKU:this.browserStorage.getWrapperMetadata()[0],wrapperVer:this.browserStorage.getWrapperMetadata()[1]},this.browserStorage)}async getDiscoveredAuthority(e){let{account:t}=e,r=e.requestExtraQueryParameters&&e.requestExtraQueryParameters.hasOwnProperty("instance_aware")?e.requestExtraQueryParameters.instance_aware:void 0;this.performanceClient.addQueueMeasurement(c,this.correlationId);let o={protocolMode:this.config.auth.protocolMode,OIDCOptions:this.config.auth.OIDCOptions,knownAuthorities:this.config.auth.knownAuthorities,cloudDiscoveryMetadata:this.config.auth.cloudDiscoveryMetadata,authorityMetadata:this.config.auth.authorityMetadata,skipAuthorityMetadataCache:this.config.auth.skipAuthorityMetadataCache},i=e.requestAuthority||this.config.auth.authority,n=r?.length?"true"===r:this.config.auth.instanceAware,a=t&&n?this.config.auth.authority.replace(e5.getDomainFromUrl(i),t.environment):i,s=nC.generateAuthority(a,e.requestAzureCloudOptions||this.config.auth.azureCloudOptions),l=await i6(n1.createDiscoveredInstance,z,this.logger,this.performanceClient,this.correlationId)(s,this.config.system.networkClient,this.browserStorage,o,this.logger,this.correlationId,this.performanceClient);if(t&&!l.isAlias(t.environment))throw eD(eH.authorityMismatch);return l}}var eH=eq;async function n6(e,t,r,o){r.addQueueMeasurement(I,e.correlationId);let i=e.authority||t.auth.authority,n=[...e&&e.scopes||[]],a={...e,correlationId:e.correlationId,authority:i,scopes:n};if(a.authenticationScheme){if(a.authenticationScheme===ez.AuthenticationScheme.SSH){if(!e.sshJwk)throw eD(eH.missingSshJwk);if(!e.sshKid)throw eD(eH.missingSshKid)}o.verbose(`Authentication Scheme set to "${a.authenticationScheme}" as configured in Auth request`)}else a.authenticationScheme=ez.AuthenticationScheme.BEARER,o.verbose('Authentication Scheme wasn\'t explicitly set in request, defaulting to "Bearer" request');return t.cache.claimsBasedCachingEnabled&&e.claims&&!eV.isEmptyObj(e.claims)&&(a.requestedClaimsHash=await iy(e.claims)),a}async function n4(e,t,r,o,i){o.addQueueMeasurement(w,e.correlationId);let n=await i6(n6,I,i,o,e.correlationId)(e,r,o,i);return{...e,...n,account:t,forceRefresh:e.forceRefresh||!1}}function n3(e,t){let r,o=e.httpMethod;if(t===ec.ProtocolMode.EAR){if((r=o||ez.HttpMethod.POST)!==ez.HttpMethod.POST)throw eD(eH.invalidRequestMethodForEAR)}else r=o||ez.HttpMethod.GET;if(e.authorizePostBodyParameters&&r!==ez.HttpMethod.POST)throw eD(eH.invalidAuthorizePostBodyParameters);return r}class n5 extends n2{initializeLogoutRequest(e){this.logger.verbose("initializeLogoutRequest called",e?.correlationId);let t={correlationId:this.correlationId||ir(),...e};if(e)if(e.logoutHint)this.logger.verbose("logoutHint has already been set in logoutRequest");else if(e.account){let r=this.getLogoutHintFromIdTokenClaims(e.account);r&&(this.logger.verbose("Setting logoutHint to login_hint ID Token Claim value for the account provided"),t.logoutHint=r)}else this.logger.verbose("logoutHint was not set and account was not passed into logout request, logoutHint will not be set");else this.logger.verbose("logoutHint will not be set since no logout request was configured");return e&&null===e.postLogoutRedirectUri?this.logger.verbose("postLogoutRedirectUri passed as null, not setting post logout redirect uri",t.correlationId):e&&e.postLogoutRedirectUri?(this.logger.verbose("Setting postLogoutRedirectUri to uri set on logout request",t.correlationId),t.postLogoutRedirectUri=e5.getAbsoluteUrl(e.postLogoutRedirectUri,iw())):null===this.config.auth.postLogoutRedirectUri?this.logger.verbose("postLogoutRedirectUri configured as null and no uri set on request, not passing post logout redirect",t.correlationId):this.config.auth.postLogoutRedirectUri?(this.logger.verbose("Setting postLogoutRedirectUri to configured uri",t.correlationId),t.postLogoutRedirectUri=e5.getAbsoluteUrl(this.config.auth.postLogoutRedirectUri,iw())):(this.logger.verbose("Setting postLogoutRedirectUri to current page",t.correlationId),t.postLogoutRedirectUri=e5.getAbsoluteUrl(iw(),iw())),t}getLogoutHintFromIdTokenClaims(e){let t=e.idTokenClaims;if(t)if(t.login_hint)return t.login_hint;else this.logger.verbose("The ID Token Claims tied to the provided account do not contain a login_hint claim, logoutHint will not be added to logout request");else this.logger.verbose("The provided account does not contain ID Token Claims, logoutHint will not be added to logout request");return null}async createAuthCodeClient(e){return this.performanceClient.addQueueMeasurement(_,this.correlationId),new nZ(await i6(this.getClientConfiguration.bind(this),R,this.logger,this.performanceClient,this.correlationId)(e),this.performanceClient)}async getClientConfiguration(e){let{serverTelemetryManager:t,requestAuthority:r,requestAzureCloudOptions:o,requestExtraQueryParameters:i,account:n}=e;this.performanceClient.addQueueMeasurement(R,this.correlationId);let a=e.authority||await i6(this.getDiscoveredAuthority.bind(this),c,this.logger,this.performanceClient,this.correlationId)({requestAuthority:r,requestAzureCloudOptions:o,requestExtraQueryParameters:i,account:n}),s=this.config.system.loggerOptions;return{authOptions:{clientId:this.config.auth.clientId,authority:a,clientCapabilities:this.config.auth.clientCapabilities,redirectUri:this.config.auth.redirectUri},systemOptions:{tokenRenewalOffsetSeconds:this.config.system.tokenRenewalOffsetSeconds,preventCorsPreflight:!0},loggerOptions:{loggerCallback:s.loggerCallback,piiLoggingEnabled:s.piiLoggingEnabled,logLevel:s.logLevel,correlationId:this.correlationId},cacheOptions:{claimsBasedCachingEnabled:this.config.cache.claimsBasedCachingEnabled},cryptoInterface:this.browserCrypto,networkInterface:this.networkClient,storageInterface:this.browserStorage,serverTelemetryManager:t,libraryInfo:{sku:tA.BrowserConstants.MSAL_SKU,version:iR,cpu:ez.Constants.EMPTY_STRING,os:ez.Constants.EMPTY_STRING},telemetry:this.config.telemetry}}async initializeAuthorizationRequest(e,t){this.performanceClient.addQueueMeasurement(b,this.correlationId);let r=this.getRedirectUri(e.redirectUri),o=nV.setRequestState(this.browserCrypto,e&&e.state||ez.Constants.EMPTY_STRING,{interactionType:t}),i={...await i6(n6,I,this.logger,this.performanceClient,this.correlationId)({...e,correlationId:this.correlationId},this.config,this.performanceClient,this.logger),redirectUri:r,state:o,nonce:e.nonce||ir(),responseMode:this.config.auth.OIDCOptions.serverResponseType},n={...i,httpMethod:n3(i,this.config.auth.protocolMode)};if(e.loginHint||e.sid)return n;let a=e.account||this.browserStorage.getActiveAccount(this.correlationId);return a&&(this.logger.verbose("Setting validated request account",this.correlationId),this.logger.verbosePii(`Setting validated request account: ${a.homeAccountId}`,this.correlationId),n.account=a),n}}var n8=e.i(95369),n8=n8,iK=eF;function n9(e,t,r){let o=n8.getDeserializedResponse(e);if(!o)if(n8.stripLeadingHashOrQuery(e))throw r.error(`A ${t} is present in the iframe but it does not contain known properties. It's likely that the ${t} has been replaced by code running on the redirectUri page.`),r.errorPii(`The ${t} detected is: ${e}`),ru(tb);else throw r.error(`The request has returned to the redirectUri but a ${t} is not present. It's likely that the ${t} has been removed or the page has been redirected by code running on the redirectUri page.`),ru(t_);return o}var eH=eq,oV=oV;function n7(e,t,r,o){let i=t.correlationId,n=new Map;if(oa(n,t.embeddedClientId||t.extraQueryParameters?.[rA]||e.clientId),on(n,[...t.scopes||[],...t.extraScopesToConsent||[]],!0,e.authority.options.OIDCOptions?.defaultScopes),os(n,t.redirectUri),of(n,i),oo(n,t.responseMode),oM(n),t.prompt&&(oT(n,t.prompt),o?.addFields({prompt:t.prompt},i)),t.domainHint&&(oh(n,t.domainHint),o?.addFields({domainHintFromRequest:!0},i)),t.prompt!==ez.PromptValue.SELECT_ACCOUNT)if(t.sid&&t.prompt===ez.PromptValue.NONE)r.verbose("createAuthCodeUrlQueryString: Prompt is none, adding sid from request"),op(n,t.sid),o?.addFields({sidFromRequest:!0},i);else if(t.account){var a,s;let e=(a=t.account,a.idTokenClaims?.sid||null),c=(s=t.account).loginHint||s.idTokenClaims?.login_hint||null;if(c&&t.domainHint&&(r.warning('AuthorizationCodeClient.createAuthCodeUrlQueryString: "domainHint" param is set, skipping opaque "login_hint" claim. Please consider not passing domainHint'),c=null),c){r.verbose("createAuthCodeUrlQueryString: login_hint claim present on account"),od(n,c),o?.addFields({loginHintFromClaim:!0},i);try{let e=(0,nB.buildClientInfoFromHomeAccountId)(t.account.homeAccountId);og(n,e)}catch(e){r.verbose("createAuthCodeUrlQueryString: Could not parse home account ID for CCS Header")}}else if(e&&t.prompt===ez.PromptValue.NONE){r.verbose("createAuthCodeUrlQueryString: Prompt is none, adding sid from account"),op(n,e),o?.addFields({sidFromClaim:!0},i);try{let e=(0,nB.buildClientInfoFromHomeAccountId)(t.account.homeAccountId);og(n,e)}catch(e){r.verbose("createAuthCodeUrlQueryString: Could not parse home account ID for CCS Header")}}else if(t.loginHint)r.verbose("createAuthCodeUrlQueryString: Adding login_hint from request"),od(n,t.loginHint),ou(n,t.loginHint),o?.addFields({loginHintFromRequest:!0},i);else if(t.account.username){r.verbose("createAuthCodeUrlQueryString: Adding login_hint from account"),od(n,t.account.username),o?.addFields({loginHintFromUpn:!0},i);try{let e=(0,nB.buildClientInfoFromHomeAccountId)(t.account.homeAccountId);og(n,e)}catch(e){r.verbose("createAuthCodeUrlQueryString: Could not parse home account ID for CCS Header")}}}else t.loginHint&&(r.verbose("createAuthCodeUrlQueryString: No account, adding login_hint from request"),od(n,t.loginHint),ou(n,t.loginHint),o?.addFields({loginHintFromRequest:!0},i));else r.verbose("createAuthCodeUrlQueryString: Prompt is select_account, ignoring account hints");return t.nonce&&oI(n,t.nonce),t.state&&oA(n,t.state),(t.claims||e.clientCapabilities&&e.clientCapabilities.length>0)&&om(n,t.claims,e.clientCapabilities),t.embeddedClientId&&o$(n,e.clientId,e.redirectUri),!e.instanceAware||t.extraQueryParameters&&Object.keys(t.extraQueryParameters).includes(r9)||oq(n),n}function ae(e,t,r,o){let i=e4(t,r,o);return e5.appendQueryString(e.authorizationEndpoint,i)}function at(e,t){if(ar(e,t),!e.code)throw(0,ex.createClientAuthError)(eF.authorizationCodeMissingFromServerResponse);return e}function ar(e,t){let r,o;if(!e.state||!t)throw e.state?(0,ex.createClientAuthError)(eF.stateNotFound,"Cached State"):(0,ex.createClientAuthError)(eF.stateNotFound,"Server State");try{r=decodeURIComponent(e.state)}catch(t){throw(0,ex.createClientAuthError)(eF.invalidState,e.state)}try{o=decodeURIComponent(t)}catch(t){throw(0,ex.createClientAuthError)(eF.invalidState,e.state)}if(r!==o)throw(0,ex.createClientAuthError)(eF.stateMismatch);if(e.error||e.error_description||e.suberror){var i;let t,r,o=(i=e,t="code=",(r=i.error_uri?.lastIndexOf(t))&&r>=0?i.error_uri?.substring(r+t.length):void 0);if((0,nA.isInteractionRequiredError)(e.error,e.error_description,e.suberror))throw new nA.InteractionRequiredAuthError(e.error||"",e.error_description,e.suberror,e.timestamp||"",e.trace_id||"",e.correlation_id||"",e.claims||"",o);throw new n$(e.error||"",e.error_description,e.suberror,o)}}e.s(["getAuthorizationCodePayload",()=>at,"getAuthorizeUrl",()=>ae,"getStandardAuthorizeRequestParameters",()=>n7,"validateAuthorizationResponse",()=>ar],32665);var ao=e.i(32665),ao=ao,nE=nE,ao=ao;class ai{constructor(e,t,r,o,i){this.authModule=e,this.browserStorage=t,this.authCodeRequest=r,this.logger=o,this.performanceClient=i}async handleCodeResponse(e,t){let r;this.performanceClient.addQueueMeasurement(N,t.correlationId);try{r=ao.getAuthorizationCodePayload(e,t.state)}catch(e){if(e instanceof n$&&e.subError===tL)throw ru(tL);throw e}return i6(this.handleCodeResponseFromServer.bind(this),O,this.logger,this.performanceClient,t.correlationId)(r,t)}async handleCodeResponseFromServer(e,t,r=!0){if(this.performanceClient.addQueueMeasurement(O,t.correlationId),this.logger.trace("InteractionHandler.handleCodeResponseFromServer called"),this.authCodeRequest.code=e.code,e.cloud_instance_host_name&&await i6(this.authModule.updateAuthority.bind(this.authModule),U,this.logger,this.performanceClient,t.correlationId)(e.cloud_instance_host_name,t.correlationId),r&&(e.nonce=t.nonce||void 0),e.state=t.state,e.client_info)this.authCodeRequest.clientInfo=e.client_info;else{let e=this.createCcsCredentials(t);e&&(this.authCodeRequest.ccsCredential=e)}return await i6(this.authModule.acquireToken.bind(this.authModule),D,this.logger,this.performanceClient,t.correlationId)(this.authCodeRequest,e)}createCcsCredentials(e){return e.account?{credential:e.account.homeAccountId,type:nF}:e.loginHint?{credential:e.loginHint,type:"UPN"}:null}}var an=e.i(14811),an=an,nE=nE,iK=eF,nI=nI,nk=nk,aa=el,nv=nv;let as="user_switch",ac={[as]:"User attempted to switch accounts in the native broker, which is not allowed. All new accounts must sign-in through the standard web flow first, please try again."};class al extends aa.AuthError{constructor(e,t,r){super(e,t),Object.setPrototypeOf(this,al.prototype),this.name="NativeAuthError",this.ext=r}}function ah(e){if(e.ext&&e.ext.status&&"DISABLED"===e.ext.status||e.ext&&e.ext.error&&-0x7ffb78ff===e.ext.error)return!0;switch(e.errorCode){case"ContentError":case"PageException":return!0;default:return!1}}function ad(e,t,r){if(r&&r.status)switch(r.status){case"ACCOUNT_UNAVAILABLE":return(0,nA.createInteractionRequiredAuthError)(nv.nativeAccountUnavailable);case"USER_INTERACTION_REQUIRED":return new nA.InteractionRequiredAuthError(e,t);case"USER_CANCEL":return ru(tL);case"NO_NETWORK":return ru(tY);case"UX_NOT_ALLOWED":return(0,nA.createInteractionRequiredAuthError)(nv.uxNotAllowed)}return new al(e,ac[e]||t,r)}class au extends nG{constructor(e,t){super(e,t)}async acquireCachedToken(e){this.performanceClient?.addQueueMeasurement(C,e.correlationId);let t=ez.CacheOutcome.NOT_APPLICABLE;if(e.forceRefresh||!this.config.cacheOptions.claimsBasedCachingEnabled&&!eV.isEmptyObj(e.claims))throw this.setCacheOutcome(ez.CacheOutcome.FORCE_REFRESH_OR_CLAIMS,e.correlationId),(0,ex.createClientAuthError)(eF.tokenRefreshRequired);if(!e.account)throw(0,ex.createClientAuthError)(eF.noAccountInSilentRequest);let r=e.account.tenantId||function(e){let t=new e5(e).getUrlComponents(),r=t.PathSegments.slice(-1)[0]?.toLowerCase();switch(r){case ez.AADAuthorityConstants.COMMON:case ez.AADAuthorityConstants.ORGANIZATIONS:case ez.AADAuthorityConstants.CONSUMERS:return;default:return r}}(e.authority),o=this.cacheManager.getTokenKeys(),i=this.cacheManager.getAccessToken(e.account,e,o,r);if(i)if(ne(i.cachedAt)||i9(i.expiresOn,this.config.systemOptions.tokenRenewalOffsetSeconds))throw this.setCacheOutcome(ez.CacheOutcome.CACHED_ACCESS_TOKEN_EXPIRED,e.correlationId),(0,ex.createClientAuthError)(eF.tokenRefreshRequired);else i.refreshOn&&i9(i.refreshOn,0)&&(t=ez.CacheOutcome.PROACTIVELY_REFRESHED);else throw this.setCacheOutcome(ez.CacheOutcome.NO_CACHED_ACCESS_TOKEN,e.correlationId),(0,ex.createClientAuthError)(eF.tokenRefreshRequired);let n=e.authority||this.authority.getPreferredCache(),a={account:this.cacheManager.getAccount(this.cacheManager.generateAccountKey(e.account),e.correlationId),accessToken:i,idToken:this.cacheManager.getIdToken(e.account,e.correlationId,o,r,this.performanceClient),refreshToken:null,appMetadata:this.cacheManager.readAppMetadataFromCache(n)};return this.setCacheOutcome(t,e.correlationId),this.config.serverTelemetryManager&&this.config.serverTelemetryManager.incrementCacheHits(),[await i6(this.generateResultFromCacheRecord.bind(this),T,this.logger,this.performanceClient,e.correlationId)(a,e),t]}setCacheOutcome(e,t){this.serverTelemetryManager?.setCacheOutcome(e),this.performanceClient?.addFields({cacheOutcome:e},t),e!==ez.CacheOutcome.NOT_APPLICABLE&&this.logger.info(`Token refresh is required due to cache outcome: ${e}`)}async generateResultFromCacheRecord(e,t){let r;if(this.performanceClient?.addQueueMeasurement(T,t.correlationId),e.idToken&&(r=eY(e.idToken.secret,this.config.cryptoInterface.base64Decode)),t.maxAge||0===t.maxAge){let e=r?.auth_time;if(!e)throw(0,ex.createClientAuthError)(eF.authTimeNotFound);e0(e,t.maxAge)}return nJ.generateAuthenticationResult(this.cryptoUtils,this.authority,e,!0,t,r)}}class ag extends n5{async acquireToken(e){this.performanceClient.addQueueMeasurement(n,e.correlationId);let t=this.initializeServerTelemetryManager(tA.ApiId.acquireTokenSilent_silentFlow),r=new au(await i6(this.getClientConfiguration.bind(this),R,this.logger,this.performanceClient,this.correlationId)({serverTelemetryManager:t,requestAuthority:e.authority,requestAzureCloudOptions:e.azureCloudOptions,account:e.account}),this.performanceClient);this.logger.verbose("Silent auth client created");try{let t=(await i6(r.acquireCachedToken.bind(r),C,this.logger,this.performanceClient,e.correlationId)(e))[0];return this.performanceClient.addFields({fromCache:!0},e.correlationId),t}catch(e){throw e instanceof rd&&e.errorCode===t2&&this.logger.verbose("Signing keypair for bound access token not found. Refreshing bound access token and generating a new crypto keypair."),e}}logout(e){this.logger.verbose("logoutRedirect called");let t=this.initializeLogoutRequest(e);return this.clearCacheOnLogout(t.correlationId,t?.account)}}class ap extends n2{constructor(e,t,r,o,i,n,a,s,c,l,h,d){super(e,t,r,o,i,n,s,c,d),this.apiId=a,this.accountId=l,this.platformAuthProvider=c,this.nativeStorageManager=h,this.silentCacheClient=new ag(e,this.nativeStorageManager,r,o,i,n,s,c,d);const u=this.platformAuthProvider.getExtensionName();this.skus=n0.makeExtraSkuString({libraryName:tA.BrowserConstants.MSAL_SKU,libraryVersion:iR,extensionName:u,extensionVersion:this.platformAuthProvider.getExtensionVersion()})}addRequestSKUs(e){e.extraParameters={...e.extraParameters,[an.X_CLIENT_EXTRA_SKU]:this.skus}}async acquireToken(e,t){this.performanceClient.addQueueMeasurement(l,this.correlationId),this.logger.trace("NativeInteractionClient - acquireToken called.");let r=this.performanceClient.startMeasurement(l,this.correlationId),o=nE.nowSeconds(),i=this.initializeServerTelemetryManager(this.apiId);try{let n=await this.initializeNativeRequest(e);try{let e=await this.acquireTokensFromCache(this.accountId,n);return r.end({success:!0,isNativeBroker:!1,fromCache:!0}),e}catch(e){if(t===tA.CacheLookupPolicy.AccessToken)throw this.logger.info("MSAL internal Cache does not contain tokens, return error as per cache policy"),r.end({success:!1,brokerErrorCode:"cache_request_failed"}),e;this.logger.info("MSAL internal Cache does not contain tokens, proceed to make a native call")}let a=await this.platformAuthProvider.sendMessage(n);return await this.handleNativeResponse(a,n,o).then(e=>(r.end({success:!0,isNativeBroker:!0,requestId:e.requestId}),i.clearNativeBrokerErrorCode(),e)).catch(e=>{throw r.end({success:!1,errorCode:e.errorCode,subErrorCode:e.subError}),e})}catch(e){throw e instanceof al&&i.setNativeBrokerErrorCode(e.errorCode),r.end({success:!1}),e}}createSilentCacheRequest(e,t){return{authority:e.authority,correlationId:this.correlationId,scopes:ej.fromString(e.scope).asArray(),account:t,forceRefresh:!1}}async acquireTokensFromCache(e,t){if(!e)throw this.logger.warning("NativeInteractionClient:acquireTokensFromCache - No nativeAccountId provided"),(0,ex.createClientAuthError)(iK.noAccountFound);let r=this.browserStorage.getBaseAccountInfo({nativeAccountId:e},this.correlationId);if(!r)throw(0,ex.createClientAuthError)(iK.noAccountFound);try{let e=this.createSilentCacheRequest(t,r),o=await this.silentCacheClient.acquireToken(e),i={...r,idTokenClaims:o?.idTokenClaims,idToken:o?.idToken};return{...o,account:i}}catch(e){throw e}}async acquireTokenRedirect(e,t){this.logger.trace("NativeInteractionClient - acquireTokenRedirect called.");let{...r}=e;delete r.onRedirectNavigate;let o=await this.initializeNativeRequest(r);try{await this.platformAuthProvider.sendMessage(o)}catch(e){if(e instanceof al&&(this.initializeServerTelemetryManager(this.apiId).setNativeBrokerErrorCode(e.errorCode),ah(e)))throw e}this.browserStorage.setTemporaryCache(tA.TemporaryCacheKeys.NATIVE_REQUEST,JSON.stringify(o),!0);let i={apiId:tA.ApiId.acquireTokenRedirect,timeout:this.config.system.redirectNavigationTimeout,noHistory:!1},n=this.config.auth.navigateToLoginRequestUrl?window.location.href:this.getRedirectUri(e.redirectUri);t.end({success:!0}),await this.navigationClient.navigateExternal(n,i)}async handleRedirectPromise(e,t){if(this.logger.trace("NativeInteractionClient - handleRedirectPromise called."),!this.browserStorage.isInteractionInProgress(!0))return this.logger.info("handleRedirectPromise called but there is no interaction in progress, returning null."),null;let r=this.browserStorage.getCachedNativeRequest();if(!r)return this.logger.verbose("NativeInteractionClient - handleRedirectPromise called but there is no cached request, returning null."),e&&t&&e?.addFields({errorCode:"no_cached_request"},t),null;let{prompt:o,...i}=r;o&&this.logger.verbose("NativeInteractionClient - handleRedirectPromise called and prompt was included in the original request, removing prompt from cached request to prevent second interaction with native broker window."),this.browserStorage.removeItem(this.browserStorage.generateCacheKey(tA.TemporaryCacheKeys.NATIVE_REQUEST));let n=nE.nowSeconds();try{this.logger.verbose("NativeInteractionClient - handleRedirectPromise sending message to native broker.");let t=await this.platformAuthProvider.sendMessage(i),r=await this.handleNativeResponse(t,i,n);return this.initializeServerTelemetryManager(this.apiId).clearNativeBrokerErrorCode(),e&&this.correlationId&&this.performanceClient.addFields({isNativeBroker:!0},this.correlationId),r}catch(e){throw e}}logout(){return this.logger.trace("NativeInteractionClient - logout called."),Promise.reject("Logout not implemented yet")}async handleNativeResponse(e,t,r){this.logger.trace("NativeInteractionClient - handleNativeResponse called.");let o=nI.extractTokenClaims(e.id_token,oX),i=this.createHomeAccountIdentifier(e,o),n=this.browserStorage.getAccountInfoFilteredBy({nativeAccountId:t.accountId},this.correlationId)?.homeAccountId;if(t.extraParameters?.child_client_id&&e.account.id!==t.accountId)this.logger.info("handleNativeServerResponse: Double broker flow detected, ignoring accountId mismatch");else if(i!==n&&e.account.id!==t.accountId)throw ad(as);let a=await this.getDiscoveredAuthority({requestAuthority:t.authority}),s=nY(this.browserStorage,a,i,oX,this.correlationId,o,e.client_info,void 0,o.tid,void 0,e.account.id,this.logger);e.expires_in=Number(e.expires_in);let c=await this.generateAuthenticationResult(e,t,o,s,a.canonicalAuthority,r);return await this.cacheAccount(s,this.correlationId,nI.isKmsi(o)),await this.cacheNativeTokens(e,t,i,o,e.access_token,c.tenantId,r),c}createHomeAccountIdentifier(e,t){return eW.AccountEntity.generateHomeAccountId(e.client_info||ez.Constants.EMPTY_STRING,i1.AuthorityType.Default,this.logger,this.browserCrypto,t)}generateScopes(e,t){return t?ej.fromString(t):ej.fromString(e)}async generatePopAccessToken(e,t){if(t.tokenType!==ez.AuthenticationScheme.POP||!t.signPopToken)return e.access_token;{if(e.shr)return this.logger.trace("handleNativeServerResponse: SHR is enabled in native layer"),e.shr;let r=new nj(this.browserCrypto),o={resourceRequestMethod:t.resourceRequestMethod,resourceRequestUri:t.resourceRequestUri,shrClaims:t.shrClaims,shrNonce:t.shrNonce};if(!t.keyId)throw(0,ex.createClientAuthError)(iK.keyIdMissing);return r.signPopToken(e.access_token,t.keyId,o)}}async generateAuthenticationResult(e,t,r,o,i,n){let a=this.addTelemetryFromNativeResponse(e.properties.MATS),s=this.generateScopes(t.scope,e.scope),c=e.account.properties||{},l=c.UID||r.oid||r.sub||ez.Constants.EMPTY_STRING,h=c.TenantId||r.tid||ez.Constants.EMPTY_STRING,d=(0,eJ.updateAccountTenantProfileData)(eW.AccountEntity.getAccountInfo(o),void 0,r,e.id_token);d.nativeAccountId!==e.account.id&&(d.nativeAccountId=e.account.id);let u=await this.generatePopAccessToken(e,t),g=t.tokenType===ez.AuthenticationScheme.POP?ez.AuthenticationScheme.POP:ez.AuthenticationScheme.BEARER;return{authority:i,uniqueId:l,tenantId:h,scopes:s.asArray(),account:d,idToken:e.id_token,idTokenClaims:r,accessToken:u,fromCache:!!a&&this.isResponseFromCache(a),expiresOn:nE.toDateFromSeconds(n+e.expires_in),tokenType:g,correlationId:this.correlationId,state:e.state,fromNativeBroker:!0}}async cacheAccount(e,t,r){await this.browserStorage.setAccount(e,this.correlationId,r),this.browserStorage.removeAccountContext(eW.AccountEntity.getAccountInfo(e),t)}cacheNativeTokens(e,t,r,o,i,n,a){let s=nk.createIdTokenEntity(r,t.authority,e.id_token||"",t.clientId,o.tid||""),c=t.tokenType===ez.AuthenticationScheme.POP?ez.Constants.SHR_NONCE_VALIDITY:("string"==typeof e.expires_in?parseInt(e.expires_in,10):e.expires_in)||0,l=this.generateScopes(e.scope,t.scope),h=nk.createAccessTokenEntity(r,t.authority,i,t.clientId,o.tid||n,l.printScopes(),a+c,0,oX,void 0,t.tokenType,void 0,t.keyId);return this.nativeStorageManager.saveCacheRecord({idToken:s,accessToken:h},this.correlationId,nI.isKmsi(o),t.storeInCache)}getExpiresInValue(e,t){return e===ez.AuthenticationScheme.POP?ez.Constants.SHR_NONCE_VALIDITY:("string"==typeof t?parseInt(t,10):t)||0}addTelemetryFromNativeResponse(e){let t=this.getMATSFromResponse(e);return t?(this.performanceClient.addFields({extensionId:this.platformAuthProvider.getExtensionId(),extensionVersion:this.platformAuthProvider.getExtensionVersion(),matsBrokerVersion:t.broker_version,matsAccountJoinOnStart:t.account_join_on_start,matsAccountJoinOnEnd:t.account_join_on_end,matsDeviceJoin:t.device_join,matsPromptBehavior:t.prompt_behavior,matsApiErrorCode:t.api_error_code,matsUiVisible:t.ui_visible,matsSilentCode:t.silent_code,matsSilentBiSubCode:t.silent_bi_sub_code,matsSilentMessage:t.silent_message,matsSilentStatus:t.silent_status,matsHttpStatus:t.http_status,matsHttpEventCount:t.http_event_count},this.correlationId),t):null}getMATSFromResponse(e){if(e)try{return JSON.parse(e)}catch(e){this.logger.error("NativeInteractionClient - Error parsing MATS telemetry, returning null instead")}return null}isResponseFromCache(e){return void 0===e.is_cached?(this.logger.verbose("NativeInteractionClient - MATS telemetry does not contain field indicating if response was served from cache. Returning false."),!1):!!e.is_cached}async initializeNativeRequest(e){this.logger.trace("NativeInteractionClient - initializeNativeRequest called");let t=await this.getCanonicalAuthority(e),{scopes:r,...o}=e,i=new ej(r||[]);i.appendScopes(ez.OIDC_DEFAULT_SCOPES);let n={...o,accountId:this.accountId,clientId:this.config.auth.clientId,authority:t.urlString,scope:i.printScopes(),redirectUri:this.getRedirectUri(e.redirectUri),prompt:this.getPrompt(e.prompt),correlationId:this.correlationId,tokenType:e.authenticationScheme,windowTitleSubstring:document.title,extraParameters:{...e.extraQueryParameters,...e.tokenQueryParameters},extendedExpiryToken:!1,keyId:e.popKid};if(n.signPopToken&&e.popKid)throw ru(ri);if(this.handleExtraBrokerParams(n),n.extraParameters=n.extraParameters||{},n.extraParameters.telemetry=tA.PlatformAuthConstants.MATS_TELEMETRY,e.authenticationScheme===ez.AuthenticationScheme.POP){let t,r={resourceRequestUri:e.resourceRequestUri,resourceRequestMethod:e.resourceRequestMethod,shrClaims:e.shrClaims,shrNonce:e.shrNonce},o=new nj(this.browserCrypto);if(n.keyId)t=this.browserCrypto.base64UrlEncode(JSON.stringify({kid:n.keyId})),n.signPopToken=!1;else{let e=await i6(o.generateCnf.bind(o),F,this.logger,this.performanceClient,this.correlationId)(r,this.logger);t=e.reqCnfString,n.keyId=e.kid,n.signPopToken=!0}n.reqCnf=t}return this.addRequestSKUs(n),n}async getCanonicalAuthority(e){let t=e.authority||this.config.auth.authority;e.account&&await this.getDiscoveredAuthority({requestAuthority:t,requestAzureCloudOptions:e.azureCloudOptions,account:e.account});let r=new e5(t);return r.validateAsUri(),r}getPrompt(e){switch(this.apiId){case tA.ApiId.ssoSilent:case tA.ApiId.acquireTokenSilent_silentFlow:return this.logger.trace("initializeNativeRequest: silent request sets prompt to none"),ez.PromptValue.NONE}if(!e)return void this.logger.trace("initializeNativeRequest: prompt was not provided");switch(e){case ez.PromptValue.NONE:case ez.PromptValue.CONSENT:case ez.PromptValue.LOGIN:case ez.PromptValue.SELECT_ACCOUNT:return this.logger.trace("initializeNativeRequest: prompt is compatible with native flow"),e;default:throw this.logger.trace(`initializeNativeRequest: prompt = ${e} is not compatible with native flow`),ru(rr)}}handleExtraBrokerParams(e){let t=e.extraParameters&&e.extraParameters.hasOwnProperty(an.BROKER_CLIENT_ID)&&e.extraParameters.hasOwnProperty(an.BROKER_REDIRECT_URI)&&e.extraParameters.hasOwnProperty(an.CLIENT_ID);if(!e.embeddedClientId&&!t)return;let r="",o=e.redirectUri;e.embeddedClientId?(e.redirectUri=this.config.auth.redirectUri,r=e.embeddedClientId):e.extraParameters&&(e.redirectUri=e.extraParameters[an.BROKER_REDIRECT_URI],r=e.extraParameters[an.CLIENT_ID]),e.extraParameters={child_client_id:r,child_redirect_uri:o},this.performanceClient?.addFields({embeddedClientId:r,embeddedRedirectUri:o},this.correlationId)}}async function am(e,t,r,o,i){let n=ao.getStandardAuthorizeRequestParameters({...e.auth,authority:t},r,o,i);if(oV.addLibraryInfo(n,{sku:tA.BrowserConstants.MSAL_SKU,version:iR,os:"",cpu:""}),e.auth.protocolMode!==ec.ProtocolMode.OIDC&&oV.addApplicationTelemetry(n,e.telemetry.application),r.platformBroker&&(oV.addNativeBroker(n),i.addFields({isPlatformAuthorizeRequest:!0},r.correlationId),r.authenticationScheme===ez.AuthenticationScheme.POP)){let e,t=new iZ(o,i),a=new nj(t);e=r.popKid?t.encodeKid(r.popKid):(await i6(a.generateCnf.bind(a),F,o,i,r.correlationId)(r,o)).reqCnfString,oV.addPopToken(n,e)}return oV.instrumentBrokerParams(n,r.correlationId,i),n}async function af(e,t,r,o,i){if(!r.codeChallenge)throw eD(eH.pkceParamsMissing);let n=await i6(am,"getStandardParams",o,i,r.correlationId)(e,t,r,o,i);return oV.addResponseType(n,ez.OAuthResponseType.CODE),oV.addCodeChallengeParams(n,r.codeChallenge,ez.Constants.S256_CODE_CHALLENGE_METHOD),oV.addExtraQueryParameters(n,r.extraQueryParameters||{}),ao.getAuthorizeUrl(t,n,e.auth.encodeExtraQueryParams,r.extraQueryParameters)}async function ay(e,t,r,o,i,n){if(!o.earJwk)throw ru(tv);let a=await am(t,r,o,i,n);oV.addResponseType(a,ez.OAuthResponseType.IDTOKEN_TOKEN_REFRESHTOKEN),oV.addEARParameters(a,o.earJwk),oV.addCodeChallengeParams(a,o.codeChallenge,ez.Constants.S256_CODE_CHALLENGE_METHOD);let s=new Map;return oV.addExtraQueryParameters(s,o.extraQueryParameters||{}),aT(e,ao.getAuthorizeUrl(r,s,t.auth.encodeExtraQueryParams,o.extraQueryParameters),a)}async function aC(e,t,r,o,i,n){let a=await am(t,r,o,i,n);oV.addResponseType(a,ez.OAuthResponseType.CODE),oV.addCodeChallengeParams(a,o.codeChallenge,o.codeChallengeMethod||ez.Constants.S256_CODE_CHALLENGE_METHOD),oV.addPostBodyParameters(a,o.authorizePostBodyParameters||{});let s=new Map;return oV.addExtraQueryParameters(s,o.extraQueryParameters||{}),aT(e,ao.getAuthorizeUrl(r,s,t.auth.encodeExtraQueryParams,o.extraQueryParameters),a)}function aT(e,t,r){let o=e.createElement("form");return o.method="post",o.action=t,r.forEach((t,r)=>{let i=e.createElement("input");i.hidden=!0,i.name=r,i.value=t,o.appendChild(i)}),e.body.appendChild(o),o}async function aA(e,t,r,o,i,n,a,s,c,h){if(s.verbose("Account id found, calling WAM for token"),!h)throw ru(re);let d=new iZ(s,c),u=new ap(o,i,d,s,a,o.system.navigationClient,r,c,h,t,n,e.correlationId),{userRequestState:g}=nV.parseRequestState(d,e.state);return i6(u.acquireToken.bind(u),l,s,c,e.correlationId)({...e,state:g,prompt:void 0})}async function aI(e,t,r,o,i,n,a,s,c,l,h,d){if(nQ.removeThrottle(a,i.auth.clientId,e),t.accountId)return i6(aA,q,l,h,e.correlationId)(e,t.accountId,o,i,a,s,c,l,h,d);let u=new ai(n,a,{...e,code:t.code||"",codeVerifier:r},l,h);return await i6(u.handleCodeResponse.bind(u),N,l,h,e.correlationId)(t,e)}async function aw(e,t,r,o,i,n,a,s,c,l,h){if(nQ.removeThrottle(n,o.auth.clientId,e),ao.validateAuthorizationResponse(t,e.state),!t.ear_jwe)throw ru(tE);if(!e.earJwk)throw ru(tv);let d=JSON.parse(await i6(ih,"decryptEarResponse",c,l,e.correlationId)(e.earJwk,t.ear_jwe));if(d.accountId)return i6(aA,q,c,l,e.correlationId)(e,d.accountId,r,o,n,a,s,c,l,h);let u=new nJ(o.auth.clientId,n,new iZ(c,l),c,null,null,l);u.validateTokenResponse(d);let g={code:"",state:e.state,nonce:e.nonce,client_info:d.client_info,cloud_graph_host_name:d.cloud_graph_host_name,cloud_instance_host_name:d.cloud_instance_host_name,cloud_instance_name:d.cloud_instance_name,msgraph_host:d.msgraph_host};return await i6(u.handleServerTokenResponse.bind(u),B,c,l,e.correlationId)(d,i,nE.nowSeconds(),e,g,void 0,void 0,void 0,void 0)}async function av(e,t,r){e.addQueueMeasurement(ee,r);let o=i2(aE,"generateCodeVerifier",t,e,r)(e,t,r),i=await i6(ak,et,t,e,r)(o,e,t,r);return{verifier:o,challenge:i}}function aE(e,t,r){try{let o=new Uint8Array(32);return i2(ie,"getRandomValues",t,e,r)(o),oW(o)}catch(e){throw ru(tw)}}async function ak(e,t,r,o){t.addQueueMeasurement(et,o);try{let i=await i6(o7,er,r,t,o)(e,t,o);return oW(new Uint8Array(i))}catch(e){throw ru(tw)}}var eH=eq,aS=e.i(94823),aS=aS;class a_{constructor(e,t,r,o){this.logger=e,this.handshakeTimeoutMs=t,this.extensionId=o,this.resolvers=new Map,this.handshakeResolvers=new Map,this.messageChannel=new MessageChannel,this.windowListener=this.onWindowMessage.bind(this),this.performanceClient=r,this.handshakeEvent=r.startMeasurement("nativeMessageHandlerHandshake"),this.platformAuthType=tA.PlatformAuthConstants.PLATFORM_EXTENSION_PROVIDER}async sendMessage(e){this.logger.trace(this.platformAuthType+" - sendMessage called.");let t={method:tA.NativeExtensionMethod.GetToken,request:e},r={channel:tA.PlatformAuthConstants.CHANNEL_ID,extensionId:this.extensionId,responseId:ir(),body:t};this.logger.trace(this.platformAuthType+" - Sending request to browser extension"),this.logger.tracePii(this.platformAuthType+` - Sending request to browser extension: ${JSON.stringify(r)}`),this.messageChannel.port1.postMessage(r);let o=await new Promise((e,t)=>{this.resolvers.set(r.responseId,{resolve:e,reject:t})});return this.validatePlatformBrokerResponse(o)}static async createProvider(e,t,r){e.trace("PlatformAuthExtensionHandler - createProvider called.");try{let o=new a_(e,t,r,tA.PlatformAuthConstants.PREFERRED_EXTENSION_ID);return await o.sendHandshakeRequest(),o}catch(i){let o=new a_(e,t,r);return await o.sendHandshakeRequest(),o}}async sendHandshakeRequest(){this.logger.trace(this.platformAuthType+" - sendHandshakeRequest called."),window.addEventListener("message",this.windowListener,!1);let e={channel:tA.PlatformAuthConstants.CHANNEL_ID,extensionId:this.extensionId,responseId:ir(),body:{method:tA.NativeExtensionMethod.HandshakeRequest}};return this.handshakeEvent.add({extensionId:this.extensionId,extensionHandshakeTimeoutMs:this.handshakeTimeoutMs}),this.messageChannel.port1.onmessage=e=>{this.onChannelMessage(e)},window.postMessage(e,window.origin,[this.messageChannel.port2]),new Promise((t,r)=>{this.handshakeResolvers.set(e.responseId,{resolve:t,reject:r}),this.timeoutId=window.setTimeout(()=>{window.removeEventListener("message",this.windowListener,!1),this.messageChannel.port1.close(),this.messageChannel.port2.close(),this.handshakeEvent.end({extensionHandshakeTimedOut:!0,success:!1}),r(ru(t9)),this.handshakeResolvers.delete(e.responseId)},this.handshakeTimeoutMs)})}onWindowMessage(e){if(this.logger.trace(this.platformAuthType+" - onWindowMessage called"),e.source!==window)return;let t=e.data;if(t.channel&&t.channel===tA.PlatformAuthConstants.CHANNEL_ID&&(!t.extensionId||t.extensionId===this.extensionId)&&t.body.method===tA.NativeExtensionMethod.HandshakeRequest){let e=this.handshakeResolvers.get(t.responseId);if(!e)return void this.logger.trace(this.platformAuthType+`.onWindowMessage - resolver can't be found for request ${t.responseId}`);this.logger.verbose(t.extensionId?`Extension with id: ${t.extensionId} not installed`:"No extension installed"),clearTimeout(this.timeoutId),this.messageChannel.port1.close(),this.messageChannel.port2.close(),window.removeEventListener("message",this.windowListener,!1),this.handshakeEvent.end({success:!1,extensionInstalled:!1}),e.reject(ru(t7))}}onChannelMessage(e){this.logger.trace(this.platformAuthType+" - onChannelMessage called.");let t=e.data,r=this.resolvers.get(t.responseId),o=this.handshakeResolvers.get(t.responseId);try{let e=t.body.method;if(e===tA.NativeExtensionMethod.Response){if(!r)return;let e=t.body.response;if(this.logger.trace(this.platformAuthType+" - Received response from browser extension"),this.logger.tracePii(this.platformAuthType+` - Received response from browser extension: ${JSON.stringify(e)}`),"Success"!==e.status)r.reject(ad(e.code,e.description,e.ext));else if(e.result)e.result.code&&e.result.description?r.reject(ad(e.result.code,e.result.description,e.result.ext)):r.resolve(e.result);else throw(0,el.createAuthError)(aS.unexpectedError,"Event does not contain result.");this.resolvers.delete(t.responseId)}else if(e===tA.NativeExtensionMethod.HandshakeResponse){if(!o)return void this.logger.trace(this.platformAuthType+`.onChannelMessage - resolver can't be found for request ${t.responseId}`);clearTimeout(this.timeoutId),window.removeEventListener("message",this.windowListener,!1),this.extensionId=t.extensionId,this.extensionVersion=t.body.version,this.logger.verbose(this.platformAuthType+` - Received HandshakeResponse from extension: ${this.extensionId}`),this.handshakeEvent.end({extensionInstalled:!0,success:!0}),o.resolve(),this.handshakeResolvers.delete(t.responseId)}}catch(t){this.logger.error("Error parsing response from WAM Extension"),this.logger.errorPii(`Error parsing response from WAM Extension: ${t}`),this.logger.errorPii(`Unable to parse ${e}`),r?r.reject(t):o&&o.reject(t)}}validatePlatformBrokerResponse(e){if(e.hasOwnProperty("access_token")&&e.hasOwnProperty("id_token")&&e.hasOwnProperty("client_info")&&e.hasOwnProperty("account")&&e.hasOwnProperty("scope")&&e.hasOwnProperty("expires_in"))return e;throw(0,el.createAuthError)(aS.unexpectedError,"Response missing expected properties.")}getExtensionId(){return this.extensionId}getExtensionVersion(){return this.extensionVersion}getExtensionName(){return this.getExtensionId()===tA.PlatformAuthConstants.PREFERRED_EXTENSION_ID?"chrome":this.getExtensionId()?.length?"unknown":void 0}}var aS=aS;class aR{constructor(e,t,r){this.logger=e,this.performanceClient=t,this.correlationId=r,this.platformAuthType=tA.PlatformAuthConstants.PLATFORM_DOM_PROVIDER}static async createProvider(e,t,r){if(e.trace("PlatformAuthDOMHandler: createProvider called"),window.navigator?.platformAuthentication){let o=await window.navigator.platformAuthentication.getSupportedContracts(tA.PlatformAuthConstants.MICROSOFT_ENTRA_BROKERID);if(o?.includes(tA.PlatformAuthConstants.PLATFORM_DOM_APIS))return e.trace("Platform auth api available in DOM"),new aR(e,t,r)}}getExtensionId(){return tA.PlatformAuthConstants.MICROSOFT_ENTRA_BROKERID}getExtensionVersion(){return""}getExtensionName(){return tA.PlatformAuthConstants.DOM_API_NAME}async sendMessage(e){this.logger.trace(this.platformAuthType+" - Sending request to browser DOM API");try{let t=this.initializePlatformDOMRequest(e),r=await window.navigator.platformAuthentication.executeGetToken(t);return this.validatePlatformBrokerResponse(r)}catch(e){throw this.logger.error(this.platformAuthType+" - executeGetToken DOM API error"),e}}initializePlatformDOMRequest(e){this.logger.trace(this.platformAuthType+" - initializeNativeDOMRequest called");let{accountId:t,clientId:r,authority:o,scope:i,redirectUri:n,correlationId:a,state:s,storeInCache:c,embeddedClientId:l,extraParameters:h,...d}=e,u=this.getDOMExtraParams(d);return{accountId:t,brokerId:this.getExtensionId(),authority:o,clientId:r,correlationId:a||this.correlationId,extraParameters:{...h,...u},isSecurityTokenService:!1,redirectUri:n,scope:i,state:s,storeInCache:c,embeddedClientId:l}}validatePlatformBrokerResponse(e){if(e.hasOwnProperty("isSuccess")){if(e.hasOwnProperty("accessToken")&&e.hasOwnProperty("idToken")&&e.hasOwnProperty("clientInfo")&&e.hasOwnProperty("account")&&e.hasOwnProperty("scopes")&&e.hasOwnProperty("expiresIn"))return this.logger.trace(this.platformAuthType+" - platform broker returned successful and valid response"),this.convertToPlatformBrokerResponse(e);else if(e.hasOwnProperty("error")&&!1===e.isSuccess&&e.error&&e.error.code)throw this.logger.trace(this.platformAuthType+" - platform broker returned error response"),ad(e.error.code,e.error.description,{error:parseInt(e.error.errorCode),protocol_error:e.error.protocolError,status:e.error.status,properties:e.error.properties})}throw(0,el.createAuthError)(aS.unexpectedError,"Response missing expected properties.")}convertToPlatformBrokerResponse(e){return this.logger.trace(this.platformAuthType+" - convertToNativeResponse called"),{access_token:e.accessToken,id_token:e.idToken,client_info:e.clientInfo,account:e.account,expires_in:e.expiresIn,scope:e.scopes,state:e.state||"",properties:e.properties||{},extendedLifetimeToken:e.extendedLifetimeToken??!1,shr:e.proofOfPossessionPayload}}getDOMExtraParams(e){return{...Object.entries(e).reduce((e,[t,r])=>(e[t]=String(r),e),{})}}}async function ab(e,t,r,o,i){let n;e.trace("getPlatformAuthProvider called",r),e.trace("Has client allowed platform auth via DOM API: "+i);try{i&&(n=await aR.createProvider(e,t,r)),n||(e.trace("Platform auth via DOM API not available, checking for extension"),n=await a_.createProvider(e,o||2e3,t))}catch(t){e.trace("Platform auth not available",t)}return n}function aP(e,t,r,o){if(t.trace("isPlatformAuthAllowed called"),!e.system.allowPlatformBroker&&e.system.allowPlatformBrokerWithDOM)throw eD(eH.invalidPlatformBrokerConfiguration);if(!e.system.allowPlatformBroker)return t.trace("isPlatformAuthAllowed: allowPlatformBroker is not enabled, returning false"),!1;if(!r)return t.trace("isPlatformAuthAllowed: Platform auth provider is not initialized, returning false"),!1;if(o)switch(o){case ez.AuthenticationScheme.BEARER:case ez.AuthenticationScheme.POP:t.trace("isPlatformAuthAllowed: authenticationScheme is supported, returning true");break;default:return t.trace("isPlatformAuthAllowed: authenticationScheme is not supported, returning false"),!1}return!0}class aO extends n5{constructor(e,t,r,o,i,n,a,s,c,l){super(e,t,r,o,i,n,a,c,l),this.unloadWindow=this.unloadWindow.bind(this),this.nativeStorage=s,this.eventHandler=i}acquireToken(e,t){let r;try{if(r={popupName:this.generatePopupName(e.scopes||ez.OIDC_DEFAULT_SCOPES,e.authority||this.config.auth.authority),popupWindowAttributes:e.popupWindowAttributes||{},popupWindowParent:e.popupWindowParent??window},this.performanceClient.addFields({isAsyncPopup:this.config.system.asyncPopups},this.correlationId),this.config.system.asyncPopups)return this.logger.verbose("asyncPopups set to true, acquiring token"),this.acquireTokenPopupAsync(e,r,t);{let o={...e,httpMethod:n3(e,this.config.auth.protocolMode)};return this.logger.verbose("asyncPopup set to false, opening popup before acquiring token"),r.popup=this.openSizedPopup("about:blank",r),this.acquireTokenPopupAsync(o,r,t)}}catch(e){return Promise.reject(e)}}logout(e){try{this.logger.verbose("logoutPopup called");let t=this.initializeLogoutRequest(e),r={popupName:this.generateLogoutPopupName(t),popupWindowAttributes:e?.popupWindowAttributes||{},popupWindowParent:e?.popupWindowParent??window},o=e&&e.authority,i=e&&e.mainWindowRedirectUri;if(this.config.system.asyncPopups)return this.logger.verbose("asyncPopups set to true"),this.logoutPopupAsync(t,r,o,i);return this.logger.verbose("asyncPopup set to false, opening popup"),r.popup=this.openSizedPopup("about:blank",r),this.logoutPopupAsync(t,r,o,i)}catch(e){return Promise.reject(e)}}async acquireTokenPopupAsync(e,t,r){this.logger.verbose("acquireTokenPopupAsync called");let o=await i6(this.initializeAuthorizationRequest.bind(this),b,this.logger,this.performanceClient,this.correlationId)(e,tA.InteractionType.Popup);return(t.popup&&i_(o.authority),o.platformBroker=aP(this.config,this.logger,this.platformAuthProvider,e.authenticationScheme),this.config.auth.protocolMode===ec.ProtocolMode.EAR)?this.executeEarFlow(o,t,r):this.executeCodeFlow(o,t,r)}async executeCodeFlow(e,t,r){let o=e.correlationId,i=this.initializeServerTelemetryManager(tA.ApiId.acquireTokenPopup),n=r||await i6(av,ee,this.logger,this.performanceClient,o)(this.performanceClient,this.logger,o),a={...e,codeChallenge:n.challenge};try{let r=await i6(this.createAuthCodeClient.bind(this),_,this.logger,this.performanceClient,o)({serverTelemetryManager:i,requestAuthority:a.authority,requestAzureCloudOptions:a.azureCloudOptions,requestExtraQueryParameters:a.extraQueryParameters,account:a.account});if(a.httpMethod===ez.HttpMethod.POST)return await this.executeCodeFlowWithPost(a,t,r,n.verifier);{let i=await i6(af,P,this.logger,this.performanceClient,o)(this.config,r.authority,a,this.logger,this.performanceClient),s=this.initiateAuthRequest(i,t);this.eventHandler.emitEvent(nL.EventType.POPUP_OPENED,tA.InteractionType.Popup,{popupWindow:s},null);let c=await this.monitorPopupForHash(s,t.popupWindowParent),l=i2(n9,K,this.logger,this.performanceClient,this.correlationId)(c,this.config.auth.OIDCOptions.serverResponseType,this.logger);return await i6(aI,L,this.logger,this.performanceClient,o)(e,l,n.verifier,tA.ApiId.acquireTokenPopup,this.config,r,this.browserStorage,this.nativeStorage,this.eventHandler,this.logger,this.performanceClient,this.platformAuthProvider)}}catch(e){throw t.popup?.close(),e instanceof el.AuthError&&(e.setCorrelationId(this.correlationId),i.cacheFailedRequest(e)),e}}async executeEarFlow(e,t,r){let o=e.correlationId,i=await i6(this.getDiscoveredAuthority.bind(this),c,this.logger,this.performanceClient,o)({requestAuthority:e.authority,requestAzureCloudOptions:e.azureCloudOptions,requestExtraQueryParameters:e.extraQueryParameters,account:e.account}),n=await i6(ic,en,this.logger,this.performanceClient,o)(),a=r||await i6(av,ee,this.logger,this.performanceClient,o)(this.performanceClient,this.logger,o),s={...e,earJwk:n,codeChallenge:a.challenge},l=t.popup||this.openPopup("about:blank",t);(await ay(l.document,this.config,i,s,this.logger,this.performanceClient)).submit();let h=await i6(this.monitorPopupForHash.bind(this),k,this.logger,this.performanceClient,o)(l,t.popupWindowParent),d=i2(n9,K,this.logger,this.performanceClient,this.correlationId)(h,this.config.auth.OIDCOptions.serverResponseType,this.logger);if(d.ear_jwe||!d.code)return i6(aw,M,this.logger,this.performanceClient,o)(s,d,tA.ApiId.acquireTokenPopup,this.config,i,this.browserStorage,this.nativeStorage,this.eventHandler,this.logger,this.performanceClient,this.platformAuthProvider);{let t=await i6(this.createAuthCodeClient.bind(this),_,this.logger,this.performanceClient,o)({serverTelemetryManager:this.initializeServerTelemetryManager(tA.ApiId.acquireTokenPopup),requestAuthority:e.authority,requestAzureCloudOptions:e.azureCloudOptions,requestExtraQueryParameters:e.extraQueryParameters,account:e.account,authority:i});return i6(aI,L,this.logger,this.performanceClient,o)(s,d,a.verifier,tA.ApiId.acquireTokenPopup,this.config,t,this.browserStorage,this.nativeStorage,this.eventHandler,this.logger,this.performanceClient,this.platformAuthProvider)}}async executeCodeFlowWithPost(e,t,r,o){let i=e.correlationId,n=await i6(this.getDiscoveredAuthority.bind(this),c,this.logger,this.performanceClient,i)({requestAuthority:e.authority,requestAzureCloudOptions:e.azureCloudOptions,requestExtraQueryParameters:e.extraQueryParameters,account:e.account}),a=t.popup||this.openPopup("about:blank",t);(await aC(a.document,this.config,n,e,this.logger,this.performanceClient)).submit();let s=await i6(this.monitorPopupForHash.bind(this),k,this.logger,this.performanceClient,i)(a,t.popupWindowParent),l=i2(n9,K,this.logger,this.performanceClient,this.correlationId)(s,this.config.auth.OIDCOptions.serverResponseType,this.logger);return i6(aI,L,this.logger,this.performanceClient,i)(e,l,o,tA.ApiId.acquireTokenPopup,this.config,r,this.browserStorage,this.nativeStorage,this.eventHandler,this.logger,this.performanceClient,this.platformAuthProvider)}async logoutPopupAsync(e,t,r,o){this.logger.verbose("logoutPopupAsync called"),this.eventHandler.emitEvent(nL.EventType.LOGOUT_START,tA.InteractionType.Popup,e);let i=this.initializeServerTelemetryManager(tA.ApiId.logoutPopup);try{await this.clearCacheOnLogout(this.correlationId,e.account);let n=await i6(this.createAuthCodeClient.bind(this),_,this.logger,this.performanceClient,this.correlationId)({serverTelemetryManager:i,requestAuthority:r,account:e.account||void 0});try{n.authority.endSessionEndpoint}catch{if(e.account?.homeAccountId&&e.postLogoutRedirectUri&&n.authority.protocolMode===ec.ProtocolMode.OIDC){if(this.eventHandler.emitEvent(nL.EventType.LOGOUT_SUCCESS,tA.InteractionType.Popup,e),o){let e={apiId:tA.ApiId.logoutPopup,timeout:this.config.system.redirectNavigationTimeout,noHistory:!1},t=e5.getAbsoluteUrl(o,iw());await this.navigationClient.navigateInternal(t,e)}t.popup?.close();return}}let a=n.getLogoutUri(e);this.eventHandler.emitEvent(nL.EventType.LOGOUT_SUCCESS,tA.InteractionType.Popup,e);let s=this.openPopup(a,t);if(this.eventHandler.emitEvent(nL.EventType.POPUP_OPENED,tA.InteractionType.Popup,{popupWindow:s},null),await this.monitorPopupForHash(s,t.popupWindowParent).catch(()=>{}),o){let e={apiId:tA.ApiId.logoutPopup,timeout:this.config.system.redirectNavigationTimeout,noHistory:!1},t=e5.getAbsoluteUrl(o,iw());this.logger.verbose("Redirecting main window to url specified in the request"),this.logger.verbosePii(`Redirecting main window to: ${t}`),await this.navigationClient.navigateInternal(t,e)}else this.logger.verbose("No main window navigation requested")}catch(e){throw t.popup?.close(),e instanceof el.AuthError&&(e.setCorrelationId(this.correlationId),i.cacheFailedRequest(e)),this.eventHandler.emitEvent(nL.EventType.LOGOUT_FAILURE,tA.InteractionType.Popup,null,e),this.eventHandler.emitEvent(nL.EventType.LOGOUT_END,tA.InteractionType.Popup),e}this.eventHandler.emitEvent(nL.EventType.LOGOUT_END,tA.InteractionType.Popup)}initiateAuthRequest(e,t){if(e)return this.logger.infoPii(`Navigate to: ${e}`),this.openPopup(e,t);throw this.logger.error("Navigate url is empty"),ru(tS)}monitorPopupForHash(e,t){return new Promise((t,r)=>{this.logger.verbose("PopupHandler.monitorPopupForHash - polling started");let o=setInterval(()=>{if(e.closed){this.logger.error("PopupHandler.monitorPopupForHash - window closed"),clearInterval(o),r(ru(tL));return}let i="";try{i=e.location.href}catch(e){}if(!i||"about:blank"===i)return;clearInterval(o);let n="",a=this.config.auth.OIDCOptions.serverResponseType;e&&(n=a===ez.ServerResponseType.QUERY?e.location.search:e.location.hash),this.logger.verbose("PopupHandler.monitorPopupForHash - popup window is on same origin as caller"),t(n)},this.config.system.pollIntervalMilliseconds)}).finally(()=>{this.cleanPopup(e,t)})}openPopup(e,t){try{let r;if(t.popup?(r=t.popup,this.logger.verbosePii(`Navigating popup window to: ${e}`),r.location.assign(e)):void 0===t.popup&&(this.logger.verbosePii(`Opening popup window to: ${e}`),r=this.openSizedPopup(e,t)),!r)throw ru(tq);return r.focus&&r.focus(),this.currentWindow=r,t.popupWindowParent.addEventListener("beforeunload",this.unloadWindow),r}catch(e){throw this.logger.error("error opening popup "+e.message),ru(tM)}}openSizedPopup(e,{popupName:t,popupWindowAttributes:r,popupWindowParent:o}){let i=o.screenLeft?o.screenLeft:o.screenX,n=o.screenTop?o.screenTop:o.screenY,a=o.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,s=o.innerHeight||document.documentElement.clientHeight||document.body.clientHeight,c=r.popupSize?.width,l=r.popupSize?.height,h=r.popupPosition?.top,d=r.popupPosition?.left;return(!c||c<0||c>a)&&(this.logger.verbose("Default popup window width used. Window width not configured or invalid."),c=tA.BrowserConstants.POPUP_WIDTH),(!l||l<0||l>s)&&(this.logger.verbose("Default popup window height used. Window height not configured or invalid."),l=tA.BrowserConstants.POPUP_HEIGHT),(!h||h<0||h>s)&&(this.logger.verbose("Default popup window top position used. Window top not configured or invalid."),h=Math.max(0,s/2-tA.BrowserConstants.POPUP_HEIGHT/2+n)),(!d||d<0||d>a)&&(this.logger.verbose("Default popup window left position used. Window left not configured or invalid."),d=Math.max(0,a/2-tA.BrowserConstants.POPUP_WIDTH/2+i)),o.open(e,t,`width=${c}, height=${l}, top=${h}, left=${d}, scrollbars=yes`)}unloadWindow(e){this.currentWindow&&this.currentWindow.close(),e.preventDefault()}cleanPopup(e,t){e.close(),t.removeEventListener("beforeunload",this.unloadWindow)}generatePopupName(e,t){return`${tA.BrowserConstants.POPUP_NAME_PREFIX}.${this.config.auth.clientId}.${e.join("-")}.${t}.${this.correlationId}`}generateLogoutPopupName(e){let t=e.account&&e.account.homeAccountId;return`${tA.BrowserConstants.POPUP_NAME_PREFIX}.${this.config.auth.clientId}.${t}.${this.correlationId}`}}var n8=n8;class aN extends n5{constructor(e,t,r,o,i,n,a,s,c,l){super(e,t,r,o,i,n,a,c,l),this.nativeStorage=s}async acquireToken(e){let t=await i6(this.initializeAuthorizationRequest.bind(this),b,this.logger,this.performanceClient,this.correlationId)(e,tA.InteractionType.Redirect);t.platformBroker=aP(this.config,this.logger,this.platformAuthProvider,e.authenticationScheme);let r=e=>{e.persisted&&(this.logger.verbose("Page was restored from back/forward cache. Clearing temporary cache."),this.browserStorage.resetRequestCache(),this.eventHandler.emitEvent(nL.EventType.RESTORE_FROM_BFCACHE,tA.InteractionType.Redirect))},o=this.getRedirectStartPage(e.redirectStartPage);this.logger.verbosePii(`Redirect start page: ${o}`),this.browserStorage.setTemporaryCache(tA.TemporaryCacheKeys.ORIGIN_URI,o,!0),window.addEventListener("pageshow",r);try{this.config.auth.protocolMode===ec.ProtocolMode.EAR?await this.executeEarFlow(t):await this.executeCodeFlow(t,e.onRedirectNavigate)}catch(e){throw e instanceof el.AuthError&&e.setCorrelationId(this.correlationId),window.removeEventListener("pageshow",r),e}}async executeCodeFlow(e,t){let r=e.correlationId,o=this.initializeServerTelemetryManager(tA.ApiId.acquireTokenRedirect),i=await i6(av,ee,this.logger,this.performanceClient,r)(this.performanceClient,this.logger,r),n={...e,codeChallenge:i.challenge};this.browserStorage.cacheAuthorizeRequest(n,i.verifier);try{if(n.httpMethod===ez.HttpMethod.POST)return await this.executeCodeFlowWithPost(n);{let r=await i6(this.createAuthCodeClient.bind(this),_,this.logger,this.performanceClient,this.correlationId)({serverTelemetryManager:o,requestAuthority:n.authority,requestAzureCloudOptions:n.azureCloudOptions,requestExtraQueryParameters:n.extraQueryParameters,account:n.account}),i=await i6(af,P,this.logger,this.performanceClient,e.correlationId)(this.config,r.authority,n,this.logger,this.performanceClient);return await this.initiateAuthRequest(i,t)}}catch(e){throw e instanceof el.AuthError&&(e.setCorrelationId(this.correlationId),o.cacheFailedRequest(e)),e}}async executeEarFlow(e){let t=e.correlationId,r=await i6(this.getDiscoveredAuthority.bind(this),c,this.logger,this.performanceClient,t)({requestAuthority:e.authority,requestAzureCloudOptions:e.azureCloudOptions,requestExtraQueryParameters:e.extraQueryParameters,account:e.account}),o=await i6(ic,en,this.logger,this.performanceClient,t)(),i=await i6(av,ee,this.logger,this.performanceClient,t)(this.performanceClient,this.logger,t),n={...e,earJwk:o,codeChallenge:i.challenge};return this.browserStorage.cacheAuthorizeRequest(n,i.verifier),(await ay(document,this.config,r,n,this.logger,this.performanceClient)).submit(),new Promise((e,t)=>{setTimeout(()=>{t(ru(rc,"failed_to_redirect"))},this.config.system.redirectNavigationTimeout)})}async executeCodeFlowWithPost(e){let t=e.correlationId,r=await i6(this.getDiscoveredAuthority.bind(this),c,this.logger,this.performanceClient,t)({requestAuthority:e.authority,requestAzureCloudOptions:e.azureCloudOptions,requestExtraQueryParameters:e.extraQueryParameters,account:e.account});return this.browserStorage.cacheAuthorizeRequest(e),(await aC(document,this.config,r,e,this.logger,this.performanceClient)).submit(),new Promise((e,t)=>{setTimeout(()=>{t(ru(rc,"failed_to_redirect"))},this.config.system.redirectNavigationTimeout)})}async handleRedirectPromise(e="",t,r,o){let i=this.initializeServerTelemetryManager(tA.ApiId.handleRedirectPromise);try{let[n,a]=this.getRedirectResponse(e||"");if(!n)return this.logger.info("handleRedirectPromise did not detect a response as a result of a redirect. Cleaning temporary cache."),this.browserStorage.resetRequestCache(),"back_forward"!==function(){if("undefined"==typeof window||void 0===window.performance||"function"!=typeof window.performance.getEntriesByType)return;let e=window.performance.getEntriesByType("navigation"),t=e.length?e[0]:void 0;return t?.type}()?o.event.errorCode="no_server_response":this.logger.verbose("Back navigation event detected. Muting no_server_response error"),null;let s=this.browserStorage.getTemporaryCache(tA.TemporaryCacheKeys.ORIGIN_URI,!0)||ez.Constants.EMPTY_STRING,c=n8.normalizeUrlForComparison(s),l=n8.normalizeUrlForComparison(window.location.href);if(c===l&&this.config.auth.navigateToLoginRequestUrl){let e;return this.logger.verbose("Current page is loginRequestUrl, handling response"),s.indexOf("#")>-1&&((e=s.split("#")).shift(),window.location.hash=e.length>0?e.join("#"):""),await this.handleResponse(n,t,r,i)}if(!this.config.auth.navigateToLoginRequestUrl)return this.logger.verbose("NavigateToLoginRequestUrl set to false, handling response"),await this.handleResponse(n,t,r,i);if(!iI()||this.config.system.allowRedirectInIframe){this.browserStorage.setTemporaryCache(tA.TemporaryCacheKeys.URL_HASH,a,!0);let e={apiId:tA.ApiId.handleRedirectPromise,timeout:this.config.system.redirectNavigationTimeout,noHistory:!0},o=!0;if(s&&"null"!==s)this.logger.verbose(`Navigating to loginRequestUrl: ${s}`),o=await this.navigationClient.navigateInternal(s,e);else{let t,r=(t=new e5(window.location.href).getUrlComponents(),`${t.Protocol}//${t.HostNameAndPort}/`);this.browserStorage.setTemporaryCache(tA.TemporaryCacheKeys.ORIGIN_URI,r,!0),this.logger.warning("Unable to get valid login request url from cache, redirecting to home page"),o=await this.navigationClient.navigateInternal(r,e)}if(!o)return await this.handleResponse(n,t,r,i)}return null}catch(e){throw e instanceof el.AuthError&&(e.setCorrelationId(this.correlationId),i.cacheFailedRequest(e)),e}}getRedirectResponse(e){this.logger.verbose("getRedirectResponseHash called");let t=e;t||(t=this.config.auth.OIDCOptions.serverResponseType===ez.ServerResponseType.QUERY?window.location.search:window.location.hash);let r=n8.getDeserializedResponse(t);if(r){try{!function(e,t,r){if(!e.state)throw ru(tR);let o=function(e,t){if(!t)return null;try{return nV.parseRequestState(e,t).libraryState.meta}catch(e){throw(0,ex.createClientAuthError)(iK.invalidState)}}(t,e.state);if(!o)throw ru(tP);if(o.interactionType!==r)throw ru(tO)}(r,this.browserCrypto,tA.InteractionType.Redirect)}catch(e){return e instanceof el.AuthError&&this.logger.error(`Interaction type validation failed due to ${e.errorCode}: ${e.errorMessage}`),[null,""]}return iA(window),this.logger.verbose("Hash contains known properties, returning response hash"),[r,t]}let o=this.browserStorage.getTemporaryCache(tA.TemporaryCacheKeys.URL_HASH,!0);return(this.browserStorage.removeItem(this.browserStorage.generateCacheKey(tA.TemporaryCacheKeys.URL_HASH)),o&&(r=n8.getDeserializedResponse(o)))?(this.logger.verbose("Hash does not contain known properties, returning cached hash"),[r,o]):[null,""]}async handleResponse(e,t,r,o){if(!e.state)throw ru(tR);if(e.ear_jwe){let r=await i6(this.getDiscoveredAuthority.bind(this),c,this.logger,this.performanceClient,t.correlationId)({requestAuthority:t.authority,requestAzureCloudOptions:t.azureCloudOptions,requestExtraQueryParameters:t.extraQueryParameters,account:t.account});return i6(aw,M,this.logger,this.performanceClient,t.correlationId)(t,e,tA.ApiId.acquireTokenRedirect,this.config,r,this.browserStorage,this.nativeStorage,this.eventHandler,this.logger,this.performanceClient,this.platformAuthProvider)}let i=await i6(this.createAuthCodeClient.bind(this),_,this.logger,this.performanceClient,this.correlationId)({serverTelemetryManager:o,requestAuthority:t.authority});return i6(aI,L,this.logger,this.performanceClient,t.correlationId)(t,e,r,tA.ApiId.acquireTokenRedirect,this.config,i,this.browserStorage,this.nativeStorage,this.eventHandler,this.logger,this.performanceClient,this.platformAuthProvider)}async initiateAuthRequest(e,t){if(this.logger.verbose("RedirectHandler.initiateAuthRequest called"),e){this.logger.infoPii(`RedirectHandler.initiateAuthRequest: Navigate to: ${e}`);let r={apiId:tA.ApiId.acquireTokenRedirect,timeout:this.config.system.redirectNavigationTimeout,noHistory:!1},o=t||this.config.auth.onRedirectNavigate;if("function"==typeof o)return(this.logger.verbose("RedirectHandler.initiateAuthRequest: Invoking onRedirectNavigate callback"),!1===o(e))?void this.logger.verbose("RedirectHandler.initiateAuthRequest: onRedirectNavigate returned false, stopping navigation"):(this.logger.verbose("RedirectHandler.initiateAuthRequest: onRedirectNavigate did not return false, navigating"),await this.navigationClient.navigateExternal(e,r),void 0);return this.logger.verbose("RedirectHandler.initiateAuthRequest: Navigating window to navigate url"),await this.navigationClient.navigateExternal(e,r),void 0}throw this.logger.info("RedirectHandler.initiateAuthRequest: Navigate url is empty"),ru(tS)}async logout(e){this.logger.verbose("logoutRedirect called");let t=this.initializeLogoutRequest(e),r=this.initializeServerTelemetryManager(tA.ApiId.logout);try{this.eventHandler.emitEvent(nL.EventType.LOGOUT_START,tA.InteractionType.Redirect,e),await this.clearCacheOnLogout(this.correlationId,t.account);let o={apiId:tA.ApiId.logout,timeout:this.config.system.redirectNavigationTimeout,noHistory:!1},i=await i6(this.createAuthCodeClient.bind(this),_,this.logger,this.performanceClient,this.correlationId)({serverTelemetryManager:r,requestAuthority:e&&e.authority,requestExtraQueryParameters:e?.extraQueryParameters,account:e&&e.account||void 0});if(i.authority.protocolMode===ec.ProtocolMode.OIDC)try{i.authority.endSessionEndpoint}catch{if(t.account?.homeAccountId)return void this.eventHandler.emitEvent(nL.EventType.LOGOUT_SUCCESS,tA.InteractionType.Redirect,t)}let n=i.getLogoutUri(t);if(this.eventHandler.emitEvent(nL.EventType.LOGOUT_SUCCESS,tA.InteractionType.Redirect,t),e&&"function"==typeof e.onRedirectNavigate){let t=e.onRedirectNavigate(n);if(!1!==t){this.logger.verbose("Logout onRedirectNavigate did not return false, navigating"),this.browserStorage.getInteractionInProgress()||this.browserStorage.setInteractionInProgress(!0,tA.INTERACTION_TYPE.SIGNOUT),await this.navigationClient.navigateExternal(n,o);return}this.browserStorage.setInteractionInProgress(!1),this.logger.verbose("Logout onRedirectNavigate returned false, stopping navigation")}else{this.browserStorage.getInteractionInProgress()||this.browserStorage.setInteractionInProgress(!0,tA.INTERACTION_TYPE.SIGNOUT),await this.navigationClient.navigateExternal(n,o);return}}catch(e){throw e instanceof el.AuthError&&(e.setCorrelationId(this.correlationId),r.cacheFailedRequest(e)),this.eventHandler.emitEvent(nL.EventType.LOGOUT_FAILURE,tA.InteractionType.Redirect,null,e),this.eventHandler.emitEvent(nL.EventType.LOGOUT_END,tA.InteractionType.Redirect),e}this.eventHandler.emitEvent(nL.EventType.LOGOUT_END,tA.InteractionType.Redirect)}getRedirectStartPage(e){let t=e||window.location.href;return e5.getAbsoluteUrl(t,iw())}}async function aM(e,t,r,o,i){if(t.addQueueMeasurement(E,o),!e)throw r.info("Navigate url is empty"),ru(tS);return i?i6(aD,S,r,t,o)(e,i,t,o):i2(aH,"silentHandlerLoadFrameSync",r,t,o)(e)}async function aq(e,t,r,o,i){let n=ax();if(!n.contentDocument)throw"No document associated with iframe!";return(await aC(n.contentDocument,e,t,r,o,i)).submit(),n}async function aL(e,t,r,o,i){let n=ax();if(!n.contentDocument)throw"No document associated with iframe!";return(await ay(n.contentDocument,e,t,r,o,i)).submit(),n}async function aU(e,t,r,o,i,n,a){return o.addQueueMeasurement(k,n),new Promise((o,n)=>{t<1e4&&i.warning(`system.loadFrameTimeout or system.iframeHashTimeout set to lower (${t}ms) than the default (10000ms). This may result in timeouts.`);let s=window.setTimeout(()=>{window.clearInterval(c),n(ru(tD))},t),c=window.setInterval(()=>{let t="",r=e.contentWindow;try{t=r?r.location.href:""}catch(e){}if(!t||"about:blank"===t)return;let i="";r&&(i=a===ez.ServerResponseType.QUERY?r.location.search:r.location.hash),window.clearTimeout(s),window.clearInterval(c),o(i)},r)}).finally(()=>{i2(aF,"removeHiddenIframe",i,o,n)(e)})}function aD(e,t,r,o){return r.addQueueMeasurement(S,o),new Promise((r,o)=>{let i=ax();window.setTimeout(()=>{i?(i.src=e,r(i)):o("Unable to load iframe")},t)})}function aH(e){let t=ax();return t.src=e,t}function ax(){let e=document.createElement("iframe");return e.className="msalSilentIframe",e.style.visibility="hidden",e.style.position="absolute",e.style.width=e.style.height="0",e.style.border="0",e.setAttribute("sandbox","allow-scripts allow-same-origin allow-forms"),e.setAttribute("allow","local-network-access *"),document.body.appendChild(e),e}function aF(e){document.body===e.parentNode&&document.body.removeChild(e)}class aB extends n5{constructor(e,t,r,o,i,n,a,s,c,l,h){super(e,t,r,o,i,n,s,l,h),this.apiId=a,this.nativeStorage=c}async acquireToken(e){this.performanceClient.addQueueMeasurement(a,e.correlationId),e.loginHint||e.sid||e.account&&e.account.username||this.logger.warning("No user hint provided. The authorization server may need more information to complete this request.");let t={...e};t.prompt?t.prompt!==ez.PromptValue.NONE&&t.prompt!==ez.PromptValue.NO_SESSION&&(this.logger.warning(`SilentIframeClient. Replacing invalid prompt ${t.prompt} with ${ez.PromptValue.NONE}`),t.prompt=ez.PromptValue.NONE):t.prompt=ez.PromptValue.NONE;let r=await i6(this.initializeAuthorizationRequest.bind(this),b,this.logger,this.performanceClient,e.correlationId)(t,tA.InteractionType.Silent);return(r.platformBroker=aP(this.config,this.logger,this.platformAuthProvider,r.authenticationScheme),i_(r.authority),this.config.auth.protocolMode===ec.ProtocolMode.EAR)?this.executeEarFlow(r):this.executeCodeFlow(r)}async executeCodeFlow(e){let t,r=this.initializeServerTelemetryManager(this.apiId);try{return t=await i6(this.createAuthCodeClient.bind(this),_,this.logger,this.performanceClient,e.correlationId)({serverTelemetryManager:r,requestAuthority:e.authority,requestAzureCloudOptions:e.azureCloudOptions,requestExtraQueryParameters:e.extraQueryParameters,account:e.account}),await i6(this.silentTokenHelper.bind(this),v,this.logger,this.performanceClient,e.correlationId)(t,e)}catch(o){if(o instanceof el.AuthError&&(o.setCorrelationId(this.correlationId),r.cacheFailedRequest(o)),!t||!(o instanceof el.AuthError)||o.errorCode!==tA.BrowserConstants.INVALID_GRANT_ERROR)throw o;return this.performanceClient.addFields({retryError:o.errorCode},this.correlationId),await i6(this.silentTokenHelper.bind(this),v,this.logger,this.performanceClient,this.correlationId)(t,e)}}async executeEarFlow(e){let t=e.correlationId,r=await i6(this.getDiscoveredAuthority.bind(this),c,this.logger,this.performanceClient,t)({requestAuthority:e.authority,requestAzureCloudOptions:e.azureCloudOptions,requestExtraQueryParameters:e.extraQueryParameters,account:e.account}),o=await i6(ic,en,this.logger,this.performanceClient,t)(),i=await i6(av,ee,this.logger,this.performanceClient,t)(this.performanceClient,this.logger,t),n={...e,earJwk:o,codeChallenge:i.challenge},a=await i6(aL,E,this.logger,this.performanceClient,t)(this.config,r,n,this.logger,this.performanceClient),s=this.config.auth.OIDCOptions.serverResponseType,l=await i6(aU,k,this.logger,this.performanceClient,t)(a,this.config.system.iframeHashTimeout,this.config.system.pollIntervalMilliseconds,this.performanceClient,this.logger,t,s),h=i2(n9,K,this.logger,this.performanceClient,t)(l,s,this.logger);if(h.ear_jwe||!h.code)return i6(aw,M,this.logger,this.performanceClient,t)(n,h,this.apiId,this.config,r,this.browserStorage,this.nativeStorage,this.eventHandler,this.logger,this.performanceClient,this.platformAuthProvider);{let o=await i6(this.createAuthCodeClient.bind(this),_,this.logger,this.performanceClient,t)({serverTelemetryManager:this.initializeServerTelemetryManager(this.apiId),requestAuthority:e.authority,requestAzureCloudOptions:e.azureCloudOptions,requestExtraQueryParameters:e.extraQueryParameters,account:e.account,authority:r});return i6(aI,L,this.logger,this.performanceClient,t)(n,h,i.verifier,this.apiId,this.config,o,this.browserStorage,this.nativeStorage,this.eventHandler,this.logger,this.performanceClient,this.platformAuthProvider)}}logout(){return Promise.reject(ru(tK))}async silentTokenHelper(e,t){let r,o=t.correlationId;this.performanceClient.addQueueMeasurement(v,o);let i=await i6(av,ee,this.logger,this.performanceClient,o)(this.performanceClient,this.logger,o),n={...t,codeChallenge:i.challenge};if(t.httpMethod===ez.HttpMethod.POST)r=await i6(aq,E,this.logger,this.performanceClient,o)(this.config,e.authority,n,this.logger,this.performanceClient);else{let t=await i6(af,P,this.logger,this.performanceClient,o)(this.config,e.authority,n,this.logger,this.performanceClient);r=await i6(aM,E,this.logger,this.performanceClient,o)(t,this.performanceClient,this.logger,o,this.config.system.navigateFrameWait)}let a=this.config.auth.OIDCOptions.serverResponseType,s=await i6(aU,k,this.logger,this.performanceClient,o)(r,this.config.system.iframeHashTimeout,this.config.system.pollIntervalMilliseconds,this.performanceClient,this.logger,o,a),c=i2(n9,K,this.logger,this.performanceClient,o)(s,a,this.logger);return i6(aI,L,this.logger,this.performanceClient,o)(t,c,i.verifier,this.apiId,this.config,e,this.browserStorage,this.nativeStorage,this.eventHandler,this.logger,this.performanceClient,this.platformAuthProvider)}}var aK=nv;class az extends nG{constructor(e,t){super(e,t)}async acquireToken(e){this.performanceClient?.addQueueMeasurement(g,e.correlationId);let t=i3(),r=await i6(this.executeTokenRequest.bind(this),u,this.logger,this.performanceClient,e.correlationId)(e,this.authority),o=r.headers?.[ez.HeaderNames.X_MS_REQUEST_ID],i=new nJ(this.config.authOptions.clientId,this.cacheManager,this.cryptoUtils,this.logger,this.config.serializableCache,this.config.persistencePlugin);return i.validateTokenResponse(r.body),i6(i.handleServerTokenResponse.bind(i),B,this.logger,this.performanceClient,e.correlationId)(r.body,this.authority,t,e,void 0,void 0,!0,e.forceCache,o)}async acquireTokenByRefreshToken(e){if(!e)throw eD(ey);if(this.performanceClient?.addQueueMeasurement(m,e.correlationId),!e.account)throw(0,ex.createClientAuthError)(eF.noAccountInSilentRequest);if(this.cacheManager.isAppMetadataFOCI(e.account.environment))try{return await i6(this.acquireTokenWithCachedRefreshToken.bind(this),p,this.logger,this.performanceClient,e.correlationId)(e,!0)}catch(r){let e=r instanceof nA.InteractionRequiredAuthError&&r.errorCode===aK.noTokensFound,t=r instanceof n$&&r.errorCode===ez.Errors.INVALID_GRANT_ERROR&&r.subError===ez.Errors.CLIENT_MISMATCH_ERROR;if(e||t);else throw r}return i6(this.acquireTokenWithCachedRefreshToken.bind(this),p,this.logger,this.performanceClient,e.correlationId)(e,!1)}async acquireTokenWithCachedRefreshToken(e,t){this.performanceClient?.addQueueMeasurement(p,e.correlationId);let r=i2(this.cacheManager.getRefreshToken.bind(this.cacheManager),"cacheManagerGetRefreshToken",this.logger,this.performanceClient,e.correlationId)(e.account,t,e.correlationId,void 0,this.performanceClient);if(!r)throw(0,nA.createInteractionRequiredAuthError)(aK.noTokensFound);if(r.expiresOn&&i9(r.expiresOn,e.refreshTokenExpirationOffsetSeconds||300))throw this.performanceClient?.addFields({rtExpiresOnMs:Number(r.expiresOn)},e.correlationId),(0,nA.createInteractionRequiredAuthError)(aK.refreshTokenExpired);let o={...e,refreshToken:r.secret,authenticationScheme:e.authenticationScheme||ez.AuthenticationScheme.BEARER,ccsCredential:{credential:e.account.homeAccountId,type:nF}};try{return await i6(this.acquireToken.bind(this),g,this.logger,this.performanceClient,e.correlationId)(o)}catch(t){if(t instanceof nA.InteractionRequiredAuthError&&(this.performanceClient?.addFields({rtExpiresOnMs:Number(r.expiresOn)},e.correlationId),t.subError===aK.badToken)){this.logger.verbose("acquireTokenWithRefreshToken: bad refresh token, removing from cache");let t=this.cacheManager.generateCredentialKey(r);this.cacheManager.removeRefreshToken(t,e.correlationId)}throw t}}async executeTokenRequest(e,t){this.performanceClient?.addQueueMeasurement(u,e.correlationId);let r=this.createTokenQueryParameters(e),o=e5.appendQueryString(t.tokenEndpoint,r),i=await i6(this.createTokenRequestBody.bind(this),f,this.logger,this.performanceClient,e.correlationId)(e),n=this.createTokenRequestHeaders(e.ccsCredential),a=nw(this.config.authOptions.clientId,e);return i6(this.executePostToTokenEndpoint.bind(this),h,this.logger,this.performanceClient,e.correlationId)(o,i,n,a,e.correlationId,h)}async createTokenRequestBody(e){this.performanceClient?.addQueueMeasurement(f,e.correlationId);let t=new Map;if(oa(t,e.embeddedClientId||e.tokenBodyParameters?.[rA]||this.config.authOptions.clientId),e.redirectUri&&os(t,e.redirectUri),on(t,e.scopes,!0,this.config.authOptions.authority.options.OIDCOptions?.defaultScopes),oN(t,ez.GrantType.REFRESH_TOKEN_GRANT),oM(t),oy(t,this.config.libraryInfo),oC(t,this.config.telemetry.application),oK(t),this.serverTelemetryManager&&!tT(this.config)&&oB(t,this.serverTelemetryManager),ok(t,e.refreshToken),this.config.clientCredentials.clientSecret&&o_(t,this.config.clientCredentials.clientSecret),this.config.clientCredentials.clientAssertion){let r=this.config.clientCredentials.clientAssertion;oR(t,await nX(r.assertion,this.config.authOptions.clientId,e.resourceRequestUri)),ob(t,r.assertionType)}if(e.authenticationScheme===ez.AuthenticationScheme.POP){let r=new nj(this.cryptoUtils,this.performanceClient);ox(t,e.popKid?this.cryptoUtils.encodeKid(e.popKid):(await i6(r.generateCnf.bind(r),F,this.logger,this.performanceClient,e.correlationId)(e,this.logger)).reqCnfString)}else if(e.authenticationScheme===ez.AuthenticationScheme.SSH)if(e.sshJwk)oF(t,e.sshJwk);else throw eD(eE);if((!eV.isEmptyObj(e.claims)||this.config.authOptions.clientCapabilities&&this.config.authOptions.clientCapabilities.length>0)&&om(t,e.claims,this.config.authOptions.clientCapabilities),this.config.systemOptions.preventCorsPreflight&&e.ccsCredential)switch(e.ccsCredential.type){case nF:try{let r=(0,nB.buildClientInfoFromHomeAccountId)(e.ccsCredential.credential);og(t,r)}catch(e){this.logger.verbose("Could not parse home account ID for CCS Header: "+e)}break;case"UPN":ou(t,e.ccsCredential.credential)}return e.embeddedClientId&&o$(t,this.config.authOptions.clientId,this.config.authOptions.redirectUri),e.tokenBodyParameters&&oL(t,e.tokenBodyParameters),ot(t,e.correlationId,this.performanceClient),e4(t)}}class a$ extends n5{async acquireToken(e){this.performanceClient.addQueueMeasurement(s,e.correlationId);let t=await i6(n6,I,this.logger,this.performanceClient,e.correlationId)(e,this.config,this.performanceClient,this.logger),r={...e,...t};e.redirectUri&&(r.redirectUri=this.getRedirectUri(e.redirectUri));let o=this.initializeServerTelemetryManager(tA.ApiId.acquireTokenSilent_silentFlow),i=await this.createRefreshTokenClient({serverTelemetryManager:o,authorityUrl:r.authority,azureCloudOptions:r.azureCloudOptions,account:r.account});return i6(i.acquireTokenByRefreshToken.bind(i),m,this.logger,this.performanceClient,e.correlationId)(r).catch(e=>{throw e.setCorrelationId(this.correlationId),o.cacheFailedRequest(e),e})}logout(){return Promise.reject(ru(tK))}async createRefreshTokenClient(e){return new az(await i6(this.getClientConfiguration.bind(this),R,this.logger,this.performanceClient,this.correlationId)({serverTelemetryManager:e.serverTelemetryManager,requestAuthority:e.authorityUrl,requestAzureCloudOptions:e.azureCloudOptions,requestExtraQueryParameters:e.extraQueryParameters,account:e.account}),this.performanceClient)}}var nI=nI,nk=nk,nE=nE;class aQ{constructor(e,t,r,o){this.isBrowserEnvironment="undefined"!=typeof window,this.config=e,this.storage=t,this.logger=r,this.cryptoObj=o}async loadExternalTokens(e,t,r){if(!this.isBrowserEnvironment)throw ru(tW);let o=e.correlationId||ir(),i=t.id_token?nI.extractTokenClaims(t.id_token,oX):void 0,n=nI.isKmsi(i||{}),a={protocolMode:this.config.auth.protocolMode,knownAuthorities:this.config.auth.knownAuthorities,cloudDiscoveryMetadata:this.config.auth.cloudDiscoveryMetadata,authorityMetadata:this.config.auth.authorityMetadata,skipAuthorityMetadataCache:this.config.auth.skipAuthorityMetadataCache},s=e.authority?new nC(nC.generateAuthority(e.authority,e.azureCloudOptions),this.config.system.networkClient,this.storage,a,this.logger,e.correlationId||ir()):void 0,c=await this.loadAccount(e,r.clientInfo||t.client_info||"",o,i,s),l=await this.loadIdToken(t,c.homeAccountId,c.environment,c.realm,o,n),h=await this.loadAccessToken(e,t,c.homeAccountId,c.environment,c.realm,r,o,n),d=await this.loadRefreshToken(t,c.homeAccountId,c.environment,o,n);return this.generateAuthenticationResult(e,{account:c,idToken:l,accessToken:h,refreshToken:d},i,s)}async loadAccount(e,t,r,o,i){if(this.logger.verbose("TokenCache - loading account"),e.account){let t=eW.AccountEntity.createFromAccountInfo(e.account);return await this.storage.setAccount(t,r,nI.isKmsi(o||{})),t}if(!i||!t&&!o)throw this.logger.error("TokenCache - if an account is not provided on the request, authority and either clientInfo or idToken must be provided instead."),ru(t1);let n=eW.AccountEntity.generateHomeAccountId(t,i.authorityType,this.logger,this.cryptoObj,o),a=o?.tid,s=nY(this.storage,i,n,oX,r,o,t,i.hostnameAndPort,a,void 0,void 0,this.logger);return await this.storage.setAccount(s,r,nI.isKmsi(o||{})),s}async loadIdToken(e,t,r,o,i,n){if(!e.id_token)return this.logger.verbose("TokenCache - no id token found in response"),null;this.logger.verbose("TokenCache - loading id token");let a=nk.createIdTokenEntity(t,r,e.id_token,this.config.auth.clientId,o);return await this.storage.setIdTokenCredential(a,i,n),a}async loadAccessToken(e,t,r,o,i,n,a,s){if(!t.access_token)return this.logger.verbose("TokenCache - no access token found in response"),null;if(!t.expires_in)return this.logger.error("TokenCache - no expiration set on the access token. Cannot add it to the cache."),null;if(!t.scope&&(!e.scopes||!e.scopes.length))return this.logger.error("TokenCache - scopes not specified in the request or response. Cannot add token to the cache."),null;this.logger.verbose("TokenCache - loading access token");let c=t.scope?ej.fromString(t.scope):new ej(e.scopes),l=n.expiresOn||t.expires_in+nE.nowSeconds(),h=n.extendedExpiresOn||(t.ext_expires_in||t.expires_in)+nE.nowSeconds(),d=nk.createAccessTokenEntity(r,o,t.access_token,this.config.auth.clientId,i,c.printScopes(),l,h,oX);return await this.storage.setAccessTokenCredential(d,a,s),d}async loadRefreshToken(e,t,r,o,i){if(!e.refresh_token)return this.logger.verbose("TokenCache - no refresh token found in response"),null;this.logger.verbose("TokenCache - loading refresh token");let n=nk.createRefreshTokenEntity(t,r,e.refresh_token,this.config.auth.clientId,e.foci,void 0,e.refresh_token_expires_in);return await this.storage.setRefreshTokenCredential(n,o,i),n}generateAuthenticationResult(e,t,r,o){let i,n="",a=[],s=null;t?.accessToken&&(n=t.accessToken.secret,a=ej.fromString(t.accessToken.target).asArray(),s=nE.toDateFromSeconds(t.accessToken.expiresOn),i=nE.toDateFromSeconds(t.accessToken.extendedExpiresOn));let c=t.account;return{authority:o?o.canonicalAuthority:"",uniqueId:t.account.localAccountId,tenantId:t.account.realm,scopes:a,account:eW.AccountEntity.getAccountInfo(c),idToken:t.idToken?.secret||"",idTokenClaims:r||{},accessToken:n,fromCache:!0,expiresOn:s,correlationId:e.correlationId||"",requestId:"",extExpiresOn:i,familyId:t.refreshToken?.familyId||"",tokenType:t?.accessToken?.tokenType||"",state:e.state||"",cloudGraphHostName:c.cloudGraphHostName||"",msGraphHost:c.msGraphHost||"",fromNativeBroker:!1}}}class aG extends nZ{constructor(e){super(e),this.includeRedirectUri=!1}}class aV extends n5{constructor(e,t,r,o,i,n,a,s,c,l){super(e,t,r,o,i,n,s,c,l),this.apiId=a}async acquireToken(e){if(!e.code)throw ru(t6);let t=await i6(this.initializeAuthorizationRequest.bind(this),b,this.logger,this.performanceClient,e.correlationId)(e,tA.InteractionType.Silent),r=this.initializeServerTelemetryManager(this.apiId);try{let o={...t,code:e.code},i=await i6(this.getClientConfiguration.bind(this),R,this.logger,this.performanceClient,e.correlationId)({serverTelemetryManager:r,requestAuthority:t.authority,requestAzureCloudOptions:t.azureCloudOptions,requestExtraQueryParameters:t.extraQueryParameters,account:t.account}),n=new aG(i);this.logger.verbose("Auth code client created");let a=new ai(n,this.browserStorage,o,this.logger,this.performanceClient);return await i6(a.handleCodeResponseFromServer.bind(a),O,this.logger,this.performanceClient,e.correlationId)({code:e.code,msgraph_host:e.msGraphHost,cloud_graph_host_name:e.cloudGraphHostName,cloud_instance_host_name:e.cloudInstanceHostName},t,!1)}catch(e){throw e instanceof el.AuthError&&(e.setCorrelationId(this.correlationId),r.cacheFailedRequest(e)),e}}logout(){return Promise.reject(ru(tK))}}function aj(e,t,r){try{ik(e)}catch(e){throw t.end({success:!1},e,r),e}}class aW{constructor(e){var t,r,o,i;this.operatingContext=e,this.isBrowserEnvironment=this.operatingContext.isBrowserEnvironment(),this.config=e.getConfig(),this.initialized=!1,this.logger=this.operatingContext.getLogger(),this.networkClient=this.config.system.networkClient,this.navigationClient=this.config.system.navigationClient,this.redirectResponse=new Map,this.hybridAuthCodeResponses=new Map,this.performanceClient=this.config.telemetry.client,this.browserCrypto=this.isBrowserEnvironment?new iZ(this.logger,this.performanceClient):eK,this.eventHandler=new nx(this.logger),this.browserStorage=this.isBrowserEnvironment?new nD(this.config.auth.clientId,this.config.cache,this.browserCrypto,this.logger,this.performanceClient,this.eventHandler,function(e){let t,r=e.cloudDiscoveryMetadata;if(r)try{t=JSON.parse(r)}catch(e){throw eD(eI)}return{canonicalAuthority:e.authority?nT(e.authority):void 0,knownAuthorities:e.knownAuthorities,cloudDiscoveryMetadata:t}}(this.config.auth)):(t=this.config.auth.clientId,r=this.logger,o=this.performanceClient,i=this.eventHandler,new nD(t,{cacheLocation:tA.BrowserCacheLocation.MemoryStorage,cacheRetentionDays:5,temporaryCacheLocation:tA.BrowserCacheLocation.MemoryStorage,storeAuthStateInCookie:!1,secureCookies:!1,cacheMigrationEnabled:!1,claimsBasedCachingEnabled:!1},eK,r,o,i));const n={cacheLocation:tA.BrowserCacheLocation.MemoryStorage,cacheRetentionDays:5,temporaryCacheLocation:tA.BrowserCacheLocation.MemoryStorage,storeAuthStateInCookie:!1,secureCookies:!1,cacheMigrationEnabled:!1,claimsBasedCachingEnabled:!1};this.nativeInternalStorage=new nD(this.config.auth.clientId,n,this.browserCrypto,this.logger,this.performanceClient,this.eventHandler),this.tokenCache=new aQ(this.config,this.browserStorage,this.logger,this.browserCrypto),this.activeSilentTokenRequests=new Map,this.trackPageVisibility=this.trackPageVisibility.bind(this),this.trackPageVisibilityWithMeasurement=this.trackPageVisibilityWithMeasurement.bind(this)}static async createController(e,t){let r=new aW(e);return await r.initialize(t),r}trackPageVisibility(e){e&&(this.logger.info("Perf: Visibility change detected"),this.performanceClient.incrementFields({visibilityChangeCount:1},e))}async initialize(e,t){if(this.logger.trace("initialize called"),this.initialized)return void this.logger.info("initialize has already been called, exiting early.");if(!this.isBrowserEnvironment){this.logger.info("in non-browser environment, exiting early."),this.initialized=!0,this.eventHandler.emitEvent(nL.EventType.INITIALIZE_END);return}let r=e?.correlationId||this.getRequestCorrelationId(),o=this.config.system.allowPlatformBroker,i=this.performanceClient.startMeasurement("initializeClientApplication",r);if(this.eventHandler.emitEvent(nL.EventType.INITIALIZE_START),!t)try{this.logMultipleInstances(i)}catch{}if(await i6(this.browserStorage.initialize.bind(this.browserStorage),"initializeCache",this.logger,this.performanceClient,r)(r),o)try{this.platformAuthProvider=await ab(this.logger,this.performanceClient,r,this.config.system.nativeBrokerHandshakeTimeout,this.config.system.allowPlatformBrokerWithDOM)}catch(e){this.logger.verbose(e)}this.config.cache.claimsBasedCachingEnabled||(this.logger.verbose("Claims-based caching is disabled. Clearing the previous cache with claims"),i2(this.browserStorage.clearTokensAndKeysWithClaims.bind(this.browserStorage),Z,this.logger,this.performanceClient,r)(r)),this.config.system.asyncPopups&&await this.preGeneratePkceCodes(r),this.initialized=!0,this.eventHandler.emitEvent(nL.EventType.INITIALIZE_END),i.end({allowPlatformBroker:o,success:!0})}async handleRedirectPromise(e){if(this.logger.verbose("handleRedirectPromise called"),iE(this.initialized),this.isBrowserEnvironment){let t=e||"",r=this.redirectResponse.get(t);return void 0===r?(r=this.handleRedirectPromiseInternal(e),this.redirectResponse.set(t,r),this.logger.verbose("handleRedirectPromise has been called for the first time, storing the promise")):this.logger.verbose("handleRedirectPromise has been called previously, returning the result from the first call"),r}return this.logger.verbose("handleRedirectPromise returns null, not browser environment"),null}async handleRedirectPromiseInternal(e){let t,r;if(!this.browserStorage.isInteractionInProgress(!0))return this.logger.info("handleRedirectPromise called but there is no interaction in progress, returning null."),null;if(this.browserStorage.getInteractionInProgress()?.type===tA.INTERACTION_TYPE.SIGNOUT)return this.logger.verbose("handleRedirectPromise removing interaction_in_progress flag and returning null after sign-out"),this.browserStorage.setInteractionInProgress(!1),Promise.resolve(null);let o=this.getAllAccounts(),n=this.browserStorage.getCachedNativeRequest(),a=n&&this.platformAuthProvider&&!e;this.eventHandler.emitEvent(nL.EventType.HANDLE_REDIRECT_START,tA.InteractionType.Redirect);try{if(a&&this.platformAuthProvider){t=this.performanceClient.startMeasurement(i,n?.correlationId||""),this.logger.trace("handleRedirectPromise - acquiring token from native platform"),t.add({isPlatformBrokerRequest:!0});let e=new ap(this.config,this.browserStorage,this.browserCrypto,this.logger,this.eventHandler,this.navigationClient,tA.ApiId.handleRedirectPromise,this.performanceClient,this.platformAuthProvider,n.accountId,this.nativeInternalStorage,n.correlationId);r=i6(e.handleRedirectPromise.bind(e),"handleNativeRedirectPromise",this.logger,this.performanceClient,t.event.correlationId)(this.performanceClient,t.event.correlationId)}else{let[o,n]=this.browserStorage.getCachedRequest(),a=o.correlationId;t=this.performanceClient.startMeasurement(i,a),this.logger.trace("handleRedirectPromise - acquiring token from web flow");let s=this.createRedirectClient(a);r=i6(s.handleRedirectPromise.bind(s),"handleRedirectPromise",this.logger,this.performanceClient,t.event.correlationId)(e,o,n,t)}}catch(e){throw this.browserStorage.resetRequestCache(),e}return r.then(e=>(e?(this.browserStorage.resetRequestCache(),o.length<this.getAllAccounts().length?(this.eventHandler.emitEvent(nL.EventType.LOGIN_SUCCESS,tA.InteractionType.Redirect,e),this.logger.verbose("handleRedirectResponse returned result, login success")):(this.eventHandler.emitEvent(nL.EventType.ACQUIRE_TOKEN_SUCCESS,tA.InteractionType.Redirect,e),this.logger.verbose("handleRedirectResponse returned result, acquire token success")),t.end({success:!0},void 0,e.account)):t.event.errorCode?t.end({success:!1},void 0):t.discard(),this.eventHandler.emitEvent(nL.EventType.HANDLE_REDIRECT_END,tA.InteractionType.Redirect),e)).catch(e=>{throw this.browserStorage.resetRequestCache(),o.length>0?this.eventHandler.emitEvent(nL.EventType.ACQUIRE_TOKEN_FAILURE,tA.InteractionType.Redirect,null,e):this.eventHandler.emitEvent(nL.EventType.LOGIN_FAILURE,tA.InteractionType.Redirect,null,e),this.eventHandler.emitEvent(nL.EventType.HANDLE_REDIRECT_END,tA.InteractionType.Redirect),t.end({success:!1},e),e})}async acquireTokenRedirect(e){let t=this.getRequestCorrelationId(e);this.logger.verbose("acquireTokenRedirect called",t);let r=this.performanceClient.startMeasurement("acquireTokenPreRedirect",t);r.add({scenarioId:e.scenarioId});let o=e.onRedirectNavigate;if(o)e.onRedirectNavigate=t=>{let i="function"==typeof o?o(t):void 0;return r.add({navigateCallbackResult:!1!==i}),r.event=r.end({success:!0},void 0,e.account)||r.event,i};else{let t=this.config.auth.onRedirectNavigate;this.config.auth.onRedirectNavigate=o=>{let i="function"==typeof t?t(o):void 0;return r.add({navigateCallbackResult:!1!==i}),r.event=r.end({success:!0},void 0,e.account)||r.event,i}}let n=this.getAllAccounts().length>0;try{let o;return iS(this.initialized,this.config),this.browserStorage.setInteractionInProgress(!0,tA.INTERACTION_TYPE.SIGNIN),n?this.eventHandler.emitEvent(nL.EventType.ACQUIRE_TOKEN_START,tA.InteractionType.Redirect,e):this.eventHandler.emitEvent(nL.EventType.LOGIN_START,tA.InteractionType.Redirect,e),o=this.platformAuthProvider&&this.canUsePlatformBroker(e)?new ap(this.config,this.browserStorage,this.browserCrypto,this.logger,this.eventHandler,this.navigationClient,tA.ApiId.acquireTokenRedirect,this.performanceClient,this.platformAuthProvider,this.getNativeAccountId(e),this.nativeInternalStorage,t).acquireTokenRedirect(e,r).catch(o=>{if(r.add({brokerErrorName:o.name,brokerErrorCode:o.errorCode}),o instanceof al&&ah(o))return this.platformAuthProvider=void 0,this.createRedirectClient(t).acquireToken(e);if(o instanceof nA.InteractionRequiredAuthError)return this.logger.verbose("acquireTokenRedirect - Resolving interaction required error thrown by native broker by falling back to web flow"),this.createRedirectClient(t).acquireToken(e);throw o}):this.createRedirectClient(t).acquireToken(e),await o}catch(o){throw this.browserStorage.resetRequestCache(),2===r.event.status?this.performanceClient.startMeasurement(i,t).end({success:!1},o,e.account):r.end({success:!1},o,e.account),n?this.eventHandler.emitEvent(nL.EventType.ACQUIRE_TOKEN_FAILURE,tA.InteractionType.Redirect,null,o):this.eventHandler.emitEvent(nL.EventType.LOGIN_FAILURE,tA.InteractionType.Redirect,null,o),o}}acquireTokenPopup(e){let t,r=this.getRequestCorrelationId(e),o=this.performanceClient.startMeasurement("acquireTokenPopup",r);o.add({scenarioId:e.scenarioId});try{this.logger.verbose("acquireTokenPopup called",r),aj(this.initialized,o,e.account),this.browserStorage.setInteractionInProgress(!0,tA.INTERACTION_TYPE.SIGNIN)}catch(e){return Promise.reject(e)}let i=this.getAllAccounts();i.length>0?this.eventHandler.emitEvent(nL.EventType.ACQUIRE_TOKEN_START,tA.InteractionType.Popup,e):this.eventHandler.emitEvent(nL.EventType.LOGIN_START,tA.InteractionType.Popup,e);let n=this.getPreGeneratedPkceCodes(r);return this.canUsePlatformBroker(e)?(o.add({isPlatformBrokerRequest:!0}),t=this.acquireTokenNative({...e,correlationId:r},tA.ApiId.acquireTokenPopup).then(e=>(o.end({success:!0},void 0,e.account),e)).catch(t=>{if(o.add({brokerErrorName:t.name,brokerErrorCode:t.errorCode}),t instanceof al&&ah(t))return this.platformAuthProvider=void 0,this.createPopupClient(r).acquireToken(e,n);if(t instanceof nA.InteractionRequiredAuthError)return this.logger.verbose("acquireTokenPopup - Resolving interaction required error thrown by native broker by falling back to web flow"),this.createPopupClient(r).acquireToken(e,n);throw t})):t=this.createPopupClient(r).acquireToken(e,n),t.then(e=>(i.length<this.getAllAccounts().length?this.eventHandler.emitEvent(nL.EventType.LOGIN_SUCCESS,tA.InteractionType.Popup,e):this.eventHandler.emitEvent(nL.EventType.ACQUIRE_TOKEN_SUCCESS,tA.InteractionType.Popup,e),o.end({success:!0,accessTokenSize:e.accessToken.length,idTokenSize:e.idToken.length},void 0,e.account),e)).catch(t=>(i.length>0?this.eventHandler.emitEvent(nL.EventType.ACQUIRE_TOKEN_FAILURE,tA.InteractionType.Popup,null,t):this.eventHandler.emitEvent(nL.EventType.LOGIN_FAILURE,tA.InteractionType.Popup,null,t),o.end({success:!1},t,e.account),Promise.reject(t))).finally(async()=>{this.browserStorage.setInteractionInProgress(!1),this.config.system.asyncPopups&&await this.preGeneratePkceCodes(r)})}trackPageVisibilityWithMeasurement(){let e=this.ssoSilentMeasurement||this.acquireTokenByCodeAsyncMeasurement;e&&(this.logger.info("Perf: Visibility change detected in ",e.event.name),e.increment({visibilityChangeCount:1}))}async ssoSilent(e){let t,r=this.getRequestCorrelationId(e),o={...e,prompt:e.prompt,correlationId:r};return this.ssoSilentMeasurement=this.performanceClient.startMeasurement("ssoSilent",r),this.ssoSilentMeasurement?.add({scenarioId:e.scenarioId}),aj(this.initialized,this.ssoSilentMeasurement,e.account),this.ssoSilentMeasurement?.increment({visibilityChangeCount:0}),document.addEventListener("visibilitychange",this.trackPageVisibilityWithMeasurement),this.logger.verbose("ssoSilent called",r),this.eventHandler.emitEvent(nL.EventType.SSO_SILENT_START,tA.InteractionType.Silent,o),this.canUsePlatformBroker(o)?(this.ssoSilentMeasurement?.add({isPlatformBrokerRequest:!0}),t=this.acquireTokenNative(o,tA.ApiId.ssoSilent).catch(e=>{if(this.ssoSilentMeasurement?.add({brokerErrorName:e.name,brokerErrorCode:e.errorCode}),e instanceof al&&ah(e))return this.platformAuthProvider=void 0,this.createSilentIframeClient(o.correlationId).acquireToken(o);throw e})):t=this.createSilentIframeClient(o.correlationId).acquireToken(o),t.then(e=>(this.eventHandler.emitEvent(nL.EventType.SSO_SILENT_SUCCESS,tA.InteractionType.Silent,e),this.ssoSilentMeasurement?.end({success:!0,accessTokenSize:e.accessToken.length,idTokenSize:e.idToken.length},void 0,e.account),e)).catch(t=>{throw this.eventHandler.emitEvent(nL.EventType.SSO_SILENT_FAILURE,tA.InteractionType.Silent,null,t),this.ssoSilentMeasurement?.end({success:!1},t,e.account),t}).finally(()=>{document.removeEventListener("visibilitychange",this.trackPageVisibilityWithMeasurement)})}async acquireTokenByCode(e){let t=this.getRequestCorrelationId(e);this.logger.trace("acquireTokenByCode called",t);let r=this.performanceClient.startMeasurement("acquireTokenByCode",t);aj(this.initialized,r),this.eventHandler.emitEvent(nL.EventType.ACQUIRE_TOKEN_BY_CODE_START,tA.InteractionType.Silent,e),r.add({scenarioId:e.scenarioId});try{if(e.code&&e.nativeAccountId)throw ru(t3);if(e.code){let o=e.code,i=this.hybridAuthCodeResponses.get(o);return i?(this.logger.verbose("Existing acquireTokenByCode request found",t),r.discard()):(this.logger.verbose("Initiating new acquireTokenByCode request",t),i=this.acquireTokenByCodeAsync({...e,correlationId:t}).then(e=>(this.eventHandler.emitEvent(nL.EventType.ACQUIRE_TOKEN_BY_CODE_SUCCESS,tA.InteractionType.Silent,e),this.hybridAuthCodeResponses.delete(o),r.end({success:!0,accessTokenSize:e.accessToken.length,idTokenSize:e.idToken.length},void 0,e.account),e)).catch(e=>{throw this.hybridAuthCodeResponses.delete(o),this.eventHandler.emitEvent(nL.EventType.ACQUIRE_TOKEN_BY_CODE_FAILURE,tA.InteractionType.Silent,null,e),r.end({success:!1},e),e}),this.hybridAuthCodeResponses.set(o,i)),await i}if(e.nativeAccountId)if(this.canUsePlatformBroker(e,e.nativeAccountId)){r.add({isPlatformBrokerRequest:!0});let o=await this.acquireTokenNative({...e,correlationId:t},tA.ApiId.acquireTokenByCode,e.nativeAccountId).catch(e=>{throw e instanceof al&&ah(e)&&(this.platformAuthProvider=void 0),r.add({brokerErrorName:e.name,brokerErrorCode:e.errorCode}),e});return r.end({success:!0},void 0,o.account),o}else throw ru(t8);else throw ru(t4)}catch(e){throw this.eventHandler.emitEvent(nL.EventType.ACQUIRE_TOKEN_BY_CODE_FAILURE,tA.InteractionType.Silent,null,e),r.end({success:!1},e),e}}async acquireTokenByCodeAsync(e){this.logger.trace("acquireTokenByCodeAsync called",e.correlationId),this.acquireTokenByCodeAsyncMeasurement=this.performanceClient.startMeasurement("acquireTokenByCodeAsync",e.correlationId),this.acquireTokenByCodeAsyncMeasurement?.increment({visibilityChangeCount:0}),document.addEventListener("visibilitychange",this.trackPageVisibilityWithMeasurement);let t=this.createSilentAuthCodeClient(e.correlationId);return await t.acquireToken(e).then(e=>(this.acquireTokenByCodeAsyncMeasurement?.end({success:!0,fromCache:e.fromCache}),e)).catch(e=>{throw this.acquireTokenByCodeAsyncMeasurement?.end({success:!1},e),e}).finally(()=>{document.removeEventListener("visibilitychange",this.trackPageVisibilityWithMeasurement)})}async acquireTokenFromCache(e,t){switch(this.performanceClient.addQueueMeasurement(y,e.correlationId),t){case tA.CacheLookupPolicy.Default:case tA.CacheLookupPolicy.AccessToken:case tA.CacheLookupPolicy.AccessTokenAndRefreshToken:let r=this.createSilentCacheClient(e.correlationId);return i6(r.acquireToken.bind(r),n,this.logger,this.performanceClient,e.correlationId)(e);default:throw(0,ex.createClientAuthError)(iK.tokenRefreshRequired)}}async acquireTokenByRefreshToken(e,t){switch(this.performanceClient.addQueueMeasurement(r,e.correlationId),t){case tA.CacheLookupPolicy.Default:case tA.CacheLookupPolicy.AccessTokenAndRefreshToken:case tA.CacheLookupPolicy.RefreshToken:case tA.CacheLookupPolicy.RefreshTokenAndNetwork:let o=this.createSilentRefreshClient(e.correlationId);return i6(o.acquireToken.bind(o),s,this.logger,this.performanceClient,e.correlationId)(e);default:throw(0,ex.createClientAuthError)(iK.tokenRefreshRequired)}}async acquireTokenBySilentIframe(e){this.performanceClient.addQueueMeasurement(A,e.correlationId);let t=this.createSilentIframeClient(e.correlationId);return i6(t.acquireToken.bind(t),a,this.logger,this.performanceClient,e.correlationId)(e)}async logout(e){let t=this.getRequestCorrelationId(e);return this.logger.warning("logout API is deprecated and will be removed in msal-browser v3.0.0. Use logoutRedirect instead.",t),this.logoutRedirect({correlationId:t,...e})}async logoutRedirect(e){let t=this.getRequestCorrelationId(e);return iS(this.initialized,this.config),this.browserStorage.setInteractionInProgress(!0,tA.INTERACTION_TYPE.SIGNOUT),this.createRedirectClient(t).logout(e)}logoutPopup(e){try{let t=this.getRequestCorrelationId(e);return ik(this.initialized),this.browserStorage.setInteractionInProgress(!0,tA.INTERACTION_TYPE.SIGNOUT),this.createPopupClient(t).logout(e).finally(()=>{this.browserStorage.setInteractionInProgress(!1)})}catch(e){return Promise.reject(e)}}async clearCache(e){if(!this.isBrowserEnvironment)return void this.logger.info("in non-browser environment, returning early.");let t=this.getRequestCorrelationId(e);return this.createSilentCacheClient(t).logout(e)}getAllAccounts(e){var t,r,o;let i=this.getRequestCorrelationId();return t=this.logger,r=this.browserStorage,o=this.isBrowserEnvironment,t.verbose("getAllAccounts called"),o?r.getAllAccounts(e||{},i):[]}getAccount(e){var t,r;let o,i=this.getRequestCorrelationId();return t=this.logger,r=this.browserStorage,(o=r.getAccountInfoFilteredBy(e,i))?(t.verbose("getAccount: Account matching provided filter found, returning"),o):(t.verbose("getAccount: No matching account found, returning null"),null)}getAccountByUsername(e){let t=this.getRequestCorrelationId();return function(e,t,r,o){if(t.trace("getAccountByUsername called"),!e)return t.warning("getAccountByUsername: No username provided"),null;let i=r.getAccountInfoFilteredBy({username:e},o);return i?(t.verbose("getAccountByUsername: Account matching username found, returning"),t.verbosePii(`getAccountByUsername: Returning signed-in accounts matching username: ${e}`),i):(t.verbose("getAccountByUsername: No matching account found, returning null"),null)}(e,this.logger,this.browserStorage,t)}getAccountByHomeId(e){let t=this.getRequestCorrelationId();return function(e,t,r,o){if(t.trace("getAccountByHomeId called"),!e)return t.warning("getAccountByHomeId: No homeAccountId provided"),null;let i=r.getAccountInfoFilteredBy({homeAccountId:e},o);return i?(t.verbose("getAccountByHomeId: Account matching homeAccountId found, returning"),t.verbosePii(`getAccountByHomeId: Returning signed-in accounts matching homeAccountId: ${e}`),i):(t.verbose("getAccountByHomeId: No matching account found, returning null"),null)}(e,this.logger,this.browserStorage,t)}getAccountByLocalId(e){let t=this.getRequestCorrelationId();return function(e,t,r,o){if(t.trace("getAccountByLocalId called"),!e)return t.warning("getAccountByLocalId: No localAccountId provided"),null;let i=r.getAccountInfoFilteredBy({localAccountId:e},o);return i?(t.verbose("getAccountByLocalId: Account matching localAccountId found, returning"),t.verbosePii(`getAccountByLocalId: Returning signed-in accounts matching localAccountId: ${e}`),i):(t.verbose("getAccountByLocalId: No matching account found, returning null"),null)}(e,this.logger,this.browserStorage,t)}setActiveAccount(e){var t;let r=this.getRequestCorrelationId();t=this.browserStorage,t.setActiveAccount(e,r)}getActiveAccount(){var e;let t=this.getRequestCorrelationId();return e=this.browserStorage,e.getActiveAccount(t)}async hydrateCache(e,t){this.logger.verbose("hydrateCache called");let r=eW.AccountEntity.createFromAccountInfo(e.account,e.cloudGraphHostName,e.msGraphHost);return(await this.browserStorage.setAccount(r,e.correlationId,nI.isKmsi(e.idTokenClaims)),e.fromNativeBroker)?(this.logger.verbose("Response was from native broker, storing in-memory"),this.nativeInternalStorage.hydrateCache(e,t)):this.browserStorage.hydrateCache(e,t)}async acquireTokenNative(e,t,r,o){if(this.logger.trace("acquireTokenNative called"),!this.platformAuthProvider)throw ru(re);return new ap(this.config,this.browserStorage,this.browserCrypto,this.logger,this.eventHandler,this.navigationClient,t,this.performanceClient,this.platformAuthProvider,r||this.getNativeAccountId(e),this.nativeInternalStorage,e.correlationId).acquireToken(e,o)}canUsePlatformBroker(e,t){if(this.logger.trace("canUsePlatformBroker called"),!this.platformAuthProvider)return this.logger.trace("canUsePlatformBroker: platform broker unavilable, returning false"),!1;if(!aP(this.config,this.logger,this.platformAuthProvider,e.authenticationScheme))return this.logger.trace("canUsePlatformBroker: isBrokerAvailable returned false, returning false"),!1;if(e.prompt)switch(e.prompt){case ez.PromptValue.NONE:case ez.PromptValue.CONSENT:case ez.PromptValue.LOGIN:case ez.PromptValue.SELECT_ACCOUNT:this.logger.trace("canUsePlatformBroker: prompt is compatible with platform broker flow");break;default:return this.logger.trace(`canUsePlatformBroker: prompt = ${e.prompt} is not compatible with platform broker flow, returning false`),!1}return!!t||!!this.getNativeAccountId(e)||(this.logger.trace("canUsePlatformBroker: nativeAccountId is not available, returning false"),!1)}getNativeAccountId(e){let t=e.account||this.getAccount({loginHint:e.loginHint,sid:e.sid})||this.getActiveAccount();return t&&t.nativeAccountId||""}createPopupClient(e){return new aO(this.config,this.browserStorage,this.browserCrypto,this.logger,this.eventHandler,this.navigationClient,this.performanceClient,this.nativeInternalStorage,this.platformAuthProvider,e)}createRedirectClient(e){return new aN(this.config,this.browserStorage,this.browserCrypto,this.logger,this.eventHandler,this.navigationClient,this.performanceClient,this.nativeInternalStorage,this.platformAuthProvider,e)}createSilentIframeClient(e){return new aB(this.config,this.browserStorage,this.browserCrypto,this.logger,this.eventHandler,this.navigationClient,tA.ApiId.ssoSilent,this.performanceClient,this.nativeInternalStorage,this.platformAuthProvider,e)}createSilentCacheClient(e){return new ag(this.config,this.browserStorage,this.browserCrypto,this.logger,this.eventHandler,this.navigationClient,this.performanceClient,this.platformAuthProvider,e)}createSilentRefreshClient(e){return new a$(this.config,this.browserStorage,this.browserCrypto,this.logger,this.eventHandler,this.navigationClient,this.performanceClient,this.platformAuthProvider,e)}createSilentAuthCodeClient(e){return new aV(this.config,this.browserStorage,this.browserCrypto,this.logger,this.eventHandler,this.navigationClient,tA.ApiId.acquireTokenByCode,this.performanceClient,this.platformAuthProvider,e)}addEventCallback(e,t){return this.eventHandler.addEventCallback(e,t)}removeEventCallback(e){this.eventHandler.removeEventCallback(e)}addPerformanceCallback(e){return iv(),this.performanceClient.addPerformanceCallback(e)}removePerformanceCallback(e){return this.performanceClient.removePerformanceCallback(e)}enableAccountStorageEvents(){this.config.cache.cacheLocation!==tA.BrowserCacheLocation.LocalStorage?this.logger.info("Account storage events are only available when cacheLocation is set to localStorage"):this.eventHandler.subscribeCrossTab()}disableAccountStorageEvents(){this.config.cache.cacheLocation!==tA.BrowserCacheLocation.LocalStorage?this.logger.info("Account storage events are only available when cacheLocation is set to localStorage"):this.eventHandler.unsubscribeCrossTab()}getTokenCache(){return this.tokenCache}getLogger(){return this.logger}setLogger(e){this.logger=e}initializeWrapperLibrary(e,t){this.browserStorage.setWrapperMetadata(e,t)}setNavigationClient(e){this.navigationClient=e}getConfiguration(){return this.config}getPerformanceClient(){return this.performanceClient}isBrowserEnv(){return this.isBrowserEnvironment}getRequestCorrelationId(e){return e?.correlationId?e.correlationId:this.isBrowserEnvironment?ir():ez.Constants.EMPTY_STRING}async loginRedirect(e){let t=this.getRequestCorrelationId(e);return this.logger.verbose("loginRedirect called",t),this.acquireTokenRedirect({correlationId:t,...e||tA.DEFAULT_REQUEST})}loginPopup(e){let t=this.getRequestCorrelationId(e);return this.logger.verbose("loginPopup called",t),this.acquireTokenPopup({correlationId:t,...e||tA.DEFAULT_REQUEST})}async acquireTokenSilent(e){let t=this.getRequestCorrelationId(e),r=this.performanceClient.startMeasurement("acquireTokenSilent",t);r.add({cacheLookupPolicy:e.cacheLookupPolicy,scenarioId:e.scenarioId}),aj(this.initialized,r,e.account),this.logger.verbose("acquireTokenSilent called",t);let o=e.account||this.getActiveAccount();if(!o)throw ru(tz);return this.acquireTokenSilentDeduped(e,o,t).then(o=>(r.end({success:!0,fromCache:o.fromCache,accessTokenSize:o.accessToken.length,idTokenSize:o.idToken.length},void 0,o.account),{...o,state:e.state,correlationId:t})).catch(e=>{throw e instanceof el.AuthError&&e.setCorrelationId(t),r.end({success:!1},e,o),e})}async acquireTokenSilentDeduped(e,t,r){let i=JSON.stringify(nw(this.config.auth.clientId,{...e,authority:e.authority||this.config.auth.authority,correlationId:r},t.homeAccountId)),n=this.activeSilentTokenRequests.get(i);if(void 0!==n)return this.logger.verbose("acquireTokenSilent has been called previously, returning the result from the first call",r),this.performanceClient.addFields({deduped:!0},r),n;{this.logger.verbose("acquireTokenSilent called for the first time, storing active request",r),this.performanceClient.addFields({deduped:!1},r);let n=i6(this.acquireTokenSilentAsync.bind(this),o,this.logger,this.performanceClient,r)({...e,correlationId:r},t);return this.activeSilentTokenRequests.set(i,n),n.finally(()=>{this.activeSilentTokenRequests.delete(i)})}}async acquireTokenSilentAsync(e,t){let r=()=>this.trackPageVisibility(e.correlationId);this.performanceClient.addQueueMeasurement(o,e.correlationId),this.eventHandler.emitEvent(nL.EventType.ACQUIRE_TOKEN_START,tA.InteractionType.Silent,e),e.correlationId&&this.performanceClient.incrementFields({visibilityChangeCount:0},e.correlationId),document.addEventListener("visibilitychange",r);let i=await i6(n4,w,this.logger,this.performanceClient,e.correlationId)(e,t,this.config,this.performanceClient,this.logger),n=e.cacheLookupPolicy||tA.CacheLookupPolicy.Default;return this.acquireTokenSilentNoIframe(i,n).catch(async e=>{var t,r;let o,a,s,c;if(t=e,r=n,o=!(t instanceof nA.InteractionRequiredAuthError&&t.subError!==nv.badToken),a=t.errorCode===tA.BrowserConstants.INVALID_GRANT_ERROR||t.errorCode===iK.tokenRefreshRequired,s=o&&a||t.errorCode===nv.noTokensFound||t.errorCode===nv.refreshTokenExpired,c=tA.iFrameRenewalPolicies.includes(r),s&&c)if(this.activeIframeRequest)if(n===tA.CacheLookupPolicy.Skip)return this.logger.warning("Another iframe request is currently in progress and CacheLookupPolicy is set to Skip. This may result in degraded performance and/or reliability for both calls. Please consider changing the CacheLookupPolicy to take advantage of request queuing and token cache.",i.correlationId),i6(this.acquireTokenBySilentIframe.bind(this),A,this.logger,this.performanceClient,i.correlationId)(i);else{let[t,r]=this.activeIframeRequest;this.logger.verbose(`Iframe request is already in progress, awaiting resolution for request with correlationId: ${r}`,i.correlationId);let o=this.performanceClient.startMeasurement("awaitConcurrentIframe",i.correlationId);o.add({awaitIframeCorrelationId:r});let a=await t;if(o.end({success:a}),a)return this.logger.verbose(`Parallel iframe request with correlationId: ${r} succeeded. Retrying cache and/or RT redemption`,i.correlationId),this.acquireTokenSilentNoIframe(i,n);throw this.logger.info(`Iframe request with correlationId: ${r} failed. Interaction is required.`),e}else{let e;return this.activeIframeRequest=[new Promise(t=>{e=t}),i.correlationId],this.logger.verbose("Refresh token expired/invalid or CacheLookupPolicy is set to Skip, attempting acquire token by iframe.",i.correlationId),i6(this.acquireTokenBySilentIframe.bind(this),A,this.logger,this.performanceClient,i.correlationId)(i).then(t=>(e(!0),t)).catch(t=>{throw e(!1),t}).finally(()=>{this.activeIframeRequest=void 0})}throw e}).then(t=>(this.eventHandler.emitEvent(nL.EventType.ACQUIRE_TOKEN_SUCCESS,tA.InteractionType.Silent,t),this.performanceClient.addFields({fromCache:t.fromCache},e.correlationId),t)).catch(e=>{throw this.eventHandler.emitEvent(nL.EventType.ACQUIRE_TOKEN_FAILURE,tA.InteractionType.Silent,null,e),e}).finally(()=>{document.removeEventListener("visibilitychange",r)})}async acquireTokenSilentNoIframe(e,t){return aP(this.config,this.logger,this.platformAuthProvider,e.authenticationScheme)&&e.account.nativeAccountId?(this.logger.verbose("acquireTokenSilent - attempting to acquire token from native platform"),this.performanceClient.addFields({isPlatformBrokerRequest:!0},e.correlationId),this.acquireTokenNative(e,tA.ApiId.acquireTokenSilent_silentFlow,e.account.nativeAccountId,t).catch(async t=>{if(this.performanceClient.addFields({brokerErrorName:t.name,brokerErrorCode:t.errorCode},e.correlationId),t instanceof al&&ah(t))throw this.logger.verbose("acquireTokenSilent - native platform unavailable, falling back to web flow"),this.platformAuthProvider=void 0,(0,ex.createClientAuthError)(iK.tokenRefreshRequired);throw t})):(this.logger.verbose("acquireTokenSilent - attempting to acquire token from web flow"),t===tA.CacheLookupPolicy.AccessToken&&this.logger.verbose("acquireTokenSilent - cache lookup policy set to AccessToken, attempting to acquire token from local cache"),i6(this.acquireTokenFromCache.bind(this),y,this.logger,this.performanceClient,e.correlationId)(e,t).catch(o=>{if(t===tA.CacheLookupPolicy.AccessToken)throw o;return this.eventHandler.emitEvent(nL.EventType.ACQUIRE_TOKEN_NETWORK_START,tA.InteractionType.Silent,e),i6(this.acquireTokenByRefreshToken.bind(this),r,this.logger,this.performanceClient,e.correlationId)(e,t)}))}async preGeneratePkceCodes(e){return this.logger.verbose("Generating new PKCE codes"),this.pkceCode=await i6(av,ee,this.logger,this.performanceClient,e)(this.performanceClient,this.logger,e),Promise.resolve()}getPreGeneratedPkceCodes(e){this.logger.verbose("Attempting to pick up pre-generated PKCE codes");let t=this.pkceCode?{...this.pkceCode}:void 0;return this.pkceCode=void 0,this.logger.verbose(`${t?"Found":"Did not find"} pre-generated PKCE codes`),this.performanceClient.addFields({usePreGeneratedPkce:!!t},e),t}logMultipleInstances(e){var t;let r,o,i,n=this.config.auth.clientId;window&&(window.msal=window.msal||{},window.msal.clientIds=window.msal.clientIds||[],window.msal.clientIds.length>0&&this.logger.verbose("There is already an instance of MSAL.js in the window."),window.msal.clientIds.push(n),t=this.logger,o=(r=window.msal?.clientIds||[]).length,(i=r.filter(e=>e===n).length)>1&&t.warning("There is already an instance of MSAL.js in the window with the same client id."),e.add({msalInstanceCount:o,sameClientIdInstanceCount:i}))}}var nE=nE,nI=nI,oV=oV,iK=eF,nE=nE,nI=nI,aJ=el;let aY="unsupported_method",aX="This method is not supported in nested app environment.";class aZ extends aJ.AuthError{constructor(e,t){super(e,t),Object.setPrototypeOf(this,aZ.prototype),this.name="NestedAppAuthError"}static createUnsupportedError(){return new aZ(aY,aX)}}async function a0(e,t){let r=new iB(e);return await r.initialize(),aW.createController(r,t)}class a1{static async createPublicClientApplication(e){let t=await a0(e);return new a1(e,t)}constructor(e,t){this.isBroker=!1,this.controller=t||new aW(new iB(e))}async initialize(e){return this.controller.initialize(e,this.isBroker)}async acquireTokenPopup(e){return this.controller.acquireTokenPopup(e)}acquireTokenRedirect(e){return this.controller.acquireTokenRedirect(e)}acquireTokenSilent(e){return this.controller.acquireTokenSilent(e)}acquireTokenByCode(e){return this.controller.acquireTokenByCode(e)}addEventCallback(e,t){return this.controller.addEventCallback(e,t)}removeEventCallback(e){return this.controller.removeEventCallback(e)}addPerformanceCallback(e){return this.controller.addPerformanceCallback(e)}removePerformanceCallback(e){return this.controller.removePerformanceCallback(e)}enableAccountStorageEvents(){this.controller.enableAccountStorageEvents()}disableAccountStorageEvents(){this.controller.disableAccountStorageEvents()}getAccount(e){return this.controller.getAccount(e)}getAccountByHomeId(e){return this.controller.getAccountByHomeId(e)}getAccountByLocalId(e){return this.controller.getAccountByLocalId(e)}getAccountByUsername(e){return this.controller.getAccountByUsername(e)}getAllAccounts(e){return this.controller.getAllAccounts(e)}handleRedirectPromise(e){return this.controller.handleRedirectPromise(e)}loginPopup(e){return this.controller.loginPopup(e)}loginRedirect(e){return this.controller.loginRedirect(e)}logout(e){return this.controller.logout(e)}logoutRedirect(e){return this.controller.logoutRedirect(e)}logoutPopup(e){return this.controller.logoutPopup(e)}ssoSilent(e){return this.controller.ssoSilent(e)}getTokenCache(){return this.controller.getTokenCache()}getLogger(){return this.controller.getLogger()}setLogger(e){this.controller.setLogger(e)}setActiveAccount(e){this.controller.setActiveAccount(e)}getActiveAccount(){return this.controller.getActiveAccount()}initializeWrapperLibrary(e,t){return this.controller.initializeWrapperLibrary(e,t)}setNavigationClient(e){this.controller.setNavigationClient(e)}getConfiguration(){return this.controller.getConfiguration()}async hydrateCache(e,t){return this.controller.hydrateCache(e,t)}clearCache(e){return this.controller.clearCache(e)}}e.s(["PublicClientApplication",()=>a1],92856)}]);