module.exports=[80420,a=>{"use strict";var b=a.i(19354);let c="acquireTokenByRefreshToken",d="acquireTokenSilentAsync",e="acquireTokenRedirect",f="silentCacheClientAcquireToken",g="silentIframeClientAcquireToken",h="silentRefreshClientAcquireToken",i="standardInteractionClientGetDiscoveredAuthority",j="nativeInteractionClientAcquireToken",k="refreshTokenClientExecutePostToTokenEndpoint",l="authorizationCodeClientExecutePostToTokenEndpoint",m="refreshTokenClientExecuteTokenRequest",n="refreshTokenClientAcquireToken",o="refreshTokenClientAcquireTokenWithCachedRefreshToken",p="refreshTokenClientAcquireTokenByRefreshToken",q="refreshTokenClientCreateTokenRequestBody",r="acquireTokenFromCache",s="silentFlowClientAcquireCachedToken",t="silentFlowClientGenerateResultFromCacheRecord",u="acquireTokenBySilentIframe",v="initializeBaseRequest",w="initializeSilentRequest",x="silentIframeClientTokenHelper",y="silentHandlerInitiateAuthRequest",z="silentHandlerMonitorIframeForHash",A="silentHandlerLoadFrame",B="standardInteractionClientCreateAuthCodeClient",C="standardInteractionClientGetClientConfiguration",D="standardInteractionClientInitializeAuthorizationRequest",E="getAuthCodeUrl",F="handleCodeResponseFromServer",G="handleCodeResponse",H="handleResponseEar",I="handleResponsePlatformBroker",J="handleResponseCode",K="updateTokenEndpointAuthority",L="authClientAcquireToken",M="authClientExecuteTokenRequest",N="authClientCreateTokenRequestBody",O="popTokenGenerateCnf",P="handleServerTokenResponse",Q="deserializeResponse",R="authorityFactoryCreateDiscoveredInstance",S="authorityResolveEndpointsAsync",T="authorityGetCloudDiscoveryMetadataFromNetwork",U="authorityUpdateCloudDiscoveryMetadata",V="authorityGetEndpointMetadataFromNetwork",W="authorityUpdateEndpointMetadata",X="authorityUpdateMetadataWithRegionalInformation",Y="regionDiscoveryDetectRegion",Z="regionDiscoveryGetRegionFromIMDS",$="regionDiscoveryGetCurrentVersion",_="clearTokensAndKeysWithClaims",aa="generatePkceCodes",ab="generateCodeChallengeFromVerifier",ac="sha256Digest",ad="generateHKDF",ae="decrypt",af="generateEarKey";class ag{startMeasurement(){}endMeasurement(){}flushMeasurement(){return null}}class ah{generateId(){return"callback-id"}startMeasurement(a,b){return{end:()=>null,discard:()=>{},add:()=>{},increment:()=>{},event:{eventId:this.generateId(),status:1,authority:"",libraryName:"",libraryVersion:"",clientId:"",name:a,startTimeMs:Date.now(),correlationId:b||""},measurement:new ag}}startPerformanceMeasurement(){return new ag}calculateQueuedTime(){return 0}addQueueMeasurement(){}setPreQueueTime(){}endMeasurement(){return null}discardMeasurements(){}removePerformanceCallback(){return!0}addPerformanceCallback(){return""}emitEvents(){}addFields(){}incrementFields(){}cacheEventByCorrelationId(){}}var ai=a.i(98072),aj=a.i(67723);let ak="redirect_uri_empty",al="claims_request_parsing_error",am="authority_uri_insecure",an="url_parse_error",ao="empty_url_error",ap="empty_input_scopes_error",aq="invalid_claims",ar="token_request_empty",as="logout_request_empty",at="invalid_code_challenge_method",au="pkce_params_missing",av="invalid_cloud_discovery_metadata",aw="invalid_authority_metadata",ax="untrusted_authority",ay="missing_ssh_jwk",az="missing_ssh_kid",aA="missing_nonce_authentication_header",aB="invalid_authentication_header",aC="cannot_set_OIDCOptions",aD="cannot_allow_platform_broker",aE="authority_mismatch",aF="invalid_request_method_for_EAR",aG="invalid_authorize_post_body_parameters",aH="invalid_platform_broker_configuration";a.s(["authorityMismatch",()=>aE,"authorityUriInsecure",()=>am,"cannotAllowPlatformBroker",()=>aD,"cannotSetOIDCOptions",()=>aC,"claimsRequestParsingError",()=>al,"emptyInputScopesError",()=>ap,"invalidAuthenticationHeader",()=>aB,"invalidAuthorityMetadata",()=>aw,"invalidAuthorizePostBodyParameters",()=>aG,"invalidClaims",()=>aq,"invalidCloudDiscoveryMetadata",()=>av,"invalidCodeChallengeMethod",()=>at,"invalidPlatformBrokerConfiguration",()=>aH,"invalidRequestMethodForEAR",()=>aF,"logoutRequestEmpty",()=>as,"missingNonceAuthenticationHeader",()=>aA,"missingSshJwk",()=>ay,"missingSshKid",()=>az,"pkceParamsMissing",()=>au,"redirectUriEmpty",()=>ak,"tokenRequestEmpty",()=>ar,"untrustedAuthority",()=>ax,"urlEmptyError",()=>ao,"urlParseError",()=>an],99532);var aI=a.i(99532);let aJ={[ak]:"A redirect URI is required for all calls, and none has been set.",[al]:"Could not parse the given claims request object.",[am]:"Authority URIs must use https.  Please see here for valid authority configuration options: https://docs.microsoft.com/en-us/azure/active-directory/develop/msal-js-initializing-client-applications#configuration-options",[an]:"URL could not be parsed into appropriate segments.",[ao]:"URL was empty or null.",[ap]:"Scopes cannot be passed as null, undefined or empty array because they are required to obtain an access token.",[aq]:"Given claims parameter must be a stringified JSON object.",[ar]:"Token request was empty and not found in cache.",[as]:"The logout request was null or undefined.",[at]:'code_challenge_method passed is invalid. Valid values are "plain" and "S256".',[au]:"Both params: code_challenge and code_challenge_method are to be passed if to be sent in the request",[av]:"Invalid cloudDiscoveryMetadata provided. Must be a stringified JSON object containing tenant_discovery_endpoint and metadata fields",[aw]:"Invalid authorityMetadata provided. Must by a stringified JSON object containing authorization_endpoint, token_endpoint, issuer fields.",[ax]:"The provided authority is not a trusted authority. Please include this authority in the knownAuthorities config parameter.",[ay]:"Missing sshJwk in SSH certificate request. A stringified JSON Web Key is required when using the SSH authentication scheme.",[az]:"Missing sshKid in SSH certificate request. A string that uniquely identifies the public SSH key is required when using the SSH authentication scheme.",[aA]:"Unable to find an authentication header containing server nonce. Either the Authentication-Info or WWW-Authenticate headers must be present in order to obtain a server nonce.",[aB]:"Invalid authentication header provided",[aC]:"Cannot set OIDCOptions parameter. Please change the protocol mode to OIDC or use a non-Microsoft authority.",[aD]:"Cannot set allowPlatformBroker parameter to true when not in AAD protocol mode.",[aE]:"Authority mismatch error. Authority provided in login request or PublicClientApplication config does not match the environment of the provided account. Please use a matching account or make an interactive request to login to this authority.",[aG]:"Invalid authorize post body parameters provided. If you are using authorizePostBodyParameters, the request method must be POST. Please check the request method and parameters.",[aF]:"Invalid request method for EAR protocol mode. The request method cannot be GET when using EAR protocol mode. Please change the request method to POST.",[aH]:"Invalid platform broker configuration. `allowPlatformBrokerWithDOM` can only be enabled when `allowPlatformBroker` is enabled."};aJ[ak],aJ[al],aJ[am],aJ[an],aJ[ao],aJ[ap],aJ[aq],aJ[ar],aJ[as],aJ[at],aJ[au],aJ[av],aJ[aw],aJ[ax],aJ[ay],aJ[az],aJ[aA],aJ[aB],aJ[aC],aJ[aD],aJ[aE],aJ[aG],aJ[aF],aJ[aH];class aK extends aj.AuthError{constructor(a){super(a,aJ[a]),this.name="ClientConfigurationError",Object.setPrototypeOf(this,aK.prototype)}}function aL(a){return new aK(a)}var aM=aI,aN=a.i(73780),aO=a.i(97728);let aP={sendGetRequestAsync:()=>Promise.reject((0,aN.createClientAuthError)(aO.methodNotImplemented)),sendPostRequestAsync:()=>Promise.reject((0,aN.createClientAuthError)(aO.methodNotImplemented))},aQ={createNewGuid:()=>{throw(0,aN.createClientAuthError)(aO.methodNotImplemented)},base64Decode:()=>{throw(0,aN.createClientAuthError)(aO.methodNotImplemented)},base64Encode:()=>{throw(0,aN.createClientAuthError)(aO.methodNotImplemented)},base64UrlEncode:()=>{throw(0,aN.createClientAuthError)(aO.methodNotImplemented)},encodeKid:()=>{throw(0,aN.createClientAuthError)(aO.methodNotImplemented)},async getPublicKeyThumbprint(){throw(0,aN.createClientAuthError)(aO.methodNotImplemented)},async removeTokenBindingKey(){throw(0,aN.createClientAuthError)(aO.methodNotImplemented)},async clearKeystore(){throw(0,aN.createClientAuthError)(aO.methodNotImplemented)},async signJwt(){throw(0,aN.createClientAuthError)(aO.methodNotImplemented)},async hashString(){throw(0,aN.createClientAuthError)(aO.methodNotImplemented)}};var aR=a.i(16830);let aS="@azure/msal-common",aT="15.13.3",aU="none";class aV{static isEmptyObj(a){if(a)try{let b=JSON.parse(a);return 0===Object.keys(b).length}catch(a){}return!0}static startsWith(a,b){return 0===a.indexOf(b)}static endsWith(a,b){return a.length>=b.length&&a.lastIndexOf(b)===a.length-b.length}static queryStringToObject(a){let b={},c=a.split("&"),d=a=>decodeURIComponent(a.replace(/\+/g," "));return c.forEach(a=>{if(a.trim()){let[c,e]=a.split(/=(.+)/g,2);c&&e&&(b[d(c)]=d(e))}}),b}static trimArrayEntries(a){return a.map(a=>a.trim())}static removeEmptyStringsFromArray(a){return a.filter(a=>!!a)}static jsonParseHelper(a){try{return JSON.parse(a)}catch(a){return null}}static matchPattern(a,b){return new RegExp(a.replace(/\\/g,"\\\\").replace(/\*/g,"[^ ]*").replace(/\?/g,"\\?")).test(b)}}class aW{constructor(a){const b=a?aV.trimArrayEntries([...a]):[],c=b?aV.removeEmptyStringsFromArray(b):[];if(!c||!c.length)throw aL(ap);this.scopes=new Set,c.forEach(a=>this.scopes.add(a))}static fromString(a){return new aW((a||aR.Constants.EMPTY_STRING).split(" "))}static createSearchScopes(a){let b=new aW(a&&a.length>0?a:[...aR.OIDC_DEFAULT_SCOPES]);return b.containsOnlyOIDCScopes()?b.removeScope(aR.Constants.OFFLINE_ACCESS_SCOPE):b.removeOIDCScopes(),b}containsScope(a){let b=new aW(this.printScopesLowerCase().split(" "));return!!a&&b.scopes.has(a.toLowerCase())}containsScopeSet(a){return!!a&&!(a.scopes.size<=0)&&this.scopes.size>=a.scopes.size&&a.asArray().every(a=>this.containsScope(a))}containsOnlyOIDCScopes(){let a=0;return aR.OIDC_SCOPES.forEach(b=>{this.containsScope(b)&&(a+=1)}),this.scopes.size===a}appendScope(a){a&&this.scopes.add(a.trim())}appendScopes(a){try{a.forEach(a=>this.appendScope(a))}catch(a){throw(0,aN.createClientAuthError)(aO.cannotAppendScopeSet)}}removeScope(a){if(!a)throw(0,aN.createClientAuthError)(aO.cannotRemoveEmptyScope);this.scopes.delete(a.trim())}removeOIDCScopes(){aR.OIDC_SCOPES.forEach(a=>{this.scopes.delete(a)})}unionScopeSets(a){if(!a)throw(0,aN.createClientAuthError)(aO.emptyInputScopeSet);let b=new Set;return a.scopes.forEach(a=>b.add(a.toLowerCase())),this.scopes.forEach(a=>b.add(a.toLowerCase())),b}intersectingScopeSets(a){if(!a)throw(0,aN.createClientAuthError)(aO.emptyInputScopeSet);a.containsOnlyOIDCScopes()||a.removeOIDCScopes();let b=this.unionScopeSets(a),c=a.getScopeCount(),d=this.getScopeCount();return b.size<d+c}getScopeCount(){return this.scopes.size}asArray(){let a=[];return this.scopes.forEach(b=>a.push(b)),a}printScopes(){return this.scopes?this.asArray().join(" "):aR.Constants.EMPTY_STRING}printScopesLowerCase(){return this.printScopes().toLowerCase()}}var aX=a.i(51198),aY=a.i(31229);function aZ(a,b){let c=a_(a);try{let a=b(c);return JSON.parse(a)}catch(a){throw(0,aN.createClientAuthError)(aO.tokenParsingError)}}function a$(a){if(!a.signin_state)return!1;let b=["kmsi","dvc_dmjd"];return a.signin_state.some(a=>b.includes(a.trim().toLowerCase()))}function a_(a){if(!a)throw(0,aN.createClientAuthError)(aO.nullOrEmptyToken);let b=/^([^\.\s]*)\.([^\.\s]+)\.([^\.\s]*)$/.exec(a);if(!b||b.length<4)throw(0,aN.createClientAuthError)(aO.tokenParsingError);return b[2]}function a0(a,b){if(0===b||Date.now()-3e5>a+b)throw(0,aN.createClientAuthError)(aO.maxAgeTranspired)}function a1(a){if(!a)return a;let b=a.toLowerCase();return aV.endsWith(b,"?")?b=b.slice(0,-1):aV.endsWith(b,"?/")&&(b=b.slice(0,-2)),aV.endsWith(b,"/")||(b+="/"),b}function a2(a){return a.startsWith("#/")?a.substring(2):a.startsWith("#")||a.startsWith("?")?a.substring(1):a}function a3(a){if(!a||0>a.indexOf("="))return null;try{let b=a2(a),c=Object.fromEntries(new URLSearchParams(b));if(c.code||c.ear_jwe||c.error||c.error_description||c.state)return c}catch(a){throw(0,aN.createClientAuthError)(aO.hashNotDeserialized)}return null}function a4(a,b=!0,c){let d=[];return a.forEach((a,e)=>{!b&&c&&e in c?d.push(`${e}=${a}`):d.push(`${e}=${encodeURIComponent(a)}`)}),d.join("&")}function a5(a){if(!a)return a;let b=a.split("#")[0];try{let a=new URL(b),c=a.origin+a.pathname+a.search;return a1(c)}catch(a){return a1(b)}}a.s(["checkMaxAge",()=>a0,"extractTokenClaims",()=>aZ,"getJWSPayload",()=>a_,"isKmsi",()=>a$],59703),a.s(["getDeserializedResponse",()=>a3,"mapToQueryString",()=>a4,"normalizeUrlForComparison",()=>a5,"stripLeadingHashOrQuery",()=>a2],98327);class a6{get urlString(){return this._urlString}constructor(a){if(this._urlString=a,!this._urlString)throw aL(ao);a.includes("#")||(this._urlString=a6.canonicalizeUri(a))}static canonicalizeUri(a){if(a){let b=a.toLowerCase();return aV.endsWith(b,"?")?b=b.slice(0,-1):aV.endsWith(b,"?/")&&(b=b.slice(0,-2)),aV.endsWith(b,"/")||(b+="/"),b}return a}validateAsUri(){let a;try{a=this.getUrlComponents()}catch(a){throw aL(an)}if(!a.HostNameAndPort||!a.PathSegments)throw aL(an);if(!a.Protocol||"https:"!==a.Protocol.toLowerCase())throw aL(am)}static appendQueryString(a,b){return b?0>a.indexOf("?")?`${a}?${b}`:`${a}&${b}`:a}static removeHashFromUrl(a){return a6.canonicalizeUri(a.split("#")[0])}replaceTenantPath(a){let b=this.getUrlComponents(),c=b.PathSegments;return a&&0!==c.length&&(c[0]===aR.AADAuthorityConstants.COMMON||c[0]===aR.AADAuthorityConstants.ORGANIZATIONS)&&(c[0]=a),a6.constructAuthorityUriFromObject(b)}getUrlComponents(){let a=RegExp("^(([^:/?#]+):)?(//([^/?#]*))?([^?#]*)(\\?([^#]*))?(#(.*))?"),b=this.urlString.match(a);if(!b)throw aL(an);let c={Protocol:b[1],HostNameAndPort:b[4],AbsolutePath:b[5],QueryString:b[7]},d=c.AbsolutePath.split("/");return c.PathSegments=d=d.filter(a=>a&&a.length>0),c.QueryString&&c.QueryString.endsWith("/")&&(c.QueryString=c.QueryString.substring(0,c.QueryString.length-1)),c}static getDomainFromUrl(a){let b=RegExp("^([^:/?#]+://)?([^/?#]*)"),c=a.match(b);if(!c)throw aL(an);return c[2]}static getAbsoluteUrl(a,b){if(a[0]===aR.Constants.FORWARD_SLASH){let c=new a6(b).getUrlComponents();return c.Protocol+"//"+c.HostNameAndPort+a}return a}static constructAuthorityUriFromObject(a){return new a6(a.Protocol+"//"+a.HostNameAndPort+"/"+a.PathSegments.join("/"))}static hashContainsKnownProperties(a){return!!a3(a)}}let a7={"login.microsoftonline.com":{token_endpoint:"https://login.microsoftonline.com/{tenantid}/oauth2/v2.0/token",jwks_uri:"https://login.microsoftonline.com/{tenantid}/discovery/v2.0/keys",issuer:"https://login.microsoftonline.com/{tenantid}/v2.0",authorization_endpoint:"https://login.microsoftonline.com/{tenantid}/oauth2/v2.0/authorize",end_session_endpoint:"https://login.microsoftonline.com/{tenantid}/oauth2/v2.0/logout"},"login.chinacloudapi.cn":{token_endpoint:"https://login.chinacloudapi.cn/{tenantid}/oauth2/v2.0/token",jwks_uri:"https://login.chinacloudapi.cn/{tenantid}/discovery/v2.0/keys",issuer:"https://login.partner.microsoftonline.cn/{tenantid}/v2.0",authorization_endpoint:"https://login.chinacloudapi.cn/{tenantid}/oauth2/v2.0/authorize",end_session_endpoint:"https://login.chinacloudapi.cn/{tenantid}/oauth2/v2.0/logout"},"login.microsoftonline.us":{token_endpoint:"https://login.microsoftonline.us/{tenantid}/oauth2/v2.0/token",jwks_uri:"https://login.microsoftonline.us/{tenantid}/discovery/v2.0/keys",issuer:"https://login.microsoftonline.us/{tenantid}/v2.0",authorization_endpoint:"https://login.microsoftonline.us/{tenantid}/oauth2/v2.0/authorize",end_session_endpoint:"https://login.microsoftonline.us/{tenantid}/oauth2/v2.0/logout"}},a8=[{preferred_network:"login.microsoftonline.com",preferred_cache:"login.windows.net",aliases:["login.microsoftonline.com","login.windows.net","login.microsoft.com","sts.windows.net"]},{preferred_network:"login.partner.microsoftonline.cn",preferred_cache:"login.partner.microsoftonline.cn",aliases:["login.partner.microsoftonline.cn","login.chinacloudapi.cn"]},{preferred_network:"login.microsoftonline.de",preferred_cache:"login.microsoftonline.de",aliases:["login.microsoftonline.de"]},{preferred_network:"login.microsoftonline.us",preferred_cache:"login.microsoftonline.us",aliases:["login.microsoftonline.us","login.usgovcloudapi.net"]},{preferred_network:"login-us.microsoftonline.com",preferred_cache:"login-us.microsoftonline.com",aliases:["login-us.microsoftonline.com"]}],a9=new Set;function ba(a,b,c,d){if(d?.trace(`getAliasesFromMetadata called with source: ${c}`),a&&b){let e=bb(b,a);if(e)return d?.trace(`getAliasesFromMetadata: found cloud discovery metadata in ${c}, returning aliases`),e.aliases;d?.trace(`getAliasesFromMetadata: did not find cloud discovery metadata in ${c}`)}return null}function bb(a,b){for(let c=0;c<a.length;c++){let d=a[c];if(d.aliases.includes(b))return d}return null}a8.forEach(a=>{a.aliases.forEach(a=>{a9.add(a)})});var bc=aj;let bd="cache_quota_exceeded",be="cache_error_unknown";a.s(["cacheErrorUnknown",()=>be,"cacheQuotaExceeded",()=>bd],45264);var bf=a.i(45264);let bg={[bd]:"Exceeded cache storage capacity.",[be]:"Unexpected error occurred when using cache storage."};class bh extends bc.AuthError{constructor(a,b){const c=b||(bg[a]?bg[a]:bg[be]);super(`${a}: ${c}`),Object.setPrototypeOf(this,bh.prototype),this.name="CacheError",this.errorCode=a,this.errorMessage=c}}function bi(a){return a instanceof Error?"QuotaExceededError"===a.name||"NS_ERROR_DOM_QUOTA_REACHED"===a.name||a.message.includes("exceeded the quota")?new bh(bd):new bh(a.name,a.message):new bh(be)}class bj{constructor(a,b,c,d,e){this.clientId=a,this.cryptoImpl=b,this.commonLogger=c.clone(aS,aT),this.staticAuthorityOptions=e,this.performanceClient=d}getAllAccounts(a,b){return this.buildTenantProfiles(this.getAccountsFilteredBy(a,b),b,a)}getAccountInfoFilteredBy(a,b){if(0===Object.keys(a).length||Object.values(a).every(a=>!a))return this.commonLogger.warning("getAccountInfoFilteredBy: Account filter is empty or invalid, returning null"),null;let c=this.getAllAccounts(a,b);return c.length>1?c.sort(a=>a.idTokenClaims?-1:1)[0]:1===c.length?c[0]:null}getBaseAccountInfo(a,b){let c=this.getAccountsFilteredBy(a,b);return c.length>0?aX.AccountEntity.getAccountInfo(c[0]):null}buildTenantProfiles(a,b,c){return a.flatMap(a=>this.getTenantProfilesFromAccountEntity(a,b,c?.tenantId,c))}getTenantedAccountInfoByFilter(a,b,c,d,e){let f;if(e&&!this.tenantProfileMatchesFilter(c,e))return null;let g=this.getIdToken(a,d,b,c.tenantId);return g&&(f=aZ(g.secret,this.cryptoImpl.base64Decode),!this.idTokenClaimsMatchTenantProfileFilter(f,e))?null:(0,aY.updateAccountTenantProfileData)(a,c,f,g?.secret)}getTenantProfilesFromAccountEntity(a,b,c,d){let e=aX.AccountEntity.getAccountInfo(a),f=e.tenantProfiles||new Map,g=this.getTokenKeys();if(c){let a=f.get(c);if(!a)return[];f=new Map([[c,a]])}let h=[];return f.forEach(a=>{let c=this.getTenantedAccountInfoByFilter(e,g,a,b,d);c&&h.push(c)}),h}tenantProfileMatchesFilter(a,b){return(!b.localAccountId||!!this.matchLocalAccountIdFromTenantProfile(a,b.localAccountId))&&(!b.name||a.name===b.name)&&(void 0===b.isHomeTenant||a.isHomeTenant===b.isHomeTenant)}idTokenClaimsMatchTenantProfileFilter(a,b){return(!b||(!b.localAccountId||!!this.matchLocalAccountIdFromTokenClaims(a,b.localAccountId))&&(!b.loginHint||!!this.matchLoginHintFromTokenClaims(a,b.loginHint))&&(!b.username||!!this.matchUsername(a.preferred_username,b.username))&&(!b.name||!!this.matchName(a,b.name))&&(!b.sid||!!this.matchSid(a,b.sid)))&&!0}async saveCacheRecord(a,b,c,d){if(!a)throw(0,aN.createClientAuthError)(aO.invalidCacheRecord);try{a.account&&await this.setAccount(a.account,b,c),a.idToken&&d?.idToken!==!1&&await this.setIdTokenCredential(a.idToken,b,c),a.accessToken&&d?.accessToken!==!1&&await this.saveAccessToken(a.accessToken,b,c),a.refreshToken&&d?.refreshToken!==!1&&await this.setRefreshTokenCredential(a.refreshToken,b,c),a.appMetadata&&this.setAppMetadata(a.appMetadata,b)}catch(a){if(this.commonLogger?.error("CacheManager.saveCacheRecord: failed"),a instanceof aj.AuthError)throw a;throw bi(a)}}async saveAccessToken(a,b,c){let d={clientId:a.clientId,credentialType:a.credentialType,environment:a.environment,homeAccountId:a.homeAccountId,realm:a.realm,tokenType:a.tokenType,requestedClaimsHash:a.requestedClaimsHash},e=this.getTokenKeys(),f=aW.fromString(a.target);e.accessToken.forEach(a=>{if(!this.accessTokenKeyMatchesFilter(a,d,!1))return;let c=this.getAccessTokenCredential(a,b);c&&this.credentialMatchesFilter(c,d)&&aW.fromString(c.target).intersectingScopeSets(f)&&this.removeAccessToken(a,b)}),await this.setAccessTokenCredential(a,b,c)}getAccountsFilteredBy(a,b){let c=this.getAccountKeys(),d=[];return c.forEach(c=>{let e=this.getAccount(c,b);if(!e||a.homeAccountId&&!this.matchHomeAccountId(e,a.homeAccountId)||a.username&&!this.matchUsername(e.username,a.username)||a.environment&&!this.matchEnvironment(e,a.environment)||a.realm&&!this.matchRealm(e,a.realm)||a.nativeAccountId&&!this.matchNativeAccountId(e,a.nativeAccountId)||a.authorityType&&!this.matchAuthorityType(e,a.authorityType))return;let f={localAccountId:a?.localAccountId,name:a?.name},g=e.tenantProfiles?.filter(a=>this.tenantProfileMatchesFilter(a,f));g&&0===g.length||d.push(e)}),d}credentialMatchesFilter(a,b){return(!b.clientId||!!this.matchClientId(a,b.clientId))&&(!b.userAssertionHash||!!this.matchUserAssertionHash(a,b.userAssertionHash))&&("string"!=typeof b.homeAccountId||!!this.matchHomeAccountId(a,b.homeAccountId))&&(!b.environment||!!this.matchEnvironment(a,b.environment))&&(!b.realm||!!this.matchRealm(a,b.realm))&&(!b.credentialType||!!this.matchCredentialType(a,b.credentialType))&&(!b.familyId||!!this.matchFamilyId(a,b.familyId))&&(!b.target||!!this.matchTarget(a,b.target))&&(!b.requestedClaimsHash&&!a.requestedClaimsHash||a.requestedClaimsHash===b.requestedClaimsHash)&&(a.credentialType!==aR.CredentialType.ACCESS_TOKEN_WITH_AUTH_SCHEME||(!b.tokenType||!!this.matchTokenType(a,b.tokenType))&&(b.tokenType!==aR.AuthenticationScheme.SSH||!b.keyId||!!this.matchKeyId(a,b.keyId)))&&!0}getAppMetadataFilteredBy(a){let b=this.getKeys(),c={};return b.forEach(b=>{if(!this.isAppMetadata(b))return;let d=this.getAppMetadata(b);!d||a.environment&&!this.matchEnvironment(d,a.environment)||(!a.clientId||this.matchClientId(d,a.clientId))&&(c[b]=d)}),c}getAuthorityMetadataByAlias(a){let b=this.getAuthorityMetadataKeys(),c=null;return b.forEach(b=>{if(!this.isAuthorityMetadata(b)||-1===b.indexOf(this.clientId))return;let d=this.getAuthorityMetadata(b);d&&-1!==d.aliases.indexOf(a)&&(c=d)}),c}removeAllAccounts(a){this.getAllAccounts({},a).forEach(b=>{this.removeAccount(b,a)})}removeAccount(a,b){this.removeAccountContext(a,b),this.getAccountKeys().filter(b=>b.includes(a.homeAccountId)&&b.includes(a.environment)).forEach(a=>{this.removeItem(a,b),this.performanceClient.incrementFields({accountsRemoved:1},b)})}removeAccountContext(a,b){let c=this.getTokenKeys(),d=b=>b.includes(a.homeAccountId)&&b.includes(a.environment);c.idToken.filter(d).forEach(a=>{this.removeIdToken(a,b)}),c.accessToken.filter(d).forEach(a=>{this.removeAccessToken(a,b)}),c.refreshToken.filter(d).forEach(a=>{this.removeRefreshToken(a,b)})}removeAccessToken(a,b){let c=this.getAccessTokenCredential(a,b);if(this.removeItem(a,b),this.performanceClient.incrementFields({accessTokensRemoved:1},b),!c||c.credentialType.toLowerCase()!==aR.CredentialType.ACCESS_TOKEN_WITH_AUTH_SCHEME.toLowerCase()||c.tokenType!==aR.AuthenticationScheme.POP)return;let d=c.keyId;d&&this.cryptoImpl.removeTokenBindingKey(d).catch(()=>{this.commonLogger.error(`Failed to remove token binding key ${d}`,b),this.performanceClient?.incrementFields({removeTokenBindingKeyFailure:1},b)})}removeAppMetadata(a){return this.getKeys().forEach(b=>{this.isAppMetadata(b)&&this.removeItem(b,a)}),!0}getIdToken(a,b,c,d,e){this.commonLogger.trace("CacheManager - getIdToken called");let f={homeAccountId:a.homeAccountId,environment:a.environment,credentialType:aR.CredentialType.ID_TOKEN,clientId:this.clientId,realm:d},g=this.getIdTokensByFilter(f,b,c),h=g.size;if(h<1)return this.commonLogger.info("CacheManager:getIdToken - No token found"),null;if(h>1){let c=g;if(!d){let b=new Map;g.forEach((c,d)=>{c.realm===a.tenantId&&b.set(d,c)});let d=b.size;if(d<1)return this.commonLogger.info("CacheManager:getIdToken - Multiple ID tokens found for account but none match account entity tenant id, returning first result"),g.values().next().value;if(1===d)return this.commonLogger.info("CacheManager:getIdToken - Multiple ID tokens found for account, defaulting to home tenant profile"),b.values().next().value;c=b}return this.commonLogger.info("CacheManager:getIdToken - Multiple matching ID tokens found, clearing them"),c.forEach((a,c)=>{this.removeIdToken(c,b)}),e&&b&&e.addFields({multiMatchedID:g.size},b),null}return this.commonLogger.info("CacheManager:getIdToken - Returning ID token"),g.values().next().value}getIdTokensByFilter(a,b,c){let d=c&&c.idToken||this.getTokenKeys().idToken,e=new Map;return d.forEach(c=>{if(!this.idTokenKeyMatchesFilter(c,{clientId:this.clientId,...a}))return;let d=this.getIdTokenCredential(c,b);d&&this.credentialMatchesFilter(d,a)&&e.set(c,d)}),e}idTokenKeyMatchesFilter(a,b){let c=a.toLowerCase();return(!b.clientId||-1!==c.indexOf(b.clientId.toLowerCase()))&&(!b.homeAccountId||-1!==c.indexOf(b.homeAccountId.toLowerCase()))}removeIdToken(a,b){this.removeItem(a,b)}removeRefreshToken(a,b){this.removeItem(a,b)}getAccessToken(a,b,c,d){let e=b.correlationId;this.commonLogger.trace("CacheManager - getAccessToken called",e);let f=aW.createSearchScopes(b.scopes),g=b.authenticationScheme||aR.AuthenticationScheme.BEARER,h=g&&g.toLowerCase()!==aR.AuthenticationScheme.BEARER.toLowerCase()?aR.CredentialType.ACCESS_TOKEN_WITH_AUTH_SCHEME:aR.CredentialType.ACCESS_TOKEN,i={homeAccountId:a.homeAccountId,environment:a.environment,credentialType:h,clientId:this.clientId,realm:d||a.tenantId,target:f,tokenType:g,keyId:b.sshKid,requestedClaimsHash:b.requestedClaimsHash},j=c&&c.accessToken||this.getTokenKeys().accessToken,k=[];j.forEach(a=>{if(this.accessTokenKeyMatchesFilter(a,i,!0)){let b=this.getAccessTokenCredential(a,e);b&&this.credentialMatchesFilter(b,i)&&k.push(b)}});let l=k.length;return l<1?(this.commonLogger.info("CacheManager:getAccessToken - No token found",e),null):l>1?(this.commonLogger.info("CacheManager:getAccessToken - Multiple access tokens found, clearing them",e),k.forEach(a=>{this.removeAccessToken(this.generateCredentialKey(a),e)}),this.performanceClient.addFields({multiMatchedAT:k.length},e),null):(this.commonLogger.info("CacheManager:getAccessToken - Returning access token",e),k[0])}accessTokenKeyMatchesFilter(a,b,c){let d=a.toLowerCase();if(b.clientId&&-1===d.indexOf(b.clientId.toLowerCase())||b.homeAccountId&&-1===d.indexOf(b.homeAccountId.toLowerCase())||b.realm&&-1===d.indexOf(b.realm.toLowerCase())||b.requestedClaimsHash&&-1===d.indexOf(b.requestedClaimsHash.toLowerCase()))return!1;if(b.target){let a=b.target.asArray();for(let b=0;b<a.length;b++)if(c&&!d.includes(a[b].toLowerCase()))return!1;else if(!c&&d.includes(a[b].toLowerCase()))break}return!0}getAccessTokensByFilter(a,b){let c=this.getTokenKeys(),d=[];return c.accessToken.forEach(c=>{if(!this.accessTokenKeyMatchesFilter(c,a,!0))return;let e=this.getAccessTokenCredential(c,b);e&&this.credentialMatchesFilter(e,a)&&d.push(e)}),d}getRefreshToken(a,b,c,d,e){this.commonLogger.trace("CacheManager - getRefreshToken called");let f=b?aR.THE_FAMILY_ID:void 0,g={homeAccountId:a.homeAccountId,environment:a.environment,credentialType:aR.CredentialType.REFRESH_TOKEN,clientId:this.clientId,familyId:f},h=d&&d.refreshToken||this.getTokenKeys().refreshToken,i=[];h.forEach(a=>{if(this.refreshTokenKeyMatchesFilter(a,g)){let b=this.getRefreshTokenCredential(a,c);b&&this.credentialMatchesFilter(b,g)&&i.push(b)}});let j=i.length;return j<1?(this.commonLogger.info("CacheManager:getRefreshToken - No refresh token found."),null):(j>1&&e&&c&&e.addFields({multiMatchedRT:j},c),this.commonLogger.info("CacheManager:getRefreshToken - returning refresh token"),i[0])}refreshTokenKeyMatchesFilter(a,b){let c=a.toLowerCase();return(!b.familyId||-1!==c.indexOf(b.familyId.toLowerCase()))&&(!!b.familyId||!b.clientId||-1!==c.indexOf(b.clientId.toLowerCase()))&&(!b.homeAccountId||-1!==c.indexOf(b.homeAccountId.toLowerCase()))}readAppMetadataFromCache(a){let b={environment:a,clientId:this.clientId},c=this.getAppMetadataFilteredBy(b),d=Object.keys(c).map(a=>c[a]),e=d.length;if(e<1)return null;if(e>1)throw(0,aN.createClientAuthError)(aO.multipleMatchingAppMetadata);return d[0]}isAppMetadataFOCI(a){let b=this.readAppMetadataFromCache(a);return!!(b&&b.familyId===aR.THE_FAMILY_ID)}matchHomeAccountId(a,b){return"string"==typeof a.homeAccountId&&b===a.homeAccountId}matchLocalAccountIdFromTokenClaims(a,b){return b===(a.oid||a.sub)}matchLocalAccountIdFromTenantProfile(a,b){return a.localAccountId===b}matchName(a,b){return b.toLowerCase()===a.name?.toLowerCase()}matchUsername(a,b){return!!(a&&"string"==typeof a&&b?.toLowerCase()===a.toLowerCase())}matchUserAssertionHash(a,b){return!!(a.userAssertionHash&&b===a.userAssertionHash)}matchEnvironment(a,b){if(this.staticAuthorityOptions){let c=function(a,b){let c,d=a.canonicalAuthority;if(d){let e=new a6(d).getUrlComponents().HostNameAndPort;c=ba(e,a.cloudDiscoveryMetadata?.metadata,aR.AuthorityMetadataSource.CONFIG,b)||ba(e,a8,aR.AuthorityMetadataSource.HARDCODED_VALUES,b)||a.knownAuthorities}return c||[]}(this.staticAuthorityOptions,this.commonLogger);if(c.includes(b)&&c.includes(a.environment))return!0}let c=this.getAuthorityMetadataByAlias(b);return!!(c&&c.aliases.indexOf(a.environment)>-1)}matchCredentialType(a,b){return a.credentialType&&b.toLowerCase()===a.credentialType.toLowerCase()}matchClientId(a,b){return!!(a.clientId&&b===a.clientId)}matchFamilyId(a,b){return!!(a.familyId&&b===a.familyId)}matchRealm(a,b){return a.realm?.toLowerCase()===b.toLowerCase()}matchNativeAccountId(a,b){return!!(a.nativeAccountId&&b===a.nativeAccountId)}matchLoginHintFromTokenClaims(a,b){return a.login_hint===b||a.preferred_username===b||a.upn===b}matchSid(a,b){return a.sid===b}matchAuthorityType(a,b){return!!(a.authorityType&&b.toLowerCase()===a.authorityType.toLowerCase())}matchTarget(a,b){return(a.credentialType===aR.CredentialType.ACCESS_TOKEN||a.credentialType===aR.CredentialType.ACCESS_TOKEN_WITH_AUTH_SCHEME)&&!!a.target&&aW.fromString(a.target).containsScopeSet(b)}matchTokenType(a,b){return!!(a.tokenType&&a.tokenType===b)}matchKeyId(a,b){return!!(a.keyId&&a.keyId===b)}isAppMetadata(a){return -1!==a.indexOf(aR.APP_METADATA)}isAuthorityMetadata(a){return -1!==a.indexOf(aR.AUTHORITY_METADATA_CONSTANTS.CACHE_KEY)}generateAuthorityMetadataCacheKey(a){return`${aR.AUTHORITY_METADATA_CONSTANTS.CACHE_KEY}-${this.clientId}-${a}`}static toObject(a,b){for(let c in b)a[c]=b[c];return a}}class bk extends bj{async setAccount(){throw(0,aN.createClientAuthError)(aO.methodNotImplemented)}getAccount(){throw(0,aN.createClientAuthError)(aO.methodNotImplemented)}async setIdTokenCredential(){throw(0,aN.createClientAuthError)(aO.methodNotImplemented)}getIdTokenCredential(){throw(0,aN.createClientAuthError)(aO.methodNotImplemented)}async setAccessTokenCredential(){throw(0,aN.createClientAuthError)(aO.methodNotImplemented)}getAccessTokenCredential(){throw(0,aN.createClientAuthError)(aO.methodNotImplemented)}async setRefreshTokenCredential(){throw(0,aN.createClientAuthError)(aO.methodNotImplemented)}getRefreshTokenCredential(){throw(0,aN.createClientAuthError)(aO.methodNotImplemented)}setAppMetadata(){throw(0,aN.createClientAuthError)(aO.methodNotImplemented)}getAppMetadata(){throw(0,aN.createClientAuthError)(aO.methodNotImplemented)}setServerTelemetry(){throw(0,aN.createClientAuthError)(aO.methodNotImplemented)}getServerTelemetry(){throw(0,aN.createClientAuthError)(aO.methodNotImplemented)}setAuthorityMetadata(){throw(0,aN.createClientAuthError)(aO.methodNotImplemented)}getAuthorityMetadata(){throw(0,aN.createClientAuthError)(aO.methodNotImplemented)}getAuthorityMetadataKeys(){throw(0,aN.createClientAuthError)(aO.methodNotImplemented)}setThrottlingCache(){throw(0,aN.createClientAuthError)(aO.methodNotImplemented)}getThrottlingCache(){throw(0,aN.createClientAuthError)(aO.methodNotImplemented)}removeItem(){throw(0,aN.createClientAuthError)(aO.methodNotImplemented)}getKeys(){throw(0,aN.createClientAuthError)(aO.methodNotImplemented)}getAccountKeys(){throw(0,aN.createClientAuthError)(aO.methodNotImplemented)}getTokenKeys(){throw(0,aN.createClientAuthError)(aO.methodNotImplemented)}generateCredentialKey(){throw(0,aN.createClientAuthError)(aO.methodNotImplemented)}generateAccountKey(){throw(0,aN.createClientAuthError)(aO.methodNotImplemented)}}let bl={tokenRenewalOffsetSeconds:aR.DEFAULT_TOKEN_RENEWAL_OFFSET_SEC,preventCorsPreflight:!1},bm={loggerCallback:()=>{},piiLoggingEnabled:!1,logLevel:b.LogLevel.Info,correlationId:aR.Constants.EMPTY_STRING},bn={claimsBasedCachingEnabled:!1},bo={async sendGetRequestAsync(){throw(0,aN.createClientAuthError)(aO.methodNotImplemented)},async sendPostRequestAsync(){throw(0,aN.createClientAuthError)(aO.methodNotImplemented)}},bp={sku:aR.Constants.SKU,version:aT,cpu:aR.Constants.EMPTY_STRING,os:aR.Constants.EMPTY_STRING},bq={clientSecret:aR.Constants.EMPTY_STRING,clientAssertion:void 0},br={azureCloudInstance:aU,tenant:`${aR.Constants.DEFAULT_COMMON_TENANT}`},bs={application:{appName:"",appVersion:""}};function bt(a){return a.authOptions.authority.options.protocolMode===ai.ProtocolMode.OIDC}var bu=a.i(62851),bv=aj;let bw="pkce_not_created",bx="ear_jwk_empty",by="ear_jwe_empty",bz="crypto_nonexistent",bA="empty_navigate_uri",bB="hash_empty_error",bC="no_state_in_hash",bD="hash_does_not_contain_known_properties",bE="unable_to_parse_state",bF="state_interaction_type_mismatch",bG="interaction_in_progress",bH="popup_window_error",bI="empty_window_error",bJ="user_cancelled",bK="monitor_popup_timeout",bL="monitor_window_timeout",bM="redirect_in_iframe",bN="block_iframe_reload",bO="block_nested_popups",bP="iframe_closed_prematurely",bQ="silent_logout_unsupported",bR="no_account_error",bS="silent_prompt_value_error",bT="no_token_request_cache_error",bU="unable_to_parse_token_request_cache_error",bV="auth_request_not_set_error",bW="invalid_cache_type",bX="non_browser_environment",bY="database_not_open",bZ="no_network_connectivity",b$="post_request_failed",b_="get_request_failed",b0="failed_to_parse_response",b1="unable_to_load_token",b2="crypto_key_not_found",b3="auth_code_required",b4="auth_code_or_nativeAccountId_required",b5="spa_code_and_nativeAccountId_present",b6="database_unavailable",b7="unable_to_acquire_token_from_native_platform",b8="native_handshake_timeout",b9="native_extension_not_installed",ca="native_connection_not_established",cb="uninitialized_public_client_application",cc="native_prompt_not_supported",cd="invalid_base64_string",ce="invalid_pop_token_request",cf="failed_to_build_headers",cg="failed_to_parse_headers",ch="failed_to_decrypt_ear_response",ci="timed_out";a.s(["authCodeOrNativeAccountIdRequired",()=>b4,"authCodeRequired",()=>b3,"authRequestNotSetError",()=>bV,"blockIframeReload",()=>bN,"blockNestedPopups",()=>bO,"cryptoKeyNotFound",()=>b2,"cryptoNonExistent",()=>bz,"databaseNotOpen",()=>bY,"databaseUnavailable",()=>b6,"earJweEmpty",()=>by,"earJwkEmpty",()=>bx,"emptyNavigateUri",()=>bA,"emptyWindowError",()=>bI,"failedToBuildHeaders",()=>cf,"failedToDecryptEarResponse",()=>ch,"failedToParseHeaders",()=>cg,"failedToParseResponse",()=>b0,"getRequestFailed",()=>b_,"hashDoesNotContainKnownProperties",()=>bD,"hashEmptyError",()=>bB,"iframeClosedPrematurely",()=>bP,"interactionInProgress",()=>bG,"invalidBase64String",()=>cd,"invalidCacheType",()=>bW,"invalidPopTokenRequest",()=>ce,"monitorPopupTimeout",()=>bK,"monitorWindowTimeout",()=>bL,"nativeConnectionNotEstablished",()=>ca,"nativeExtensionNotInstalled",()=>b9,"nativeHandshakeTimeout",()=>b8,"nativePromptNotSupported",()=>cc,"noAccountError",()=>bR,"noNetworkConnectivity",()=>bZ,"noStateInHash",()=>bC,"noTokenRequestCacheError",()=>bT,"nonBrowserEnvironment",()=>bX,"pkceNotCreated",()=>bw,"popupWindowError",()=>bH,"postRequestFailed",()=>b$,"redirectInIframe",()=>bM,"silentLogoutUnsupported",()=>bQ,"silentPromptValueError",()=>bS,"spaCodeAndNativeAccountIdPresent",()=>b5,"stateInteractionTypeMismatch",()=>bF,"timedOut",()=>ci,"unableToAcquireTokenFromNativePlatform",()=>b7,"unableToLoadToken",()=>b1,"unableToParseState",()=>bE,"unableToParseTokenRequestCacheError",()=>bU,"uninitializedPublicClientApplication",()=>cb,"userCancelled",()=>bJ],74804),a.i(74804);let cj="For more visit: aka.ms/msaljs/browser-errors",ck={[bw]:"The PKCE code challenge and verifier could not be generated.",[bx]:"No EAR encryption key provided. This is unexpected.",[by]:"Server response does not contain ear_jwe property. This is unexpected.",[bz]:"The crypto object or function is not available.",[bA]:"Navigation URI is empty. Please check stack trace for more info.",[bB]:`Hash value cannot be processed because it is empty. Please verify that your redirectUri is not clearing the hash. ${cj}`,[bC]:"Hash does not contain state. Please verify that the request originated from msal.",[bD]:`Hash does not contain known properites. Please verify that your redirectUri is not changing the hash.  ${cj}`,[bE]:"Unable to parse state. Please verify that the request originated from msal.",[bF]:"Hash contains state but the interaction type does not match the caller.",[bG]:`Interaction is currently in progress. Please ensure that this interaction has been completed before calling an interactive API.   ${cj}`,[bH]:"Error opening popup window. This can happen if you are using IE or if popups are blocked in the browser.",[bI]:"window.open returned null or undefined window object.",[bJ]:"User cancelled the flow.",[bK]:`Token acquisition in popup failed due to timeout.  ${cj}`,[bL]:`Token acquisition in iframe failed due to timeout.  ${cj}`,[bM]:"Redirects are not supported for iframed or brokered applications. Please ensure you are using MSAL.js in a top frame of the window if using the redirect APIs, or use the popup APIs.",[bN]:`Request was blocked inside an iframe because MSAL detected an authentication response.  ${cj}`,[bO]:"Request was blocked inside a popup because MSAL detected it was running in a popup.",[bP]:"The iframe being monitored was closed prematurely.",[bQ]:"Silent logout not supported. Please call logoutRedirect or logoutPopup instead.",[bR]:"No account object provided to acquireTokenSilent and no active account has been set. Please call setActiveAccount or provide an account on the request.",[bS]:"The value given for the prompt value is not valid for silent requests - must be set to 'none' or 'no_session'.",[bT]:"No token request found in cache.",[bU]:"The cached token request could not be parsed.",[bV]:"Auth Request not set. Please ensure initiateAuthRequest was called from the InteractionHandler",[bW]:"Invalid cache type",[bX]:"Login and token requests are not supported in non-browser environments.",[bY]:"Database is not open!",[bZ]:"No network connectivity. Check your internet connection.",[b$]:"Network request failed: If the browser threw a CORS error, check that the redirectUri is registered in the Azure App Portal as type 'SPA'",[b_]:"Network request failed. Please check the network trace to determine root cause.",[b0]:"Failed to parse network response. Check network trace.",[b1]:"Error loading token to cache.",[b2]:"Cryptographic Key or Keypair not found in browser storage.",[b3]:"An authorization code must be provided (as the `code` property on the request) to this flow.",[b4]:"An authorization code or nativeAccountId must be provided to this flow.",[b5]:"Request cannot contain both spa code and native account id.",[b6]:"IndexedDB, which is required for persistent cryptographic key storage, is unavailable. This may be caused by browser privacy features which block persistent storage in third-party contexts.",[b7]:`Unable to acquire token from native platform.  ${cj}`,[b8]:"Timed out while attempting to establish connection to browser extension",[b9]:"Native extension is not installed. If you think this is a mistake call the initialize function.",[ca]:`Connection to native platform has not been established. Please install a compatible browser extension and run initialize().  ${cj}`,[cb]:`You must call and await the initialize function before attempting to call any other MSAL API.  ${cj}`,[cc]:"The provided prompt is not supported by the native platform. This request should be routed to the web based flow.",[cd]:"Invalid base64 encoded string.",[ce]:"Invalid PoP token request. The request should not have both a popKid value and signPopToken set to true.",[cf]:"Failed to build request headers object.",[cg]:"Failed to parse response headers",[ch]:"Failed to decrypt ear response",[ci]:"The request timed out."};ck[bw],ck[bz],ck[bA],ck[bB],ck[bC],ck[bD],ck[bE],ck[bF],ck[bG],ck[bH],ck[bI],ck[bJ],ck[bK],ck[bL],ck[bM],ck[bN],ck[bO],ck[bP],ck[bQ],ck[bR],ck[bS],ck[bT],ck[bU],ck[bV],ck[bW],ck[bX],ck[bY],ck[bZ],ck[b$],ck[b_],ck[b0],ck[b1],ck[b2],ck[b3],ck[b4],ck[b5],ck[b6],ck[b7],ck[b8],ck[b9],ck[ca],ck[cb],ck[cc],ck[cd],ck[ce];class cl extends bv.AuthError{constructor(a,b){super(a,ck[a],b),Object.setPrototypeOf(this,cl.prototype),this.name="BrowserAuthError"}}function cm(a,b){return new cl(a,b)}class cn{navigateInternal(a,b){return cn.defaultNavigateWindow(a,b)}navigateExternal(a,b){return cn.defaultNavigateWindow(a,b)}static defaultNavigateWindow(a,b){return b.noHistory?window.location.replace(a):window.location.assign(a),new Promise((a,c)=>{setTimeout(()=>{c(cm(ci,"failed_to_redirect"))},b.timeout)})}}var co=aj;class cp extends co.AuthError{constructor(a,b,c){super(a.errorCode,a.errorMessage,a.subError),Object.setPrototypeOf(this,cp.prototype),this.name="NetworkError",this.error=a,this.httpStatus=b,this.responseHeaders=c}}function cq(a,b,c,d){return a.errorMessage=`${a.errorMessage}, additionalErrorInfo: error.name:${d?.name}, error.message:${d?.message}`,new cp(a,b,c)}class cr{async sendGetRequestAsync(a,b){let c,d={},e=0,f=cs(b);try{c=await fetch(a,{method:bu.HTTP_REQUEST_TYPE.GET,headers:f})}catch(a){throw cq(cm(window.navigator.onLine?b_:bZ),void 0,void 0,a)}d=ct(c.headers);try{return e=c.status,{headers:d,body:await c.json(),status:e}}catch(a){throw cq(cm(b0),e,d,a)}}async sendPostRequestAsync(a,b){let c,d=b&&b.body||"",e=cs(b),f=0,g={};try{c=await fetch(a,{method:bu.HTTP_REQUEST_TYPE.POST,headers:e,body:d})}catch(a){throw cq(cm(window.navigator.onLine?b$:bZ),void 0,void 0,a)}g=ct(c.headers);try{return f=c.status,{headers:g,body:await c.json(),status:f}}catch(a){throw cq(cm(b0),f,g,a)}}}function cs(a){try{let b=new Headers;if(!(a&&a.headers))return b;let c=a.headers;return Object.entries(c).forEach(([a,c])=>{b.append(a,c)}),b}catch(a){throw cq(cm(cf),void 0,void 0,a)}}function ct(a){try{let b={};return a.forEach((a,c)=>{b[c]=a}),b}catch(a){throw cm(cg)}}let cu="4.27.0",cv="msal",cw="browser",cx=`${cv}.${cw}.log.level`,cy=`${cv}.${cw}.log.pii`,cz=`${cv}.version`,cA="account.keys",cB="token.keys";function cC(a=2){return a<1?`${cv}.${cA}`:`${cv}.${a}.${cA}`}function cD(a,b=2){return b<1?`${cv}.${cB}.${a}`:`${cv}.${b}.${cB}.${a}`}class cE{static loggerCallback(a,c){switch(a){case b.LogLevel.Error:console.error(c);return;case b.LogLevel.Info:console.info(c);return;case b.LogLevel.Verbose:console.debug(c);return;case b.LogLevel.Warning:console.warn(c);return;default:console.log(c);return}}constructor(a){let c;this.browserEnvironment=!1,this.config=function({auth:a,cache:c,system:d,telemetry:e},f){let g={clientId:aR.Constants.EMPTY_STRING,authority:`${aR.Constants.DEFAULT_AUTHORITY}`,knownAuthorities:[],cloudDiscoveryMetadata:aR.Constants.EMPTY_STRING,authorityMetadata:aR.Constants.EMPTY_STRING,redirectUri:"",postLogoutRedirectUri:aR.Constants.EMPTY_STRING,navigateToLoginRequestUrl:!0,clientCapabilities:[],protocolMode:ai.ProtocolMode.AAD,OIDCOptions:{serverResponseType:aR.ServerResponseType.FRAGMENT,defaultScopes:[aR.Constants.OPENID_SCOPE,aR.Constants.PROFILE_SCOPE,aR.Constants.OFFLINE_ACCESS_SCOPE]},azureCloudOptions:{azureCloudInstance:aU,tenant:aR.Constants.EMPTY_STRING},skipAuthorityMetadataCache:!1,supportsNestedAppAuth:!1,instanceAware:!1,encodeExtraQueryParams:!1},h={cacheLocation:bu.BrowserCacheLocation.SessionStorage,cacheRetentionDays:5,temporaryCacheLocation:bu.BrowserCacheLocation.SessionStorage,storeAuthStateInCookie:!1,secureCookies:!1,cacheMigrationEnabled:!!c&&c.cacheLocation===bu.BrowserCacheLocation.LocalStorage,claimsBasedCachingEnabled:!1},i={loggerCallback:()=>{},logLevel:b.LogLevel.Info,piiLoggingEnabled:!1},j={...{...bl,loggerOptions:i,networkClient:f?new cr:aP,navigationClient:new cn,loadFrameTimeout:0,windowHashTimeout:d?.loadFrameTimeout||6e4,iframeHashTimeout:d?.loadFrameTimeout||1e4,navigateFrameWait:0,redirectNavigationTimeout:3e4,asyncPopups:!1,allowRedirectInIframe:!1,allowPlatformBroker:!1,allowPlatformBrokerWithDOM:!1,nativeBrokerHandshakeTimeout:d?.nativeBrokerHandshakeTimeout||2e3,pollIntervalMilliseconds:bu.BrowserConstants.DEFAULT_POLL_INTERVAL_MS},...d,loggerOptions:d?.loggerOptions||i},k={application:{appName:aR.Constants.EMPTY_STRING,appVersion:aR.Constants.EMPTY_STRING},client:new ah};if(a?.protocolMode!==ai.ProtocolMode.OIDC&&a?.OIDCOptions&&new b.Logger(j.loggerOptions).warning(JSON.stringify(aL(aM.cannotSetOIDCOptions))),a?.protocolMode&&a.protocolMode===ai.ProtocolMode.OIDC&&j?.allowPlatformBroker)throw aL(aM.cannotAllowPlatformBroker);return{auth:{...g,...a,OIDCOptions:{...g.OIDCOptions,...a?.OIDCOptions}},cache:{...h,...c},system:j,telemetry:{...k,...e}}}(a,this.browserEnvironment);try{c=window[bu.BrowserCacheLocation.SessionStorage]}catch(a){}const d=c?.getItem(cx),e=c?.getItem(cy)?.toLowerCase(),f="true"===e||"false"!==e&&void 0,g={...this.config.system.loggerOptions},h=d&&Object.keys(b.LogLevel).includes(d)?b.LogLevel[d]:void 0;h&&(g.loggerCallback=cE.loggerCallback,g.logLevel=h),void 0!==f&&(g.piiLoggingEnabled=f),this.logger=new b.Logger(g,"@azure/msal-browser",cu),this.available=!1}getConfig(){return this.config}getLogger(){return this.logger}isAvailable(){return this.available}isBrowserEnvironment(){return this.browserEnvironment}}class cF extends cE{constructor(){super(...arguments),this.bridgeProxy=void 0,this.accountContext=null}getModuleName(){return cF.MODULE_NAME}getId(){return cF.ID}getBridgeProxy(){return this.bridgeProxy}async initialize(){return this.logger.info(`Nested App Auth Bridge available: ${this.available}`),this.available}}cF.MODULE_NAME="",cF.ID="NestedAppOperatingContext";class cG extends cE{getModuleName(){return cG.MODULE_NAME}getId(){return cG.ID}async initialize(){return this.available=!1,this.available}}cG.MODULE_NAME="",cG.ID="StandardOperatingContext";var cH=aO,cI=aj;let cJ="missing_kid_error",cK="missing_alg_error",cL={[cJ]:"The JOSE Header for the requested JWT, JWS or JWK object requires a keyId to be configured as the 'kid' header claim. No 'kid' value was provided.",[cK]:"The JOSE Header for the requested JWT, JWS or JWK object requires an algorithm to be specified as the 'alg' header claim. No 'alg' value was provided."};class cM extends cI.AuthError{constructor(a,b){super(a,b),this.name="JoseHeaderError",Object.setPrototypeOf(this,cM.prototype)}}function cN(a){return new cM(a,cL[a])}class cO{constructor(a){this.typ=a.typ,this.alg=a.alg,this.kid=a.kid}static getShrHeaderString(a){if(!a.kid)throw cN(cJ);if(!a.alg)throw cN(cK);return JSON.stringify(new cO({typ:a.typ||aR.JsonWebTokenTypes.Pop,kid:a.kid,alg:a.alg}))}}function cP(a){return encodeURIComponent(cR(a).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_"))}function cQ(a){return cS(a).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}function cR(a){return cS(new TextEncoder().encode(a))}function cS(a){return btoa(Array.from(a,a=>String.fromCodePoint(a)).join(""))}function cT(a){return new TextDecoder().decode(cU(a))}function cU(a){let b=a.replace(/-/g,"+").replace(/_/g,"/");switch(b.length%4){case 0:break;case 2:b+="==";break;case 3:b+="=";break;default:throw cm(cd)}let c=atob(b);return Uint8Array.from(c,a=>a.codePointAt(0)||0)}let cV="AES-GCM",cW="HKDF",cX="SHA-256",cY=new Uint8Array([1,0,1]),cZ="0123456789abcdef",c$=new Uint32Array(1),c_="encrypt",c0="decrypt",c1={name:"RSASSA-PKCS1-v1_5",hash:cX,modulusLength:2048,publicExponent:cY};async function c2(a,b,c){b?.addQueueMeasurement(ac,c);let d=new TextEncoder().encode(a);return window.crypto.subtle.digest(cX,d)}function c3(a){return window.crypto.getRandomValues(a)}function c4(){return window.crypto.getRandomValues(c$),c$[0]}function c5(){let a=Date.now(),b=1024*c4()+(1023&c4()),c=new Uint8Array(16),d=Math.trunc(b/0x40000000),e=b&0x40000000-1,f=c4();c[0]=a/0x10000000000,c[1]=a/0x100000000,c[2]=a/0x1000000,c[3]=a/65536,c[4]=a/256,c[5]=a,c[6]=112|d>>>8,c[7]=d,c[8]=128|e>>>24,c[9]=e>>>16,c[10]=e>>>8,c[11]=e,c[12]=f>>>24,c[13]=f>>>16,c[14]=f>>>8,c[15]=f;let g="";for(let a=0;a<c.length;a++)g+=cZ.charAt(c[a]>>>4),g+=cZ.charAt(15&c[a]),(3===a||5===a||7===a||9===a)&&(g+="-");return g}async function c6(a,b){return window.crypto.subtle.generateKey(c1,a,b)}async function c7(a){return window.crypto.subtle.exportKey(bu.KEY_FORMAT_JWK,a)}async function c8(a,b,c){return window.crypto.subtle.importKey(bu.KEY_FORMAT_JWK,a,c1,b,c)}async function c9(a,b){return window.crypto.subtle.sign(c1,a,b)}async function da(){return cR(JSON.stringify({alg:"dir",kty:"oct",k:cQ(new Uint8Array(await dd()))}))}async function db(a){let b=cU(JSON.parse(cT(a)).k);return window.crypto.subtle.importKey("raw",b,cV,!1,[c0])}async function dc(a,b){let c=b.split(".");if(5!==c.length)throw cm(ch,"jwe_length");let d=await db(a).catch(()=>{throw cm(ch,"import_key")});try{let a=new TextEncoder().encode(c[0]),b=cU(c[2]),e=cU(c[3]),f=cU(c[4]),g=8*f.byteLength,h=new Uint8Array(e.length+f.length);h.set(e),h.set(f,e.length);let i=await window.crypto.subtle.decrypt({name:cV,iv:b,tagLength:g,additionalData:a},d,h);return new TextDecoder().decode(i)}catch(a){throw cm(ch,"decrypt")}}async function dd(){let a=await window.crypto.subtle.generateKey({name:cV,length:256},!0,[c_,c0]);return window.crypto.subtle.exportKey("raw",a)}async function de(a){return window.crypto.subtle.importKey("raw",a,cW,!1,["deriveKey"])}async function df(a,b,c){return window.crypto.subtle.deriveKey({name:cW,salt:b,hash:cX,info:new TextEncoder().encode(c)},a,{name:cV,length:256},!1,[c_,c0])}async function dg(a,b,c){let d=new TextEncoder().encode(b),e=window.crypto.getRandomValues(new Uint8Array(16)),f=await df(a,e,c),g=await window.crypto.subtle.encrypt({name:cV,iv:new Uint8Array(12)},f,d);return{data:cQ(new Uint8Array(g)),nonce:cQ(e)}}async function dh(a,b,c,d){let e=cU(d),f=await df(a,cU(b),c),g=await window.crypto.subtle.decrypt({name:cV,iv:new Uint8Array(12)},f,e);return new TextDecoder().decode(g)}async function di(a){return cQ(new Uint8Array(await c2(a)))}class dj{constructor(){this.dbName=bu.DB_NAME,this.version=bu.DB_VERSION,this.tableName=bu.DB_TABLE_NAME,this.dbOpen=!1}async open(){return new Promise((a,b)=>{let c=window.indexedDB.open(this.dbName,this.version);c.addEventListener("upgradeneeded",a=>{a.target.result.createObjectStore(this.tableName)}),c.addEventListener("success",b=>{this.db=b.target.result,this.dbOpen=!0,a()}),c.addEventListener("error",()=>b(cm(b6)))})}closeConnection(){let a=this.db;a&&this.dbOpen&&(a.close(),this.dbOpen=!1)}async validateDbIsOpen(){if(!this.dbOpen)return this.open()}async getItem(a){return await this.validateDbIsOpen(),new Promise((b,c)=>{if(!this.db)return c(cm(bY));let d=this.db.transaction([this.tableName],"readonly").objectStore(this.tableName).get(a);d.addEventListener("success",a=>{this.closeConnection(),b(a.target.result)}),d.addEventListener("error",a=>{this.closeConnection(),c(a)})})}async setItem(a,b){return await this.validateDbIsOpen(),new Promise((c,d)=>{if(!this.db)return d(cm(bY));let e=this.db.transaction([this.tableName],"readwrite").objectStore(this.tableName).put(b,a);e.addEventListener("success",()=>{this.closeConnection(),c()}),e.addEventListener("error",a=>{this.closeConnection(),d(a)})})}async removeItem(a){return await this.validateDbIsOpen(),new Promise((b,c)=>{if(!this.db)return c(cm(bY));let d=this.db.transaction([this.tableName],"readwrite").objectStore(this.tableName).delete(a);d.addEventListener("success",()=>{this.closeConnection(),b()}),d.addEventListener("error",a=>{this.closeConnection(),c(a)})})}async getKeys(){return await this.validateDbIsOpen(),new Promise((a,b)=>{if(!this.db)return b(cm(bY));let c=this.db.transaction([this.tableName],"readonly").objectStore(this.tableName).getAllKeys();c.addEventListener("success",b=>{this.closeConnection(),a(b.target.result)}),c.addEventListener("error",a=>{this.closeConnection(),b(a)})})}async containsKey(a){return await this.validateDbIsOpen(),new Promise((b,c)=>{if(!this.db)return c(cm(bY));let d=this.db.transaction([this.tableName],"readonly").objectStore(this.tableName).count(a);d.addEventListener("success",a=>{this.closeConnection(),b(1===a.target.result)}),d.addEventListener("error",a=>{this.closeConnection(),c(a)})})}async deleteDatabase(){return this.db&&this.dbOpen&&this.closeConnection(),new Promise((a,b)=>{let c=window.indexedDB.deleteDatabase(bu.DB_NAME),d=setTimeout(()=>b(!1),200);c.addEventListener("success",()=>(clearTimeout(d),a(!0))),c.addEventListener("blocked",()=>(clearTimeout(d),a(!0))),c.addEventListener("error",()=>(clearTimeout(d),b(!1)))})}}class dk{constructor(){this.cache=new Map}async initialize(){}getItem(a){return this.cache.get(a)||null}getUserData(a){return this.getItem(a)}setItem(a,b){this.cache.set(a,b)}async setUserData(a,b){this.setItem(a,b)}removeItem(a){this.cache.delete(a)}getKeys(){let a=[];return this.cache.forEach((b,c)=>{a.push(c)}),a}containsKey(a){return this.cache.has(a)}clear(){this.cache.clear()}decryptData(){return Promise.resolve(null)}}class dl{constructor(a){this.inMemoryCache=new dk,this.indexedDBCache=new dj,this.logger=a}handleDatabaseAccessError(a){if(a instanceof cl&&a.errorCode===b6)this.logger.error("Could not access persistent storage. This may be caused by browser privacy features which block persistent storage in third-party contexts.");else throw a}async getItem(a){let b=this.inMemoryCache.getItem(a);if(!b)try{return this.logger.verbose("Queried item not found in in-memory cache, now querying persistent storage."),await this.indexedDBCache.getItem(a)}catch(a){this.handleDatabaseAccessError(a)}return b}async setItem(a,b){this.inMemoryCache.setItem(a,b);try{await this.indexedDBCache.setItem(a,b)}catch(a){this.handleDatabaseAccessError(a)}}async removeItem(a){this.inMemoryCache.removeItem(a);try{await this.indexedDBCache.removeItem(a)}catch(a){this.handleDatabaseAccessError(a)}}async getKeys(){let a=this.inMemoryCache.getKeys();if(0===a.length)try{return this.logger.verbose("In-memory cache is empty, now querying persistent storage."),await this.indexedDBCache.getKeys()}catch(a){this.handleDatabaseAccessError(a)}return a}async containsKey(a){let b=this.inMemoryCache.containsKey(a);if(!b)try{return this.logger.verbose("Key not found in in-memory cache, now querying persistent storage."),await this.indexedDBCache.containsKey(a)}catch(a){this.handleDatabaseAccessError(a)}return b}clearInMemory(){this.logger.verbose("Deleting in-memory keystore"),this.inMemoryCache.clear(),this.logger.verbose("In-memory keystore deleted")}async clearPersistent(){try{this.logger.verbose("Deleting persistent keystore");let a=await this.indexedDBCache.deleteDatabase();return a&&this.logger.verbose("Persistent keystore deleted"),a}catch(a){return this.handleDatabaseAccessError(a),!1}}}class dm{constructor(a,b,c){this.logger=a;if(!window)throw cm(bX);if(!window.crypto)throw cm(bz);if(!c&&!window.crypto.subtle)throw cm(bz,"crypto_subtle_undefined");this.cache=new dl(this.logger),this.performanceClient=b}createNewGuid(){return c5()}base64Encode(a){return cR(a)}base64Decode(a){return cT(a)}base64UrlEncode(a){return cP(a)}encodeKid(a){return this.base64UrlEncode(JSON.stringify({kid:a}))}async getPublicKeyThumbprint(a){let b=this.performanceClient?.startMeasurement("cryptoOptsGetPublicKeyThumbprint",a.correlationId),c=await c6(dm.EXTRACTABLE,dm.POP_KEY_USAGES),d=await c7(c.publicKey),e=dn({e:d.e,kty:d.kty,n:d.n}),f=await this.hashString(e),g=await c7(c.privateKey),h=await c8(g,!1,["sign"]);return await this.cache.setItem(f,{privateKey:h,publicKey:c.publicKey,requestMethod:a.resourceRequestMethod,requestUri:a.resourceRequestUri}),b&&b.end({success:!0}),f}async removeTokenBindingKey(a){if(await this.cache.removeItem(a),await this.cache.containsKey(a))throw(0,aN.createClientAuthError)(cH.bindingKeyNotRemoved)}async clearKeystore(){this.cache.clearInMemory();try{return await this.cache.clearPersistent(),!0}catch(a){return a instanceof Error?this.logger.error(`Clearing keystore failed with error: ${a.message}`):this.logger.error("Clearing keystore failed with unknown error"),!1}}async signJwt(a,b,c,d){let e=this.performanceClient?.startMeasurement("cryptoOptsSignJwt",d),f=await this.cache.getItem(b);if(!f)throw cm(b2);let g=await c7(f.publicKey),h=dn(g),i=cP(JSON.stringify({kid:b})),j=cP(cO.getShrHeaderString({...c?.header,alg:g.alg,kid:i}));a.cnf={jwk:JSON.parse(h)};let k=cP(JSON.stringify(a)),l=`${j}.${k}`,m=new TextEncoder().encode(l),n=cQ(new Uint8Array(await c9(f.privateKey,m))),o=`${l}.${n}`;return e&&e.end({success:!0}),o}async hashString(a){return di(a)}}function dn(a){return JSON.stringify(a,Object.keys(a).sort())}dm.POP_KEY_USAGES=["sign","verify"],dm.EXTRACTABLE=!0;var dp=a.i(31601);let dq=(a,b,c,d,e)=>(...f)=>{c.trace(`Executing function ${b}`);let g=d?.startMeasurement(b,e);e&&d?.incrementFields({[b+"CallCount"]:1},e);try{let d=a(...f);return g?.end({success:!0}),c.trace(`Returning result from ${b}`),d}catch(a){c.trace(`Error occurred in ${b}`);try{c.trace(JSON.stringify(a))}catch(a){c.trace("Unable to print error message.")}throw g?.end({success:!1},a),a}},dr=(a,b,c,d,e)=>(...f)=>{c.trace(`Executing function ${b}`);let g=d?.startMeasurement(b,e);return e&&d?.incrementFields({[b+"CallCount"]:1},e),d?.setPreQueueTime(b,e),a(...f).then(a=>(c.trace(`Returning result from ${b}`),g?.end({success:!0}),a)).catch(a=>{c.trace(`Error occurred in ${b}`);try{c.trace(JSON.stringify(a))}catch(a){c.trace("Unable to print error message.")}throw g?.end({success:!1},a),a})};class ds{constructor(a,b,c,d){this.networkInterface=a,this.logger=b,this.performanceClient=c,this.correlationId=d}async detectRegion(a,b){this.performanceClient?.addQueueMeasurement(Y,this.correlationId);let c=a;if(c)b.region_source=aR.RegionDiscoverySources.ENVIRONMENT_VARIABLE;else{let a=ds.IMDS_OPTIONS;try{let d=await dr(this.getRegionFromIMDS.bind(this),Z,this.logger,this.performanceClient,this.correlationId)(aR.Constants.IMDS_VERSION,a);if(d.status===aR.HttpStatus.SUCCESS&&(c=d.body,b.region_source=aR.RegionDiscoverySources.IMDS),d.status===aR.HttpStatus.BAD_REQUEST){let d=await dr(this.getCurrentVersion.bind(this),$,this.logger,this.performanceClient,this.correlationId)(a);if(!d)return b.region_source=aR.RegionDiscoverySources.FAILED_AUTO_DETECTION,null;let e=await dr(this.getRegionFromIMDS.bind(this),Z,this.logger,this.performanceClient,this.correlationId)(d,a);e.status===aR.HttpStatus.SUCCESS&&(c=e.body,b.region_source=aR.RegionDiscoverySources.IMDS)}}catch(a){return b.region_source=aR.RegionDiscoverySources.FAILED_AUTO_DETECTION,null}}return c||(b.region_source=aR.RegionDiscoverySources.FAILED_AUTO_DETECTION),c||null}async getRegionFromIMDS(a,b){return this.performanceClient?.addQueueMeasurement(Z,this.correlationId),this.networkInterface.sendGetRequestAsync(`${aR.Constants.IMDS_ENDPOINT}?api-version=${a}&format=text`,b,aR.Constants.IMDS_TIMEOUT)}async getCurrentVersion(a){this.performanceClient?.addQueueMeasurement($,this.correlationId);try{let b=await this.networkInterface.sendGetRequestAsync(`${aR.Constants.IMDS_ENDPOINT}?format=json`,a);if(b.status===aR.HttpStatus.BAD_REQUEST&&b.body&&b.body["newest-versions"]&&b.body["newest-versions"].length>0)return b.body["newest-versions"][0];return null}catch(a){return null}}}function dt(){return Math.round(new Date().getTime()/1e3)}function du(a){return a.getTime()/1e3}function dv(a){return a?new Date(1e3*Number(a)):new Date}function dw(a,b){let c=Number(a)||0;return dt()+b>c}function dx(a,b){let c=Number(a)+24*b*36e5;return Date.now()>c}function dy(a){return Number(a)>dt()}function dz(a,b){return new Promise(c=>setTimeout(()=>c(b),a))}function dA(a,b,c,d,e){return{credentialType:aR.CredentialType.ID_TOKEN,homeAccountId:a,environment:b,clientId:d,secret:c,realm:e,lastUpdatedAt:Date.now().toString()}}function dB(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){let p={homeAccountId:a,credentialType:aR.CredentialType.ACCESS_TOKEN,secret:c,cachedAt:dt().toString(),expiresOn:g.toString(),extendedExpiresOn:h.toString(),environment:b,clientId:d,realm:e,target:f,tokenType:k||aR.AuthenticationScheme.BEARER,lastUpdatedAt:Date.now().toString()};if(l&&(p.userAssertionHash=l),j&&(p.refreshOn=j.toString()),n&&(p.requestedClaims=n,p.requestedClaimsHash=o),p.tokenType?.toLowerCase()!==aR.AuthenticationScheme.BEARER.toLowerCase())switch(p.credentialType=aR.CredentialType.ACCESS_TOKEN_WITH_AUTH_SCHEME,p.tokenType){case aR.AuthenticationScheme.POP:let q=aZ(c,i);if(!q?.cnf?.kid)throw(0,aN.createClientAuthError)(aO.tokenClaimsCnfRequiredForSignedJwt);p.keyId=q.cnf.kid;break;case aR.AuthenticationScheme.SSH:p.keyId=m}return p}function dC(a,b,c,d,e,f,g){let h={credentialType:aR.CredentialType.REFRESH_TOKEN,homeAccountId:a,environment:b,clientId:d,secret:c,lastUpdatedAt:Date.now().toString()};return f&&(h.userAssertionHash=f),e&&(h.familyId=e),g&&(h.expiresOn=g.toString()),h}function dD(a){return a.hasOwnProperty("homeAccountId")&&a.hasOwnProperty("environment")&&a.hasOwnProperty("credentialType")&&a.hasOwnProperty("clientId")&&a.hasOwnProperty("secret")}function dE(a){return!!a&&dD(a)&&a.hasOwnProperty("realm")&&a.hasOwnProperty("target")&&(a.credentialType===aR.CredentialType.ACCESS_TOKEN||a.credentialType===aR.CredentialType.ACCESS_TOKEN_WITH_AUTH_SCHEME)}function dF(a){return!!a&&dD(a)&&a.hasOwnProperty("realm")&&a.credentialType===aR.CredentialType.ID_TOKEN}function dG(a){return!!a&&dD(a)&&a.credentialType===aR.CredentialType.REFRESH_TOKEN}function dH(a,b){let c=0===a.indexOf(aR.SERVER_TELEM_CONSTANTS.CACHE_KEY),d=!0;return b&&(d=b.hasOwnProperty("failedRequests")&&b.hasOwnProperty("errors")&&b.hasOwnProperty("cacheHits")),c&&d}function dI(a,b){let c=!1;a&&(c=0===a.indexOf(aR.ThrottlingConstants.THROTTLING_PREFIX));let d=!0;return b&&(d=b.hasOwnProperty("throttleTime")),c&&d}function dJ({environment:a,clientId:b}){return[aR.APP_METADATA,a,b].join(aR.Separators.CACHE_KEY_SEPARATOR).toLowerCase()}function dK(a,b){return!!b&&0===a.indexOf(aR.APP_METADATA)&&b.hasOwnProperty("clientId")&&b.hasOwnProperty("environment")}function dL(a,b){return!!b&&0===a.indexOf(aR.AUTHORITY_METADATA_CONSTANTS.CACHE_KEY)&&b.hasOwnProperty("aliases")&&b.hasOwnProperty("preferred_cache")&&b.hasOwnProperty("preferred_network")&&b.hasOwnProperty("canonical_authority")&&b.hasOwnProperty("authorization_endpoint")&&b.hasOwnProperty("token_endpoint")&&b.hasOwnProperty("issuer")&&b.hasOwnProperty("aliasesFromNetwork")&&b.hasOwnProperty("endpointsFromNetwork")&&b.hasOwnProperty("expiresAt")&&b.hasOwnProperty("jwks_uri")}function dM(){return dt()+aR.AUTHORITY_METADATA_CONSTANTS.REFRESH_TIME_SECONDS}function dN(a,b,c){a.authorization_endpoint=b.authorization_endpoint,a.token_endpoint=b.token_endpoint,a.end_session_endpoint=b.end_session_endpoint,a.issuer=b.issuer,a.endpointsFromNetwork=c,a.jwks_uri=b.jwks_uri}function dO(a,b,c){a.aliases=b.aliases,a.preferred_cache=b.preferred_cache,a.preferred_network=b.preferred_network,a.aliasesFromNetwork=c}function dP(a){return a.expiresAt<=dt()}ds.IMDS_OPTIONS={headers:{Metadata:"true"}},a.s(["delay",()=>dz,"isCacheExpired",()=>dx,"isTokenExpired",()=>dw,"nowSeconds",()=>dt,"toDateFromSeconds",()=>dv,"toSecondsFromDate",()=>du,"wasClockTurnedBack",()=>dy],64509),a.s(["createAccessTokenEntity",()=>dB,"createIdTokenEntity",()=>dA,"createRefreshTokenEntity",()=>dC,"generateAppMetadataKey",()=>dJ,"generateAuthorityMetadataExpiresAt",()=>dM,"isAccessTokenEntity",()=>dE,"isAppMetadataEntity",()=>dK,"isAuthorityMetadataEntity",()=>dL,"isAuthorityMetadataExpired",()=>dP,"isCredentialEntity",()=>dD,"isIdTokenEntity",()=>dF,"isRefreshTokenEntity",()=>dG,"isServerTelemetryEntity",()=>dH,"isThrottlingEntity",()=>dI,"updateAuthorityEndpointMetadata",()=>dN,"updateCloudDiscoveryMetadata",()=>dO],54895);class dQ{constructor(a,b,c,d,e,f,g,h){this.canonicalAuthority=a,this._canonicalAuthority.validateAsUri(),this.networkInterface=b,this.cacheManager=c,this.authorityOptions=d,this.regionDiscoveryMetadata={region_used:void 0,region_source:void 0,region_outcome:void 0},this.logger=e,this.performanceClient=g,this.correlationId=f,this.managedIdentity=h||!1,this.regionDiscovery=new ds(b,this.logger,this.performanceClient,this.correlationId)}getAuthorityType(a){if(a.HostNameAndPort.endsWith(aR.Constants.CIAM_AUTH_URL))return dp.AuthorityType.Ciam;let b=a.PathSegments;if(b.length)switch(b[0].toLowerCase()){case aR.Constants.ADFS:return dp.AuthorityType.Adfs;case aR.Constants.DSTS:return dp.AuthorityType.Dsts}return dp.AuthorityType.Default}get authorityType(){return this.getAuthorityType(this.canonicalAuthorityUrlComponents)}get protocolMode(){return this.authorityOptions.protocolMode}get options(){return this.authorityOptions}get canonicalAuthority(){return this._canonicalAuthority.urlString}set canonicalAuthority(a){this._canonicalAuthority=new a6(a),this._canonicalAuthority.validateAsUri(),this._canonicalAuthorityUrlComponents=null}get canonicalAuthorityUrlComponents(){return this._canonicalAuthorityUrlComponents||(this._canonicalAuthorityUrlComponents=this._canonicalAuthority.getUrlComponents()),this._canonicalAuthorityUrlComponents}get hostnameAndPort(){return this.canonicalAuthorityUrlComponents.HostNameAndPort.toLowerCase()}get tenant(){return this.canonicalAuthorityUrlComponents.PathSegments[0]}get authorizationEndpoint(){if(this.discoveryComplete())return this.replacePath(this.metadata.authorization_endpoint);throw(0,aN.createClientAuthError)(aO.endpointResolutionError)}get tokenEndpoint(){if(this.discoveryComplete())return this.replacePath(this.metadata.token_endpoint);throw(0,aN.createClientAuthError)(aO.endpointResolutionError)}get deviceCodeEndpoint(){if(this.discoveryComplete())return this.replacePath(this.metadata.token_endpoint.replace("/token","/devicecode"));throw(0,aN.createClientAuthError)(aO.endpointResolutionError)}get endSessionEndpoint(){if(this.discoveryComplete()){if(!this.metadata.end_session_endpoint)throw(0,aN.createClientAuthError)(aO.endSessionEndpointNotSupported);return this.replacePath(this.metadata.end_session_endpoint)}throw(0,aN.createClientAuthError)(aO.endpointResolutionError)}get selfSignedJwtAudience(){if(this.discoveryComplete())return this.replacePath(this.metadata.issuer);throw(0,aN.createClientAuthError)(aO.endpointResolutionError)}get jwksUri(){if(this.discoveryComplete())return this.replacePath(this.metadata.jwks_uri);throw(0,aN.createClientAuthError)(aO.endpointResolutionError)}canReplaceTenant(a){return 1===a.PathSegments.length&&!dQ.reservedTenantDomains.has(a.PathSegments[0])&&this.getAuthorityType(a)===dp.AuthorityType.Default&&this.protocolMode!==ai.ProtocolMode.OIDC}replaceTenant(a){return a.replace(/{tenant}|{tenantid}/g,this.tenant)}replacePath(a){let b=a,c=new a6(this.metadata.canonical_authority).getUrlComponents(),d=c.PathSegments;return this.canonicalAuthorityUrlComponents.PathSegments.forEach((a,e)=>{let f=d[e];if(0===e&&this.canReplaceTenant(c)){let a=new a6(this.metadata.authorization_endpoint).getUrlComponents().PathSegments[0];f!==a&&(this.logger.verbose(`Replacing tenant domain name ${f} with id ${a}`),f=a)}a!==f&&(b=b.replace(`/${f}/`,`/${a}/`))}),this.replaceTenant(b)}get defaultOpenIdConfigurationEndpoint(){let a=this.hostnameAndPort;return this.canonicalAuthority.endsWith("v2.0/")||this.authorityType===dp.AuthorityType.Adfs||this.protocolMode===ai.ProtocolMode.OIDC&&!this.isAliasOfKnownMicrosoftAuthority(a)?`${this.canonicalAuthority}.well-known/openid-configuration`:`${this.canonicalAuthority}v2.0/.well-known/openid-configuration`}discoveryComplete(){return!!this.metadata}async resolveEndpointsAsync(){this.performanceClient?.addQueueMeasurement(S,this.correlationId);let a=this.getCurrentMetadataEntity(),b=await dr(this.updateCloudDiscoveryMetadata.bind(this),U,this.logger,this.performanceClient,this.correlationId)(a);this.canonicalAuthority=this.canonicalAuthority.replace(this.hostnameAndPort,a.preferred_network);let c=await dr(this.updateEndpointMetadata.bind(this),W,this.logger,this.performanceClient,this.correlationId)(a);this.updateCachedMetadata(a,b,{source:c}),this.performanceClient?.addFields({cloudDiscoverySource:b,authorityEndpointSource:c},this.correlationId)}getCurrentMetadataEntity(){let a=this.cacheManager.getAuthorityMetadataByAlias(this.hostnameAndPort);return a||(a={aliases:[],preferred_cache:this.hostnameAndPort,preferred_network:this.hostnameAndPort,canonical_authority:this.canonicalAuthority,authorization_endpoint:"",token_endpoint:"",end_session_endpoint:"",issuer:"",aliasesFromNetwork:!1,endpointsFromNetwork:!1,expiresAt:dM(),jwks_uri:""}),a}updateCachedMetadata(a,b,c){b!==aR.AuthorityMetadataSource.CACHE&&c?.source!==aR.AuthorityMetadataSource.CACHE&&(a.expiresAt=dM(),a.canonical_authority=this.canonicalAuthority);let d=this.cacheManager.generateAuthorityMetadataCacheKey(a.preferred_cache);this.cacheManager.setAuthorityMetadata(d,a),this.metadata=a}async updateEndpointMetadata(a){this.performanceClient?.addQueueMeasurement(W,this.correlationId);let b=this.updateEndpointMetadataFromLocalSources(a);if(b)return b.source===aR.AuthorityMetadataSource.HARDCODED_VALUES&&this.authorityOptions.azureRegionConfiguration?.azureRegion&&b.metadata&&(dN(a,await dr(this.updateMetadataWithRegionalInformation.bind(this),X,this.logger,this.performanceClient,this.correlationId)(b.metadata),!1),a.canonical_authority=this.canonicalAuthority),b.source;let c=await dr(this.getEndpointMetadataFromNetwork.bind(this),V,this.logger,this.performanceClient,this.correlationId)();if(c)return this.authorityOptions.azureRegionConfiguration?.azureRegion&&(c=await dr(this.updateMetadataWithRegionalInformation.bind(this),X,this.logger,this.performanceClient,this.correlationId)(c)),dN(a,c,!0),aR.AuthorityMetadataSource.NETWORK;throw(0,aN.createClientAuthError)(aO.openIdConfigError,this.defaultOpenIdConfigurationEndpoint)}updateEndpointMetadataFromLocalSources(a){this.logger.verbose("Attempting to get endpoint metadata from authority configuration");let b=this.getEndpointMetadataFromConfig();if(b)return this.logger.verbose("Found endpoint metadata in authority configuration"),dN(a,b,!1),{source:aR.AuthorityMetadataSource.CONFIG};if(this.logger.verbose("Did not find endpoint metadata in the config... Attempting to get endpoint metadata from the hardcoded values."),this.authorityOptions.skipAuthorityMetadataCache)this.logger.verbose("Skipping hardcoded metadata cache since skipAuthorityMetadataCache is set to true. Attempting to get endpoint metadata from the network metadata cache.");else{let b=this.getEndpointMetadataFromHardcodedValues();if(b)return dN(a,b,!1),{source:aR.AuthorityMetadataSource.HARDCODED_VALUES,metadata:b};this.logger.verbose("Did not find endpoint metadata in hardcoded values... Attempting to get endpoint metadata from the network metadata cache.")}let c=dP(a);return this.isAuthoritySameType(a)&&a.endpointsFromNetwork&&!c?(this.logger.verbose("Found endpoint metadata in the cache."),{source:aR.AuthorityMetadataSource.CACHE}):(c&&this.logger.verbose("The metadata entity is expired."),null)}isAuthoritySameType(a){return new a6(a.canonical_authority).getUrlComponents().PathSegments.length===this.canonicalAuthorityUrlComponents.PathSegments.length}getEndpointMetadataFromConfig(){if(this.authorityOptions.authorityMetadata)try{return JSON.parse(this.authorityOptions.authorityMetadata)}catch(a){throw aL(aw)}return null}async getEndpointMetadataFromNetwork(){this.performanceClient?.addQueueMeasurement(V,this.correlationId);let a=this.defaultOpenIdConfigurationEndpoint;this.logger.verbose(`Authority.getEndpointMetadataFromNetwork: attempting to retrieve OAuth endpoints from ${a}`);try{var b;let c=await this.networkInterface.sendGetRequestAsync(a,{});if((b=c.body).hasOwnProperty("authorization_endpoint")&&b.hasOwnProperty("token_endpoint")&&b.hasOwnProperty("issuer")&&b.hasOwnProperty("jwks_uri"))return c.body;return this.logger.verbose("Authority.getEndpointMetadataFromNetwork: could not parse response as OpenID configuration"),null}catch(a){return this.logger.verbose(`Authority.getEndpointMetadataFromNetwork: ${a}`),null}}getEndpointMetadataFromHardcodedValues(){return this.hostnameAndPort in a7?a7[this.hostnameAndPort]:null}async updateMetadataWithRegionalInformation(a){this.performanceClient?.addQueueMeasurement(X,this.correlationId);let b=this.authorityOptions.azureRegionConfiguration?.azureRegion;if(b){if(b!==aR.Constants.AZURE_REGION_AUTO_DISCOVER_FLAG)return this.regionDiscoveryMetadata.region_outcome=aR.RegionDiscoveryOutcomes.CONFIGURED_NO_AUTO_DETECTION,this.regionDiscoveryMetadata.region_used=b,dQ.replaceWithRegionalInformation(a,b);let c=await dr(this.regionDiscovery.detectRegion.bind(this.regionDiscovery),Y,this.logger,this.performanceClient,this.correlationId)(this.authorityOptions.azureRegionConfiguration?.environmentRegion,this.regionDiscoveryMetadata);if(c)return this.regionDiscoveryMetadata.region_outcome=aR.RegionDiscoveryOutcomes.AUTO_DETECTION_REQUESTED_SUCCESSFUL,this.regionDiscoveryMetadata.region_used=c,dQ.replaceWithRegionalInformation(a,c);this.regionDiscoveryMetadata.region_outcome=aR.RegionDiscoveryOutcomes.AUTO_DETECTION_REQUESTED_FAILED}return a}async updateCloudDiscoveryMetadata(a){this.performanceClient?.addQueueMeasurement(U,this.correlationId);let b=this.updateCloudDiscoveryMetadataFromLocalSources(a);if(b)return b;let c=await dr(this.getCloudDiscoveryMetadataFromNetwork.bind(this),T,this.logger,this.performanceClient,this.correlationId)();if(c)return dO(a,c,!0),aR.AuthorityMetadataSource.NETWORK;throw aL(ax)}updateCloudDiscoveryMetadataFromLocalSources(a){this.logger.verbose("Attempting to get cloud discovery metadata  from authority configuration"),this.logger.verbosePii(`Known Authorities: ${this.authorityOptions.knownAuthorities||aR.Constants.NOT_APPLICABLE}`),this.logger.verbosePii(`Authority Metadata: ${this.authorityOptions.authorityMetadata||aR.Constants.NOT_APPLICABLE}`),this.logger.verbosePii(`Canonical Authority: ${a.canonical_authority||aR.Constants.NOT_APPLICABLE}`);let b=this.getCloudDiscoveryMetadataFromConfig();if(b)return this.logger.verbose("Found cloud discovery metadata in authority configuration"),dO(a,b,!1),aR.AuthorityMetadataSource.CONFIG;if(this.logger.verbose("Did not find cloud discovery metadata in the config... Attempting to get cloud discovery metadata from the hardcoded values."),this.options.skipAuthorityMetadataCache)this.logger.verbose("Skipping hardcoded cloud discovery metadata cache since skipAuthorityMetadataCache is set to true. Attempting to get cloud discovery metadata from the network metadata cache.");else{var c;let b=(c=this.hostnameAndPort,bb(a8,c));if(b)return this.logger.verbose("Found cloud discovery metadata from hardcoded values."),dO(a,b,!1),aR.AuthorityMetadataSource.HARDCODED_VALUES;this.logger.verbose("Did not find cloud discovery metadata in hardcoded values... Attempting to get cloud discovery metadata from the network metadata cache.")}let d=dP(a);return this.isAuthoritySameType(a)&&a.aliasesFromNetwork&&!d?(this.logger.verbose("Found cloud discovery metadata in the cache."),aR.AuthorityMetadataSource.CACHE):(d&&this.logger.verbose("The metadata entity is expired."),null)}getCloudDiscoveryMetadataFromConfig(){if(this.authorityType===dp.AuthorityType.Ciam)return this.logger.verbose("CIAM authorities do not support cloud discovery metadata, generate the aliases from authority host."),dQ.createCloudDiscoveryMetadataFromHost(this.hostnameAndPort);if(this.authorityOptions.cloudDiscoveryMetadata){this.logger.verbose("The cloud discovery metadata has been provided as a network response, in the config.");try{this.logger.verbose("Attempting to parse the cloud discovery metadata.");let a=JSON.parse(this.authorityOptions.cloudDiscoveryMetadata),b=bb(a.metadata,this.hostnameAndPort);if(this.logger.verbose("Parsed the cloud discovery metadata."),b)return this.logger.verbose("There is returnable metadata attached to the parsed cloud discovery metadata."),b;this.logger.verbose("There is no metadata attached to the parsed cloud discovery metadata.")}catch(a){throw this.logger.verbose("Unable to parse the cloud discovery metadata. Throwing Invalid Cloud Discovery Metadata Error."),aL(av)}}return this.isInKnownAuthorities()?(this.logger.verbose("The host is included in knownAuthorities. Creating new cloud discovery metadata from the host."),dQ.createCloudDiscoveryMetadataFromHost(this.hostnameAndPort)):null}async getCloudDiscoveryMetadataFromNetwork(){this.performanceClient?.addQueueMeasurement(T,this.correlationId);let a=`${aR.Constants.AAD_INSTANCE_DISCOVERY_ENDPT}${this.canonicalAuthority}oauth2/v2.0/authorize`,b=null;try{var c,d;let e,f,g=await this.networkInterface.sendGetRequestAsync(a,{});if((c=g.body).hasOwnProperty("tenant_discovery_endpoint")&&c.hasOwnProperty("metadata"))f=(e=g.body).metadata,this.logger.verbosePii(`tenant_discovery_endpoint is: ${e.tenant_discovery_endpoint}`);else{if(!((d=g.body).hasOwnProperty("error")&&d.hasOwnProperty("error_description")))return this.logger.error("AAD did not return a CloudInstanceDiscoveryResponse or CloudInstanceDiscoveryErrorResponse"),null;if(this.logger.warning(`A CloudInstanceDiscoveryErrorResponse was returned. The cloud instance discovery network request's status code is: ${g.status}`),(e=g.body).error===aR.Constants.INVALID_INSTANCE)return this.logger.error("The CloudInstanceDiscoveryErrorResponse error is invalid_instance."),null;this.logger.warning(`The CloudInstanceDiscoveryErrorResponse error is ${e.error}`),this.logger.warning(`The CloudInstanceDiscoveryErrorResponse error description is ${e.error_description}`),this.logger.warning("Setting the value of the CloudInstanceDiscoveryMetadata (returned from the network) to []"),f=[]}this.logger.verbose("Attempting to find a match between the developer's authority and the CloudInstanceDiscoveryMetadata returned from the network request."),b=bb(f,this.hostnameAndPort)}catch(a){return a instanceof aj.AuthError?this.logger.error(`There was a network error while attempting to get the cloud discovery instance metadata.
Error: ${a.errorCode}
Error Description: ${a.errorMessage}`):this.logger.error(`A non-MSALJS error was thrown while attempting to get the cloud instance discovery metadata.
Error: ${a.name}
Error Description: ${a.message}`),null}return b||(this.logger.warning("The developer's authority was not found within the CloudInstanceDiscoveryMetadata returned from the network request."),this.logger.verbose("Creating custom Authority for custom domain scenario."),b=dQ.createCloudDiscoveryMetadataFromHost(this.hostnameAndPort)),b}isInKnownAuthorities(){return this.authorityOptions.knownAuthorities.filter(a=>a&&a6.getDomainFromUrl(a).toLowerCase()===this.hostnameAndPort).length>0}static generateAuthority(a,b){let c;if(b&&b.azureCloudInstance!==aU){let a=b.tenant?b.tenant:aR.Constants.DEFAULT_COMMON_TENANT;c=`${b.azureCloudInstance}/${a}/`}return c||a}static createCloudDiscoveryMetadataFromHost(a){return{preferred_network:a,preferred_cache:a,aliases:[a]}}getPreferredCache(){if(this.managedIdentity)return aR.Constants.DEFAULT_AUTHORITY_HOST;if(this.discoveryComplete())return this.metadata.preferred_cache;throw(0,aN.createClientAuthError)(aO.endpointResolutionError)}isAlias(a){return this.metadata.aliases.indexOf(a)>-1}isAliasOfKnownMicrosoftAuthority(a){return a9.has(a)}static isPublicCloudAuthority(a){return aR.Constants.KNOWN_PUBLIC_CLOUDS.indexOf(a)>=0}static buildRegionalAuthorityString(a,b,c){let d=new a6(a);d.validateAsUri();let e=d.getUrlComponents(),f=`${b}.${e.HostNameAndPort}`;this.isPublicCloudAuthority(e.HostNameAndPort)&&(f=`${b}.${aR.Constants.REGIONAL_AUTH_PUBLIC_CLOUD_SUFFIX}`);let g=a6.constructAuthorityUriFromObject({...d.getUrlComponents(),HostNameAndPort:f}).urlString;return c?`${g}?${c}`:g}static replaceWithRegionalInformation(a,b){let c={...a};return c.authorization_endpoint=dQ.buildRegionalAuthorityString(c.authorization_endpoint,b),c.token_endpoint=dQ.buildRegionalAuthorityString(c.token_endpoint,b),c.end_session_endpoint&&(c.end_session_endpoint=dQ.buildRegionalAuthorityString(c.end_session_endpoint,b)),c}static transformCIAMAuthority(a){let b=a,c=new a6(a).getUrlComponents();if(0===c.PathSegments.length&&c.HostNameAndPort.endsWith(aR.Constants.CIAM_AUTH_URL)){let a=c.HostNameAndPort.split(".")[0];b=`${b}${a}${aR.Constants.AAD_TENANT_DOMAIN_SUFFIX}`}return b}}function dR(a){return a.endsWith(aR.Constants.FORWARD_SLASH)?a:`${a}${aR.Constants.FORWARD_SLASH}`}dQ.reservedTenantDomains=new Set(["{tenant}","{tenantid}",aR.AADAuthorityConstants.COMMON,aR.AADAuthorityConstants.CONSUMERS,aR.AADAuthorityConstants.ORGANIZATIONS]);var dS=a.i(51644),cH=aO,dT=a.i(59703),dT=dT;function dU(a,b,c){return{clientId:a,authority:b.authority,scopes:b.scopes,homeAccountIdentifier:c,claims:b.claims,authenticationScheme:b.authenticationScheme,resourceRequestMethod:b.resourceRequestMethod,resourceRequestUri:b.resourceRequestUri,shrClaims:b.shrClaims,sshKid:b.sshKid,embeddedClientId:b.embeddedClientId||b.tokenBodyParameters?.clientId}}var dV=a.i(85733),dV=dV,dW=a.i(64509),dW=dW,dX=a.i(54895),dX=dX,dT=dT,dY=a.i(23962),dZ=a.i(53814),cH=aO;let d$="None";class d_{initialize(){return Promise.resolve()}getItem(a){let b=`${encodeURIComponent(a)}`,c=document.cookie.split(";");for(let a=0;a<c.length;a++){let[d,...e]=decodeURIComponent(c[a]).trim().split("="),f=e.join("=");if(d===b)return f}return""}getUserData(){throw(0,aN.createClientAuthError)(cH.methodNotImplemented)}setItem(a,b,c,d=!0,e="Lax"){let f=`${encodeURIComponent(a)}=${encodeURIComponent(b)};path=/;SameSite=${e};`;if(c){var g;let a=(g=c,new Date(new Date().getTime()+864e5*g).toUTCString());f+=`expires=${a};`}(d||e===d$)&&(f+="Secure;"),document.cookie=f}async setUserData(){return Promise.reject((0,aN.createClientAuthError)(cH.methodNotImplemented))}removeItem(a){this.setItem(a,"",-1)}getKeys(){let a=document.cookie.split(";"),b=[];return a.forEach(a=>{let c=decodeURIComponent(a).trim().split("=");b.push(c[0])}),b}containsKey(a){return this.getKeys().includes(a)}decryptData(){return Promise.resolve(null)}}function d0(a,b){let c=a.getItem(cC(b));return c?JSON.parse(c):[]}function d1(a,b,c){let d=b.getItem(cD(a,c));if(d){let a=JSON.parse(d);if(a&&a.hasOwnProperty("idToken")&&a.hasOwnProperty("accessToken")&&a.hasOwnProperty("refreshToken"))return a}return{idToken:[],accessToken:[],refreshToken:[]}}function d2(a){return a.hasOwnProperty("id")&&a.hasOwnProperty("nonce")&&a.hasOwnProperty("data")}var d3=a.i(18865);let d4="msal.cache.encryption";class d5{constructor(a,b,c){if(!window.localStorage)throw(0,dZ.createBrowserConfigurationAuthError)(d3.storageNotSupported);this.memoryStorage=new dk,this.initialized=!1,this.clientId=a,this.logger=b,this.performanceClient=c,this.broadcast=new BroadcastChannel("msal.broadcast.cache")}async initialize(a){let b=new d_,c=b.getItem(d4),d={key:"",id:""};if(c)try{d=JSON.parse(c)}catch(a){}if(d.key&&d.id){let b=dq(cU,"base64Decode",this.logger,this.performanceClient,a)(d.key);this.encryptionCookie={id:d.id,key:await dr(de,ad,this.logger,this.performanceClient,a)(b)}}else{let c=c5(),d=await dr(dd,"generateBaseKey",this.logger,this.performanceClient,a)(),e=dq(cQ,"urlEncodeArr",this.logger,this.performanceClient,a)(new Uint8Array(d));this.encryptionCookie={id:c,key:await dr(de,ad,this.logger,this.performanceClient,a)(d)},b.setItem(d4,JSON.stringify({id:c,key:e}),0,!0,d$)}await dr(this.importExistingCache.bind(this),"importExistingCache",this.logger,this.performanceClient,a)(a),this.broadcast.addEventListener("message",this.updateCache.bind(this)),this.initialized=!0}getItem(a){return window.localStorage.getItem(a)}getUserData(a){if(!this.initialized)throw cm(cb);return this.memoryStorage.getItem(a)}async decryptData(a,b,c){if(!this.initialized||!this.encryptionCookie)throw cm(cb);if(b.id!==this.encryptionCookie.id)return this.performanceClient.incrementFields({encryptedCacheExpiredCount:1},c),null;let d=await dr(dh,ae,this.logger,this.performanceClient,c)(this.encryptionCookie.key,b.nonce,this.getContext(a),b.data);if(!d)return null;try{return{...JSON.parse(d),lastUpdatedAt:b.lastUpdatedAt}}catch(a){return this.performanceClient.incrementFields({encryptedCacheCorruptionCount:1},c),null}}setItem(a,b){window.localStorage.setItem(a,b)}async setUserData(a,b,c,d,e){if(!this.initialized||!this.encryptionCookie)throw cm(cb);if(e)this.setItem(a,b);else{let{data:e,nonce:f}=await dr(dg,"encrypt",this.logger,this.performanceClient,c)(this.encryptionCookie.key,b,this.getContext(a)),g={id:this.encryptionCookie.id,nonce:f,data:e,lastUpdatedAt:d};this.setItem(a,JSON.stringify(g))}this.memoryStorage.setItem(a,b),this.broadcast.postMessage({key:a,value:b,context:this.getContext(a)})}removeItem(a){this.memoryStorage.containsKey(a)&&(this.memoryStorage.removeItem(a),this.broadcast.postMessage({key:a,value:null,context:this.getContext(a)})),window.localStorage.removeItem(a)}getKeys(){return Object.keys(window.localStorage)}containsKey(a){return window.localStorage.hasOwnProperty(a)}clear(){this.memoryStorage.clear(),d0(this).forEach(a=>this.removeItem(a));let a=d1(this.clientId,this);a.idToken.forEach(a=>this.removeItem(a)),a.accessToken.forEach(a=>this.removeItem(a)),a.refreshToken.forEach(a=>this.removeItem(a)),this.getKeys().forEach(a=>{(a.startsWith(cv)||-1!==a.indexOf(this.clientId))&&this.removeItem(a)})}async importExistingCache(a){if(!this.encryptionCookie)return;let b=d0(this);(b=await this.importArray(b,a)).length?this.setItem(cC(),JSON.stringify(b)):this.removeItem(cC());let c=d1(this.clientId,this);c.idToken=await this.importArray(c.idToken,a),c.accessToken=await this.importArray(c.accessToken,a),c.refreshToken=await this.importArray(c.refreshToken,a),c.idToken.length||c.accessToken.length||c.refreshToken.length?this.setItem(cD(this.clientId),JSON.stringify(c)):this.removeItem(cD(this.clientId))}async getItemFromEncryptedCache(a,b){let c;if(!this.encryptionCookie)return null;let d=this.getItem(a);if(!d)return null;try{c=JSON.parse(d)}catch(a){return null}return d2(c)?c.id!==this.encryptionCookie.id?(this.performanceClient.incrementFields({encryptedCacheExpiredCount:1},b),null):(this.performanceClient.incrementFields({encryptedCacheCount:1},b),dr(dh,ae,this.logger,this.performanceClient,b)(this.encryptionCookie.key,c.nonce,this.getContext(a),c.data)):(this.performanceClient.incrementFields({unencryptedCacheCount:1},b),d)}async importArray(a,b){let c=[],d=[];return a.forEach(a=>{let e=this.getItemFromEncryptedCache(a,b).then(b=>{b?(this.memoryStorage.setItem(a,b),c.push(a)):this.removeItem(a)});d.push(e)}),await Promise.all(d),c}getContext(a){let b="";return a.includes(this.clientId)&&(b=this.clientId),b}updateCache(a){this.logger.trace("Updating internal cache from broadcast event");let b=this.performanceClient.startMeasurement("localStorageUpdated");b.add({isBackground:!0});let{key:c,value:d,context:e}=a.data;if(!c){this.logger.error("Broadcast event missing key"),b.end({success:!1,errorCode:"noKey"});return}if(e&&e!==this.clientId){this.logger.trace(`Ignoring broadcast event from clientId: ${e}`),b.end({success:!1,errorCode:"contextMismatch"});return}d?(this.memoryStorage.setItem(c,d),this.logger.verbose("Updated item in internal cache")):(this.memoryStorage.removeItem(c),this.logger.verbose("Removed item from internal cache")),b.end({success:!0})}}class d6{constructor(){if(!window.sessionStorage)throw(0,dZ.createBrowserConfigurationAuthError)(d3.storageNotSupported)}async initialize(){}getItem(a){return window.sessionStorage.getItem(a)}getUserData(a){return this.getItem(a)}setItem(a,b){window.sessionStorage.setItem(a,b)}async setUserData(a,b){this.setItem(a,b)}removeItem(a){window.sessionStorage.removeItem(a)}getKeys(){return Object.keys(window.sessionStorage)}containsKey(a){return window.sessionStorage.hasOwnProperty(a)}decryptData(){return Promise.resolve(null)}}var d7=a.i(88562);let d8="client_id",d9="redirect_uri",ea="response_type",eb="response_mode",ec="grant_type",ed="claims",ee="scope",ef="refresh_token",eg="state",eh="nonce",ei="prompt",ej="code",ek="code_challenge",el="code_challenge_method",em="code_verifier",en="client-request-id",eo="x-client-SKU",ep="x-client-VER",eq="x-client-OS",er="x-client-CPU",es="x-client-current-telemetry",et="x-client-last-telemetry",eu="x-ms-lib-capability",ev="x-app-name",ew="x-app-ver",ex="post_logout_redirect_uri",ey="id_token_hint",ez="device_code",eA="client_secret",eB="client_assertion",eC="client_assertion_type",eD="token_type",eE="req_cnf",eF="assertion",eG="requested_token_use",eH="return_spa_code",eI="nativebroker",eJ="logout_hint",eK="login_hint",eL="domain_hint",eM="brk_client_id",eN="brk_redirect_uri",eO="instance_aware",eP="ear_jwk",eQ="ear_jwe_crypto";function eR(a,b,c){if(!b)return;let d=a.get(d8);d&&a.has(eM)&&c?.addFields({embeddedClientId:d,embeddedRedirectUri:a.get(d9)},b)}function eS(a,b){a.set(ea,b)}function eT(a,b){a.set(eb,b||aR.ResponseMode.QUERY)}function eU(a){a.set(eI,"1")}function eV(a,b,c=!0,d=aR.OIDC_DEFAULT_SCOPES){!c||d.includes("openid")||b.includes("openid")||d.push("openid");let e=new aW(c?[...b||[],...d]:b||[]);a.set(ee,e.printScopes())}function eW(a,b){a.set(d8,b)}function eX(a,b){a.set(d9,b)}function eY(a,b){a.set(ex,b)}function eZ(a,b){a.set(ey,b)}function e$(a,b){a.set(eL,b)}function e_(a,b){a.set(eK,b)}function e0(a,b){a.set(aR.HeaderNames.CCS_HEADER,`UPN:${b}`)}function e1(a,b){a.set(aR.HeaderNames.CCS_HEADER,`Oid:${b.uid}@${b.utid}`)}function e2(a,b){a.set("sid",b)}function e3(a,b,c){let d=fo(b,c);try{JSON.parse(d)}catch(a){throw aL(aq)}a.set(ed,d)}function e4(a,b){a.set(en,b)}function e5(a,b){a.set(eo,b.sku),a.set(ep,b.version),b.os&&a.set(eq,b.os),b.cpu&&a.set(er,b.cpu)}function e6(a,b){b?.appName&&a.set(ev,b.appName),b?.appVersion&&a.set(ew,b.appVersion)}function e7(a,b){a.set(ei,b)}function e8(a,b){b&&a.set(eg,b)}function e9(a,b){a.set(eh,b)}function fa(a,b,c){if(b&&c)a.set(ek,b),a.set(el,c);else throw aL(au)}function fb(a,b){a.set(ej,b)}function fc(a,b){a.set(ez,b)}function fd(a,b){a.set(ef,b)}function fe(a,b){a.set(em,b)}function ff(a,b){a.set(eA,b)}function fg(a,b){b&&a.set(eB,b)}function fh(a,b){b&&a.set(eC,b)}function fi(a,b){a.set(eF,b)}function fj(a,b){a.set(eG,b)}function fk(a,b){a.set(ec,b)}function fl(a){a.set(aR.CLIENT_INFO,"1")}function fm(a){a.has(eO)||a.set(eO,"true")}function fn(a,b){Object.entries(b).forEach(([b,c])=>{!a.has(b)&&c&&a.set(b,c)})}function fo(a,b){let c;if(a)try{c=JSON.parse(a)}catch(a){throw aL(aq)}else c={};return b&&b.length>0&&(c.hasOwnProperty(aR.ClaimsRequestKeys.ACCESS_TOKEN)||(c[aR.ClaimsRequestKeys.ACCESS_TOKEN]={}),c[aR.ClaimsRequestKeys.ACCESS_TOKEN][aR.ClaimsRequestKeys.XMS_CC]={values:b}),JSON.stringify(c)}function fp(a,b){a.set(aR.PasswordGrantConstants.username,b)}function fq(a,b){a.set(aR.PasswordGrantConstants.password,b)}function fr(a,b){b&&(a.set(eD,aR.AuthenticationScheme.POP),a.set(eE,b))}function fs(a,b){b&&(a.set(eD,aR.AuthenticationScheme.SSH),a.set(eE,b))}function ft(a,b){a.set(es,b.generateCurrentRequestHeaderValue()),a.set(et,b.generateLastRequestHeaderValue())}function fu(a){a.set(eu,aR.ThrottlingConstants.X_MS_LIB_CAPABILITY_VALUE)}function fv(a,b){a.set(eJ,b)}function fw(a,b,c){a.has(eM)||a.set(eM,b),a.has(eN)||a.set(eN,c)}function fx(a,b){a.set(eP,encodeURIComponent(b)),a.set(eQ,"eyJhbGciOiJkaXIiLCJlbmMiOiJBMjU2R0NNIn0")}function fy(a,b){Object.entries(b).forEach(([b,c])=>{c&&a.set(b,c)})}a.s(["ACCESS_TOKEN",()=>"access_token","BROKER_CLIENT_ID",()=>eM,"BROKER_REDIRECT_URI",()=>eN,"CCS_HEADER",()=>"X-AnchorMailbox","CLAIMS",()=>ed,"CLIENT_ASSERTION",()=>eB,"CLIENT_ASSERTION_TYPE",()=>eC,"CLIENT_ID",()=>d8,"CLIENT_INFO",()=>"client_info","CLIENT_REQUEST_ID",()=>en,"CLIENT_SECRET",()=>eA,"CODE",()=>ej,"CODE_CHALLENGE",()=>ek,"CODE_CHALLENGE_METHOD",()=>el,"CODE_VERIFIER",()=>em,"DEVICE_CODE",()=>ez,"DOMAIN_HINT",()=>eL,"EAR_JWE_CRYPTO",()=>eQ,"EAR_JWK",()=>eP,"ERROR",()=>"error","ERROR_DESCRIPTION",()=>"error_description","EXPIRES_IN",()=>"expires_in","FOCI",()=>"foci","GRANT_TYPE",()=>ec,"ID_TOKEN",()=>"id_token","ID_TOKEN_HINT",()=>ey,"INSTANCE_AWARE",()=>eO,"LOGIN_HINT",()=>eK,"LOGOUT_HINT",()=>eJ,"NATIVE_BROKER",()=>eI,"NONCE",()=>eh,"OBO_ASSERTION",()=>eF,"ON_BEHALF_OF",()=>"on_behalf_of","POST_LOGOUT_URI",()=>ex,"PROMPT",()=>ei,"REDIRECT_URI",()=>d9,"REFRESH_TOKEN",()=>ef,"REFRESH_TOKEN_EXPIRES_IN",()=>"refresh_token_expires_in","REQUESTED_TOKEN_USE",()=>eG,"REQ_CNF",()=>eE,"RESPONSE_MODE",()=>eb,"RESPONSE_TYPE",()=>ea,"RETURN_SPA_CODE",()=>eH,"SCOPE",()=>ee,"SESSION_STATE",()=>"session_state","SID",()=>"sid","STATE",()=>eg,"TOKEN_TYPE",()=>eD,"X_APP_NAME",()=>ev,"X_APP_VER",()=>ew,"X_CLIENT_CPU",()=>er,"X_CLIENT_CURR_TELEM",()=>es,"X_CLIENT_EXTRA_SKU",()=>"x-client-xtra-sku","X_CLIENT_LAST_TELEM",()=>et,"X_CLIENT_OS",()=>eq,"X_CLIENT_SKU",()=>eo,"X_CLIENT_VER",()=>ep,"X_MS_LIB_CAPABILITY",()=>eu],30553),a.s(["addApplicationTelemetry",()=>e6,"addAuthorizationCode",()=>fb,"addBrokerParameters",()=>fw,"addCcsOid",()=>e1,"addCcsUpn",()=>e0,"addClaims",()=>e3,"addClientAssertion",()=>fg,"addClientAssertionType",()=>fh,"addClientCapabilitiesToClaims",()=>fo,"addClientId",()=>eW,"addClientInfo",()=>fl,"addClientSecret",()=>ff,"addCodeChallengeParams",()=>fa,"addCodeVerifier",()=>fe,"addCorrelationId",()=>e4,"addDeviceCode",()=>fc,"addDomainHint",()=>e$,"addEARParameters",()=>fx,"addExtraQueryParameters",()=>fn,"addGrantType",()=>fk,"addIdTokenHint",()=>eZ,"addInstanceAware",()=>fm,"addLibraryInfo",()=>e5,"addLoginHint",()=>e_,"addLogoutHint",()=>fv,"addNativeBroker",()=>eU,"addNonce",()=>e9,"addOboAssertion",()=>fi,"addPassword",()=>fq,"addPopToken",()=>fr,"addPostBodyParameters",()=>fy,"addPostLogoutRedirectUri",()=>eY,"addPrompt",()=>e7,"addRedirectUri",()=>eX,"addRefreshToken",()=>fd,"addRequestTokenUse",()=>fj,"addResponseMode",()=>eT,"addResponseType",()=>eS,"addScopes",()=>eV,"addServerTelemetry",()=>ft,"addSid",()=>e2,"addSshJwk",()=>fs,"addState",()=>e8,"addThrottling",()=>fu,"addUsername",()=>fp,"instrumentBrokerParams",()=>eR],74374);var fz=a.i(74374),fz=fz;function fA(a){a.location.hash="","function"==typeof a.history.replaceState&&a.history.replaceState(null,"",`${a.location.origin}${a.location.pathname}${a.location.search}`)}function fB(){return window.parent!==window}function fC(){throw cm(bX)}function fD(a){if(!a)throw cm(cb)}function fE(a){if(fC(),a6.hashContainsKnownProperties(window.location.hash)&&fB())throw cm(bN);fD(a)}function fF(a,b){fE(a);var c=b.system.allowRedirectInIframe;if(fB()&&!c)throw cm(bM);if(b.cache.cacheLocation===bu.BrowserCacheLocation.MemoryStorage&&!b.cache.storeAuthStateInCookie)throw(0,dZ.createBrowserConfigurationAuthError)(d3.inMemRedirectUnavailable)}function fG(a){let b=document.createElement("link");b.rel="preconnect",b.href=new URL(a).origin,b.crossOrigin="anonymous",document.head.appendChild(b),window.setTimeout(()=>{try{document.head.removeChild(b)}catch{}},1e4)}function fH(a,b){let c=a.indexOf(b);c>-1&&a.splice(c,1)}fz.addClientCapabilitiesToClaims;class fI extends bj{constructor(a,b,c,d,e,f,g){super(a,c,d,e,g),this.cacheConfig=b,this.logger=d,this.internalStorage=new dk,this.browserStorage=fJ(a,b.cacheLocation,d,e),this.temporaryCacheStorage=fJ(a,b.temporaryCacheLocation,d,e),this.cookieStorage=new d_,this.eventHandler=f}async initialize(a){this.performanceClient.addFields({cacheLocation:this.cacheConfig.cacheLocation,cacheRetentionDays:this.cacheConfig.cacheRetentionDays},a),await this.browserStorage.initialize(a),await this.migrateExistingCache(a),this.trackVersionChanges(a)}async migrateExistingCache(a){let b=d0(this.browserStorage),c=d1(this.clientId,this.browserStorage);this.performanceClient.addFields({preMigrateAcntCount:b.length,preMigrateATCount:c.accessToken.length,preMigrateITCount:c.idToken.length,preMigrateRTCount:c.refreshToken.length},a);for(let b=0;b<2;b++){let c=b;await this.removeStaleAccounts(b,c,a)}for(let b=0;b<2;b++){let c=b;await this.migrateIdTokens(b,c,a)}let d=this.getKMSIValues();for(let b=0;b<2;b++)await this.migrateAccessTokens(b,d,a),await this.migrateRefreshTokens(b,d,a);b=d0(this.browserStorage),c=d1(this.clientId,this.browserStorage),this.performanceClient.addFields({postMigrateAcntCount:b.length,postMigrateATCount:c.accessToken.length,postMigrateITCount:c.idToken.length,postMigrateRTCount:c.refreshToken.length},a)}async updateOldEntry(a,b){let c=this.browserStorage.getItem(a),d=this.validateAndParseJson(c||"");if(!d)return this.browserStorage.removeItem(a),null;if(d.lastUpdatedAt){if(dW.isCacheExpired(d.lastUpdatedAt,this.cacheConfig.cacheRetentionDays))return this.browserStorage.removeItem(a),this.performanceClient.incrementFields({expiredCacheRemovedCount:1},b),null}else d.lastUpdatedAt=Date.now().toString(),this.setItem(a,JSON.stringify(d),b);let e=d2(d)?await this.browserStorage.decryptData(a,d,b):d;return e&&dX.isCredentialEntity(e)?(dX.isAccessTokenEntity(e)||dX.isRefreshTokenEntity(e))&&e.expiresOn&&dW.isTokenExpired(e.expiresOn,aR.DEFAULT_TOKEN_RENEWAL_OFFSET_SEC)?(this.browserStorage.removeItem(a),this.performanceClient.incrementFields({expiredCacheRemovedCount:1},b),null):e:(this.performanceClient.incrementFields({invalidCacheCount:1},b),null)}async removeStaleAccounts(a,b,c){let d=d0(this.browserStorage,a);if(0!==d.length){for(let a of[...d]){this.performanceClient.incrementFields({oldAcntCount:1},c);let e=this.browserStorage.getItem(a),f=this.validateAndParseJson(e||"");if(!f){fH(d,a);continue}if(f.lastUpdatedAt)dW.isCacheExpired(f.lastUpdatedAt,this.cacheConfig.cacheRetentionDays)&&(await this.removeAccountOldSchema(a,f,b,c),fH(d,a));else{f.lastUpdatedAt=Date.now().toString(),this.setItem(a,JSON.stringify(f),c);continue}}this.setAccountKeys(d,c,a)}}async removeAccountOldSchema(a,b,c,d){let e=d2(b)?await this.browserStorage.decryptData(a,b,d):b,f=e?.homeAccountId;if(f){let a=this.getTokenKeys(c);[...a.idToken].filter(a=>a.includes(f)).forEach(b=>{this.browserStorage.removeItem(b),fH(a.idToken,b)}),[...a.accessToken].filter(a=>a.includes(f)).forEach(b=>{this.browserStorage.removeItem(b),fH(a.accessToken,b)}),[...a.refreshToken].filter(a=>a.includes(f)).forEach(b=>{this.browserStorage.removeItem(b),fH(a.refreshToken,b)}),this.setTokenKeys(a,d,c)}this.performanceClient.incrementFields({expiredAcntRemovedCount:1},d),this.browserStorage.removeItem(a)}getKMSIValues(){let a={};for(let b of this.getTokenKeys().idToken){let c=this.browserStorage.getUserData(b);if(c){let b=JSON.parse(c),d=dT.extractTokenClaims(b.secret,cT);d&&(a[b.homeAccountId]=dT.isKmsi(d))}}return a}async migrateIdTokens(a,b,c){let d=d1(this.clientId,this.browserStorage,a);if(0===d.idToken.length)return;let e=d1(this.clientId,this.browserStorage,2),f=d0(this.browserStorage),g=d0(this.browserStorage,b);for(let a of[...d.idToken]){this.performanceClient.incrementFields({oldITCount:1},c);let b=await this.updateOldEntry(a,c);if(!b){fH(d.idToken,a);continue}let h=f.find(a=>a.includes(b.homeAccountId)),i=g.find(a=>a.includes(b.homeAccountId)),j=null;if(h)j=this.getAccount(h,c);else if(i){let a=this.browserStorage.getItem(i),b=this.validateAndParseJson(a||"");j=b&&d2(b)?await this.browserStorage.decryptData(i,b,c):b}if(!j){this.performanceClient.incrementFields({skipITMigrateCount:1},c);continue}let k=dT.extractTokenClaims(b.secret,cT),l=this.generateCredentialKey(b),m=this.getIdTokenCredential(l,c),n=Object.keys(k).includes("signin_state"),o=m&&Object.keys(dT.extractTokenClaims(m.secret,cT)||{}).includes("signin_state");if(!m||b.lastUpdatedAt>m.lastUpdatedAt&&(n||!o)){let a=j.tenantProfiles||[],d=(0,dY.getTenantIdFromIdTokenClaims)(k)||j.realm;if(d&&!a.find(a=>a.tenantId===d)){let b=(0,aY.buildTenantProfile)(j.homeAccountId,j.localAccountId,d,k);a.push(b)}j.tenantProfiles=a;let g=this.generateAccountKey(aX.AccountEntity.getAccountInfo(j)),h=dT.isKmsi(k);await this.setUserData(g,JSON.stringify(j),c,j.lastUpdatedAt,h),f.includes(g)||f.push(g),await this.setUserData(l,JSON.stringify(b),c,b.lastUpdatedAt,h),this.performanceClient.incrementFields({migratedITCount:1},c),e.idToken.push(l)}}this.setTokenKeys(d,c,a),this.setTokenKeys(e,c),this.setAccountKeys(f,c)}async migrateAccessTokens(a,b,c){let d=d1(this.clientId,this.browserStorage,a);if(0===d.accessToken.length)return;let e=d1(this.clientId,this.browserStorage,2);for(let a of[...d.accessToken]){this.performanceClient.incrementFields({oldATCount:1},c);let f=await this.updateOldEntry(a,c);if(!f){fH(d.accessToken,a);continue}if(!Object.keys(b).includes(f.homeAccountId)){this.performanceClient.incrementFields({skipATMigrateCount:1},c);continue}let g=this.generateCredentialKey(f),h=b[f.homeAccountId];if(e.accessToken.includes(g)){let a=this.getAccessTokenCredential(g,c);(!a||f.lastUpdatedAt>a.lastUpdatedAt)&&(await this.setUserData(g,JSON.stringify(f),c,f.lastUpdatedAt,h),this.performanceClient.incrementFields({migratedATCount:1},c))}else await this.setUserData(g,JSON.stringify(f),c,f.lastUpdatedAt,h),this.performanceClient.incrementFields({migratedATCount:1},c),e.accessToken.push(g)}this.setTokenKeys(d,c,a),this.setTokenKeys(e,c)}async migrateRefreshTokens(a,b,c){let d=d1(this.clientId,this.browserStorage,a);if(0===d.refreshToken.length)return;let e=d1(this.clientId,this.browserStorage,2);for(let a of[...d.refreshToken]){this.performanceClient.incrementFields({oldRTCount:1},c);let f=await this.updateOldEntry(a,c);if(!f){fH(d.refreshToken,a);continue}if(!Object.keys(b).includes(f.homeAccountId)){this.performanceClient.incrementFields({skipRTMigrateCount:1},c);continue}let g=this.generateCredentialKey(f),h=b[f.homeAccountId];if(e.refreshToken.includes(g)){let a=this.getRefreshTokenCredential(g,c);(!a||f.lastUpdatedAt>a.lastUpdatedAt)&&(await this.setUserData(g,JSON.stringify(f),c,f.lastUpdatedAt,h),this.performanceClient.incrementFields({migratedRTCount:1},c))}else await this.setUserData(g,JSON.stringify(f),c,f.lastUpdatedAt,h),this.performanceClient.incrementFields({migratedRTCount:1},c),e.refreshToken.push(g)}this.setTokenKeys(d,c,a),this.setTokenKeys(e,c)}trackVersionChanges(a){let b=this.browserStorage.getItem(cz);b&&(this.logger.info(`MSAL.js was last initialized by version: ${b}`),this.performanceClient.addFields({previousLibraryVersion:b},a)),b!==cu&&this.setItem(cz,cu,a)}validateAndParseJson(a){if(!a)return null;try{let b=JSON.parse(a);return b&&"object"==typeof b?b:null}catch(a){return null}}setItem(a,b,c){let d=[,,,].fill(0),e=[];for(let f=0;f<=20;f++)try{if(this.browserStorage.setItem(a,b),f>0)for(let a=0;a<=2;a++){let b=d.slice(0,a).reduce((a,b)=>a+b,0);if(b>=f)break;let g=f>b+d[a]?b+d[a]:f;f>b&&d[a]>0&&this.removeAccessTokenKeys(e.slice(b,g),c,a)}break}catch(h){let g=bi(h);if(g.errorCode===bf.cacheQuotaExceeded&&f<20){if(!e.length)for(let c=0;c<=2;c++)if(a===cD(this.clientId,c)){let a=JSON.parse(b).accessToken;e.push(...a),d[c]=a.length}else{let a=this.getTokenKeys(c).accessToken;e.push(...a),d[c]=a.length}if(e.length<=f)throw g;this.removeAccessToken(e[f],c,!1)}else throw g}}async setUserData(a,b,c,d,e){let f=[,,,].fill(0),g=[];for(let h=0;h<=20;h++)try{if(await dr(this.browserStorage.setUserData.bind(this.browserStorage),"setUserData",this.logger,this.performanceClient)(a,b,c,d,e),h>0)for(let a=0;a<=2;a++){let b=f.slice(0,a).reduce((a,b)=>a+b,0);if(b>=h)break;let d=h>b+f[a]?b+f[a]:h;h>b&&f[a]>0&&this.removeAccessTokenKeys(g.slice(b,d),c,a)}break}catch(b){let a=bi(b);if(a.errorCode===bf.cacheQuotaExceeded&&h<20){if(!g.length)for(let a=0;a<=2;a++){let b=this.getTokenKeys(a).accessToken;g.push(...b),f[a]=b.length}if(g.length<=h)throw a;this.removeAccessToken(g[h],c,!1)}else throw a}}getAccount(a,b){this.logger.trace("BrowserCacheManager.getAccount called");let c=this.browserStorage.getUserData(a);if(!c)return this.removeAccountKeyFromMap(a,b),null;let d=this.validateAndParseJson(c);return d&&aX.AccountEntity.isAccountEntity(d)?bj.toObject(new aX.AccountEntity,d):null}async setAccount(a,b,c){this.logger.trace("BrowserCacheManager.setAccount called");let d=this.generateAccountKey(aX.AccountEntity.getAccountInfo(a)),e=Date.now().toString();a.lastUpdatedAt=e,await this.setUserData(d,JSON.stringify(a),b,e,c);let f=this.addAccountKeyToMap(d,b);this.performanceClient.addFields({kmsi:c},b),this.cacheConfig.cacheLocation===bu.BrowserCacheLocation.LocalStorage&&f&&this.eventHandler.emitEvent(d7.EventType.ACCOUNT_ADDED,void 0,aX.AccountEntity.getAccountInfo(a))}getAccountKeys(){return d0(this.browserStorage)}setAccountKeys(a,b,c=2){0===a.length?this.removeItem(cC(c)):this.setItem(cC(c),JSON.stringify(a),b)}addAccountKeyToMap(a,b){this.logger.trace("BrowserCacheManager.addAccountKeyToMap called"),this.logger.tracePii(`BrowserCacheManager.addAccountKeyToMap called with key: ${a}`);let c=this.getAccountKeys();return -1===c.indexOf(a)?(c.push(a),this.setItem(cC(),JSON.stringify(c),b),this.logger.verbose("BrowserCacheManager.addAccountKeyToMap account key added"),!0):(this.logger.verbose("BrowserCacheManager.addAccountKeyToMap account key already exists in map"),!1)}removeAccountKeyFromMap(a,b){this.logger.trace("BrowserCacheManager.removeAccountKeyFromMap called"),this.logger.tracePii(`BrowserCacheManager.removeAccountKeyFromMap called with key: ${a}`);let c=this.getAccountKeys(),d=c.indexOf(a);d>-1?(c.splice(d,1),this.setAccountKeys(c,b),this.logger.trace("BrowserCacheManager.removeAccountKeyFromMap account key removed")):this.logger.trace("BrowserCacheManager.removeAccountKeyFromMap key not found in existing map")}removeAccount(a,b){let c=this.getActiveAccount(b);c?.homeAccountId===a.homeAccountId&&c?.environment===a.environment&&this.setActiveAccount(null,b),super.removeAccount(a,b),this.removeAccountKeyFromMap(this.generateAccountKey(a),b),this.browserStorage.getKeys().forEach(b=>{b.includes(a.homeAccountId)&&b.includes(a.environment)&&this.browserStorage.removeItem(b)}),this.cacheConfig.cacheLocation===bu.BrowserCacheLocation.LocalStorage&&this.eventHandler.emitEvent(d7.EventType.ACCOUNT_REMOVED,void 0,a)}removeIdToken(a,b){super.removeIdToken(a,b);let c=this.getTokenKeys(),d=c.idToken.indexOf(a);d>-1&&(this.logger.info("idToken removed from tokenKeys map"),c.idToken.splice(d,1),this.setTokenKeys(c,b))}removeAccessToken(a,b,c=!0){super.removeAccessToken(a,b),c&&this.removeAccessTokenKeys([a],b)}removeAccessTokenKeys(a,b,c=2){this.logger.trace("removeAccessTokenKey called");let d=this.getTokenKeys(c),e=0;if(a.forEach(a=>{let b=d.accessToken.indexOf(a);b>-1&&(d.accessToken.splice(b,1),e++)}),e>0){this.logger.info(`removed ${e} accessToken keys from tokenKeys map`),this.setTokenKeys(d,b,c);return}}removeRefreshToken(a,b){super.removeRefreshToken(a,b);let c=this.getTokenKeys(),d=c.refreshToken.indexOf(a);d>-1&&(this.logger.info("refreshToken removed from tokenKeys map"),c.refreshToken.splice(d,1),this.setTokenKeys(c,b))}getTokenKeys(a=2){return d1(this.clientId,this.browserStorage,a)}setTokenKeys(a,b,c=2){0===a.idToken.length&&0===a.accessToken.length&&0===a.refreshToken.length?this.removeItem(cD(this.clientId,c)):this.setItem(cD(this.clientId,c),JSON.stringify(a),b)}getIdTokenCredential(a,b){let c=this.browserStorage.getUserData(a);if(!c)return this.logger.trace("BrowserCacheManager.getIdTokenCredential: called, no cache hit"),this.removeIdToken(a,b),null;let d=this.validateAndParseJson(c);return d&&dX.isIdTokenEntity(d)?(this.logger.trace("BrowserCacheManager.getIdTokenCredential: cache hit"),d):(this.logger.trace("BrowserCacheManager.getIdTokenCredential: called, no cache hit"),null)}async setIdTokenCredential(a,b,c){this.logger.trace("BrowserCacheManager.setIdTokenCredential called");let d=this.generateCredentialKey(a),e=Date.now().toString();a.lastUpdatedAt=e,await this.setUserData(d,JSON.stringify(a),b,e,c);let f=this.getTokenKeys();-1===f.idToken.indexOf(d)&&(this.logger.info("BrowserCacheManager: addTokenKey - idToken added to map"),f.idToken.push(d),this.setTokenKeys(f,b))}getAccessTokenCredential(a,b){let c=this.browserStorage.getUserData(a);if(!c)return this.logger.trace("BrowserCacheManager.getAccessTokenCredential: called, no cache hit"),this.removeAccessTokenKeys([a],b),null;let d=this.validateAndParseJson(c);return d&&dX.isAccessTokenEntity(d)?(this.logger.trace("BrowserCacheManager.getAccessTokenCredential: cache hit"),d):(this.logger.trace("BrowserCacheManager.getAccessTokenCredential: called, no cache hit"),null)}async setAccessTokenCredential(a,b,c){this.logger.trace("BrowserCacheManager.setAccessTokenCredential called");let d=this.generateCredentialKey(a),e=Date.now().toString();a.lastUpdatedAt=e,await this.setUserData(d,JSON.stringify(a),b,e,c);let f=this.getTokenKeys(),g=f.accessToken.indexOf(d);-1!==g&&f.accessToken.splice(g,1),this.logger.trace(`access token ${-1===g?"added to":"updated in"} map`),f.accessToken.push(d),this.setTokenKeys(f,b)}getRefreshTokenCredential(a,b){let c=this.browserStorage.getUserData(a);if(!c)return this.logger.trace("BrowserCacheManager.getRefreshTokenCredential: called, no cache hit"),this.removeRefreshToken(a,b),null;let d=this.validateAndParseJson(c);return d&&dX.isRefreshTokenEntity(d)?(this.logger.trace("BrowserCacheManager.getRefreshTokenCredential: cache hit"),d):(this.logger.trace("BrowserCacheManager.getRefreshTokenCredential: called, no cache hit"),null)}async setRefreshTokenCredential(a,b,c){this.logger.trace("BrowserCacheManager.setRefreshTokenCredential called");let d=this.generateCredentialKey(a),e=Date.now().toString();a.lastUpdatedAt=e,await this.setUserData(d,JSON.stringify(a),b,e,c);let f=this.getTokenKeys();-1===f.refreshToken.indexOf(d)&&(this.logger.info("BrowserCacheManager: addTokenKey - refreshToken added to map"),f.refreshToken.push(d),this.setTokenKeys(f,b))}getAppMetadata(a){let b=this.browserStorage.getItem(a);if(!b)return this.logger.trace("BrowserCacheManager.getAppMetadata: called, no cache hit"),null;let c=this.validateAndParseJson(b);return c&&dX.isAppMetadataEntity(a,c)?(this.logger.trace("BrowserCacheManager.getAppMetadata: cache hit"),c):(this.logger.trace("BrowserCacheManager.getAppMetadata: called, no cache hit"),null)}setAppMetadata(a,b){this.logger.trace("BrowserCacheManager.setAppMetadata called");let c=dX.generateAppMetadataKey(a);this.setItem(c,JSON.stringify(a),b)}getServerTelemetry(a){let b=this.browserStorage.getItem(a);if(!b)return this.logger.trace("BrowserCacheManager.getServerTelemetry: called, no cache hit"),null;let c=this.validateAndParseJson(b);return c&&dX.isServerTelemetryEntity(a,c)?(this.logger.trace("BrowserCacheManager.getServerTelemetry: cache hit"),c):(this.logger.trace("BrowserCacheManager.getServerTelemetry: called, no cache hit"),null)}setServerTelemetry(a,b,c){this.logger.trace("BrowserCacheManager.setServerTelemetry called"),this.setItem(a,JSON.stringify(b),c)}getAuthorityMetadata(a){let b=this.internalStorage.getItem(a);if(!b)return this.logger.trace("BrowserCacheManager.getAuthorityMetadata: called, no cache hit"),null;let c=this.validateAndParseJson(b);return c&&dX.isAuthorityMetadataEntity(a,c)?(this.logger.trace("BrowserCacheManager.getAuthorityMetadata: cache hit"),c):null}getAuthorityMetadataKeys(){return this.internalStorage.getKeys().filter(a=>this.isAuthorityMetadata(a))}setWrapperMetadata(a,b){this.internalStorage.setItem(bu.InMemoryCacheKeys.WRAPPER_SKU,a),this.internalStorage.setItem(bu.InMemoryCacheKeys.WRAPPER_VER,b)}getWrapperMetadata(){return[this.internalStorage.getItem(bu.InMemoryCacheKeys.WRAPPER_SKU)||aR.Constants.EMPTY_STRING,this.internalStorage.getItem(bu.InMemoryCacheKeys.WRAPPER_VER)||aR.Constants.EMPTY_STRING]}setAuthorityMetadata(a,b){this.logger.trace("BrowserCacheManager.setAuthorityMetadata called"),this.internalStorage.setItem(a,JSON.stringify(b))}getActiveAccount(a){let b=this.generateCacheKey(aR.PersistentCacheKeys.ACTIVE_ACCOUNT_FILTERS),c=this.browserStorage.getItem(b);if(!c)return this.logger.trace("BrowserCacheManager.getActiveAccount: No active account filters found"),null;let d=this.validateAndParseJson(c);return d?(this.logger.trace("BrowserCacheManager.getActiveAccount: Active account filters schema found"),this.getAccountInfoFilteredBy({homeAccountId:d.homeAccountId,localAccountId:d.localAccountId,tenantId:d.tenantId},a)):(this.logger.trace("BrowserCacheManager.getActiveAccount: No active account found"),null)}setActiveAccount(a,b){let c=this.generateCacheKey(aR.PersistentCacheKeys.ACTIVE_ACCOUNT_FILTERS);if(a){this.logger.verbose("setActiveAccount: Active account set");let d={homeAccountId:a.homeAccountId,localAccountId:a.localAccountId,tenantId:a.tenantId,lastUpdatedAt:dW.nowSeconds().toString()};this.setItem(c,JSON.stringify(d),b)}else this.logger.verbose("setActiveAccount: No account passed, active account not set"),this.browserStorage.removeItem(c);this.eventHandler.emitEvent(d7.EventType.ACTIVE_ACCOUNT_CHANGED)}getThrottlingCache(a){let b=this.browserStorage.getItem(a);if(!b)return this.logger.trace("BrowserCacheManager.getThrottlingCache: called, no cache hit"),null;let c=this.validateAndParseJson(b);return c&&dX.isThrottlingEntity(a,c)?(this.logger.trace("BrowserCacheManager.getThrottlingCache: cache hit"),c):(this.logger.trace("BrowserCacheManager.getThrottlingCache: called, no cache hit"),null)}setThrottlingCache(a,b,c){this.logger.trace("BrowserCacheManager.setThrottlingCache called"),this.setItem(a,JSON.stringify(b),c)}getTemporaryCache(a,b){let c=b?this.generateCacheKey(a):a;if(this.cacheConfig.storeAuthStateInCookie){let a=this.cookieStorage.getItem(c);if(a)return this.logger.trace("BrowserCacheManager.getTemporaryCache: storeAuthStateInCookies set to true, retrieving from cookies"),a}let d=this.temporaryCacheStorage.getItem(c);if(!d){if(this.cacheConfig.cacheLocation===bu.BrowserCacheLocation.LocalStorage){let a=this.browserStorage.getItem(c);if(a)return this.logger.trace("BrowserCacheManager.getTemporaryCache: Temporary cache item found in local storage"),a}return this.logger.trace("BrowserCacheManager.getTemporaryCache: No cache item found in local storage"),null}return this.logger.trace("BrowserCacheManager.getTemporaryCache: Temporary cache item returned"),d}setTemporaryCache(a,b,c){let d=c?this.generateCacheKey(a):a;this.temporaryCacheStorage.setItem(d,b),this.cacheConfig.storeAuthStateInCookie&&(this.logger.trace("BrowserCacheManager.setTemporaryCache: storeAuthStateInCookie set to true, setting item cookie"),this.cookieStorage.setItem(d,b,void 0,this.cacheConfig.secureCookies))}removeItem(a){this.browserStorage.removeItem(a)}removeTemporaryItem(a){this.temporaryCacheStorage.removeItem(a),this.cacheConfig.storeAuthStateInCookie&&(this.logger.trace("BrowserCacheManager.removeItem: storeAuthStateInCookie is true, clearing item cookie"),this.cookieStorage.removeItem(a))}getKeys(){return this.browserStorage.getKeys()}clear(a){this.removeAllAccounts(a),this.removeAppMetadata(a),this.temporaryCacheStorage.getKeys().forEach(a=>{(-1!==a.indexOf(cv)||-1!==a.indexOf(this.clientId))&&this.removeTemporaryItem(a)}),this.browserStorage.getKeys().forEach(a=>{(-1!==a.indexOf(cv)||-1!==a.indexOf(this.clientId))&&this.browserStorage.removeItem(a)}),this.internalStorage.clear()}clearTokensAndKeysWithClaims(a){this.performanceClient.addQueueMeasurement(_,a);let b=this.getTokenKeys(),c=0;b.accessToken.forEach(b=>{let d=this.getAccessTokenCredential(b,a);d?.requestedClaimsHash&&b.includes(d.requestedClaimsHash.toLowerCase())&&(this.removeAccessToken(b,a),c++)}),c>0&&this.logger.warning(`${c} access tokens with claims in the cache keys have been removed from the cache.`)}generateCacheKey(a){return aV.startsWith(a,cv)?a:`${cv}.${this.clientId}.${a}`}generateCredentialKey(a){let b=a.credentialType===aR.CredentialType.REFRESH_TOKEN&&a.familyId||a.clientId,c=a.tokenType&&a.tokenType.toLowerCase()!==aR.AuthenticationScheme.BEARER.toLowerCase()?a.tokenType.toLowerCase():"";return[`${cv}.2`,a.homeAccountId,a.environment,a.credentialType,b,a.realm||"",a.target||"",a.requestedClaimsHash||"",c].join("|").toLowerCase()}generateAccountKey(a){let b=a.homeAccountId.split(".")[1];return[`${cv}.2`,a.homeAccountId,a.environment,b||a.tenantId||""].join("|").toLowerCase()}resetRequestCache(){this.logger.trace("BrowserCacheManager.resetRequestCache called"),this.removeTemporaryItem(this.generateCacheKey(bu.TemporaryCacheKeys.REQUEST_PARAMS)),this.removeTemporaryItem(this.generateCacheKey(bu.TemporaryCacheKeys.VERIFIER)),this.removeTemporaryItem(this.generateCacheKey(bu.TemporaryCacheKeys.ORIGIN_URI)),this.removeTemporaryItem(this.generateCacheKey(bu.TemporaryCacheKeys.URL_HASH)),this.removeTemporaryItem(this.generateCacheKey(bu.TemporaryCacheKeys.NATIVE_REQUEST)),this.setInteractionInProgress(!1)}cacheAuthorizeRequest(a,b){this.logger.trace("BrowserCacheManager.cacheAuthorizeRequest called");let c=cR(JSON.stringify(a));if(this.setTemporaryCache(bu.TemporaryCacheKeys.REQUEST_PARAMS,c,!0),b){let a=cR(b);this.setTemporaryCache(bu.TemporaryCacheKeys.VERIFIER,a,!0)}}getCachedRequest(){let a;this.logger.trace("BrowserCacheManager.getCachedRequest called");let b=this.getTemporaryCache(bu.TemporaryCacheKeys.REQUEST_PARAMS,!0);if(!b)throw cm(bT);let c=this.getTemporaryCache(bu.TemporaryCacheKeys.VERIFIER,!0),d="";try{a=JSON.parse(cT(b)),c&&(d=cT(c))}catch(a){throw this.logger.errorPii(`Attempted to parse: ${b}`),this.logger.error(`Parsing cached token request threw with error: ${a}`),cm(bU)}return[a,d]}getCachedNativeRequest(){this.logger.trace("BrowserCacheManager.getCachedNativeRequest called");let a=this.getTemporaryCache(bu.TemporaryCacheKeys.NATIVE_REQUEST,!0);if(!a)return this.logger.trace("BrowserCacheManager.getCachedNativeRequest: No cached native request found"),null;let b=this.validateAndParseJson(a);return b||(this.logger.error("BrowserCacheManager.getCachedNativeRequest: Unable to parse native request"),null)}isInteractionInProgress(a){let b=this.getInteractionInProgress()?.clientId;return a?b===this.clientId:!!b}getInteractionInProgress(){let a=`${cv}.${bu.TemporaryCacheKeys.INTERACTION_STATUS_KEY}`,b=this.getTemporaryCache(a,!1);try{return b?JSON.parse(b):null}catch(b){return this.logger.error("Cannot parse interaction status. Removing temporary cache items and clearing url hash. Retrying interaction should fix the error"),this.removeTemporaryItem(a),this.resetRequestCache(),fA(window),null}}setInteractionInProgress(a,b=bu.INTERACTION_TYPE.SIGNIN){let c=`${cv}.${bu.TemporaryCacheKeys.INTERACTION_STATUS_KEY}`;if(a)if(this.getInteractionInProgress())throw cm(bG);else this.setTemporaryCache(c,JSON.stringify({clientId:this.clientId,type:b}),!1);else a||this.getInteractionInProgress()?.clientId!==this.clientId||this.removeTemporaryItem(c)}async hydrateCache(a,b){let c,d=dX.createIdTokenEntity(a.account?.homeAccountId,a.account?.environment,a.idToken,this.clientId,a.tenantId);b.claims&&(c=await this.cryptoImpl.hashString(b.claims));let e=dX.createAccessTokenEntity(a.account?.homeAccountId,a.account.environment,a.accessToken,this.clientId,a.tenantId,a.scopes.join(" "),a.expiresOn?dW.toSecondsFromDate(a.expiresOn):0,a.extExpiresOn?dW.toSecondsFromDate(a.extExpiresOn):0,cT,void 0,a.tokenType,void 0,b.sshKid,b.claims,c);return this.saveCacheRecord({idToken:d,accessToken:e},a.correlationId,dT.isKmsi(dT.extractTokenClaims(a.idToken,cT)))}async saveCacheRecord(a,b,c,d){try{await super.saveCacheRecord(a,b,c,d)}catch(a){if(a instanceof bh&&this.performanceClient&&b)try{let a=this.getTokenKeys();this.performanceClient.addFields({cacheRtCount:a.refreshToken.length,cacheIdCount:a.idToken.length,cacheAtCount:a.accessToken.length},b)}catch(a){}throw a}}}function fJ(a,b,c,d){try{switch(b){case bu.BrowserCacheLocation.LocalStorage:return new d5(a,c,d);case bu.BrowserCacheLocation.SessionStorage:return new d6;case bu.BrowserCacheLocation.MemoryStorage:}}catch(a){c.error(a)}return new dk}class fK{constructor(a){this.eventCallbacks=new Map,this.logger=a||new b.Logger({}),"undefined"!=typeof BroadcastChannel&&(this.broadcastChannel=new BroadcastChannel("msal.broadcast.event")),this.invokeCrossTabCallbacks=this.invokeCrossTabCallbacks.bind(this)}addEventCallback(a,b,c){return null}removeEventCallback(a){this.eventCallbacks.delete(a),this.logger.verbose(`Event callback ${a} removed.`)}emitEvent(a,b,c,d){let e={eventType:a,interactionType:b||null,payload:c||null,error:d||null,timestamp:Date.now()};switch(a){case d7.EventType.ACCOUNT_ADDED:case d7.EventType.ACCOUNT_REMOVED:case d7.EventType.ACTIVE_ACCOUNT_CHANGED:this.broadcastChannel?.postMessage(e);break;default:this.invokeCallbacks(e)}}invokeCallbacks(a){this.eventCallbacks.forEach(([b,c],d)=>{(0===c.length||c.includes(a.eventType))&&(this.logger.verbose(`Emitting event to callback ${d}: ${a.eventType}`),b.apply(null,[a]))})}invokeCrossTabCallbacks(a){let b=a.data;this.invokeCallbacks(b)}subscribeCrossTab(){this.broadcastChannel?.addEventListener("message",this.invokeCrossTabCallbacks)}unsubscribeCrossTab(){this.broadcastChannel?.removeEventListener("message",this.invokeCrossTabCallbacks)}}let fL="home_account_id";var fM=a.i(65194);async function fN(a,b,c,d,e,f,g){g?.addQueueMeasurement(R,f);let h=dQ.transformCIAMAuthority(dR(a)),i=new dQ(h,b,c,d,e,f,g);try{return await dr(i.resolveEndpointsAsync.bind(i),S,e,g,f)(),i}catch(a){throw(0,aN.createClientAuthError)(aO.endpointResolutionError)}}a.s(["createDiscoveredInstance",()=>fN],45238);var fO=aj;class fP extends fO.AuthError{constructor(a,b,c,d,e){super(a,b,c),this.name="ServerError",this.errorNo=d,this.status=e,Object.setPrototypeOf(this,fP.prototype)}}class fQ{static generateThrottlingStorageKey(a){return`${aR.ThrottlingConstants.THROTTLING_PREFIX}.${JSON.stringify(a)}`}static preProcess(a,b,c){let d=fQ.generateThrottlingStorageKey(b),e=a.getThrottlingCache(d);if(e){if(e.throttleTime<Date.now())return void a.removeItem(d,c);throw new fP(e.errorCodes?.join(" ")||aR.Constants.EMPTY_STRING,e.errorMessage,e.subError)}}static postProcess(a,b,c,d){if(fQ.checkResponseStatus(c)||fQ.checkResponseForRetryAfter(c)){let e={throttleTime:fQ.calculateThrottleTime(parseInt(c.headers[aR.HeaderNames.RETRY_AFTER])),error:c.body.error,errorCodes:c.body.error_codes,errorMessage:c.body.error_description,subError:c.body.suberror};a.setThrottlingCache(fQ.generateThrottlingStorageKey(b),e,d)}}static checkResponseStatus(a){return 429===a.status||a.status>=500&&a.status<600}static checkResponseForRetryAfter(a){return!!a.headers&&a.headers.hasOwnProperty(aR.HeaderNames.RETRY_AFTER)&&(a.status<200||a.status>=300)}static calculateThrottleTime(a){let b=Date.now()/1e3;return Math.floor(1e3*Math.min(b+((a<=0?0:a)||aR.ThrottlingConstants.DEFAULT_THROTTLE_TIME_SECONDS),b+aR.ThrottlingConstants.DEFAULT_MAX_THROTTLE_TIME_SECONDS))}static removeThrottle(a,b,c,d){let e=dU(b,c,d),f=this.generateThrottlingStorageKey(e);a.removeItem(f,c.correlationId)}}class fR{constructor(a,c){this.config=function({authOptions:a,systemOptions:c,loggerOptions:d,cacheOptions:e,storageInterface:f,networkInterface:g,cryptoInterface:h,clientCredentials:i,libraryInfo:j,telemetry:k,serverTelemetryManager:l,persistencePlugin:m,serializableCache:n}){let o={...bm,...d};return{authOptions:{clientCapabilities:[],azureCloudOptions:br,skipAuthorityMetadataCache:!1,instanceAware:!1,encodeExtraQueryParams:!1,...a},systemOptions:{...bl,...c},loggerOptions:o,cacheOptions:{...bn,...e},storageInterface:f||new bk(a.clientId,aQ,new b.Logger(o),new ah),networkInterface:g||bo,cryptoInterface:h||aQ,clientCredentials:i||bq,libraryInfo:{...bp,...j},telemetry:{...bs,...k},serverTelemetryManager:l||null,persistencePlugin:m||null,serializableCache:n||null}}(a),this.logger=new b.Logger(this.config.loggerOptions,aS,aT),this.cryptoUtils=this.config.cryptoInterface,this.cacheManager=this.config.storageInterface,this.networkClient=this.config.networkInterface,this.serverTelemetryManager=this.config.serverTelemetryManager,this.authority=this.config.authOptions.authority,this.performanceClient=c}createTokenRequestHeaders(a){let b={};if(b[aR.HeaderNames.CONTENT_TYPE]=aR.Constants.URL_FORM_CONTENT_TYPE,!this.config.systemOptions.preventCorsPreflight&&a)switch(a.type){case fL:try{let c=(0,fM.buildClientInfoFromHomeAccountId)(a.credential);b[aR.HeaderNames.CCS_HEADER]=`Oid:${c.uid}@${c.utid}`}catch(a){this.logger.verbose("Could not parse home account ID for CCS Header: "+a)}break;case"UPN":b[aR.HeaderNames.CCS_HEADER]=`UPN: ${a.credential}`}return b}async executePostToTokenEndpoint(a,b,c,d,e,f){f&&this.performanceClient?.addQueueMeasurement(f,e);let g=await this.sendPostRequest(d,a,{body:b,headers:c},e);return this.config.serverTelemetryManager&&g.status<500&&429!==g.status&&this.config.serverTelemetryManager.clearTelemetryCache(),g}async sendPostRequest(a,b,c,d){let e;fQ.preProcess(this.cacheManager,a,d);try{let a=(e=await dr(this.networkClient.sendPostRequestAsync.bind(this.networkClient),"networkClientSendPostRequestAsync",this.logger,this.performanceClient,d)(b,c)).headers||{};this.performanceClient?.addFields({refreshTokenSize:e.body.refresh_token?.length||0,httpVerToken:a[aR.HeaderNames.X_MS_HTTP_VERSION]||"",requestId:a[aR.HeaderNames.X_MS_REQUEST_ID]||""},d)}catch(a){if(a instanceof cp){let b=a.responseHeaders;throw b&&this.performanceClient?.addFields({httpVerToken:b[aR.HeaderNames.X_MS_HTTP_VERSION]||"",requestId:b[aR.HeaderNames.X_MS_REQUEST_ID]||"",contentTypeHeader:b[aR.HeaderNames.CONTENT_TYPE]||void 0,contentLengthHeader:b[aR.HeaderNames.CONTENT_LENGTH]||void 0,httpStatus:a.httpStatus},d),a.error}if(a instanceof aj.AuthError)throw a;throw(0,aN.createClientAuthError)(aO.networkError)}return fQ.postProcess(this.cacheManager,a,e,d),e}async updateAuthority(a,b){this.performanceClient?.addQueueMeasurement(K,b);let c=`https://${a}/${this.authority.tenant}/`,d=await fN(c,this.networkClient,this.cacheManager,this.authority.options,this.logger,b,this.performanceClient);this.authority=d}createTokenQueryParameters(a){let b=new Map;return a.embeddedClientId&&fw(b,this.config.authOptions.clientId,this.config.authOptions.redirectUri),a.tokenQueryParameters&&fn(b,a.tokenQueryParameters),e4(b,a.correlationId),eR(b,a.correlationId,this.performanceClient),a4(b)}}class fS{static setRequestState(a,b,c){let d=fS.generateLibraryState(a,c);return b?`${d}${aR.Constants.RESOURCE_DELIM}${b}`:d}static generateLibraryState(a,b){if(!a)throw(0,aN.createClientAuthError)(aO.noCryptoObject);let c={id:a.createNewGuid()};b&&(c.meta=b);let d=JSON.stringify(c);return a.base64Encode(d)}static parseRequestState(a,b){if(!a)throw(0,aN.createClientAuthError)(aO.noCryptoObject);if(!b)throw(0,aN.createClientAuthError)(aO.invalidState);try{let c=b.split(aR.Constants.RESOURCE_DELIM),d=c[0],e=c.length>1?c.slice(1).join(aR.Constants.RESOURCE_DELIM):aR.Constants.EMPTY_STRING,f=a.base64Decode(d),g=JSON.parse(f);return{userRequestState:e||aR.Constants.EMPTY_STRING,libraryState:g}}catch(a){throw(0,aN.createClientAuthError)(aO.invalidState)}}}class fT{constructor(a,b){this.cryptoUtils=a,this.performanceClient=b}async generateCnf(a,b){this.performanceClient?.addQueueMeasurement(O,a.correlationId);let c=await dr(this.generateKid.bind(this),O,b,this.performanceClient,a.correlationId)(a),d=this.cryptoUtils.base64UrlEncode(JSON.stringify(c));return{kid:c.kid,reqCnfString:d}}async generateKid(a){return this.performanceClient?.addQueueMeasurement("popTokenGenerateKid",a.correlationId),{kid:await this.cryptoUtils.getPublicKeyThumbprint(a),xms_ksl:"sw"}}async signPopToken(a,b,c){return this.signPayload(a,b,c)}async signPayload(a,b,c,d){let{resourceRequestMethod:e,resourceRequestUri:f,shrClaims:g,shrNonce:h,shrOptions:i}=c,j=f?new a6(f):void 0,k=j?.getUrlComponents();return this.cryptoUtils.signJwt({at:a,ts:dt(),m:e?.toUpperCase(),u:k?.HostNameAndPort,nonce:h||this.cryptoUtils.createNewGuid(),p:k?.AbsolutePath,q:k?.QueryString?[[],k.QueryString]:void 0,client_claims:g||void 0,...d},b,i,c.correlationId)}}class fU{constructor(a,b){this.cache=a,this.hasChanged=b}get cacheHasChanged(){return this.hasChanged}get tokenCache(){return this.cache}}class fV{constructor(a,b,c,d,e,f,g){this.clientId=a,this.cacheStorage=b,this.cryptoObj=c,this.logger=d,this.serializableCache=e,this.persistencePlugin=f,this.performanceClient=g}validateTokenResponse(a,b){if(a.error||a.error_description||a.suberror){let c=`Error(s): ${a.error_codes||aR.Constants.NOT_AVAILABLE} - Timestamp: ${a.timestamp||aR.Constants.NOT_AVAILABLE} - Description: ${a.error_description||aR.Constants.NOT_AVAILABLE} - Correlation ID: ${a.correlation_id||aR.Constants.NOT_AVAILABLE} - Trace ID: ${a.trace_id||aR.Constants.NOT_AVAILABLE}`,d=a.error_codes?.length?a.error_codes[0]:void 0,e=new fP(a.error,c,a.suberror,d,a.status);if(b&&a.status&&a.status>=aR.HttpStatus.SERVER_ERROR_RANGE_START&&a.status<=aR.HttpStatus.SERVER_ERROR_RANGE_END)return void this.logger.warning(`executeTokenRequest:validateTokenResponse - AAD is currently unavailable and the access token is unable to be refreshed.
${e}`);if(b&&a.status&&a.status>=aR.HttpStatus.CLIENT_ERROR_RANGE_START&&a.status<=aR.HttpStatus.CLIENT_ERROR_RANGE_END)return void this.logger.warning(`executeTokenRequest:validateTokenResponse - AAD is currently available but is unable to refresh the access token.
${e}`);if((0,dS.isInteractionRequiredError)(a.error,a.error_description,a.suberror))throw new dS.InteractionRequiredAuthError(a.error,a.error_description,a.suberror,a.timestamp||aR.Constants.EMPTY_STRING,a.trace_id||aR.Constants.EMPTY_STRING,a.correlation_id||aR.Constants.EMPTY_STRING,a.claims||aR.Constants.EMPTY_STRING,d);throw e}}async handleServerTokenResponse(a,b,c,d,e,f,g,h,i){let j,k,l;if(this.performanceClient?.addQueueMeasurement(P,a.correlation_id),a.id_token){if(j=aZ(a.id_token||aR.Constants.EMPTY_STRING,this.cryptoObj.base64Decode),e&&e.nonce&&j.nonce!==e.nonce)throw(0,aN.createClientAuthError)(aO.nonceMismatch);if(d.maxAge||0===d.maxAge){let a=j.auth_time;if(!a)throw(0,aN.createClientAuthError)(aO.authTimeNotFound);a0(a,d.maxAge)}}this.homeAccountIdentifier=aX.AccountEntity.generateHomeAccountId(a.client_info||aR.Constants.EMPTY_STRING,b.authorityType,this.logger,this.cryptoObj,j),e&&e.state&&(k=fS.parseRequestState(this.cryptoObj,e.state)),a.key_id=a.key_id||d.sshKid||void 0;let m=this.generateCacheRecord(a,b,c,d,j,f,e);try{if(this.persistencePlugin&&this.serializableCache&&(this.logger.verbose("Persistence enabled, calling beforeCacheAccess"),l=new fU(this.serializableCache,!0),await this.persistencePlugin.beforeCacheAccess(l)),g&&!h&&m.account){let a=this.cacheStorage.generateAccountKey(aX.AccountEntity.getAccountInfo(m.account));if(!this.cacheStorage.getAccount(a,d.correlationId))return this.logger.warning("Account used to refresh tokens not in persistence, refreshed tokens will not be stored in the cache"),await fV.generateAuthenticationResult(this.cryptoObj,b,m,!1,d,j,k,void 0,i)}await this.cacheStorage.saveCacheRecord(m,d.correlationId,a$(j||{}),d.storeInCache)}finally{this.persistencePlugin&&this.serializableCache&&l&&(this.logger.verbose("Persistence enabled, calling afterCacheAccess"),await this.persistencePlugin.afterCacheAccess(l))}return fV.generateAuthenticationResult(this.cryptoObj,b,m,!1,d,j,k,a,i)}generateCacheRecord(a,b,c,d,e,f,g){let h,i,j=b.getPreferredCache();if(!j)throw(0,aN.createClientAuthError)(aO.invalidCacheEnvironment);let k=(0,dY.getTenantIdFromIdTokenClaims)(e);a.id_token&&e&&(h=dA(this.homeAccountIdentifier,j,a.id_token,this.clientId,k||""),i=fW(this.cacheStorage,b,this.homeAccountIdentifier,this.cryptoObj.base64Decode,d.correlationId,e,a.client_info,j,k,g,void 0,this.logger));let l=null;if(a.access_token){let e=a.scope?aW.fromString(a.scope):new aW(d.scopes||[]),g=("string"==typeof a.expires_in?parseInt(a.expires_in,10):a.expires_in)||0,h=("string"==typeof a.ext_expires_in?parseInt(a.ext_expires_in,10):a.ext_expires_in)||0,i=("string"==typeof a.refresh_in?parseInt(a.refresh_in,10):a.refresh_in)||void 0,m=c+g;l=dB(this.homeAccountIdentifier,j,a.access_token,this.clientId,k||b.tenant||"",e.printScopes(),m,m+h,this.cryptoObj.base64Decode,i&&i>0?c+i:void 0,a.token_type,f,a.key_id,d.claims,d.requestedClaimsHash)}let m=null;if(a.refresh_token){let b;a.refresh_token_expires_in&&(b=c+("string"==typeof a.refresh_token_expires_in?parseInt(a.refresh_token_expires_in,10):a.refresh_token_expires_in)),m=dC(this.homeAccountIdentifier,j,a.refresh_token,this.clientId,a.foci,f,b)}let n=null;return a.foci&&(n={clientId:this.clientId,environment:j,familyId:a.foci}),{account:i,idToken:h,accessToken:l,refreshToken:m,appMetadata:n}}static async generateAuthenticationResult(a,b,c,d,e,f,g,h,i){let j,k,l=aR.Constants.EMPTY_STRING,m=[],n=null,o=aR.Constants.EMPTY_STRING;if(c.accessToken){if(c.accessToken.tokenType!==aR.AuthenticationScheme.POP||e.popKid)l=c.accessToken.secret;else{let b=new fT(a),{secret:d,keyId:f}=c.accessToken;if(!f)throw(0,aN.createClientAuthError)(aO.keyIdMissing);l=await b.signPopToken(d,f,e)}m=aW.fromString(c.accessToken.target).asArray(),n=dv(c.accessToken.expiresOn),j=dv(c.accessToken.extendedExpiresOn),c.accessToken.refreshOn&&(k=dv(c.accessToken.refreshOn))}c.appMetadata&&(o=c.appMetadata.familyId===aR.THE_FAMILY_ID?aR.THE_FAMILY_ID:"");let p=f?.oid||f?.sub||"",q=f?.tid||"";h?.spa_accountid&&c.account&&(c.account.nativeAccountId=h?.spa_accountid);let r=c.account?(0,aY.updateAccountTenantProfileData)(aX.AccountEntity.getAccountInfo(c.account),void 0,f,c.idToken?.secret):null;return{authority:b.canonicalAuthority,uniqueId:p,tenantId:q,scopes:m,account:r,idToken:c?.idToken?.secret||"",idTokenClaims:f||{},accessToken:l,fromCache:d,expiresOn:n,extExpiresOn:j,refreshOn:k,correlationId:e.correlationId,requestId:i||aR.Constants.EMPTY_STRING,familyId:o,tokenType:c.accessToken?.tokenType||aR.Constants.EMPTY_STRING,state:g?g.userRequestState:aR.Constants.EMPTY_STRING,cloudGraphHostName:c.account?.cloudGraphHostName||aR.Constants.EMPTY_STRING,msGraphHost:c.account?.msGraphHost||aR.Constants.EMPTY_STRING,code:h?.spa_code,fromNativeBroker:!1}}}function fW(a,b,c,d,e,f,g,h,i,j,k,l){l?.verbose("setCachedAccount called");let m=a.getAccountKeys().find(a=>a.startsWith(c)),n=null;m&&(n=a.getAccount(m,e));let o=n||aX.AccountEntity.createAccount({homeAccountId:c,idTokenClaims:f,clientInfo:g,environment:h,cloudGraphHostName:j?.cloud_graph_host_name,msGraphHost:j?.msgraph_host,nativeAccountId:k},b,d),p=o.tenantProfiles||[],q=i||o.realm;if(q&&!p.find(a=>a.tenantId===q)){let a=(0,aY.buildTenantProfile)(c,o.localAccountId,q,f);p.push(a)}return o.tenantProfiles=p,o}async function fX(a,b,c){return"string"==typeof a?a:a({clientId:b,tokenEndpoint:c})}class fY extends fR{constructor(a,b){super(a,b),this.includeRedirectUri=!0,this.oidcDefaultScopes=this.config.authOptions.authority.options.OIDCOptions?.defaultScopes}async acquireToken(a,b){if(this.performanceClient?.addQueueMeasurement(L,a.correlationId),!a.code)throw(0,aN.createClientAuthError)(aO.requestCannotBeMade);let c=dt(),d=await dr(this.executeTokenRequest.bind(this),M,this.logger,this.performanceClient,a.correlationId)(this.authority,a),e=d.headers?.[aR.HeaderNames.X_MS_REQUEST_ID],f=new fV(this.config.authOptions.clientId,this.cacheManager,this.cryptoUtils,this.logger,this.config.serializableCache,this.config.persistencePlugin,this.performanceClient);return f.validateTokenResponse(d.body),dr(f.handleServerTokenResponse.bind(f),P,this.logger,this.performanceClient,a.correlationId)(d.body,this.authority,c,a,b,void 0,void 0,void 0,e)}getLogoutUri(a){if(!a)throw aL(as);let b=this.createLogoutUrlQueryString(a);return a6.appendQueryString(this.authority.endSessionEndpoint,b)}async executeTokenRequest(a,b){let c;this.performanceClient?.addQueueMeasurement(M,b.correlationId);let d=this.createTokenQueryParameters(b),e=a6.appendQueryString(a.tokenEndpoint,d),f=await dr(this.createTokenRequestBody.bind(this),N,this.logger,this.performanceClient,b.correlationId)(b);if(b.clientInfo)try{let a=(0,fM.buildClientInfo)(b.clientInfo,this.cryptoUtils.base64Decode);c={credential:`${a.uid}${aR.Separators.CLIENT_INFO_SEPARATOR}${a.utid}`,type:fL}}catch(a){this.logger.verbose("Could not parse client info for CCS Header: "+a)}let g=this.createTokenRequestHeaders(c||b.ccsCredential),h=dU(this.config.authOptions.clientId,b);return dr(this.executePostToTokenEndpoint.bind(this),l,this.logger,this.performanceClient,b.correlationId)(e,f,g,h,b.correlationId,l)}async createTokenRequestBody(a){let b;this.performanceClient?.addQueueMeasurement(N,a.correlationId);let c=new Map;if(eW(c,a.embeddedClientId||a.tokenBodyParameters?.[d8]||this.config.authOptions.clientId),this.includeRedirectUri)eX(c,a.redirectUri);else if(!a.redirectUri)throw aL(ak);if(eV(c,a.scopes,!0,this.oidcDefaultScopes),fb(c,a.code),e5(c,this.config.libraryInfo),e6(c,this.config.telemetry.application),fu(c),this.serverTelemetryManager&&!bt(this.config)&&ft(c,this.serverTelemetryManager),a.codeVerifier&&fe(c,a.codeVerifier),this.config.clientCredentials.clientSecret&&ff(c,this.config.clientCredentials.clientSecret),this.config.clientCredentials.clientAssertion){let b=this.config.clientCredentials.clientAssertion;fg(c,await fX(b.assertion,this.config.authOptions.clientId,a.resourceRequestUri)),fh(c,b.assertionType)}if(fk(c,aR.GrantType.AUTHORIZATION_CODE_GRANT),fl(c),a.authenticationScheme===aR.AuthenticationScheme.POP){let b=new fT(this.cryptoUtils,this.performanceClient);fr(c,a.popKid?this.cryptoUtils.encodeKid(a.popKid):(await dr(b.generateCnf.bind(b),O,this.logger,this.performanceClient,a.correlationId)(a,this.logger)).reqCnfString)}else if(a.authenticationScheme===aR.AuthenticationScheme.SSH)if(a.sshJwk)fs(c,a.sshJwk);else throw aL(ay);if((!aV.isEmptyObj(a.claims)||this.config.authOptions.clientCapabilities&&this.config.authOptions.clientCapabilities.length>0)&&e3(c,a.claims,this.config.authOptions.clientCapabilities),a.clientInfo)try{let c=(0,fM.buildClientInfo)(a.clientInfo,this.cryptoUtils.base64Decode);b={credential:`${c.uid}${aR.Separators.CLIENT_INFO_SEPARATOR}${c.utid}`,type:fL}}catch(a){this.logger.verbose("Could not parse client info for CCS Header: "+a)}else b=a.ccsCredential;if(this.config.systemOptions.preventCorsPreflight&&b)switch(b.type){case fL:try{let a=(0,fM.buildClientInfoFromHomeAccountId)(b.credential);e1(c,a)}catch(a){this.logger.verbose("Could not parse home account ID for CCS Header: "+a)}break;case"UPN":e0(c,b.credential)}return a.embeddedClientId&&fw(c,this.config.authOptions.clientId,this.config.authOptions.redirectUri),a.tokenBodyParameters&&fn(c,a.tokenBodyParameters),!a.enableSpaAuthorizationCode||a.tokenBodyParameters&&a.tokenBodyParameters[eH]||fn(c,{[eH]:"1"}),eR(c,a.correlationId,this.performanceClient),a4(c)}createLogoutUrlQueryString(a){let b=new Map;return a.postLogoutRedirectUri&&eY(b,a.postLogoutRedirectUri),a.correlationId&&e4(b,a.correlationId),a.idTokenHint&&eZ(b,a.idTokenHint),a.state&&e8(b,a.state),a.logoutHint&&fv(b,a.logoutHint),a.extraQueryParameters&&fn(b,a.extraQueryParameters),this.config.authOptions.instanceAware&&fm(b),a4(b,this.config.authOptions.encodeExtraQueryParams,a.extraQueryParameters)}}class fZ{constructor(a,b){this.cacheOutcome=aR.CacheOutcome.NOT_APPLICABLE,this.cacheManager=b,this.apiId=a.apiId,this.correlationId=a.correlationId,this.wrapperSKU=a.wrapperSKU||aR.Constants.EMPTY_STRING,this.wrapperVer=a.wrapperVer||aR.Constants.EMPTY_STRING,this.telemetryCacheKey=aR.SERVER_TELEM_CONSTANTS.CACHE_KEY+aR.Separators.CACHE_KEY_SEPARATOR+a.clientId}generateCurrentRequestHeaderValue(){let a=`${this.apiId}${aR.SERVER_TELEM_CONSTANTS.VALUE_SEPARATOR}${this.cacheOutcome}`,b=[this.wrapperSKU,this.wrapperVer],c=this.getNativeBrokerErrorCode();c?.length&&b.push(`broker_error=${c}`);let d=b.join(aR.SERVER_TELEM_CONSTANTS.VALUE_SEPARATOR),e=[a,this.getRegionDiscoveryFields()].join(aR.SERVER_TELEM_CONSTANTS.VALUE_SEPARATOR);return[aR.SERVER_TELEM_CONSTANTS.SCHEMA_VERSION,e,d].join(aR.SERVER_TELEM_CONSTANTS.CATEGORY_SEPARATOR)}generateLastRequestHeaderValue(){let a=this.getLastRequests(),b=fZ.maxErrorsToSend(a),c=a.failedRequests.slice(0,2*b).join(aR.SERVER_TELEM_CONSTANTS.VALUE_SEPARATOR),d=a.errors.slice(0,b).join(aR.SERVER_TELEM_CONSTANTS.VALUE_SEPARATOR),e=a.errors.length,f=b<e?aR.SERVER_TELEM_CONSTANTS.OVERFLOW_TRUE:aR.SERVER_TELEM_CONSTANTS.OVERFLOW_FALSE,g=[e,f].join(aR.SERVER_TELEM_CONSTANTS.VALUE_SEPARATOR);return[aR.SERVER_TELEM_CONSTANTS.SCHEMA_VERSION,a.cacheHits,c,d,g].join(aR.SERVER_TELEM_CONSTANTS.CATEGORY_SEPARATOR)}cacheFailedRequest(a){let b=this.getLastRequests();b.errors.length>=aR.SERVER_TELEM_CONSTANTS.MAX_CACHED_ERRORS&&(b.failedRequests.shift(),b.failedRequests.shift(),b.errors.shift()),b.failedRequests.push(this.apiId,this.correlationId),a instanceof Error&&a&&a.toString()?a instanceof aj.AuthError?a.subError?b.errors.push(a.subError):a.errorCode?b.errors.push(a.errorCode):b.errors.push(a.toString()):b.errors.push(a.toString()):b.errors.push(aR.SERVER_TELEM_CONSTANTS.UNKNOWN_ERROR),this.cacheManager.setServerTelemetry(this.telemetryCacheKey,b,this.correlationId)}incrementCacheHits(){let a=this.getLastRequests();return a.cacheHits+=1,this.cacheManager.setServerTelemetry(this.telemetryCacheKey,a,this.correlationId),a.cacheHits}getLastRequests(){return this.cacheManager.getServerTelemetry(this.telemetryCacheKey)||{failedRequests:[],errors:[],cacheHits:0}}clearTelemetryCache(){let a=this.getLastRequests(),b=fZ.maxErrorsToSend(a);if(b===a.errors.length)this.cacheManager.removeItem(this.telemetryCacheKey,this.correlationId);else{let c={failedRequests:a.failedRequests.slice(2*b),errors:a.errors.slice(b),cacheHits:0};this.cacheManager.setServerTelemetry(this.telemetryCacheKey,c,this.correlationId)}}static maxErrorsToSend(a){let b,c=0,d=0,e=a.errors.length;for(b=0;b<e;b++){let e=a.failedRequests[2*b]||aR.Constants.EMPTY_STRING,f=a.failedRequests[2*b+1]||aR.Constants.EMPTY_STRING,g=a.errors[b]||aR.Constants.EMPTY_STRING;if((d+=e.toString().length+f.toString().length+g.length+3)<aR.SERVER_TELEM_CONSTANTS.MAX_LAST_HEADER_BYTES)c+=1;else break}return c}getRegionDiscoveryFields(){let a=[];return a.push(this.regionUsed||aR.Constants.EMPTY_STRING),a.push(this.regionSource||aR.Constants.EMPTY_STRING),a.push(this.regionOutcome||aR.Constants.EMPTY_STRING),a.join(",")}updateRegionDiscoveryMetadata(a){this.regionUsed=a.region_used,this.regionSource=a.region_source,this.regionOutcome=a.region_outcome}setCacheOutcome(a){this.cacheOutcome=a}setNativeBrokerErrorCode(a){let b=this.getLastRequests();b.nativeBrokerErrorCode=a,this.cacheManager.setServerTelemetry(this.telemetryCacheKey,b,this.correlationId)}getNativeBrokerErrorCode(){return this.getLastRequests().nativeBrokerErrorCode}clearNativeBrokerErrorCode(){let a=this.getLastRequests();delete a.nativeBrokerErrorCode,this.cacheManager.setServerTelemetry(this.telemetryCacheKey,a,this.correlationId)}static makeExtraSkuString(a){return function(a){let{skus:b,libraryName:c,libraryVersion:d,extensionName:e,extensionVersion:f}=a,g=new Map([[0,[c,d]],[2,[e,f]]]),h=[];if(b?.length){if((h=b.split(",")).length<4)return b}else h=Array.from({length:4},()=>"|");return g.forEach((a,b)=>{2===a.length&&a[0]?.length&&a[1]?.length&&function(a){let{skuArr:b,index:c,skuName:d,skuVersion:e}=a;c>=b.length||(b[c]=[d,e].join("|"))}({skuArr:h,index:b,skuName:a[0],skuVersion:a[1]})}),h.join(",")}(a)}}var f$=a.i(45238),f$=f$,aM=aI;class f_{constructor(a,b,c,d,e,f,g,h,i){this.config=a,this.browserStorage=b,this.browserCrypto=c,this.networkClient=this.config.system.networkClient,this.eventHandler=e,this.navigationClient=f,this.platformAuthProvider=h,this.correlationId=i||c5(),this.logger=d.clone(bu.BrowserConstants.MSAL_SKU,cu,this.correlationId),this.performanceClient=g}async clearCacheOnLogout(a,b){if(b)try{this.browserStorage.removeAccount(b,a),this.logger.verbose("Cleared cache items belonging to the account provided in the logout request.")}catch(a){this.logger.error("Account provided in logout request was not found. Local cache unchanged.")}else try{this.logger.verbose("No account provided in logout request, clearing all cache items.",this.correlationId),this.browserStorage.clear(a),await this.browserCrypto.clearKeystore()}catch(a){this.logger.error("Attempted to clear all MSAL cache items and failed. Local cache unchanged.")}}getRedirectUri(a){this.logger.verbose("getRedirectUri called");let b=a||this.config.auth.redirectUri;return a6.getAbsoluteUrl(b,"")}initializeServerTelemetryManager(a,b){return this.logger.verbose("initializeServerTelemetryManager called"),new fZ({clientId:this.config.auth.clientId,correlationId:this.correlationId,apiId:a,forceRefresh:b||!1,wrapperSKU:this.browserStorage.getWrapperMetadata()[0],wrapperVer:this.browserStorage.getWrapperMetadata()[1]},this.browserStorage)}async getDiscoveredAuthority(a){let{account:b}=a,c=a.requestExtraQueryParameters&&a.requestExtraQueryParameters.hasOwnProperty("instance_aware")?a.requestExtraQueryParameters.instance_aware:void 0;this.performanceClient.addQueueMeasurement(i,this.correlationId);let d={protocolMode:this.config.auth.protocolMode,OIDCOptions:this.config.auth.OIDCOptions,knownAuthorities:this.config.auth.knownAuthorities,cloudDiscoveryMetadata:this.config.auth.cloudDiscoveryMetadata,authorityMetadata:this.config.auth.authorityMetadata,skipAuthorityMetadataCache:this.config.auth.skipAuthorityMetadataCache},e=a.requestAuthority||this.config.auth.authority,f=c?.length?"true"===c:this.config.auth.instanceAware,g=b&&f?this.config.auth.authority.replace(a6.getDomainFromUrl(e),b.environment):e,h=dQ.generateAuthority(g,a.requestAzureCloudOptions||this.config.auth.azureCloudOptions),j=await dr(f$.createDiscoveredInstance,R,this.logger,this.performanceClient,this.correlationId)(h,this.config.system.networkClient,this.browserStorage,d,this.logger,this.correlationId,this.performanceClient);if(b&&!j.isAlias(b.environment))throw aL(aM.authorityMismatch);return j}}var aM=aI;async function f0(a,b,c,d){c.addQueueMeasurement(v,a.correlationId);let e=a.authority||b.auth.authority,f=[...a&&a.scopes||[]],g={...a,correlationId:a.correlationId,authority:e,scopes:f};if(g.authenticationScheme){if(g.authenticationScheme===aR.AuthenticationScheme.SSH){if(!a.sshJwk)throw aL(aM.missingSshJwk);if(!a.sshKid)throw aL(aM.missingSshKid)}d.verbose(`Authentication Scheme set to "${g.authenticationScheme}" as configured in Auth request`)}else g.authenticationScheme=aR.AuthenticationScheme.BEARER,d.verbose('Authentication Scheme wasn\'t explicitly set in request, defaulting to "Bearer" request');return b.cache.claimsBasedCachingEnabled&&a.claims&&!aV.isEmptyObj(a.claims)&&(g.requestedClaimsHash=await di(a.claims)),g}async function f1(a,b,c,d,e){d.addQueueMeasurement(w,a.correlationId);let f=await dr(f0,v,e,d,a.correlationId)(a,c,d,e);return{...a,...f,account:b,forceRefresh:a.forceRefresh||!1}}function f2(a,b){let c,d=a.httpMethod;if(b===ai.ProtocolMode.EAR){if((c=d||aR.HttpMethod.POST)!==aR.HttpMethod.POST)throw aL(aM.invalidRequestMethodForEAR)}else c=d||aR.HttpMethod.GET;if(a.authorizePostBodyParameters&&c!==aR.HttpMethod.POST)throw aL(aM.invalidAuthorizePostBodyParameters);return c}class f3 extends f_{initializeLogoutRequest(a){this.logger.verbose("initializeLogoutRequest called",a?.correlationId);let b={correlationId:this.correlationId||c5(),...a};if(a)if(a.logoutHint)this.logger.verbose("logoutHint has already been set in logoutRequest");else if(a.account){let c=this.getLogoutHintFromIdTokenClaims(a.account);c&&(this.logger.verbose("Setting logoutHint to login_hint ID Token Claim value for the account provided"),b.logoutHint=c)}else this.logger.verbose("logoutHint was not set and account was not passed into logout request, logoutHint will not be set");else this.logger.verbose("logoutHint will not be set since no logout request was configured");return a&&null===a.postLogoutRedirectUri?this.logger.verbose("postLogoutRedirectUri passed as null, not setting post logout redirect uri",b.correlationId):a&&a.postLogoutRedirectUri?(this.logger.verbose("Setting postLogoutRedirectUri to uri set on logout request",b.correlationId),b.postLogoutRedirectUri=a6.getAbsoluteUrl(a.postLogoutRedirectUri,"")):null===this.config.auth.postLogoutRedirectUri?this.logger.verbose("postLogoutRedirectUri configured as null and no uri set on request, not passing post logout redirect",b.correlationId):this.config.auth.postLogoutRedirectUri?(this.logger.verbose("Setting postLogoutRedirectUri to configured uri",b.correlationId),b.postLogoutRedirectUri=a6.getAbsoluteUrl(this.config.auth.postLogoutRedirectUri,"")):(this.logger.verbose("Setting postLogoutRedirectUri to current page",b.correlationId),b.postLogoutRedirectUri=a6.getAbsoluteUrl("","")),b}getLogoutHintFromIdTokenClaims(a){let b=a.idTokenClaims;if(b)if(b.login_hint)return b.login_hint;else this.logger.verbose("The ID Token Claims tied to the provided account do not contain a login_hint claim, logoutHint will not be added to logout request");else this.logger.verbose("The provided account does not contain ID Token Claims, logoutHint will not be added to logout request");return null}async createAuthCodeClient(a){return this.performanceClient.addQueueMeasurement(B,this.correlationId),new fY(await dr(this.getClientConfiguration.bind(this),C,this.logger,this.performanceClient,this.correlationId)(a),this.performanceClient)}async getClientConfiguration(a){let{serverTelemetryManager:b,requestAuthority:c,requestAzureCloudOptions:d,requestExtraQueryParameters:e,account:f}=a;this.performanceClient.addQueueMeasurement(C,this.correlationId);let g=a.authority||await dr(this.getDiscoveredAuthority.bind(this),i,this.logger,this.performanceClient,this.correlationId)({requestAuthority:c,requestAzureCloudOptions:d,requestExtraQueryParameters:e,account:f}),h=this.config.system.loggerOptions;return{authOptions:{clientId:this.config.auth.clientId,authority:g,clientCapabilities:this.config.auth.clientCapabilities,redirectUri:this.config.auth.redirectUri},systemOptions:{tokenRenewalOffsetSeconds:this.config.system.tokenRenewalOffsetSeconds,preventCorsPreflight:!0},loggerOptions:{loggerCallback:h.loggerCallback,piiLoggingEnabled:h.piiLoggingEnabled,logLevel:h.logLevel,correlationId:this.correlationId},cacheOptions:{claimsBasedCachingEnabled:this.config.cache.claimsBasedCachingEnabled},cryptoInterface:this.browserCrypto,networkInterface:this.networkClient,storageInterface:this.browserStorage,serverTelemetryManager:b,libraryInfo:{sku:bu.BrowserConstants.MSAL_SKU,version:cu,cpu:aR.Constants.EMPTY_STRING,os:aR.Constants.EMPTY_STRING},telemetry:this.config.telemetry}}async initializeAuthorizationRequest(a,b){this.performanceClient.addQueueMeasurement(D,this.correlationId);let c=this.getRedirectUri(a.redirectUri),d=fS.setRequestState(this.browserCrypto,a&&a.state||aR.Constants.EMPTY_STRING,{interactionType:b}),e={...await dr(f0,v,this.logger,this.performanceClient,this.correlationId)({...a,correlationId:this.correlationId},this.config,this.performanceClient,this.logger),redirectUri:c,state:d,nonce:a.nonce||c5(),responseMode:this.config.auth.OIDCOptions.serverResponseType},f={...e,httpMethod:f2(e,this.config.auth.protocolMode)};if(a.loginHint||a.sid)return f;let g=a.account||this.browserStorage.getActiveAccount(this.correlationId);return g&&(this.logger.verbose("Setting validated request account",this.correlationId),this.logger.verbosePii(`Setting validated request account: ${g.homeAccountId}`,this.correlationId),f.account=g),f}}var f4=a.i(98327),f4=f4,cH=aO;function f5(a,b,c){let d=f4.getDeserializedResponse(a);if(!d)if(f4.stripLeadingHashOrQuery(a))throw c.error(`A ${b} is present in the iframe but it does not contain known properties. It's likely that the ${b} has been replaced by code running on the redirectUri page.`),c.errorPii(`The ${b} detected is: ${a}`),cm(bD);else throw c.error(`The request has returned to the redirectUri but a ${b} is not present. It's likely that the ${b} has been removed or the page has been redirected by code running on the redirectUri page.`),cm(bB);return d}var aM=aI,fz=fz;function f6(a,b,c,d){let e=b.correlationId,f=new Map;if(eW(f,b.embeddedClientId||b.extraQueryParameters?.[d8]||a.clientId),eV(f,[...b.scopes||[],...b.extraScopesToConsent||[]],!0,a.authority.options.OIDCOptions?.defaultScopes),eX(f,b.redirectUri),e4(f,e),eT(f,b.responseMode),fl(f),b.prompt&&(e7(f,b.prompt),d?.addFields({prompt:b.prompt},e)),b.domainHint&&(e$(f,b.domainHint),d?.addFields({domainHintFromRequest:!0},e)),b.prompt!==aR.PromptValue.SELECT_ACCOUNT)if(b.sid&&b.prompt===aR.PromptValue.NONE)c.verbose("createAuthCodeUrlQueryString: Prompt is none, adding sid from request"),e2(f,b.sid),d?.addFields({sidFromRequest:!0},e);else if(b.account){var g,h;let a=(g=b.account,g.idTokenClaims?.sid||null),i=(h=b.account).loginHint||h.idTokenClaims?.login_hint||null;if(i&&b.domainHint&&(c.warning('AuthorizationCodeClient.createAuthCodeUrlQueryString: "domainHint" param is set, skipping opaque "login_hint" claim. Please consider not passing domainHint'),i=null),i){c.verbose("createAuthCodeUrlQueryString: login_hint claim present on account"),e_(f,i),d?.addFields({loginHintFromClaim:!0},e);try{let a=(0,fM.buildClientInfoFromHomeAccountId)(b.account.homeAccountId);e1(f,a)}catch(a){c.verbose("createAuthCodeUrlQueryString: Could not parse home account ID for CCS Header")}}else if(a&&b.prompt===aR.PromptValue.NONE){c.verbose("createAuthCodeUrlQueryString: Prompt is none, adding sid from account"),e2(f,a),d?.addFields({sidFromClaim:!0},e);try{let a=(0,fM.buildClientInfoFromHomeAccountId)(b.account.homeAccountId);e1(f,a)}catch(a){c.verbose("createAuthCodeUrlQueryString: Could not parse home account ID for CCS Header")}}else if(b.loginHint)c.verbose("createAuthCodeUrlQueryString: Adding login_hint from request"),e_(f,b.loginHint),e0(f,b.loginHint),d?.addFields({loginHintFromRequest:!0},e);else if(b.account.username){c.verbose("createAuthCodeUrlQueryString: Adding login_hint from account"),e_(f,b.account.username),d?.addFields({loginHintFromUpn:!0},e);try{let a=(0,fM.buildClientInfoFromHomeAccountId)(b.account.homeAccountId);e1(f,a)}catch(a){c.verbose("createAuthCodeUrlQueryString: Could not parse home account ID for CCS Header")}}}else b.loginHint&&(c.verbose("createAuthCodeUrlQueryString: No account, adding login_hint from request"),e_(f,b.loginHint),e0(f,b.loginHint),d?.addFields({loginHintFromRequest:!0},e));else c.verbose("createAuthCodeUrlQueryString: Prompt is select_account, ignoring account hints");return b.nonce&&e9(f,b.nonce),b.state&&e8(f,b.state),(b.claims||a.clientCapabilities&&a.clientCapabilities.length>0)&&e3(f,b.claims,a.clientCapabilities),b.embeddedClientId&&fw(f,a.clientId,a.redirectUri),!a.instanceAware||b.extraQueryParameters&&Object.keys(b.extraQueryParameters).includes(eO)||fm(f),f}function f7(a,b,c,d){let e=a4(b,c,d);return a6.appendQueryString(a.authorizationEndpoint,e)}function f8(a,b){if(f9(a,b),!a.code)throw(0,aN.createClientAuthError)(aO.authorizationCodeMissingFromServerResponse);return a}function f9(a,b){let c,d;if(!a.state||!b)throw a.state?(0,aN.createClientAuthError)(aO.stateNotFound,"Cached State"):(0,aN.createClientAuthError)(aO.stateNotFound,"Server State");try{c=decodeURIComponent(a.state)}catch(b){throw(0,aN.createClientAuthError)(aO.invalidState,a.state)}try{d=decodeURIComponent(b)}catch(b){throw(0,aN.createClientAuthError)(aO.invalidState,a.state)}if(c!==d)throw(0,aN.createClientAuthError)(aO.stateMismatch);if(a.error||a.error_description||a.suberror){var e;let b,c,d=(e=a,b="code=",(c=e.error_uri?.lastIndexOf(b))&&c>=0?e.error_uri?.substring(c+b.length):void 0);if((0,dS.isInteractionRequiredError)(a.error,a.error_description,a.suberror))throw new dS.InteractionRequiredAuthError(a.error||"",a.error_description,a.suberror,a.timestamp||"",a.trace_id||"",a.correlation_id||"",a.claims||"",d);throw new fP(a.error||"",a.error_description,a.suberror,d)}}a.s(["getAuthorizationCodePayload",()=>f8,"getAuthorizeUrl",()=>f7,"getStandardAuthorizeRequestParameters",()=>f6,"validateAuthorizationResponse",()=>f9],77929);var ga=a.i(77929),ga=ga,dW=dW,ga=ga;class gb{constructor(a,b,c,d,e){this.authModule=a,this.browserStorage=b,this.authCodeRequest=c,this.logger=d,this.performanceClient=e}async handleCodeResponse(a,b){let c;this.performanceClient.addQueueMeasurement(G,b.correlationId);try{c=ga.getAuthorizationCodePayload(a,b.state)}catch(a){if(a instanceof fP&&a.subError===bJ)throw cm(bJ);throw a}return dr(this.handleCodeResponseFromServer.bind(this),F,this.logger,this.performanceClient,b.correlationId)(c,b)}async handleCodeResponseFromServer(a,b,c=!0){if(this.performanceClient.addQueueMeasurement(F,b.correlationId),this.logger.trace("InteractionHandler.handleCodeResponseFromServer called"),this.authCodeRequest.code=a.code,a.cloud_instance_host_name&&await dr(this.authModule.updateAuthority.bind(this.authModule),K,this.logger,this.performanceClient,b.correlationId)(a.cloud_instance_host_name,b.correlationId),c&&(a.nonce=b.nonce||void 0),a.state=b.state,a.client_info)this.authCodeRequest.clientInfo=a.client_info;else{let a=this.createCcsCredentials(b);a&&(this.authCodeRequest.ccsCredential=a)}return await dr(this.authModule.acquireToken.bind(this.authModule),L,this.logger,this.performanceClient,b.correlationId)(this.authCodeRequest,a)}createCcsCredentials(a){return a.account?{credential:a.account.homeAccountId,type:fL}:a.loginHint?{credential:a.loginHint,type:"UPN"}:null}}var gc=a.i(30553),gc=gc,dW=dW,cH=aO,dT=dT,dX=dX,gd=aj,dV=dV;let ge="user_switch",gf={[ge]:"User attempted to switch accounts in the native broker, which is not allowed. All new accounts must sign-in through the standard web flow first, please try again."};class gg extends gd.AuthError{constructor(a,b,c){super(a,b),Object.setPrototypeOf(this,gg.prototype),this.name="NativeAuthError",this.ext=c}}function gh(a){if(a.ext&&a.ext.status&&"DISABLED"===a.ext.status||a.ext&&a.ext.error&&-0x7ffb78ff===a.ext.error)return!0;switch(a.errorCode){case"ContentError":case"PageException":return!0;default:return!1}}function gi(a,b,c){if(c&&c.status)switch(c.status){case"ACCOUNT_UNAVAILABLE":return(0,dS.createInteractionRequiredAuthError)(dV.nativeAccountUnavailable);case"USER_INTERACTION_REQUIRED":return new dS.InteractionRequiredAuthError(a,b);case"USER_CANCEL":return cm(bJ);case"NO_NETWORK":return cm(bZ);case"UX_NOT_ALLOWED":return(0,dS.createInteractionRequiredAuthError)(dV.uxNotAllowed)}return new gg(a,gf[a]||b,c)}class gj extends fR{constructor(a,b){super(a,b)}async acquireCachedToken(a){this.performanceClient?.addQueueMeasurement(s,a.correlationId);let b=aR.CacheOutcome.NOT_APPLICABLE;if(a.forceRefresh||!this.config.cacheOptions.claimsBasedCachingEnabled&&!aV.isEmptyObj(a.claims))throw this.setCacheOutcome(aR.CacheOutcome.FORCE_REFRESH_OR_CLAIMS,a.correlationId),(0,aN.createClientAuthError)(aO.tokenRefreshRequired);if(!a.account)throw(0,aN.createClientAuthError)(aO.noAccountInSilentRequest);let c=a.account.tenantId||function(a){let b=new a6(a).getUrlComponents(),c=b.PathSegments.slice(-1)[0]?.toLowerCase();switch(c){case aR.AADAuthorityConstants.COMMON:case aR.AADAuthorityConstants.ORGANIZATIONS:case aR.AADAuthorityConstants.CONSUMERS:return;default:return c}}(a.authority),d=this.cacheManager.getTokenKeys(),e=this.cacheManager.getAccessToken(a.account,a,d,c);if(e)if(dy(e.cachedAt)||dw(e.expiresOn,this.config.systemOptions.tokenRenewalOffsetSeconds))throw this.setCacheOutcome(aR.CacheOutcome.CACHED_ACCESS_TOKEN_EXPIRED,a.correlationId),(0,aN.createClientAuthError)(aO.tokenRefreshRequired);else e.refreshOn&&dw(e.refreshOn,0)&&(b=aR.CacheOutcome.PROACTIVELY_REFRESHED);else throw this.setCacheOutcome(aR.CacheOutcome.NO_CACHED_ACCESS_TOKEN,a.correlationId),(0,aN.createClientAuthError)(aO.tokenRefreshRequired);let f=a.authority||this.authority.getPreferredCache(),g={account:this.cacheManager.getAccount(this.cacheManager.generateAccountKey(a.account),a.correlationId),accessToken:e,idToken:this.cacheManager.getIdToken(a.account,a.correlationId,d,c,this.performanceClient),refreshToken:null,appMetadata:this.cacheManager.readAppMetadataFromCache(f)};return this.setCacheOutcome(b,a.correlationId),this.config.serverTelemetryManager&&this.config.serverTelemetryManager.incrementCacheHits(),[await dr(this.generateResultFromCacheRecord.bind(this),t,this.logger,this.performanceClient,a.correlationId)(g,a),b]}setCacheOutcome(a,b){this.serverTelemetryManager?.setCacheOutcome(a),this.performanceClient?.addFields({cacheOutcome:a},b),a!==aR.CacheOutcome.NOT_APPLICABLE&&this.logger.info(`Token refresh is required due to cache outcome: ${a}`)}async generateResultFromCacheRecord(a,b){let c;if(this.performanceClient?.addQueueMeasurement(t,b.correlationId),a.idToken&&(c=aZ(a.idToken.secret,this.config.cryptoInterface.base64Decode)),b.maxAge||0===b.maxAge){let a=c?.auth_time;if(!a)throw(0,aN.createClientAuthError)(aO.authTimeNotFound);a0(a,b.maxAge)}return fV.generateAuthenticationResult(this.cryptoUtils,this.authority,a,!0,b,c)}}class gk extends f3{async acquireToken(a){this.performanceClient.addQueueMeasurement(f,a.correlationId);let b=this.initializeServerTelemetryManager(bu.ApiId.acquireTokenSilent_silentFlow),c=new gj(await dr(this.getClientConfiguration.bind(this),C,this.logger,this.performanceClient,this.correlationId)({serverTelemetryManager:b,requestAuthority:a.authority,requestAzureCloudOptions:a.azureCloudOptions,account:a.account}),this.performanceClient);this.logger.verbose("Silent auth client created");try{let b=(await dr(c.acquireCachedToken.bind(c),s,this.logger,this.performanceClient,a.correlationId)(a))[0];return this.performanceClient.addFields({fromCache:!0},a.correlationId),b}catch(a){throw a instanceof cl&&a.errorCode===b2&&this.logger.verbose("Signing keypair for bound access token not found. Refreshing bound access token and generating a new crypto keypair."),a}}logout(a){this.logger.verbose("logoutRedirect called");let b=this.initializeLogoutRequest(a);return this.clearCacheOnLogout(b.correlationId,b?.account)}}class gl extends f_{constructor(a,b,c,d,e,f,g,h,i,j,k,l){super(a,b,c,d,e,f,h,i,l),this.apiId=g,this.accountId=j,this.platformAuthProvider=i,this.nativeStorageManager=k,this.silentCacheClient=new gk(a,this.nativeStorageManager,c,d,e,f,h,i,l);const m=this.platformAuthProvider.getExtensionName();this.skus=fZ.makeExtraSkuString({libraryName:bu.BrowserConstants.MSAL_SKU,libraryVersion:cu,extensionName:m,extensionVersion:this.platformAuthProvider.getExtensionVersion()})}addRequestSKUs(a){a.extraParameters={...a.extraParameters,[gc.X_CLIENT_EXTRA_SKU]:this.skus}}async acquireToken(a,b){this.performanceClient.addQueueMeasurement(j,this.correlationId),this.logger.trace("NativeInteractionClient - acquireToken called.");let c=this.performanceClient.startMeasurement(j,this.correlationId),d=dW.nowSeconds(),e=this.initializeServerTelemetryManager(this.apiId);try{let f=await this.initializeNativeRequest(a);try{let a=await this.acquireTokensFromCache(this.accountId,f);return c.end({success:!0,isNativeBroker:!1,fromCache:!0}),a}catch(a){if(b===bu.CacheLookupPolicy.AccessToken)throw this.logger.info("MSAL internal Cache does not contain tokens, return error as per cache policy"),c.end({success:!1,brokerErrorCode:"cache_request_failed"}),a;this.logger.info("MSAL internal Cache does not contain tokens, proceed to make a native call")}let g=await this.platformAuthProvider.sendMessage(f);return await this.handleNativeResponse(g,f,d).then(a=>(c.end({success:!0,isNativeBroker:!0,requestId:a.requestId}),e.clearNativeBrokerErrorCode(),a)).catch(a=>{throw c.end({success:!1,errorCode:a.errorCode,subErrorCode:a.subError}),a})}catch(a){throw a instanceof gg&&e.setNativeBrokerErrorCode(a.errorCode),c.end({success:!1}),a}}createSilentCacheRequest(a,b){return{authority:a.authority,correlationId:this.correlationId,scopes:aW.fromString(a.scope).asArray(),account:b,forceRefresh:!1}}async acquireTokensFromCache(a,b){if(!a)throw this.logger.warning("NativeInteractionClient:acquireTokensFromCache - No nativeAccountId provided"),(0,aN.createClientAuthError)(cH.noAccountFound);let c=this.browserStorage.getBaseAccountInfo({nativeAccountId:a},this.correlationId);if(!c)throw(0,aN.createClientAuthError)(cH.noAccountFound);try{let a=this.createSilentCacheRequest(b,c),d=await this.silentCacheClient.acquireToken(a),e={...c,idTokenClaims:d?.idTokenClaims,idToken:d?.idToken};return{...d,account:e}}catch(a){throw a}}async acquireTokenRedirect(a,b){this.logger.trace("NativeInteractionClient - acquireTokenRedirect called.");let{...c}=a;delete c.onRedirectNavigate;let d=await this.initializeNativeRequest(c);try{await this.platformAuthProvider.sendMessage(d)}catch(a){if(a instanceof gg&&(this.initializeServerTelemetryManager(this.apiId).setNativeBrokerErrorCode(a.errorCode),gh(a)))throw a}this.browserStorage.setTemporaryCache(bu.TemporaryCacheKeys.NATIVE_REQUEST,JSON.stringify(d),!0);let e={apiId:bu.ApiId.acquireTokenRedirect,timeout:this.config.system.redirectNavigationTimeout,noHistory:!1},f=this.config.auth.navigateToLoginRequestUrl?window.location.href:this.getRedirectUri(a.redirectUri);b.end({success:!0}),await this.navigationClient.navigateExternal(f,e)}async handleRedirectPromise(a,b){if(this.logger.trace("NativeInteractionClient - handleRedirectPromise called."),!this.browserStorage.isInteractionInProgress(!0))return this.logger.info("handleRedirectPromise called but there is no interaction in progress, returning null."),null;let c=this.browserStorage.getCachedNativeRequest();if(!c)return this.logger.verbose("NativeInteractionClient - handleRedirectPromise called but there is no cached request, returning null."),a&&b&&a?.addFields({errorCode:"no_cached_request"},b),null;let{prompt:d,...e}=c;d&&this.logger.verbose("NativeInteractionClient - handleRedirectPromise called and prompt was included in the original request, removing prompt from cached request to prevent second interaction with native broker window."),this.browserStorage.removeItem(this.browserStorage.generateCacheKey(bu.TemporaryCacheKeys.NATIVE_REQUEST));let f=dW.nowSeconds();try{this.logger.verbose("NativeInteractionClient - handleRedirectPromise sending message to native broker.");let b=await this.platformAuthProvider.sendMessage(e),c=await this.handleNativeResponse(b,e,f);return this.initializeServerTelemetryManager(this.apiId).clearNativeBrokerErrorCode(),a&&this.correlationId&&this.performanceClient.addFields({isNativeBroker:!0},this.correlationId),c}catch(a){throw a}}logout(){return this.logger.trace("NativeInteractionClient - logout called."),Promise.reject("Logout not implemented yet")}async handleNativeResponse(a,b,c){this.logger.trace("NativeInteractionClient - handleNativeResponse called.");let d=dT.extractTokenClaims(a.id_token,cT),e=this.createHomeAccountIdentifier(a,d),f=this.browserStorage.getAccountInfoFilteredBy({nativeAccountId:b.accountId},this.correlationId)?.homeAccountId;if(b.extraParameters?.child_client_id&&a.account.id!==b.accountId)this.logger.info("handleNativeServerResponse: Double broker flow detected, ignoring accountId mismatch");else if(e!==f&&a.account.id!==b.accountId)throw gi(ge);let g=await this.getDiscoveredAuthority({requestAuthority:b.authority}),h=fW(this.browserStorage,g,e,cT,this.correlationId,d,a.client_info,void 0,d.tid,void 0,a.account.id,this.logger);a.expires_in=Number(a.expires_in);let i=await this.generateAuthenticationResult(a,b,d,h,g.canonicalAuthority,c);return await this.cacheAccount(h,this.correlationId,dT.isKmsi(d)),await this.cacheNativeTokens(a,b,e,d,a.access_token,i.tenantId,c),i}createHomeAccountIdentifier(a,b){return aX.AccountEntity.generateHomeAccountId(a.client_info||aR.Constants.EMPTY_STRING,dp.AuthorityType.Default,this.logger,this.browserCrypto,b)}generateScopes(a,b){return b?aW.fromString(b):aW.fromString(a)}async generatePopAccessToken(a,b){if(b.tokenType!==aR.AuthenticationScheme.POP||!b.signPopToken)return a.access_token;{if(a.shr)return this.logger.trace("handleNativeServerResponse: SHR is enabled in native layer"),a.shr;let c=new fT(this.browserCrypto),d={resourceRequestMethod:b.resourceRequestMethod,resourceRequestUri:b.resourceRequestUri,shrClaims:b.shrClaims,shrNonce:b.shrNonce};if(!b.keyId)throw(0,aN.createClientAuthError)(cH.keyIdMissing);return c.signPopToken(a.access_token,b.keyId,d)}}async generateAuthenticationResult(a,b,c,d,e,f){let g=this.addTelemetryFromNativeResponse(a.properties.MATS),h=this.generateScopes(b.scope,a.scope),i=a.account.properties||{},j=i.UID||c.oid||c.sub||aR.Constants.EMPTY_STRING,k=i.TenantId||c.tid||aR.Constants.EMPTY_STRING,l=(0,aY.updateAccountTenantProfileData)(aX.AccountEntity.getAccountInfo(d),void 0,c,a.id_token);l.nativeAccountId!==a.account.id&&(l.nativeAccountId=a.account.id);let m=await this.generatePopAccessToken(a,b),n=b.tokenType===aR.AuthenticationScheme.POP?aR.AuthenticationScheme.POP:aR.AuthenticationScheme.BEARER;return{authority:e,uniqueId:j,tenantId:k,scopes:h.asArray(),account:l,idToken:a.id_token,idTokenClaims:c,accessToken:m,fromCache:!!g&&this.isResponseFromCache(g),expiresOn:dW.toDateFromSeconds(f+a.expires_in),tokenType:n,correlationId:this.correlationId,state:a.state,fromNativeBroker:!0}}async cacheAccount(a,b,c){await this.browserStorage.setAccount(a,this.correlationId,c),this.browserStorage.removeAccountContext(aX.AccountEntity.getAccountInfo(a),b)}cacheNativeTokens(a,b,c,d,e,f,g){let h=dX.createIdTokenEntity(c,b.authority,a.id_token||"",b.clientId,d.tid||""),i=b.tokenType===aR.AuthenticationScheme.POP?aR.Constants.SHR_NONCE_VALIDITY:("string"==typeof a.expires_in?parseInt(a.expires_in,10):a.expires_in)||0,j=this.generateScopes(a.scope,b.scope),k=dX.createAccessTokenEntity(c,b.authority,e,b.clientId,d.tid||f,j.printScopes(),g+i,0,cT,void 0,b.tokenType,void 0,b.keyId);return this.nativeStorageManager.saveCacheRecord({idToken:h,accessToken:k},this.correlationId,dT.isKmsi(d),b.storeInCache)}getExpiresInValue(a,b){return a===aR.AuthenticationScheme.POP?aR.Constants.SHR_NONCE_VALIDITY:("string"==typeof b?parseInt(b,10):b)||0}addTelemetryFromNativeResponse(a){let b=this.getMATSFromResponse(a);return b?(this.performanceClient.addFields({extensionId:this.platformAuthProvider.getExtensionId(),extensionVersion:this.platformAuthProvider.getExtensionVersion(),matsBrokerVersion:b.broker_version,matsAccountJoinOnStart:b.account_join_on_start,matsAccountJoinOnEnd:b.account_join_on_end,matsDeviceJoin:b.device_join,matsPromptBehavior:b.prompt_behavior,matsApiErrorCode:b.api_error_code,matsUiVisible:b.ui_visible,matsSilentCode:b.silent_code,matsSilentBiSubCode:b.silent_bi_sub_code,matsSilentMessage:b.silent_message,matsSilentStatus:b.silent_status,matsHttpStatus:b.http_status,matsHttpEventCount:b.http_event_count},this.correlationId),b):null}getMATSFromResponse(a){if(a)try{return JSON.parse(a)}catch(a){this.logger.error("NativeInteractionClient - Error parsing MATS telemetry, returning null instead")}return null}isResponseFromCache(a){return void 0===a.is_cached?(this.logger.verbose("NativeInteractionClient - MATS telemetry does not contain field indicating if response was served from cache. Returning false."),!1):!!a.is_cached}async initializeNativeRequest(a){this.logger.trace("NativeInteractionClient - initializeNativeRequest called");let b=await this.getCanonicalAuthority(a),{scopes:c,...d}=a,e=new aW(c||[]);e.appendScopes(aR.OIDC_DEFAULT_SCOPES);let f={...d,accountId:this.accountId,clientId:this.config.auth.clientId,authority:b.urlString,scope:e.printScopes(),redirectUri:this.getRedirectUri(a.redirectUri),prompt:this.getPrompt(a.prompt),correlationId:this.correlationId,tokenType:a.authenticationScheme,windowTitleSubstring:document.title,extraParameters:{...a.extraQueryParameters,...a.tokenQueryParameters},extendedExpiryToken:!1,keyId:a.popKid};if(f.signPopToken&&a.popKid)throw cm(ce);if(this.handleExtraBrokerParams(f),f.extraParameters=f.extraParameters||{},f.extraParameters.telemetry=bu.PlatformAuthConstants.MATS_TELEMETRY,a.authenticationScheme===aR.AuthenticationScheme.POP){let b,c={resourceRequestUri:a.resourceRequestUri,resourceRequestMethod:a.resourceRequestMethod,shrClaims:a.shrClaims,shrNonce:a.shrNonce},d=new fT(this.browserCrypto);if(f.keyId)b=this.browserCrypto.base64UrlEncode(JSON.stringify({kid:f.keyId})),f.signPopToken=!1;else{let a=await dr(d.generateCnf.bind(d),O,this.logger,this.performanceClient,this.correlationId)(c,this.logger);b=a.reqCnfString,f.keyId=a.kid,f.signPopToken=!0}f.reqCnf=b}return this.addRequestSKUs(f),f}async getCanonicalAuthority(a){let b=a.authority||this.config.auth.authority;a.account&&await this.getDiscoveredAuthority({requestAuthority:b,requestAzureCloudOptions:a.azureCloudOptions,account:a.account});let c=new a6(b);return c.validateAsUri(),c}getPrompt(a){switch(this.apiId){case bu.ApiId.ssoSilent:case bu.ApiId.acquireTokenSilent_silentFlow:return this.logger.trace("initializeNativeRequest: silent request sets prompt to none"),aR.PromptValue.NONE}if(!a)return void this.logger.trace("initializeNativeRequest: prompt was not provided");switch(a){case aR.PromptValue.NONE:case aR.PromptValue.CONSENT:case aR.PromptValue.LOGIN:case aR.PromptValue.SELECT_ACCOUNT:return this.logger.trace("initializeNativeRequest: prompt is compatible with native flow"),a;default:throw this.logger.trace(`initializeNativeRequest: prompt = ${a} is not compatible with native flow`),cm(cc)}}handleExtraBrokerParams(a){let b=a.extraParameters&&a.extraParameters.hasOwnProperty(gc.BROKER_CLIENT_ID)&&a.extraParameters.hasOwnProperty(gc.BROKER_REDIRECT_URI)&&a.extraParameters.hasOwnProperty(gc.CLIENT_ID);if(!a.embeddedClientId&&!b)return;let c="",d=a.redirectUri;a.embeddedClientId?(a.redirectUri=this.config.auth.redirectUri,c=a.embeddedClientId):a.extraParameters&&(a.redirectUri=a.extraParameters[gc.BROKER_REDIRECT_URI],c=a.extraParameters[gc.CLIENT_ID]),a.extraParameters={child_client_id:c,child_redirect_uri:d},this.performanceClient?.addFields({embeddedClientId:c,embeddedRedirectUri:d},this.correlationId)}}async function gm(a,b,c,d,e){let f=ga.getStandardAuthorizeRequestParameters({...a.auth,authority:b},c,d,e);if(fz.addLibraryInfo(f,{sku:bu.BrowserConstants.MSAL_SKU,version:cu,os:"",cpu:""}),a.auth.protocolMode!==ai.ProtocolMode.OIDC&&fz.addApplicationTelemetry(f,a.telemetry.application),c.platformBroker&&(fz.addNativeBroker(f),e.addFields({isPlatformAuthorizeRequest:!0},c.correlationId),c.authenticationScheme===aR.AuthenticationScheme.POP)){let a,b=new dm(d,e),g=new fT(b);a=c.popKid?b.encodeKid(c.popKid):(await dr(g.generateCnf.bind(g),O,d,e,c.correlationId)(c,d)).reqCnfString,fz.addPopToken(f,a)}return fz.instrumentBrokerParams(f,c.correlationId,e),f}async function gn(a,b,c,d,e){if(!c.codeChallenge)throw aL(aM.pkceParamsMissing);let f=await dr(gm,"getStandardParams",d,e,c.correlationId)(a,b,c,d,e);return fz.addResponseType(f,aR.OAuthResponseType.CODE),fz.addCodeChallengeParams(f,c.codeChallenge,aR.Constants.S256_CODE_CHALLENGE_METHOD),fz.addExtraQueryParameters(f,c.extraQueryParameters||{}),ga.getAuthorizeUrl(b,f,a.auth.encodeExtraQueryParams,c.extraQueryParameters)}async function go(a,b,c,d,e,f){if(!d.earJwk)throw cm(bx);let g=await gm(b,c,d,e,f);fz.addResponseType(g,aR.OAuthResponseType.IDTOKEN_TOKEN_REFRESHTOKEN),fz.addEARParameters(g,d.earJwk),fz.addCodeChallengeParams(g,d.codeChallenge,aR.Constants.S256_CODE_CHALLENGE_METHOD);let h=new Map;return fz.addExtraQueryParameters(h,d.extraQueryParameters||{}),gq(a,ga.getAuthorizeUrl(c,h,b.auth.encodeExtraQueryParams,d.extraQueryParameters),g)}async function gp(a,b,c,d,e,f){let g=await gm(b,c,d,e,f);fz.addResponseType(g,aR.OAuthResponseType.CODE),fz.addCodeChallengeParams(g,d.codeChallenge,d.codeChallengeMethod||aR.Constants.S256_CODE_CHALLENGE_METHOD),fz.addPostBodyParameters(g,d.authorizePostBodyParameters||{});let h=new Map;return fz.addExtraQueryParameters(h,d.extraQueryParameters||{}),gq(a,ga.getAuthorizeUrl(c,h,b.auth.encodeExtraQueryParams,d.extraQueryParameters),g)}function gq(a,b,c){let d=a.createElement("form");return d.method="post",d.action=b,c.forEach((b,c)=>{let e=a.createElement("input");e.hidden=!0,e.name=c,e.value=b,d.appendChild(e)}),a.body.appendChild(d),d}async function gr(a,b,c,d,e,f,g,h,i,k){if(h.verbose("Account id found, calling WAM for token"),!k)throw cm(ca);let l=new dm(h,i),m=new gl(d,e,l,h,g,d.system.navigationClient,c,i,k,b,f,a.correlationId),{userRequestState:n}=fS.parseRequestState(l,a.state);return dr(m.acquireToken.bind(m),j,h,i,a.correlationId)({...a,state:n,prompt:void 0})}async function gs(a,b,c,d,e,f,g,h,i,j,k,l){if(fQ.removeThrottle(g,e.auth.clientId,a),b.accountId)return dr(gr,I,j,k,a.correlationId)(a,b.accountId,d,e,g,h,i,j,k,l);let m=new gb(f,g,{...a,code:b.code||"",codeVerifier:c},j,k);return await dr(m.handleCodeResponse.bind(m),G,j,k,a.correlationId)(b,a)}async function gt(a,b,c,d,e,f,g,h,i,j,k){if(fQ.removeThrottle(f,d.auth.clientId,a),ga.validateAuthorizationResponse(b,a.state),!b.ear_jwe)throw cm(by);if(!a.earJwk)throw cm(bx);let l=JSON.parse(await dr(dc,"decryptEarResponse",i,j,a.correlationId)(a.earJwk,b.ear_jwe));if(l.accountId)return dr(gr,I,i,j,a.correlationId)(a,l.accountId,c,d,f,g,h,i,j,k);let m=new fV(d.auth.clientId,f,new dm(i,j),i,null,null,j);m.validateTokenResponse(l);let n={code:"",state:a.state,nonce:a.nonce,client_info:l.client_info,cloud_graph_host_name:l.cloud_graph_host_name,cloud_instance_host_name:l.cloud_instance_host_name,cloud_instance_name:l.cloud_instance_name,msgraph_host:l.msgraph_host};return await dr(m.handleServerTokenResponse.bind(m),P,i,j,a.correlationId)(l,e,dW.nowSeconds(),a,n,void 0,void 0,void 0,void 0)}async function gu(a,b,c){a.addQueueMeasurement(aa,c);let d=dq(gv,"generateCodeVerifier",b,a,c)(a,b,c),e=await dr(gw,ab,b,a,c)(d,a,b,c);return{verifier:d,challenge:e}}function gv(a,b,c){try{let d=new Uint8Array(32);return dq(c3,"getRandomValues",b,a,c)(d),cQ(d)}catch(a){throw cm(bw)}}async function gw(a,b,c,d){b.addQueueMeasurement(ab,d);try{let e=await dr(c2,ac,c,b,d)(a,b,d);return cQ(new Uint8Array(e))}catch(a){throw cm(bw)}}var aM=aI,gx=a.i(3054),gx=gx;class gy{constructor(a,b,c,d){this.logger=a,this.handshakeTimeoutMs=b,this.extensionId=d,this.resolvers=new Map,this.handshakeResolvers=new Map,this.messageChannel=new MessageChannel,this.windowListener=this.onWindowMessage.bind(this),this.performanceClient=c,this.handshakeEvent=c.startMeasurement("nativeMessageHandlerHandshake"),this.platformAuthType=bu.PlatformAuthConstants.PLATFORM_EXTENSION_PROVIDER}async sendMessage(a){this.logger.trace(this.platformAuthType+" - sendMessage called.");let b={method:bu.NativeExtensionMethod.GetToken,request:a},c={channel:bu.PlatformAuthConstants.CHANNEL_ID,extensionId:this.extensionId,responseId:c5(),body:b};this.logger.trace(this.platformAuthType+" - Sending request to browser extension"),this.logger.tracePii(this.platformAuthType+` - Sending request to browser extension: ${JSON.stringify(c)}`),this.messageChannel.port1.postMessage(c);let d=await new Promise((a,b)=>{this.resolvers.set(c.responseId,{resolve:a,reject:b})});return this.validatePlatformBrokerResponse(d)}static async createProvider(a,b,c){a.trace("PlatformAuthExtensionHandler - createProvider called.");try{let d=new gy(a,b,c,bu.PlatformAuthConstants.PREFERRED_EXTENSION_ID);return await d.sendHandshakeRequest(),d}catch(e){let d=new gy(a,b,c);return await d.sendHandshakeRequest(),d}}async sendHandshakeRequest(){this.logger.trace(this.platformAuthType+" - sendHandshakeRequest called."),window.addEventListener("message",this.windowListener,!1);let a={channel:bu.PlatformAuthConstants.CHANNEL_ID,extensionId:this.extensionId,responseId:c5(),body:{method:bu.NativeExtensionMethod.HandshakeRequest}};return this.handshakeEvent.add({extensionId:this.extensionId,extensionHandshakeTimeoutMs:this.handshakeTimeoutMs}),this.messageChannel.port1.onmessage=a=>{this.onChannelMessage(a)},window.postMessage(a,window.origin,[this.messageChannel.port2]),new Promise((b,c)=>{this.handshakeResolvers.set(a.responseId,{resolve:b,reject:c}),this.timeoutId=window.setTimeout(()=>{window.removeEventListener("message",this.windowListener,!1),this.messageChannel.port1.close(),this.messageChannel.port2.close(),this.handshakeEvent.end({extensionHandshakeTimedOut:!0,success:!1}),c(cm(b8)),this.handshakeResolvers.delete(a.responseId)},this.handshakeTimeoutMs)})}onWindowMessage(a){if(this.logger.trace(this.platformAuthType+" - onWindowMessage called"),a.source!==window)return;let b=a.data;if(b.channel&&b.channel===bu.PlatformAuthConstants.CHANNEL_ID&&(!b.extensionId||b.extensionId===this.extensionId)&&b.body.method===bu.NativeExtensionMethod.HandshakeRequest){let a=this.handshakeResolvers.get(b.responseId);if(!a)return void this.logger.trace(this.platformAuthType+`.onWindowMessage - resolver can't be found for request ${b.responseId}`);this.logger.verbose(b.extensionId?`Extension with id: ${b.extensionId} not installed`:"No extension installed"),clearTimeout(this.timeoutId),this.messageChannel.port1.close(),this.messageChannel.port2.close(),window.removeEventListener("message",this.windowListener,!1),this.handshakeEvent.end({success:!1,extensionInstalled:!1}),a.reject(cm(b9))}}onChannelMessage(a){this.logger.trace(this.platformAuthType+" - onChannelMessage called.");let b=a.data,c=this.resolvers.get(b.responseId),d=this.handshakeResolvers.get(b.responseId);try{let a=b.body.method;if(a===bu.NativeExtensionMethod.Response){if(!c)return;let a=b.body.response;if(this.logger.trace(this.platformAuthType+" - Received response from browser extension"),this.logger.tracePii(this.platformAuthType+` - Received response from browser extension: ${JSON.stringify(a)}`),"Success"!==a.status)c.reject(gi(a.code,a.description,a.ext));else if(a.result)a.result.code&&a.result.description?c.reject(gi(a.result.code,a.result.description,a.result.ext)):c.resolve(a.result);else throw(0,aj.createAuthError)(gx.unexpectedError,"Event does not contain result.");this.resolvers.delete(b.responseId)}else if(a===bu.NativeExtensionMethod.HandshakeResponse){if(!d)return void this.logger.trace(this.platformAuthType+`.onChannelMessage - resolver can't be found for request ${b.responseId}`);clearTimeout(this.timeoutId),window.removeEventListener("message",this.windowListener,!1),this.extensionId=b.extensionId,this.extensionVersion=b.body.version,this.logger.verbose(this.platformAuthType+` - Received HandshakeResponse from extension: ${this.extensionId}`),this.handshakeEvent.end({extensionInstalled:!0,success:!0}),d.resolve(),this.handshakeResolvers.delete(b.responseId)}}catch(b){this.logger.error("Error parsing response from WAM Extension"),this.logger.errorPii(`Error parsing response from WAM Extension: ${b}`),this.logger.errorPii(`Unable to parse ${a}`),c?c.reject(b):d&&d.reject(b)}}validatePlatformBrokerResponse(a){if(a.hasOwnProperty("access_token")&&a.hasOwnProperty("id_token")&&a.hasOwnProperty("client_info")&&a.hasOwnProperty("account")&&a.hasOwnProperty("scope")&&a.hasOwnProperty("expires_in"))return a;throw(0,aj.createAuthError)(gx.unexpectedError,"Response missing expected properties.")}getExtensionId(){return this.extensionId}getExtensionVersion(){return this.extensionVersion}getExtensionName(){return this.getExtensionId()===bu.PlatformAuthConstants.PREFERRED_EXTENSION_ID?"chrome":this.getExtensionId()?.length?"unknown":void 0}}var gx=gx;class gz{constructor(a,b,c){this.logger=a,this.performanceClient=b,this.correlationId=c,this.platformAuthType=bu.PlatformAuthConstants.PLATFORM_DOM_PROVIDER}static async createProvider(a,b,c){if(a.trace("PlatformAuthDOMHandler: createProvider called"),window.navigator?.platformAuthentication){let d=await window.navigator.platformAuthentication.getSupportedContracts(bu.PlatformAuthConstants.MICROSOFT_ENTRA_BROKERID);if(d?.includes(bu.PlatformAuthConstants.PLATFORM_DOM_APIS))return a.trace("Platform auth api available in DOM"),new gz(a,b,c)}}getExtensionId(){return bu.PlatformAuthConstants.MICROSOFT_ENTRA_BROKERID}getExtensionVersion(){return""}getExtensionName(){return bu.PlatformAuthConstants.DOM_API_NAME}async sendMessage(a){this.logger.trace(this.platformAuthType+" - Sending request to browser DOM API");try{let b=this.initializePlatformDOMRequest(a),c=await window.navigator.platformAuthentication.executeGetToken(b);return this.validatePlatformBrokerResponse(c)}catch(a){throw this.logger.error(this.platformAuthType+" - executeGetToken DOM API error"),a}}initializePlatformDOMRequest(a){this.logger.trace(this.platformAuthType+" - initializeNativeDOMRequest called");let{accountId:b,clientId:c,authority:d,scope:e,redirectUri:f,correlationId:g,state:h,storeInCache:i,embeddedClientId:j,extraParameters:k,...l}=a,m=this.getDOMExtraParams(l);return{accountId:b,brokerId:this.getExtensionId(),authority:d,clientId:c,correlationId:g||this.correlationId,extraParameters:{...k,...m},isSecurityTokenService:!1,redirectUri:f,scope:e,state:h,storeInCache:i,embeddedClientId:j}}validatePlatformBrokerResponse(a){if(a.hasOwnProperty("isSuccess")){if(a.hasOwnProperty("accessToken")&&a.hasOwnProperty("idToken")&&a.hasOwnProperty("clientInfo")&&a.hasOwnProperty("account")&&a.hasOwnProperty("scopes")&&a.hasOwnProperty("expiresIn"))return this.logger.trace(this.platformAuthType+" - platform broker returned successful and valid response"),this.convertToPlatformBrokerResponse(a);else if(a.hasOwnProperty("error")&&!1===a.isSuccess&&a.error&&a.error.code)throw this.logger.trace(this.platformAuthType+" - platform broker returned error response"),gi(a.error.code,a.error.description,{error:parseInt(a.error.errorCode),protocol_error:a.error.protocolError,status:a.error.status,properties:a.error.properties})}throw(0,aj.createAuthError)(gx.unexpectedError,"Response missing expected properties.")}convertToPlatformBrokerResponse(a){return this.logger.trace(this.platformAuthType+" - convertToNativeResponse called"),{access_token:a.accessToken,id_token:a.idToken,client_info:a.clientInfo,account:a.account,expires_in:a.expiresIn,scope:a.scopes,state:a.state||"",properties:a.properties||{},extendedLifetimeToken:a.extendedLifetimeToken??!1,shr:a.proofOfPossessionPayload}}getDOMExtraParams(a){return{...Object.entries(a).reduce((a,[b,c])=>(a[b]=String(c),a),{})}}}async function gA(a,b,c,d,e){let f;a.trace("getPlatformAuthProvider called",c),a.trace("Has client allowed platform auth via DOM API: "+e);try{e&&(f=await gz.createProvider(a,b,c)),f||(a.trace("Platform auth via DOM API not available, checking for extension"),f=await gy.createProvider(a,d||2e3,b))}catch(b){a.trace("Platform auth not available",b)}return f}function gB(a,b,c,d){if(b.trace("isPlatformAuthAllowed called"),!a.system.allowPlatformBroker&&a.system.allowPlatformBrokerWithDOM)throw aL(aM.invalidPlatformBrokerConfiguration);if(!a.system.allowPlatformBroker)return b.trace("isPlatformAuthAllowed: allowPlatformBroker is not enabled, returning false"),!1;if(!c)return b.trace("isPlatformAuthAllowed: Platform auth provider is not initialized, returning false"),!1;if(d)switch(d){case aR.AuthenticationScheme.BEARER:case aR.AuthenticationScheme.POP:b.trace("isPlatformAuthAllowed: authenticationScheme is supported, returning true");break;default:return b.trace("isPlatformAuthAllowed: authenticationScheme is not supported, returning false"),!1}return!0}class gC extends f3{constructor(a,b,c,d,e,f,g,h,i,j){super(a,b,c,d,e,f,g,i,j),this.unloadWindow=this.unloadWindow.bind(this),this.nativeStorage=h,this.eventHandler=e}acquireToken(a,b){let c;try{if(c={popupName:this.generatePopupName(a.scopes||aR.OIDC_DEFAULT_SCOPES,a.authority||this.config.auth.authority),popupWindowAttributes:a.popupWindowAttributes||{},popupWindowParent:a.popupWindowParent??window},this.performanceClient.addFields({isAsyncPopup:this.config.system.asyncPopups},this.correlationId),this.config.system.asyncPopups)return this.logger.verbose("asyncPopups set to true, acquiring token"),this.acquireTokenPopupAsync(a,c,b);{let d={...a,httpMethod:f2(a,this.config.auth.protocolMode)};return this.logger.verbose("asyncPopup set to false, opening popup before acquiring token"),c.popup=this.openSizedPopup("about:blank",c),this.acquireTokenPopupAsync(d,c,b)}}catch(a){return Promise.reject(a)}}logout(a){try{this.logger.verbose("logoutPopup called");let b=this.initializeLogoutRequest(a),c={popupName:this.generateLogoutPopupName(b),popupWindowAttributes:a?.popupWindowAttributes||{},popupWindowParent:a?.popupWindowParent??window},d=a&&a.authority,e=a&&a.mainWindowRedirectUri;if(this.config.system.asyncPopups)return this.logger.verbose("asyncPopups set to true"),this.logoutPopupAsync(b,c,d,e);return this.logger.verbose("asyncPopup set to false, opening popup"),c.popup=this.openSizedPopup("about:blank",c),this.logoutPopupAsync(b,c,d,e)}catch(a){return Promise.reject(a)}}async acquireTokenPopupAsync(a,b,c){this.logger.verbose("acquireTokenPopupAsync called");let d=await dr(this.initializeAuthorizationRequest.bind(this),D,this.logger,this.performanceClient,this.correlationId)(a,bu.InteractionType.Popup);return(b.popup&&fG(d.authority),d.platformBroker=gB(this.config,this.logger,this.platformAuthProvider,a.authenticationScheme),this.config.auth.protocolMode===ai.ProtocolMode.EAR)?this.executeEarFlow(d,b,c):this.executeCodeFlow(d,b,c)}async executeCodeFlow(a,b,c){let d=a.correlationId,e=this.initializeServerTelemetryManager(bu.ApiId.acquireTokenPopup),f=c||await dr(gu,aa,this.logger,this.performanceClient,d)(this.performanceClient,this.logger,d),g={...a,codeChallenge:f.challenge};try{let c=await dr(this.createAuthCodeClient.bind(this),B,this.logger,this.performanceClient,d)({serverTelemetryManager:e,requestAuthority:g.authority,requestAzureCloudOptions:g.azureCloudOptions,requestExtraQueryParameters:g.extraQueryParameters,account:g.account});if(g.httpMethod===aR.HttpMethod.POST)return await this.executeCodeFlowWithPost(g,b,c,f.verifier);{let e=await dr(gn,E,this.logger,this.performanceClient,d)(this.config,c.authority,g,this.logger,this.performanceClient),h=this.initiateAuthRequest(e,b);this.eventHandler.emitEvent(d7.EventType.POPUP_OPENED,bu.InteractionType.Popup,{popupWindow:h},null);let i=await this.monitorPopupForHash(h,b.popupWindowParent),j=dq(f5,Q,this.logger,this.performanceClient,this.correlationId)(i,this.config.auth.OIDCOptions.serverResponseType,this.logger);return await dr(gs,J,this.logger,this.performanceClient,d)(a,j,f.verifier,bu.ApiId.acquireTokenPopup,this.config,c,this.browserStorage,this.nativeStorage,this.eventHandler,this.logger,this.performanceClient,this.platformAuthProvider)}}catch(a){throw b.popup?.close(),a instanceof aj.AuthError&&(a.setCorrelationId(this.correlationId),e.cacheFailedRequest(a)),a}}async executeEarFlow(a,b,c){let d=a.correlationId,e=await dr(this.getDiscoveredAuthority.bind(this),i,this.logger,this.performanceClient,d)({requestAuthority:a.authority,requestAzureCloudOptions:a.azureCloudOptions,requestExtraQueryParameters:a.extraQueryParameters,account:a.account}),f=await dr(da,af,this.logger,this.performanceClient,d)(),g=c||await dr(gu,aa,this.logger,this.performanceClient,d)(this.performanceClient,this.logger,d),h={...a,earJwk:f,codeChallenge:g.challenge},j=b.popup||this.openPopup("about:blank",b);(await go(j.document,this.config,e,h,this.logger,this.performanceClient)).submit();let k=await dr(this.monitorPopupForHash.bind(this),z,this.logger,this.performanceClient,d)(j,b.popupWindowParent),l=dq(f5,Q,this.logger,this.performanceClient,this.correlationId)(k,this.config.auth.OIDCOptions.serverResponseType,this.logger);if(l.ear_jwe||!l.code)return dr(gt,H,this.logger,this.performanceClient,d)(h,l,bu.ApiId.acquireTokenPopup,this.config,e,this.browserStorage,this.nativeStorage,this.eventHandler,this.logger,this.performanceClient,this.platformAuthProvider);{let b=await dr(this.createAuthCodeClient.bind(this),B,this.logger,this.performanceClient,d)({serverTelemetryManager:this.initializeServerTelemetryManager(bu.ApiId.acquireTokenPopup),requestAuthority:a.authority,requestAzureCloudOptions:a.azureCloudOptions,requestExtraQueryParameters:a.extraQueryParameters,account:a.account,authority:e});return dr(gs,J,this.logger,this.performanceClient,d)(h,l,g.verifier,bu.ApiId.acquireTokenPopup,this.config,b,this.browserStorage,this.nativeStorage,this.eventHandler,this.logger,this.performanceClient,this.platformAuthProvider)}}async executeCodeFlowWithPost(a,b,c,d){let e=a.correlationId,f=await dr(this.getDiscoveredAuthority.bind(this),i,this.logger,this.performanceClient,e)({requestAuthority:a.authority,requestAzureCloudOptions:a.azureCloudOptions,requestExtraQueryParameters:a.extraQueryParameters,account:a.account}),g=b.popup||this.openPopup("about:blank",b);(await gp(g.document,this.config,f,a,this.logger,this.performanceClient)).submit();let h=await dr(this.monitorPopupForHash.bind(this),z,this.logger,this.performanceClient,e)(g,b.popupWindowParent),j=dq(f5,Q,this.logger,this.performanceClient,this.correlationId)(h,this.config.auth.OIDCOptions.serverResponseType,this.logger);return dr(gs,J,this.logger,this.performanceClient,e)(a,j,d,bu.ApiId.acquireTokenPopup,this.config,c,this.browserStorage,this.nativeStorage,this.eventHandler,this.logger,this.performanceClient,this.platformAuthProvider)}async logoutPopupAsync(a,b,c,d){this.logger.verbose("logoutPopupAsync called"),this.eventHandler.emitEvent(d7.EventType.LOGOUT_START,bu.InteractionType.Popup,a);let e=this.initializeServerTelemetryManager(bu.ApiId.logoutPopup);try{await this.clearCacheOnLogout(this.correlationId,a.account);let f=await dr(this.createAuthCodeClient.bind(this),B,this.logger,this.performanceClient,this.correlationId)({serverTelemetryManager:e,requestAuthority:c,account:a.account||void 0});try{f.authority.endSessionEndpoint}catch{if(a.account?.homeAccountId&&a.postLogoutRedirectUri&&f.authority.protocolMode===ai.ProtocolMode.OIDC){if(this.eventHandler.emitEvent(d7.EventType.LOGOUT_SUCCESS,bu.InteractionType.Popup,a),d){let a={apiId:bu.ApiId.logoutPopup,timeout:this.config.system.redirectNavigationTimeout,noHistory:!1},b=a6.getAbsoluteUrl(d,"");await this.navigationClient.navigateInternal(b,a)}b.popup?.close();return}}let g=f.getLogoutUri(a);this.eventHandler.emitEvent(d7.EventType.LOGOUT_SUCCESS,bu.InteractionType.Popup,a);let h=this.openPopup(g,b);if(this.eventHandler.emitEvent(d7.EventType.POPUP_OPENED,bu.InteractionType.Popup,{popupWindow:h},null),await this.monitorPopupForHash(h,b.popupWindowParent).catch(()=>{}),d){let a={apiId:bu.ApiId.logoutPopup,timeout:this.config.system.redirectNavigationTimeout,noHistory:!1},b=a6.getAbsoluteUrl(d,"");this.logger.verbose("Redirecting main window to url specified in the request"),this.logger.verbosePii(`Redirecting main window to: ${b}`),await this.navigationClient.navigateInternal(b,a)}else this.logger.verbose("No main window navigation requested")}catch(a){throw b.popup?.close(),a instanceof aj.AuthError&&(a.setCorrelationId(this.correlationId),e.cacheFailedRequest(a)),this.eventHandler.emitEvent(d7.EventType.LOGOUT_FAILURE,bu.InteractionType.Popup,null,a),this.eventHandler.emitEvent(d7.EventType.LOGOUT_END,bu.InteractionType.Popup),a}this.eventHandler.emitEvent(d7.EventType.LOGOUT_END,bu.InteractionType.Popup)}initiateAuthRequest(a,b){if(a)return this.logger.infoPii(`Navigate to: ${a}`),this.openPopup(a,b);throw this.logger.error("Navigate url is empty"),cm(bA)}monitorPopupForHash(a,b){return new Promise((b,c)=>{this.logger.verbose("PopupHandler.monitorPopupForHash - polling started");let d=setInterval(()=>{if(a.closed){this.logger.error("PopupHandler.monitorPopupForHash - window closed"),clearInterval(d),c(cm(bJ));return}let e="";try{e=a.location.href}catch(a){}if(!e||"about:blank"===e)return;clearInterval(d);let f="",g=this.config.auth.OIDCOptions.serverResponseType;a&&(f=g===aR.ServerResponseType.QUERY?a.location.search:a.location.hash),this.logger.verbose("PopupHandler.monitorPopupForHash - popup window is on same origin as caller"),b(f)},this.config.system.pollIntervalMilliseconds)}).finally(()=>{this.cleanPopup(a,b)})}openPopup(a,b){try{let c;if(b.popup?(c=b.popup,this.logger.verbosePii(`Navigating popup window to: ${a}`),c.location.assign(a)):void 0===b.popup&&(this.logger.verbosePii(`Opening popup window to: ${a}`),c=this.openSizedPopup(a,b)),!c)throw cm(bI);return c.focus&&c.focus(),this.currentWindow=c,b.popupWindowParent.addEventListener("beforeunload",this.unloadWindow),c}catch(a){throw this.logger.error("error opening popup "+a.message),cm(bH)}}openSizedPopup(a,{popupName:b,popupWindowAttributes:c,popupWindowParent:d}){let e=d.screenLeft?d.screenLeft:d.screenX,f=d.screenTop?d.screenTop:d.screenY,g=d.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,h=d.innerHeight||document.documentElement.clientHeight||document.body.clientHeight,i=c.popupSize?.width,j=c.popupSize?.height,k=c.popupPosition?.top,l=c.popupPosition?.left;return(!i||i<0||i>g)&&(this.logger.verbose("Default popup window width used. Window width not configured or invalid."),i=bu.BrowserConstants.POPUP_WIDTH),(!j||j<0||j>h)&&(this.logger.verbose("Default popup window height used. Window height not configured or invalid."),j=bu.BrowserConstants.POPUP_HEIGHT),(!k||k<0||k>h)&&(this.logger.verbose("Default popup window top position used. Window top not configured or invalid."),k=Math.max(0,h/2-bu.BrowserConstants.POPUP_HEIGHT/2+f)),(!l||l<0||l>g)&&(this.logger.verbose("Default popup window left position used. Window left not configured or invalid."),l=Math.max(0,g/2-bu.BrowserConstants.POPUP_WIDTH/2+e)),d.open(a,b,`width=${i}, height=${j}, top=${k}, left=${l}, scrollbars=yes`)}unloadWindow(a){this.currentWindow&&this.currentWindow.close(),a.preventDefault()}cleanPopup(a,b){a.close(),b.removeEventListener("beforeunload",this.unloadWindow)}generatePopupName(a,b){return`${bu.BrowserConstants.POPUP_NAME_PREFIX}.${this.config.auth.clientId}.${a.join("-")}.${b}.${this.correlationId}`}generateLogoutPopupName(a){let b=a.account&&a.account.homeAccountId;return`${bu.BrowserConstants.POPUP_NAME_PREFIX}.${this.config.auth.clientId}.${b}.${this.correlationId}`}}var f4=f4;class gD extends f3{constructor(a,b,c,d,e,f,g,h,i,j){super(a,b,c,d,e,f,g,i,j),this.nativeStorage=h}async acquireToken(a){let b=await dr(this.initializeAuthorizationRequest.bind(this),D,this.logger,this.performanceClient,this.correlationId)(a,bu.InteractionType.Redirect);b.platformBroker=gB(this.config,this.logger,this.platformAuthProvider,a.authenticationScheme);let c=a=>{a.persisted&&(this.logger.verbose("Page was restored from back/forward cache. Clearing temporary cache."),this.browserStorage.resetRequestCache(),this.eventHandler.emitEvent(d7.EventType.RESTORE_FROM_BFCACHE,bu.InteractionType.Redirect))},d=this.getRedirectStartPage(a.redirectStartPage);this.logger.verbosePii(`Redirect start page: ${d}`),this.browserStorage.setTemporaryCache(bu.TemporaryCacheKeys.ORIGIN_URI,d,!0),window.addEventListener("pageshow",c);try{this.config.auth.protocolMode===ai.ProtocolMode.EAR?await this.executeEarFlow(b):await this.executeCodeFlow(b,a.onRedirectNavigate)}catch(a){throw a instanceof aj.AuthError&&a.setCorrelationId(this.correlationId),window.removeEventListener("pageshow",c),a}}async executeCodeFlow(a,b){let c=a.correlationId,d=this.initializeServerTelemetryManager(bu.ApiId.acquireTokenRedirect),e=await dr(gu,aa,this.logger,this.performanceClient,c)(this.performanceClient,this.logger,c),f={...a,codeChallenge:e.challenge};this.browserStorage.cacheAuthorizeRequest(f,e.verifier);try{if(f.httpMethod===aR.HttpMethod.POST)return await this.executeCodeFlowWithPost(f);{let c=await dr(this.createAuthCodeClient.bind(this),B,this.logger,this.performanceClient,this.correlationId)({serverTelemetryManager:d,requestAuthority:f.authority,requestAzureCloudOptions:f.azureCloudOptions,requestExtraQueryParameters:f.extraQueryParameters,account:f.account}),e=await dr(gn,E,this.logger,this.performanceClient,a.correlationId)(this.config,c.authority,f,this.logger,this.performanceClient);return await this.initiateAuthRequest(e,b)}}catch(a){throw a instanceof aj.AuthError&&(a.setCorrelationId(this.correlationId),d.cacheFailedRequest(a)),a}}async executeEarFlow(a){let b=a.correlationId,c=await dr(this.getDiscoveredAuthority.bind(this),i,this.logger,this.performanceClient,b)({requestAuthority:a.authority,requestAzureCloudOptions:a.azureCloudOptions,requestExtraQueryParameters:a.extraQueryParameters,account:a.account}),d=await dr(da,af,this.logger,this.performanceClient,b)(),e=await dr(gu,aa,this.logger,this.performanceClient,b)(this.performanceClient,this.logger,b),f={...a,earJwk:d,codeChallenge:e.challenge};return this.browserStorage.cacheAuthorizeRequest(f,e.verifier),(await go(document,this.config,c,f,this.logger,this.performanceClient)).submit(),new Promise((a,b)=>{setTimeout(()=>{b(cm(ci,"failed_to_redirect"))},this.config.system.redirectNavigationTimeout)})}async executeCodeFlowWithPost(a){let b=a.correlationId,c=await dr(this.getDiscoveredAuthority.bind(this),i,this.logger,this.performanceClient,b)({requestAuthority:a.authority,requestAzureCloudOptions:a.azureCloudOptions,requestExtraQueryParameters:a.extraQueryParameters,account:a.account});return this.browserStorage.cacheAuthorizeRequest(a),(await gp(document,this.config,c,a,this.logger,this.performanceClient)).submit(),new Promise((a,b)=>{setTimeout(()=>{b(cm(ci,"failed_to_redirect"))},this.config.system.redirectNavigationTimeout)})}async handleRedirectPromise(a="",b,c,d){let e=this.initializeServerTelemetryManager(bu.ApiId.handleRedirectPromise);try{let[f,g]=this.getRedirectResponse(a||"");if(!f)return this.logger.info("handleRedirectPromise did not detect a response as a result of a redirect. Cleaning temporary cache."),this.browserStorage.resetRequestCache(),d.event.errorCode="no_server_response",null;let h=this.browserStorage.getTemporaryCache(bu.TemporaryCacheKeys.ORIGIN_URI,!0)||aR.Constants.EMPTY_STRING,i=f4.normalizeUrlForComparison(h),j=f4.normalizeUrlForComparison(window.location.href);if(i===j&&this.config.auth.navigateToLoginRequestUrl){let a;return this.logger.verbose("Current page is loginRequestUrl, handling response"),h.indexOf("#")>-1&&((a=h.split("#")).shift(),window.location.hash=a.length>0?a.join("#"):""),await this.handleResponse(f,b,c,e)}if(!this.config.auth.navigateToLoginRequestUrl)return this.logger.verbose("NavigateToLoginRequestUrl set to false, handling response"),await this.handleResponse(f,b,c,e);if(!fB()||this.config.system.allowRedirectInIframe){this.browserStorage.setTemporaryCache(bu.TemporaryCacheKeys.URL_HASH,g,!0);let a={apiId:bu.ApiId.handleRedirectPromise,timeout:this.config.system.redirectNavigationTimeout,noHistory:!0},d=!0;if(h&&"null"!==h)this.logger.verbose(`Navigating to loginRequestUrl: ${h}`),d=await this.navigationClient.navigateInternal(h,a);else{let b,c=(b=new a6(window.location.href).getUrlComponents(),`${b.Protocol}//${b.HostNameAndPort}/`);this.browserStorage.setTemporaryCache(bu.TemporaryCacheKeys.ORIGIN_URI,c,!0),this.logger.warning("Unable to get valid login request url from cache, redirecting to home page"),d=await this.navigationClient.navigateInternal(c,a)}if(!d)return await this.handleResponse(f,b,c,e)}return null}catch(a){throw a instanceof aj.AuthError&&(a.setCorrelationId(this.correlationId),e.cacheFailedRequest(a)),a}}getRedirectResponse(a){this.logger.verbose("getRedirectResponseHash called");let b=a;b||(b=this.config.auth.OIDCOptions.serverResponseType===aR.ServerResponseType.QUERY?window.location.search:window.location.hash);let c=f4.getDeserializedResponse(b);if(c){try{!function(a,b,c){if(!a.state)throw cm(bC);let d=function(a,b){if(!b)return null;try{return fS.parseRequestState(a,b).libraryState.meta}catch(a){throw(0,aN.createClientAuthError)(cH.invalidState)}}(b,a.state);if(!d)throw cm(bE);if(d.interactionType!==c)throw cm(bF)}(c,this.browserCrypto,bu.InteractionType.Redirect)}catch(a){return a instanceof aj.AuthError&&this.logger.error(`Interaction type validation failed due to ${a.errorCode}: ${a.errorMessage}`),[null,""]}return fA(window),this.logger.verbose("Hash contains known properties, returning response hash"),[c,b]}let d=this.browserStorage.getTemporaryCache(bu.TemporaryCacheKeys.URL_HASH,!0);return(this.browserStorage.removeItem(this.browserStorage.generateCacheKey(bu.TemporaryCacheKeys.URL_HASH)),d&&(c=f4.getDeserializedResponse(d)))?(this.logger.verbose("Hash does not contain known properties, returning cached hash"),[c,d]):[null,""]}async handleResponse(a,b,c,d){if(!a.state)throw cm(bC);if(a.ear_jwe){let c=await dr(this.getDiscoveredAuthority.bind(this),i,this.logger,this.performanceClient,b.correlationId)({requestAuthority:b.authority,requestAzureCloudOptions:b.azureCloudOptions,requestExtraQueryParameters:b.extraQueryParameters,account:b.account});return dr(gt,H,this.logger,this.performanceClient,b.correlationId)(b,a,bu.ApiId.acquireTokenRedirect,this.config,c,this.browserStorage,this.nativeStorage,this.eventHandler,this.logger,this.performanceClient,this.platformAuthProvider)}let e=await dr(this.createAuthCodeClient.bind(this),B,this.logger,this.performanceClient,this.correlationId)({serverTelemetryManager:d,requestAuthority:b.authority});return dr(gs,J,this.logger,this.performanceClient,b.correlationId)(b,a,c,bu.ApiId.acquireTokenRedirect,this.config,e,this.browserStorage,this.nativeStorage,this.eventHandler,this.logger,this.performanceClient,this.platformAuthProvider)}async initiateAuthRequest(a,b){if(this.logger.verbose("RedirectHandler.initiateAuthRequest called"),a){this.logger.infoPii(`RedirectHandler.initiateAuthRequest: Navigate to: ${a}`);let c={apiId:bu.ApiId.acquireTokenRedirect,timeout:this.config.system.redirectNavigationTimeout,noHistory:!1},d=b||this.config.auth.onRedirectNavigate;if("function"==typeof d)return(this.logger.verbose("RedirectHandler.initiateAuthRequest: Invoking onRedirectNavigate callback"),!1===d(a))?void this.logger.verbose("RedirectHandler.initiateAuthRequest: onRedirectNavigate returned false, stopping navigation"):(this.logger.verbose("RedirectHandler.initiateAuthRequest: onRedirectNavigate did not return false, navigating"),await this.navigationClient.navigateExternal(a,c),void 0);return this.logger.verbose("RedirectHandler.initiateAuthRequest: Navigating window to navigate url"),await this.navigationClient.navigateExternal(a,c),void 0}throw this.logger.info("RedirectHandler.initiateAuthRequest: Navigate url is empty"),cm(bA)}async logout(a){this.logger.verbose("logoutRedirect called");let b=this.initializeLogoutRequest(a),c=this.initializeServerTelemetryManager(bu.ApiId.logout);try{this.eventHandler.emitEvent(d7.EventType.LOGOUT_START,bu.InteractionType.Redirect,a),await this.clearCacheOnLogout(this.correlationId,b.account);let d={apiId:bu.ApiId.logout,timeout:this.config.system.redirectNavigationTimeout,noHistory:!1},e=await dr(this.createAuthCodeClient.bind(this),B,this.logger,this.performanceClient,this.correlationId)({serverTelemetryManager:c,requestAuthority:a&&a.authority,requestExtraQueryParameters:a?.extraQueryParameters,account:a&&a.account||void 0});if(e.authority.protocolMode===ai.ProtocolMode.OIDC)try{e.authority.endSessionEndpoint}catch{if(b.account?.homeAccountId)return void this.eventHandler.emitEvent(d7.EventType.LOGOUT_SUCCESS,bu.InteractionType.Redirect,b)}let f=e.getLogoutUri(b);if(this.eventHandler.emitEvent(d7.EventType.LOGOUT_SUCCESS,bu.InteractionType.Redirect,b),a&&"function"==typeof a.onRedirectNavigate){let b=a.onRedirectNavigate(f);if(!1!==b){this.logger.verbose("Logout onRedirectNavigate did not return false, navigating"),this.browserStorage.getInteractionInProgress()||this.browserStorage.setInteractionInProgress(!0,bu.INTERACTION_TYPE.SIGNOUT),await this.navigationClient.navigateExternal(f,d);return}this.browserStorage.setInteractionInProgress(!1),this.logger.verbose("Logout onRedirectNavigate returned false, stopping navigation")}else{this.browserStorage.getInteractionInProgress()||this.browserStorage.setInteractionInProgress(!0,bu.INTERACTION_TYPE.SIGNOUT),await this.navigationClient.navigateExternal(f,d);return}}catch(a){throw a instanceof aj.AuthError&&(a.setCorrelationId(this.correlationId),c.cacheFailedRequest(a)),this.eventHandler.emitEvent(d7.EventType.LOGOUT_FAILURE,bu.InteractionType.Redirect,null,a),this.eventHandler.emitEvent(d7.EventType.LOGOUT_END,bu.InteractionType.Redirect),a}this.eventHandler.emitEvent(d7.EventType.LOGOUT_END,bu.InteractionType.Redirect)}getRedirectStartPage(a){let b=a||window.location.href;return a6.getAbsoluteUrl(b,"")}}async function gE(a,b,c,d,e){if(b.addQueueMeasurement(y,d),!a)throw c.info("Navigate url is empty"),cm(bA);return e?dr(gI,A,c,b,d)(a,e,b,d):dq(gJ,"silentHandlerLoadFrameSync",c,b,d)(a)}async function gF(a,b,c,d,e){let f=gK();if(!f.contentDocument)throw"No document associated with iframe!";return(await gp(f.contentDocument,a,b,c,d,e)).submit(),f}async function gG(a,b,c,d,e){let f=gK();if(!f.contentDocument)throw"No document associated with iframe!";return(await go(f.contentDocument,a,b,c,d,e)).submit(),f}async function gH(a,b,c,d,e,f,g){return d.addQueueMeasurement(z,f),new Promise((d,f)=>{b<1e4&&e.warning(`system.loadFrameTimeout or system.iframeHashTimeout set to lower (${b}ms) than the default (10000ms). This may result in timeouts.`);let h=window.setTimeout(()=>{window.clearInterval(i),f(cm(bL))},b),i=window.setInterval(()=>{let b="",c=a.contentWindow;try{b=c?c.location.href:""}catch(a){}if(!b||"about:blank"===b)return;let e="";c&&(e=g===aR.ServerResponseType.QUERY?c.location.search:c.location.hash),window.clearTimeout(h),window.clearInterval(i),d(e)},c)}).finally(()=>{dq(gL,"removeHiddenIframe",e,d,f)(a)})}function gI(a,b,c,d){return c.addQueueMeasurement(A,d),new Promise((c,d)=>{let e=gK();window.setTimeout(()=>{e?(e.src=a,c(e)):d("Unable to load iframe")},b)})}function gJ(a){let b=gK();return b.src=a,b}function gK(){let a=document.createElement("iframe");return a.className="msalSilentIframe",a.style.visibility="hidden",a.style.position="absolute",a.style.width=a.style.height="0",a.style.border="0",a.setAttribute("sandbox","allow-scripts allow-same-origin allow-forms"),a.setAttribute("allow","local-network-access *"),document.body.appendChild(a),a}function gL(a){document.body===a.parentNode&&document.body.removeChild(a)}class gM extends f3{constructor(a,b,c,d,e,f,g,h,i,j,k){super(a,b,c,d,e,f,h,j,k),this.apiId=g,this.nativeStorage=i}async acquireToken(a){this.performanceClient.addQueueMeasurement(g,a.correlationId),a.loginHint||a.sid||a.account&&a.account.username||this.logger.warning("No user hint provided. The authorization server may need more information to complete this request.");let b={...a};b.prompt?b.prompt!==aR.PromptValue.NONE&&b.prompt!==aR.PromptValue.NO_SESSION&&(this.logger.warning(`SilentIframeClient. Replacing invalid prompt ${b.prompt} with ${aR.PromptValue.NONE}`),b.prompt=aR.PromptValue.NONE):b.prompt=aR.PromptValue.NONE;let c=await dr(this.initializeAuthorizationRequest.bind(this),D,this.logger,this.performanceClient,a.correlationId)(b,bu.InteractionType.Silent);return(c.platformBroker=gB(this.config,this.logger,this.platformAuthProvider,c.authenticationScheme),fG(c.authority),this.config.auth.protocolMode===ai.ProtocolMode.EAR)?this.executeEarFlow(c):this.executeCodeFlow(c)}async executeCodeFlow(a){let b,c=this.initializeServerTelemetryManager(this.apiId);try{return b=await dr(this.createAuthCodeClient.bind(this),B,this.logger,this.performanceClient,a.correlationId)({serverTelemetryManager:c,requestAuthority:a.authority,requestAzureCloudOptions:a.azureCloudOptions,requestExtraQueryParameters:a.extraQueryParameters,account:a.account}),await dr(this.silentTokenHelper.bind(this),x,this.logger,this.performanceClient,a.correlationId)(b,a)}catch(d){if(d instanceof aj.AuthError&&(d.setCorrelationId(this.correlationId),c.cacheFailedRequest(d)),!b||!(d instanceof aj.AuthError)||d.errorCode!==bu.BrowserConstants.INVALID_GRANT_ERROR)throw d;return this.performanceClient.addFields({retryError:d.errorCode},this.correlationId),await dr(this.silentTokenHelper.bind(this),x,this.logger,this.performanceClient,this.correlationId)(b,a)}}async executeEarFlow(a){let b=a.correlationId,c=await dr(this.getDiscoveredAuthority.bind(this),i,this.logger,this.performanceClient,b)({requestAuthority:a.authority,requestAzureCloudOptions:a.azureCloudOptions,requestExtraQueryParameters:a.extraQueryParameters,account:a.account}),d=await dr(da,af,this.logger,this.performanceClient,b)(),e=await dr(gu,aa,this.logger,this.performanceClient,b)(this.performanceClient,this.logger,b),f={...a,earJwk:d,codeChallenge:e.challenge},g=await dr(gG,y,this.logger,this.performanceClient,b)(this.config,c,f,this.logger,this.performanceClient),h=this.config.auth.OIDCOptions.serverResponseType,j=await dr(gH,z,this.logger,this.performanceClient,b)(g,this.config.system.iframeHashTimeout,this.config.system.pollIntervalMilliseconds,this.performanceClient,this.logger,b,h),k=dq(f5,Q,this.logger,this.performanceClient,b)(j,h,this.logger);if(k.ear_jwe||!k.code)return dr(gt,H,this.logger,this.performanceClient,b)(f,k,this.apiId,this.config,c,this.browserStorage,this.nativeStorage,this.eventHandler,this.logger,this.performanceClient,this.platformAuthProvider);{let d=await dr(this.createAuthCodeClient.bind(this),B,this.logger,this.performanceClient,b)({serverTelemetryManager:this.initializeServerTelemetryManager(this.apiId),requestAuthority:a.authority,requestAzureCloudOptions:a.azureCloudOptions,requestExtraQueryParameters:a.extraQueryParameters,account:a.account,authority:c});return dr(gs,J,this.logger,this.performanceClient,b)(f,k,e.verifier,this.apiId,this.config,d,this.browserStorage,this.nativeStorage,this.eventHandler,this.logger,this.performanceClient,this.platformAuthProvider)}}logout(){return Promise.reject(cm(bQ))}async silentTokenHelper(a,b){let c,d=b.correlationId;this.performanceClient.addQueueMeasurement(x,d);let e=await dr(gu,aa,this.logger,this.performanceClient,d)(this.performanceClient,this.logger,d),f={...b,codeChallenge:e.challenge};if(b.httpMethod===aR.HttpMethod.POST)c=await dr(gF,y,this.logger,this.performanceClient,d)(this.config,a.authority,f,this.logger,this.performanceClient);else{let b=await dr(gn,E,this.logger,this.performanceClient,d)(this.config,a.authority,f,this.logger,this.performanceClient);c=await dr(gE,y,this.logger,this.performanceClient,d)(b,this.performanceClient,this.logger,d,this.config.system.navigateFrameWait)}let g=this.config.auth.OIDCOptions.serverResponseType,h=await dr(gH,z,this.logger,this.performanceClient,d)(c,this.config.system.iframeHashTimeout,this.config.system.pollIntervalMilliseconds,this.performanceClient,this.logger,d,g),i=dq(f5,Q,this.logger,this.performanceClient,d)(h,g,this.logger);return dr(gs,J,this.logger,this.performanceClient,d)(b,i,e.verifier,this.apiId,this.config,a,this.browserStorage,this.nativeStorage,this.eventHandler,this.logger,this.performanceClient,this.platformAuthProvider)}}var gN=dV;class gO extends fR{constructor(a,b){super(a,b)}async acquireToken(a){this.performanceClient?.addQueueMeasurement(n,a.correlationId);let b=dt(),c=await dr(this.executeTokenRequest.bind(this),m,this.logger,this.performanceClient,a.correlationId)(a,this.authority),d=c.headers?.[aR.HeaderNames.X_MS_REQUEST_ID],e=new fV(this.config.authOptions.clientId,this.cacheManager,this.cryptoUtils,this.logger,this.config.serializableCache,this.config.persistencePlugin);return e.validateTokenResponse(c.body),dr(e.handleServerTokenResponse.bind(e),P,this.logger,this.performanceClient,a.correlationId)(c.body,this.authority,b,a,void 0,void 0,!0,a.forceCache,d)}async acquireTokenByRefreshToken(a){if(!a)throw aL(ar);if(this.performanceClient?.addQueueMeasurement(p,a.correlationId),!a.account)throw(0,aN.createClientAuthError)(aO.noAccountInSilentRequest);if(this.cacheManager.isAppMetadataFOCI(a.account.environment))try{return await dr(this.acquireTokenWithCachedRefreshToken.bind(this),o,this.logger,this.performanceClient,a.correlationId)(a,!0)}catch(c){let a=c instanceof dS.InteractionRequiredAuthError&&c.errorCode===gN.noTokensFound,b=c instanceof fP&&c.errorCode===aR.Errors.INVALID_GRANT_ERROR&&c.subError===aR.Errors.CLIENT_MISMATCH_ERROR;if(a||b);else throw c}return dr(this.acquireTokenWithCachedRefreshToken.bind(this),o,this.logger,this.performanceClient,a.correlationId)(a,!1)}async acquireTokenWithCachedRefreshToken(a,b){this.performanceClient?.addQueueMeasurement(o,a.correlationId);let c=dq(this.cacheManager.getRefreshToken.bind(this.cacheManager),"cacheManagerGetRefreshToken",this.logger,this.performanceClient,a.correlationId)(a.account,b,a.correlationId,void 0,this.performanceClient);if(!c)throw(0,dS.createInteractionRequiredAuthError)(gN.noTokensFound);if(c.expiresOn&&dw(c.expiresOn,a.refreshTokenExpirationOffsetSeconds||300))throw this.performanceClient?.addFields({rtExpiresOnMs:Number(c.expiresOn)},a.correlationId),(0,dS.createInteractionRequiredAuthError)(gN.refreshTokenExpired);let d={...a,refreshToken:c.secret,authenticationScheme:a.authenticationScheme||aR.AuthenticationScheme.BEARER,ccsCredential:{credential:a.account.homeAccountId,type:fL}};try{return await dr(this.acquireToken.bind(this),n,this.logger,this.performanceClient,a.correlationId)(d)}catch(b){if(b instanceof dS.InteractionRequiredAuthError&&(this.performanceClient?.addFields({rtExpiresOnMs:Number(c.expiresOn)},a.correlationId),b.subError===gN.badToken)){this.logger.verbose("acquireTokenWithRefreshToken: bad refresh token, removing from cache");let b=this.cacheManager.generateCredentialKey(c);this.cacheManager.removeRefreshToken(b,a.correlationId)}throw b}}async executeTokenRequest(a,b){this.performanceClient?.addQueueMeasurement(m,a.correlationId);let c=this.createTokenQueryParameters(a),d=a6.appendQueryString(b.tokenEndpoint,c),e=await dr(this.createTokenRequestBody.bind(this),q,this.logger,this.performanceClient,a.correlationId)(a),f=this.createTokenRequestHeaders(a.ccsCredential),g=dU(this.config.authOptions.clientId,a);return dr(this.executePostToTokenEndpoint.bind(this),k,this.logger,this.performanceClient,a.correlationId)(d,e,f,g,a.correlationId,k)}async createTokenRequestBody(a){this.performanceClient?.addQueueMeasurement(q,a.correlationId);let b=new Map;if(eW(b,a.embeddedClientId||a.tokenBodyParameters?.[d8]||this.config.authOptions.clientId),a.redirectUri&&eX(b,a.redirectUri),eV(b,a.scopes,!0,this.config.authOptions.authority.options.OIDCOptions?.defaultScopes),fk(b,aR.GrantType.REFRESH_TOKEN_GRANT),fl(b),e5(b,this.config.libraryInfo),e6(b,this.config.telemetry.application),fu(b),this.serverTelemetryManager&&!bt(this.config)&&ft(b,this.serverTelemetryManager),fd(b,a.refreshToken),this.config.clientCredentials.clientSecret&&ff(b,this.config.clientCredentials.clientSecret),this.config.clientCredentials.clientAssertion){let c=this.config.clientCredentials.clientAssertion;fg(b,await fX(c.assertion,this.config.authOptions.clientId,a.resourceRequestUri)),fh(b,c.assertionType)}if(a.authenticationScheme===aR.AuthenticationScheme.POP){let c=new fT(this.cryptoUtils,this.performanceClient);fr(b,a.popKid?this.cryptoUtils.encodeKid(a.popKid):(await dr(c.generateCnf.bind(c),O,this.logger,this.performanceClient,a.correlationId)(a,this.logger)).reqCnfString)}else if(a.authenticationScheme===aR.AuthenticationScheme.SSH)if(a.sshJwk)fs(b,a.sshJwk);else throw aL(ay);if((!aV.isEmptyObj(a.claims)||this.config.authOptions.clientCapabilities&&this.config.authOptions.clientCapabilities.length>0)&&e3(b,a.claims,this.config.authOptions.clientCapabilities),this.config.systemOptions.preventCorsPreflight&&a.ccsCredential)switch(a.ccsCredential.type){case fL:try{let c=(0,fM.buildClientInfoFromHomeAccountId)(a.ccsCredential.credential);e1(b,c)}catch(a){this.logger.verbose("Could not parse home account ID for CCS Header: "+a)}break;case"UPN":e0(b,a.ccsCredential.credential)}return a.embeddedClientId&&fw(b,this.config.authOptions.clientId,this.config.authOptions.redirectUri),a.tokenBodyParameters&&fn(b,a.tokenBodyParameters),eR(b,a.correlationId,this.performanceClient),a4(b)}}class gP extends f3{async acquireToken(a){this.performanceClient.addQueueMeasurement(h,a.correlationId);let b=await dr(f0,v,this.logger,this.performanceClient,a.correlationId)(a,this.config,this.performanceClient,this.logger),c={...a,...b};a.redirectUri&&(c.redirectUri=this.getRedirectUri(a.redirectUri));let d=this.initializeServerTelemetryManager(bu.ApiId.acquireTokenSilent_silentFlow),e=await this.createRefreshTokenClient({serverTelemetryManager:d,authorityUrl:c.authority,azureCloudOptions:c.azureCloudOptions,account:c.account});return dr(e.acquireTokenByRefreshToken.bind(e),p,this.logger,this.performanceClient,a.correlationId)(c).catch(a=>{throw a.setCorrelationId(this.correlationId),d.cacheFailedRequest(a),a})}logout(){return Promise.reject(cm(bQ))}async createRefreshTokenClient(a){return new gO(await dr(this.getClientConfiguration.bind(this),C,this.logger,this.performanceClient,this.correlationId)({serverTelemetryManager:a.serverTelemetryManager,requestAuthority:a.authorityUrl,requestAzureCloudOptions:a.azureCloudOptions,requestExtraQueryParameters:a.extraQueryParameters,account:a.account}),this.performanceClient)}}var dT=dT,dX=dX,dW=dW;class gQ{constructor(a,b,c,d){this.isBrowserEnvironment=!1,this.config=a,this.storage=b,this.logger=c,this.cryptoObj=d}async loadExternalTokens(a,b,c){if(!this.isBrowserEnvironment)throw cm(bX);let d=a.correlationId||c5(),e=b.id_token?dT.extractTokenClaims(b.id_token,cT):void 0,f=dT.isKmsi(e||{}),g={protocolMode:this.config.auth.protocolMode,knownAuthorities:this.config.auth.knownAuthorities,cloudDiscoveryMetadata:this.config.auth.cloudDiscoveryMetadata,authorityMetadata:this.config.auth.authorityMetadata,skipAuthorityMetadataCache:this.config.auth.skipAuthorityMetadataCache},h=a.authority?new dQ(dQ.generateAuthority(a.authority,a.azureCloudOptions),this.config.system.networkClient,this.storage,g,this.logger,a.correlationId||c5()):void 0,i=await this.loadAccount(a,c.clientInfo||b.client_info||"",d,e,h),j=await this.loadIdToken(b,i.homeAccountId,i.environment,i.realm,d,f),k=await this.loadAccessToken(a,b,i.homeAccountId,i.environment,i.realm,c,d,f),l=await this.loadRefreshToken(b,i.homeAccountId,i.environment,d,f);return this.generateAuthenticationResult(a,{account:i,idToken:j,accessToken:k,refreshToken:l},e,h)}async loadAccount(a,b,c,d,e){if(this.logger.verbose("TokenCache - loading account"),a.account){let b=aX.AccountEntity.createFromAccountInfo(a.account);return await this.storage.setAccount(b,c,dT.isKmsi(d||{})),b}if(!e||!b&&!d)throw this.logger.error("TokenCache - if an account is not provided on the request, authority and either clientInfo or idToken must be provided instead."),cm(b1);let f=aX.AccountEntity.generateHomeAccountId(b,e.authorityType,this.logger,this.cryptoObj,d),g=d?.tid,h=fW(this.storage,e,f,cT,c,d,b,e.hostnameAndPort,g,void 0,void 0,this.logger);return await this.storage.setAccount(h,c,dT.isKmsi(d||{})),h}async loadIdToken(a,b,c,d,e,f){if(!a.id_token)return this.logger.verbose("TokenCache - no id token found in response"),null;this.logger.verbose("TokenCache - loading id token");let g=dX.createIdTokenEntity(b,c,a.id_token,this.config.auth.clientId,d);return await this.storage.setIdTokenCredential(g,e,f),g}async loadAccessToken(a,b,c,d,e,f,g,h){if(!b.access_token)return this.logger.verbose("TokenCache - no access token found in response"),null;if(!b.expires_in)return this.logger.error("TokenCache - no expiration set on the access token. Cannot add it to the cache."),null;if(!b.scope&&(!a.scopes||!a.scopes.length))return this.logger.error("TokenCache - scopes not specified in the request or response. Cannot add token to the cache."),null;this.logger.verbose("TokenCache - loading access token");let i=b.scope?aW.fromString(b.scope):new aW(a.scopes),j=f.expiresOn||b.expires_in+dW.nowSeconds(),k=f.extendedExpiresOn||(b.ext_expires_in||b.expires_in)+dW.nowSeconds(),l=dX.createAccessTokenEntity(c,d,b.access_token,this.config.auth.clientId,e,i.printScopes(),j,k,cT);return await this.storage.setAccessTokenCredential(l,g,h),l}async loadRefreshToken(a,b,c,d,e){if(!a.refresh_token)return this.logger.verbose("TokenCache - no refresh token found in response"),null;this.logger.verbose("TokenCache - loading refresh token");let f=dX.createRefreshTokenEntity(b,c,a.refresh_token,this.config.auth.clientId,a.foci,void 0,a.refresh_token_expires_in);return await this.storage.setRefreshTokenCredential(f,d,e),f}generateAuthenticationResult(a,b,c,d){let e,f="",g=[],h=null;b?.accessToken&&(f=b.accessToken.secret,g=aW.fromString(b.accessToken.target).asArray(),h=dW.toDateFromSeconds(b.accessToken.expiresOn),e=dW.toDateFromSeconds(b.accessToken.extendedExpiresOn));let i=b.account;return{authority:d?d.canonicalAuthority:"",uniqueId:b.account.localAccountId,tenantId:b.account.realm,scopes:g,account:aX.AccountEntity.getAccountInfo(i),idToken:b.idToken?.secret||"",idTokenClaims:c||{},accessToken:f,fromCache:!0,expiresOn:h,correlationId:a.correlationId||"",requestId:"",extExpiresOn:e,familyId:b.refreshToken?.familyId||"",tokenType:b?.accessToken?.tokenType||"",state:a.state||"",cloudGraphHostName:i.cloudGraphHostName||"",msGraphHost:i.msGraphHost||"",fromNativeBroker:!1}}}class gR extends fY{constructor(a){super(a),this.includeRedirectUri=!1}}class gS extends f3{constructor(a,b,c,d,e,f,g,h,i,j){super(a,b,c,d,e,f,h,i,j),this.apiId=g}async acquireToken(a){if(!a.code)throw cm(b3);let b=await dr(this.initializeAuthorizationRequest.bind(this),D,this.logger,this.performanceClient,a.correlationId)(a,bu.InteractionType.Silent),c=this.initializeServerTelemetryManager(this.apiId);try{let d={...b,code:a.code},e=await dr(this.getClientConfiguration.bind(this),C,this.logger,this.performanceClient,a.correlationId)({serverTelemetryManager:c,requestAuthority:b.authority,requestAzureCloudOptions:b.azureCloudOptions,requestExtraQueryParameters:b.extraQueryParameters,account:b.account}),f=new gR(e);this.logger.verbose("Auth code client created");let g=new gb(f,this.browserStorage,d,this.logger,this.performanceClient);return await dr(g.handleCodeResponseFromServer.bind(g),F,this.logger,this.performanceClient,a.correlationId)({code:a.code,msgraph_host:a.msGraphHost,cloud_graph_host_name:a.cloudGraphHostName,cloud_instance_host_name:a.cloudInstanceHostName},b,!1)}catch(a){throw a instanceof aj.AuthError&&(a.setCorrelationId(this.correlationId),c.cacheFailedRequest(a)),a}}logout(){return Promise.reject(cm(bQ))}}function gT(a,b,c){try{fE(a)}catch(a){throw b.end({success:!1},a,c),a}}class gU{constructor(a){var b,c,d,e;this.operatingContext=a,this.isBrowserEnvironment=this.operatingContext.isBrowserEnvironment(),this.config=a.getConfig(),this.initialized=!1,this.logger=this.operatingContext.getLogger(),this.networkClient=this.config.system.networkClient,this.navigationClient=this.config.system.navigationClient,this.redirectResponse=new Map,this.hybridAuthCodeResponses=new Map,this.performanceClient=this.config.telemetry.client,this.browserCrypto=this.isBrowserEnvironment?new dm(this.logger,this.performanceClient):aQ,this.eventHandler=new fK(this.logger),this.browserStorage=this.isBrowserEnvironment?new fI(this.config.auth.clientId,this.config.cache,this.browserCrypto,this.logger,this.performanceClient,this.eventHandler,function(a){let b,c=a.cloudDiscoveryMetadata;if(c)try{b=JSON.parse(c)}catch(a){throw aL(av)}return{canonicalAuthority:a.authority?dR(a.authority):void 0,knownAuthorities:a.knownAuthorities,cloudDiscoveryMetadata:b}}(this.config.auth)):(b=this.config.auth.clientId,c=this.logger,d=this.performanceClient,e=this.eventHandler,new fI(b,{cacheLocation:bu.BrowserCacheLocation.MemoryStorage,cacheRetentionDays:5,temporaryCacheLocation:bu.BrowserCacheLocation.MemoryStorage,storeAuthStateInCookie:!1,secureCookies:!1,cacheMigrationEnabled:!1,claimsBasedCachingEnabled:!1},aQ,c,d,e));const f={cacheLocation:bu.BrowserCacheLocation.MemoryStorage,cacheRetentionDays:5,temporaryCacheLocation:bu.BrowserCacheLocation.MemoryStorage,storeAuthStateInCookie:!1,secureCookies:!1,cacheMigrationEnabled:!1,claimsBasedCachingEnabled:!1};this.nativeInternalStorage=new fI(this.config.auth.clientId,f,this.browserCrypto,this.logger,this.performanceClient,this.eventHandler),this.tokenCache=new gQ(this.config,this.browserStorage,this.logger,this.browserCrypto),this.activeSilentTokenRequests=new Map,this.trackPageVisibility=this.trackPageVisibility.bind(this),this.trackPageVisibilityWithMeasurement=this.trackPageVisibilityWithMeasurement.bind(this)}static async createController(a,b){let c=new gU(a);return await c.initialize(b),c}trackPageVisibility(a){a&&(this.logger.info("Perf: Visibility change detected"),this.performanceClient.incrementFields({visibilityChangeCount:1},a))}async initialize(a,b){if(this.logger.trace("initialize called"),this.initialized)return void this.logger.info("initialize has already been called, exiting early.");if(!this.isBrowserEnvironment){this.logger.info("in non-browser environment, exiting early."),this.initialized=!0,this.eventHandler.emitEvent(d7.EventType.INITIALIZE_END);return}let c=a?.correlationId||this.getRequestCorrelationId(),d=this.config.system.allowPlatformBroker,e=this.performanceClient.startMeasurement("initializeClientApplication",c);if(this.eventHandler.emitEvent(d7.EventType.INITIALIZE_START),!b)try{this.logMultipleInstances(e)}catch{}if(await dr(this.browserStorage.initialize.bind(this.browserStorage),"initializeCache",this.logger,this.performanceClient,c)(c),d)try{this.platformAuthProvider=await gA(this.logger,this.performanceClient,c,this.config.system.nativeBrokerHandshakeTimeout,this.config.system.allowPlatformBrokerWithDOM)}catch(a){this.logger.verbose(a)}this.config.cache.claimsBasedCachingEnabled||(this.logger.verbose("Claims-based caching is disabled. Clearing the previous cache with claims"),dq(this.browserStorage.clearTokensAndKeysWithClaims.bind(this.browserStorage),_,this.logger,this.performanceClient,c)(c)),this.config.system.asyncPopups&&await this.preGeneratePkceCodes(c),this.initialized=!0,this.eventHandler.emitEvent(d7.EventType.INITIALIZE_END),e.end({allowPlatformBroker:d,success:!0})}async handleRedirectPromise(a){if(this.logger.verbose("handleRedirectPromise called"),fD(this.initialized),this.isBrowserEnvironment){let b=a||"",c=this.redirectResponse.get(b);return void 0===c?(c=this.handleRedirectPromiseInternal(a),this.redirectResponse.set(b,c),this.logger.verbose("handleRedirectPromise has been called for the first time, storing the promise")):this.logger.verbose("handleRedirectPromise has been called previously, returning the result from the first call"),c}return this.logger.verbose("handleRedirectPromise returns null, not browser environment"),null}async handleRedirectPromiseInternal(a){let b,c;if(!this.browserStorage.isInteractionInProgress(!0))return this.logger.info("handleRedirectPromise called but there is no interaction in progress, returning null."),null;if(this.browserStorage.getInteractionInProgress()?.type===bu.INTERACTION_TYPE.SIGNOUT)return this.logger.verbose("handleRedirectPromise removing interaction_in_progress flag and returning null after sign-out"),this.browserStorage.setInteractionInProgress(!1),Promise.resolve(null);let d=this.getAllAccounts(),f=this.browserStorage.getCachedNativeRequest(),g=f&&this.platformAuthProvider&&!a;this.eventHandler.emitEvent(d7.EventType.HANDLE_REDIRECT_START,bu.InteractionType.Redirect);try{if(g&&this.platformAuthProvider){b=this.performanceClient.startMeasurement(e,f?.correlationId||""),this.logger.trace("handleRedirectPromise - acquiring token from native platform"),b.add({isPlatformBrokerRequest:!0});let a=new gl(this.config,this.browserStorage,this.browserCrypto,this.logger,this.eventHandler,this.navigationClient,bu.ApiId.handleRedirectPromise,this.performanceClient,this.platformAuthProvider,f.accountId,this.nativeInternalStorage,f.correlationId);c=dr(a.handleRedirectPromise.bind(a),"handleNativeRedirectPromise",this.logger,this.performanceClient,b.event.correlationId)(this.performanceClient,b.event.correlationId)}else{let[d,f]=this.browserStorage.getCachedRequest(),g=d.correlationId;b=this.performanceClient.startMeasurement(e,g),this.logger.trace("handleRedirectPromise - acquiring token from web flow");let h=this.createRedirectClient(g);c=dr(h.handleRedirectPromise.bind(h),"handleRedirectPromise",this.logger,this.performanceClient,b.event.correlationId)(a,d,f,b)}}catch(a){throw this.browserStorage.resetRequestCache(),a}return c.then(a=>(a?(this.browserStorage.resetRequestCache(),d.length<this.getAllAccounts().length?(this.eventHandler.emitEvent(d7.EventType.LOGIN_SUCCESS,bu.InteractionType.Redirect,a),this.logger.verbose("handleRedirectResponse returned result, login success")):(this.eventHandler.emitEvent(d7.EventType.ACQUIRE_TOKEN_SUCCESS,bu.InteractionType.Redirect,a),this.logger.verbose("handleRedirectResponse returned result, acquire token success")),b.end({success:!0},void 0,a.account)):b.event.errorCode?b.end({success:!1},void 0):b.discard(),this.eventHandler.emitEvent(d7.EventType.HANDLE_REDIRECT_END,bu.InteractionType.Redirect),a)).catch(a=>{throw this.browserStorage.resetRequestCache(),d.length>0?this.eventHandler.emitEvent(d7.EventType.ACQUIRE_TOKEN_FAILURE,bu.InteractionType.Redirect,null,a):this.eventHandler.emitEvent(d7.EventType.LOGIN_FAILURE,bu.InteractionType.Redirect,null,a),this.eventHandler.emitEvent(d7.EventType.HANDLE_REDIRECT_END,bu.InteractionType.Redirect),b.end({success:!1},a),a})}async acquireTokenRedirect(a){let b=this.getRequestCorrelationId(a);this.logger.verbose("acquireTokenRedirect called",b);let c=this.performanceClient.startMeasurement("acquireTokenPreRedirect",b);c.add({scenarioId:a.scenarioId});let d=a.onRedirectNavigate;if(d)a.onRedirectNavigate=b=>{let e="function"==typeof d?d(b):void 0;return c.add({navigateCallbackResult:!1!==e}),c.event=c.end({success:!0},void 0,a.account)||c.event,e};else{let b=this.config.auth.onRedirectNavigate;this.config.auth.onRedirectNavigate=d=>{let e="function"==typeof b?b(d):void 0;return c.add({navigateCallbackResult:!1!==e}),c.event=c.end({success:!0},void 0,a.account)||c.event,e}}let f=this.getAllAccounts().length>0;try{let d;return fF(this.initialized,this.config),this.browserStorage.setInteractionInProgress(!0,bu.INTERACTION_TYPE.SIGNIN),f?this.eventHandler.emitEvent(d7.EventType.ACQUIRE_TOKEN_START,bu.InteractionType.Redirect,a):this.eventHandler.emitEvent(d7.EventType.LOGIN_START,bu.InteractionType.Redirect,a),d=this.platformAuthProvider&&this.canUsePlatformBroker(a)?new gl(this.config,this.browserStorage,this.browserCrypto,this.logger,this.eventHandler,this.navigationClient,bu.ApiId.acquireTokenRedirect,this.performanceClient,this.platformAuthProvider,this.getNativeAccountId(a),this.nativeInternalStorage,b).acquireTokenRedirect(a,c).catch(d=>{if(c.add({brokerErrorName:d.name,brokerErrorCode:d.errorCode}),d instanceof gg&&gh(d))return this.platformAuthProvider=void 0,this.createRedirectClient(b).acquireToken(a);if(d instanceof dS.InteractionRequiredAuthError)return this.logger.verbose("acquireTokenRedirect - Resolving interaction required error thrown by native broker by falling back to web flow"),this.createRedirectClient(b).acquireToken(a);throw d}):this.createRedirectClient(b).acquireToken(a),await d}catch(d){throw this.browserStorage.resetRequestCache(),2===c.event.status?this.performanceClient.startMeasurement(e,b).end({success:!1},d,a.account):c.end({success:!1},d,a.account),f?this.eventHandler.emitEvent(d7.EventType.ACQUIRE_TOKEN_FAILURE,bu.InteractionType.Redirect,null,d):this.eventHandler.emitEvent(d7.EventType.LOGIN_FAILURE,bu.InteractionType.Redirect,null,d),d}}acquireTokenPopup(a){let b,c=this.getRequestCorrelationId(a),d=this.performanceClient.startMeasurement("acquireTokenPopup",c);d.add({scenarioId:a.scenarioId});try{this.logger.verbose("acquireTokenPopup called",c),gT(this.initialized,d,a.account),this.browserStorage.setInteractionInProgress(!0,bu.INTERACTION_TYPE.SIGNIN)}catch(a){return Promise.reject(a)}let e=this.getAllAccounts();e.length>0?this.eventHandler.emitEvent(d7.EventType.ACQUIRE_TOKEN_START,bu.InteractionType.Popup,a):this.eventHandler.emitEvent(d7.EventType.LOGIN_START,bu.InteractionType.Popup,a);let f=this.getPreGeneratedPkceCodes(c);return this.canUsePlatformBroker(a)?(d.add({isPlatformBrokerRequest:!0}),b=this.acquireTokenNative({...a,correlationId:c},bu.ApiId.acquireTokenPopup).then(a=>(d.end({success:!0},void 0,a.account),a)).catch(b=>{if(d.add({brokerErrorName:b.name,brokerErrorCode:b.errorCode}),b instanceof gg&&gh(b))return this.platformAuthProvider=void 0,this.createPopupClient(c).acquireToken(a,f);if(b instanceof dS.InteractionRequiredAuthError)return this.logger.verbose("acquireTokenPopup - Resolving interaction required error thrown by native broker by falling back to web flow"),this.createPopupClient(c).acquireToken(a,f);throw b})):b=this.createPopupClient(c).acquireToken(a,f),b.then(a=>(e.length<this.getAllAccounts().length?this.eventHandler.emitEvent(d7.EventType.LOGIN_SUCCESS,bu.InteractionType.Popup,a):this.eventHandler.emitEvent(d7.EventType.ACQUIRE_TOKEN_SUCCESS,bu.InteractionType.Popup,a),d.end({success:!0,accessTokenSize:a.accessToken.length,idTokenSize:a.idToken.length},void 0,a.account),a)).catch(b=>(e.length>0?this.eventHandler.emitEvent(d7.EventType.ACQUIRE_TOKEN_FAILURE,bu.InteractionType.Popup,null,b):this.eventHandler.emitEvent(d7.EventType.LOGIN_FAILURE,bu.InteractionType.Popup,null,b),d.end({success:!1},b,a.account),Promise.reject(b))).finally(async()=>{this.browserStorage.setInteractionInProgress(!1),this.config.system.asyncPopups&&await this.preGeneratePkceCodes(c)})}trackPageVisibilityWithMeasurement(){let a=this.ssoSilentMeasurement||this.acquireTokenByCodeAsyncMeasurement;a&&(this.logger.info("Perf: Visibility change detected in ",a.event.name),a.increment({visibilityChangeCount:1}))}async ssoSilent(a){let b,c=this.getRequestCorrelationId(a),d={...a,prompt:a.prompt,correlationId:c};return this.ssoSilentMeasurement=this.performanceClient.startMeasurement("ssoSilent",c),this.ssoSilentMeasurement?.add({scenarioId:a.scenarioId}),gT(this.initialized,this.ssoSilentMeasurement,a.account),this.ssoSilentMeasurement?.increment({visibilityChangeCount:0}),document.addEventListener("visibilitychange",this.trackPageVisibilityWithMeasurement),this.logger.verbose("ssoSilent called",c),this.eventHandler.emitEvent(d7.EventType.SSO_SILENT_START,bu.InteractionType.Silent,d),this.canUsePlatformBroker(d)?(this.ssoSilentMeasurement?.add({isPlatformBrokerRequest:!0}),b=this.acquireTokenNative(d,bu.ApiId.ssoSilent).catch(a=>{if(this.ssoSilentMeasurement?.add({brokerErrorName:a.name,brokerErrorCode:a.errorCode}),a instanceof gg&&gh(a))return this.platformAuthProvider=void 0,this.createSilentIframeClient(d.correlationId).acquireToken(d);throw a})):b=this.createSilentIframeClient(d.correlationId).acquireToken(d),b.then(a=>(this.eventHandler.emitEvent(d7.EventType.SSO_SILENT_SUCCESS,bu.InteractionType.Silent,a),this.ssoSilentMeasurement?.end({success:!0,accessTokenSize:a.accessToken.length,idTokenSize:a.idToken.length},void 0,a.account),a)).catch(b=>{throw this.eventHandler.emitEvent(d7.EventType.SSO_SILENT_FAILURE,bu.InteractionType.Silent,null,b),this.ssoSilentMeasurement?.end({success:!1},b,a.account),b}).finally(()=>{document.removeEventListener("visibilitychange",this.trackPageVisibilityWithMeasurement)})}async acquireTokenByCode(a){let b=this.getRequestCorrelationId(a);this.logger.trace("acquireTokenByCode called",b);let c=this.performanceClient.startMeasurement("acquireTokenByCode",b);gT(this.initialized,c),this.eventHandler.emitEvent(d7.EventType.ACQUIRE_TOKEN_BY_CODE_START,bu.InteractionType.Silent,a),c.add({scenarioId:a.scenarioId});try{if(a.code&&a.nativeAccountId)throw cm(b5);if(a.code){let d=a.code,e=this.hybridAuthCodeResponses.get(d);return e?(this.logger.verbose("Existing acquireTokenByCode request found",b),c.discard()):(this.logger.verbose("Initiating new acquireTokenByCode request",b),e=this.acquireTokenByCodeAsync({...a,correlationId:b}).then(a=>(this.eventHandler.emitEvent(d7.EventType.ACQUIRE_TOKEN_BY_CODE_SUCCESS,bu.InteractionType.Silent,a),this.hybridAuthCodeResponses.delete(d),c.end({success:!0,accessTokenSize:a.accessToken.length,idTokenSize:a.idToken.length},void 0,a.account),a)).catch(a=>{throw this.hybridAuthCodeResponses.delete(d),this.eventHandler.emitEvent(d7.EventType.ACQUIRE_TOKEN_BY_CODE_FAILURE,bu.InteractionType.Silent,null,a),c.end({success:!1},a),a}),this.hybridAuthCodeResponses.set(d,e)),await e}if(a.nativeAccountId)if(this.canUsePlatformBroker(a,a.nativeAccountId)){c.add({isPlatformBrokerRequest:!0});let d=await this.acquireTokenNative({...a,correlationId:b},bu.ApiId.acquireTokenByCode,a.nativeAccountId).catch(a=>{throw a instanceof gg&&gh(a)&&(this.platformAuthProvider=void 0),c.add({brokerErrorName:a.name,brokerErrorCode:a.errorCode}),a});return c.end({success:!0},void 0,d.account),d}else throw cm(b7);else throw cm(b4)}catch(a){throw this.eventHandler.emitEvent(d7.EventType.ACQUIRE_TOKEN_BY_CODE_FAILURE,bu.InteractionType.Silent,null,a),c.end({success:!1},a),a}}async acquireTokenByCodeAsync(a){this.logger.trace("acquireTokenByCodeAsync called",a.correlationId),this.acquireTokenByCodeAsyncMeasurement=this.performanceClient.startMeasurement("acquireTokenByCodeAsync",a.correlationId),this.acquireTokenByCodeAsyncMeasurement?.increment({visibilityChangeCount:0}),document.addEventListener("visibilitychange",this.trackPageVisibilityWithMeasurement);let b=this.createSilentAuthCodeClient(a.correlationId);return await b.acquireToken(a).then(a=>(this.acquireTokenByCodeAsyncMeasurement?.end({success:!0,fromCache:a.fromCache}),a)).catch(a=>{throw this.acquireTokenByCodeAsyncMeasurement?.end({success:!1},a),a}).finally(()=>{document.removeEventListener("visibilitychange",this.trackPageVisibilityWithMeasurement)})}async acquireTokenFromCache(a,b){switch(this.performanceClient.addQueueMeasurement(r,a.correlationId),b){case bu.CacheLookupPolicy.Default:case bu.CacheLookupPolicy.AccessToken:case bu.CacheLookupPolicy.AccessTokenAndRefreshToken:let c=this.createSilentCacheClient(a.correlationId);return dr(c.acquireToken.bind(c),f,this.logger,this.performanceClient,a.correlationId)(a);default:throw(0,aN.createClientAuthError)(cH.tokenRefreshRequired)}}async acquireTokenByRefreshToken(a,b){switch(this.performanceClient.addQueueMeasurement(c,a.correlationId),b){case bu.CacheLookupPolicy.Default:case bu.CacheLookupPolicy.AccessTokenAndRefreshToken:case bu.CacheLookupPolicy.RefreshToken:case bu.CacheLookupPolicy.RefreshTokenAndNetwork:let d=this.createSilentRefreshClient(a.correlationId);return dr(d.acquireToken.bind(d),h,this.logger,this.performanceClient,a.correlationId)(a);default:throw(0,aN.createClientAuthError)(cH.tokenRefreshRequired)}}async acquireTokenBySilentIframe(a){this.performanceClient.addQueueMeasurement(u,a.correlationId);let b=this.createSilentIframeClient(a.correlationId);return dr(b.acquireToken.bind(b),g,this.logger,this.performanceClient,a.correlationId)(a)}async logout(a){let b=this.getRequestCorrelationId(a);return this.logger.warning("logout API is deprecated and will be removed in msal-browser v3.0.0. Use logoutRedirect instead.",b),this.logoutRedirect({correlationId:b,...a})}async logoutRedirect(a){let b=this.getRequestCorrelationId(a);return fF(this.initialized,this.config),this.browserStorage.setInteractionInProgress(!0,bu.INTERACTION_TYPE.SIGNOUT),this.createRedirectClient(b).logout(a)}logoutPopup(a){try{let b=this.getRequestCorrelationId(a);return fE(this.initialized),this.browserStorage.setInteractionInProgress(!0,bu.INTERACTION_TYPE.SIGNOUT),this.createPopupClient(b).logout(a).finally(()=>{this.browserStorage.setInteractionInProgress(!1)})}catch(a){return Promise.reject(a)}}async clearCache(a){if(!this.isBrowserEnvironment)return void this.logger.info("in non-browser environment, returning early.");let b=this.getRequestCorrelationId(a);return this.createSilentCacheClient(b).logout(a)}getAllAccounts(a){var b,c,d;let e=this.getRequestCorrelationId();return b=this.logger,c=this.browserStorage,d=this.isBrowserEnvironment,b.verbose("getAllAccounts called"),d?c.getAllAccounts(a||{},e):[]}getAccount(a){var b,c;let d,e=this.getRequestCorrelationId();return b=this.logger,c=this.browserStorage,(d=c.getAccountInfoFilteredBy(a,e))?(b.verbose("getAccount: Account matching provided filter found, returning"),d):(b.verbose("getAccount: No matching account found, returning null"),null)}getAccountByUsername(a){let b=this.getRequestCorrelationId();return function(a,b,c,d){if(b.trace("getAccountByUsername called"),!a)return b.warning("getAccountByUsername: No username provided"),null;let e=c.getAccountInfoFilteredBy({username:a},d);return e?(b.verbose("getAccountByUsername: Account matching username found, returning"),b.verbosePii(`getAccountByUsername: Returning signed-in accounts matching username: ${a}`),e):(b.verbose("getAccountByUsername: No matching account found, returning null"),null)}(a,this.logger,this.browserStorage,b)}getAccountByHomeId(a){let b=this.getRequestCorrelationId();return function(a,b,c,d){if(b.trace("getAccountByHomeId called"),!a)return b.warning("getAccountByHomeId: No homeAccountId provided"),null;let e=c.getAccountInfoFilteredBy({homeAccountId:a},d);return e?(b.verbose("getAccountByHomeId: Account matching homeAccountId found, returning"),b.verbosePii(`getAccountByHomeId: Returning signed-in accounts matching homeAccountId: ${a}`),e):(b.verbose("getAccountByHomeId: No matching account found, returning null"),null)}(a,this.logger,this.browserStorage,b)}getAccountByLocalId(a){let b=this.getRequestCorrelationId();return function(a,b,c,d){if(b.trace("getAccountByLocalId called"),!a)return b.warning("getAccountByLocalId: No localAccountId provided"),null;let e=c.getAccountInfoFilteredBy({localAccountId:a},d);return e?(b.verbose("getAccountByLocalId: Account matching localAccountId found, returning"),b.verbosePii(`getAccountByLocalId: Returning signed-in accounts matching localAccountId: ${a}`),e):(b.verbose("getAccountByLocalId: No matching account found, returning null"),null)}(a,this.logger,this.browserStorage,b)}setActiveAccount(a){var b;let c=this.getRequestCorrelationId();b=this.browserStorage,b.setActiveAccount(a,c)}getActiveAccount(){var a;let b=this.getRequestCorrelationId();return a=this.browserStorage,a.getActiveAccount(b)}async hydrateCache(a,b){this.logger.verbose("hydrateCache called");let c=aX.AccountEntity.createFromAccountInfo(a.account,a.cloudGraphHostName,a.msGraphHost);return(await this.browserStorage.setAccount(c,a.correlationId,dT.isKmsi(a.idTokenClaims)),a.fromNativeBroker)?(this.logger.verbose("Response was from native broker, storing in-memory"),this.nativeInternalStorage.hydrateCache(a,b)):this.browserStorage.hydrateCache(a,b)}async acquireTokenNative(a,b,c,d){if(this.logger.trace("acquireTokenNative called"),!this.platformAuthProvider)throw cm(ca);return new gl(this.config,this.browserStorage,this.browserCrypto,this.logger,this.eventHandler,this.navigationClient,b,this.performanceClient,this.platformAuthProvider,c||this.getNativeAccountId(a),this.nativeInternalStorage,a.correlationId).acquireToken(a,d)}canUsePlatformBroker(a,b){if(this.logger.trace("canUsePlatformBroker called"),!this.platformAuthProvider)return this.logger.trace("canUsePlatformBroker: platform broker unavilable, returning false"),!1;if(!gB(this.config,this.logger,this.platformAuthProvider,a.authenticationScheme))return this.logger.trace("canUsePlatformBroker: isBrokerAvailable returned false, returning false"),!1;if(a.prompt)switch(a.prompt){case aR.PromptValue.NONE:case aR.PromptValue.CONSENT:case aR.PromptValue.LOGIN:case aR.PromptValue.SELECT_ACCOUNT:this.logger.trace("canUsePlatformBroker: prompt is compatible with platform broker flow");break;default:return this.logger.trace(`canUsePlatformBroker: prompt = ${a.prompt} is not compatible with platform broker flow, returning false`),!1}return!!b||!!this.getNativeAccountId(a)||(this.logger.trace("canUsePlatformBroker: nativeAccountId is not available, returning false"),!1)}getNativeAccountId(a){let b=a.account||this.getAccount({loginHint:a.loginHint,sid:a.sid})||this.getActiveAccount();return b&&b.nativeAccountId||""}createPopupClient(a){return new gC(this.config,this.browserStorage,this.browserCrypto,this.logger,this.eventHandler,this.navigationClient,this.performanceClient,this.nativeInternalStorage,this.platformAuthProvider,a)}createRedirectClient(a){return new gD(this.config,this.browserStorage,this.browserCrypto,this.logger,this.eventHandler,this.navigationClient,this.performanceClient,this.nativeInternalStorage,this.platformAuthProvider,a)}createSilentIframeClient(a){return new gM(this.config,this.browserStorage,this.browserCrypto,this.logger,this.eventHandler,this.navigationClient,bu.ApiId.ssoSilent,this.performanceClient,this.nativeInternalStorage,this.platformAuthProvider,a)}createSilentCacheClient(a){return new gk(this.config,this.browserStorage,this.browserCrypto,this.logger,this.eventHandler,this.navigationClient,this.performanceClient,this.platformAuthProvider,a)}createSilentRefreshClient(a){return new gP(this.config,this.browserStorage,this.browserCrypto,this.logger,this.eventHandler,this.navigationClient,this.performanceClient,this.platformAuthProvider,a)}createSilentAuthCodeClient(a){return new gS(this.config,this.browserStorage,this.browserCrypto,this.logger,this.eventHandler,this.navigationClient,bu.ApiId.acquireTokenByCode,this.performanceClient,this.platformAuthProvider,a)}addEventCallback(a,b){return this.eventHandler.addEventCallback(a,b)}removeEventCallback(a){this.eventHandler.removeEventCallback(a)}addPerformanceCallback(a){return fC(),this.performanceClient.addPerformanceCallback(a)}removePerformanceCallback(a){return this.performanceClient.removePerformanceCallback(a)}enableAccountStorageEvents(){this.config.cache.cacheLocation!==bu.BrowserCacheLocation.LocalStorage?this.logger.info("Account storage events are only available when cacheLocation is set to localStorage"):this.eventHandler.subscribeCrossTab()}disableAccountStorageEvents(){this.config.cache.cacheLocation!==bu.BrowserCacheLocation.LocalStorage?this.logger.info("Account storage events are only available when cacheLocation is set to localStorage"):this.eventHandler.unsubscribeCrossTab()}getTokenCache(){return this.tokenCache}getLogger(){return this.logger}setLogger(a){this.logger=a}initializeWrapperLibrary(a,b){this.browserStorage.setWrapperMetadata(a,b)}setNavigationClient(a){this.navigationClient=a}getConfiguration(){return this.config}getPerformanceClient(){return this.performanceClient}isBrowserEnv(){return this.isBrowserEnvironment}getRequestCorrelationId(a){return a?.correlationId?a.correlationId:this.isBrowserEnvironment?c5():aR.Constants.EMPTY_STRING}async loginRedirect(a){let b=this.getRequestCorrelationId(a);return this.logger.verbose("loginRedirect called",b),this.acquireTokenRedirect({correlationId:b,...a||bu.DEFAULT_REQUEST})}loginPopup(a){let b=this.getRequestCorrelationId(a);return this.logger.verbose("loginPopup called",b),this.acquireTokenPopup({correlationId:b,...a||bu.DEFAULT_REQUEST})}async acquireTokenSilent(a){let b=this.getRequestCorrelationId(a),c=this.performanceClient.startMeasurement("acquireTokenSilent",b);c.add({cacheLookupPolicy:a.cacheLookupPolicy,scenarioId:a.scenarioId}),gT(this.initialized,c,a.account),this.logger.verbose("acquireTokenSilent called",b);let d=a.account||this.getActiveAccount();if(!d)throw cm(bR);return this.acquireTokenSilentDeduped(a,d,b).then(d=>(c.end({success:!0,fromCache:d.fromCache,accessTokenSize:d.accessToken.length,idTokenSize:d.idToken.length},void 0,d.account),{...d,state:a.state,correlationId:b})).catch(a=>{throw a instanceof aj.AuthError&&a.setCorrelationId(b),c.end({success:!1},a,d),a})}async acquireTokenSilentDeduped(a,b,c){let e=JSON.stringify(dU(this.config.auth.clientId,{...a,authority:a.authority||this.config.auth.authority,correlationId:c},b.homeAccountId)),f=this.activeSilentTokenRequests.get(e);if(void 0!==f)return this.logger.verbose("acquireTokenSilent has been called previously, returning the result from the first call",c),this.performanceClient.addFields({deduped:!0},c),f;{this.logger.verbose("acquireTokenSilent called for the first time, storing active request",c),this.performanceClient.addFields({deduped:!1},c);let f=dr(this.acquireTokenSilentAsync.bind(this),d,this.logger,this.performanceClient,c)({...a,correlationId:c},b);return this.activeSilentTokenRequests.set(e,f),f.finally(()=>{this.activeSilentTokenRequests.delete(e)})}}async acquireTokenSilentAsync(a,b){let c=()=>this.trackPageVisibility(a.correlationId);this.performanceClient.addQueueMeasurement(d,a.correlationId),this.eventHandler.emitEvent(d7.EventType.ACQUIRE_TOKEN_START,bu.InteractionType.Silent,a),a.correlationId&&this.performanceClient.incrementFields({visibilityChangeCount:0},a.correlationId),document.addEventListener("visibilitychange",c);let e=await dr(f1,w,this.logger,this.performanceClient,a.correlationId)(a,b,this.config,this.performanceClient,this.logger),f=a.cacheLookupPolicy||bu.CacheLookupPolicy.Default;return this.acquireTokenSilentNoIframe(e,f).catch(async a=>{var b,c;let d,g,h,i;if(b=a,c=f,d=!(b instanceof dS.InteractionRequiredAuthError&&b.subError!==dV.badToken),g=b.errorCode===bu.BrowserConstants.INVALID_GRANT_ERROR||b.errorCode===cH.tokenRefreshRequired,h=d&&g||b.errorCode===dV.noTokensFound||b.errorCode===dV.refreshTokenExpired,i=bu.iFrameRenewalPolicies.includes(c),h&&i)if(this.activeIframeRequest)if(f===bu.CacheLookupPolicy.Skip)return this.logger.warning("Another iframe request is currently in progress and CacheLookupPolicy is set to Skip. This may result in degraded performance and/or reliability for both calls. Please consider changing the CacheLookupPolicy to take advantage of request queuing and token cache.",e.correlationId),dr(this.acquireTokenBySilentIframe.bind(this),u,this.logger,this.performanceClient,e.correlationId)(e);else{let[b,c]=this.activeIframeRequest;this.logger.verbose(`Iframe request is already in progress, awaiting resolution for request with correlationId: ${c}`,e.correlationId);let d=this.performanceClient.startMeasurement("awaitConcurrentIframe",e.correlationId);d.add({awaitIframeCorrelationId:c});let g=await b;if(d.end({success:g}),g)return this.logger.verbose(`Parallel iframe request with correlationId: ${c} succeeded. Retrying cache and/or RT redemption`,e.correlationId),this.acquireTokenSilentNoIframe(e,f);throw this.logger.info(`Iframe request with correlationId: ${c} failed. Interaction is required.`),a}else{let a;return this.activeIframeRequest=[new Promise(b=>{a=b}),e.correlationId],this.logger.verbose("Refresh token expired/invalid or CacheLookupPolicy is set to Skip, attempting acquire token by iframe.",e.correlationId),dr(this.acquireTokenBySilentIframe.bind(this),u,this.logger,this.performanceClient,e.correlationId)(e).then(b=>(a(!0),b)).catch(b=>{throw a(!1),b}).finally(()=>{this.activeIframeRequest=void 0})}throw a}).then(b=>(this.eventHandler.emitEvent(d7.EventType.ACQUIRE_TOKEN_SUCCESS,bu.InteractionType.Silent,b),this.performanceClient.addFields({fromCache:b.fromCache},a.correlationId),b)).catch(a=>{throw this.eventHandler.emitEvent(d7.EventType.ACQUIRE_TOKEN_FAILURE,bu.InteractionType.Silent,null,a),a}).finally(()=>{document.removeEventListener("visibilitychange",c)})}async acquireTokenSilentNoIframe(a,b){return gB(this.config,this.logger,this.platformAuthProvider,a.authenticationScheme)&&a.account.nativeAccountId?(this.logger.verbose("acquireTokenSilent - attempting to acquire token from native platform"),this.performanceClient.addFields({isPlatformBrokerRequest:!0},a.correlationId),this.acquireTokenNative(a,bu.ApiId.acquireTokenSilent_silentFlow,a.account.nativeAccountId,b).catch(async b=>{if(this.performanceClient.addFields({brokerErrorName:b.name,brokerErrorCode:b.errorCode},a.correlationId),b instanceof gg&&gh(b))throw this.logger.verbose("acquireTokenSilent - native platform unavailable, falling back to web flow"),this.platformAuthProvider=void 0,(0,aN.createClientAuthError)(cH.tokenRefreshRequired);throw b})):(this.logger.verbose("acquireTokenSilent - attempting to acquire token from web flow"),b===bu.CacheLookupPolicy.AccessToken&&this.logger.verbose("acquireTokenSilent - cache lookup policy set to AccessToken, attempting to acquire token from local cache"),dr(this.acquireTokenFromCache.bind(this),r,this.logger,this.performanceClient,a.correlationId)(a,b).catch(d=>{if(b===bu.CacheLookupPolicy.AccessToken)throw d;return this.eventHandler.emitEvent(d7.EventType.ACQUIRE_TOKEN_NETWORK_START,bu.InteractionType.Silent,a),dr(this.acquireTokenByRefreshToken.bind(this),c,this.logger,this.performanceClient,a.correlationId)(a,b)}))}async preGeneratePkceCodes(a){return this.logger.verbose("Generating new PKCE codes"),this.pkceCode=await dr(gu,aa,this.logger,this.performanceClient,a)(this.performanceClient,this.logger,a),Promise.resolve()}getPreGeneratedPkceCodes(a){this.logger.verbose("Attempting to pick up pre-generated PKCE codes");let b=this.pkceCode?{...this.pkceCode}:void 0;return this.pkceCode=void 0,this.logger.verbose(`${b?"Found":"Did not find"} pre-generated PKCE codes`),this.performanceClient.addFields({usePreGeneratedPkce:!!b},a),b}logMultipleInstances(a){var b;let c,d,e,f=this.config.auth.clientId;window&&(window.msal=window.msal||{},window.msal.clientIds=window.msal.clientIds||[],window.msal.clientIds.length>0&&this.logger.verbose("There is already an instance of MSAL.js in the window."),window.msal.clientIds.push(f),b=this.logger,d=(c=window.msal?.clientIds||[]).length,(e=c.filter(a=>a===f).length)>1&&b.warning("There is already an instance of MSAL.js in the window with the same client id."),a.add({msalInstanceCount:d,sameClientIdInstanceCount:e}))}}var dW=dW,dT=dT,fz=fz,cH=aO,dW=dW,dT=dT,gV=aj;let gW="unsupported_method",gX="This method is not supported in nested app environment.";class gY extends gV.AuthError{constructor(a,b){super(a,b),Object.setPrototypeOf(this,gY.prototype),this.name="NestedAppAuthError"}static createUnsupportedError(){return new gY(gW,gX)}}async function gZ(a,b){let c=new cG(a);return await c.initialize(),gU.createController(c,b)}class g${static async createPublicClientApplication(a){let b=await gZ(a);return new g$(a,b)}constructor(a,b){this.isBroker=!1,this.controller=b||new gU(new cG(a))}async initialize(a){return this.controller.initialize(a,this.isBroker)}async acquireTokenPopup(a){return this.controller.acquireTokenPopup(a)}acquireTokenRedirect(a){return this.controller.acquireTokenRedirect(a)}acquireTokenSilent(a){return this.controller.acquireTokenSilent(a)}acquireTokenByCode(a){return this.controller.acquireTokenByCode(a)}addEventCallback(a,b){return this.controller.addEventCallback(a,b)}removeEventCallback(a){return this.controller.removeEventCallback(a)}addPerformanceCallback(a){return this.controller.addPerformanceCallback(a)}removePerformanceCallback(a){return this.controller.removePerformanceCallback(a)}enableAccountStorageEvents(){this.controller.enableAccountStorageEvents()}disableAccountStorageEvents(){this.controller.disableAccountStorageEvents()}getAccount(a){return this.controller.getAccount(a)}getAccountByHomeId(a){return this.controller.getAccountByHomeId(a)}getAccountByLocalId(a){return this.controller.getAccountByLocalId(a)}getAccountByUsername(a){return this.controller.getAccountByUsername(a)}getAllAccounts(a){return this.controller.getAllAccounts(a)}handleRedirectPromise(a){return this.controller.handleRedirectPromise(a)}loginPopup(a){return this.controller.loginPopup(a)}loginRedirect(a){return this.controller.loginRedirect(a)}logout(a){return this.controller.logout(a)}logoutRedirect(a){return this.controller.logoutRedirect(a)}logoutPopup(a){return this.controller.logoutPopup(a)}ssoSilent(a){return this.controller.ssoSilent(a)}getTokenCache(){return this.controller.getTokenCache()}getLogger(){return this.controller.getLogger()}setLogger(a){this.controller.setLogger(a)}setActiveAccount(a){this.controller.setActiveAccount(a)}getActiveAccount(){return this.controller.getActiveAccount()}initializeWrapperLibrary(a,b){return this.controller.initializeWrapperLibrary(a,b)}setNavigationClient(a){this.controller.setNavigationClient(a)}getConfiguration(){return this.controller.getConfiguration()}async hydrateCache(a,b){return this.controller.hydrateCache(a,b)}clearCache(a){return this.controller.clearCache(a)}}a.s(["PublicClientApplication",()=>g$],80420)}];

//# sourceMappingURL=10412_%40azure_msal-browser_dist_app_PublicClientApplication_mjs_98b12c37._.js.map